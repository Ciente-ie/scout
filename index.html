<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Monitoramento Integrado de Atletas</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f9fafb;
        }
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3b82f6;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .details-section {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.5s ease-in-out;
        }
        .details-section.open {
            max-height: 1000px; /* Adjust as needed */
        }
        .tab-btn {
            transition: all 0.3s ease;
        }
        .tab-btn.active {
            border-color: #3b82f6;
            color: #3b82f6;
            background-color: #eff6ff;
        }
        /* Custom styles for load indicators */
        .carga-leve { border-color: #3b82f6; } /* Azul */
        .carga-moderada { border-color: #f59e0b; } /* Amarelo */
        .carga-alta { border-color: #f97316; } /* Laranja */
        .carga-maxima { border-color: #ef4444; } /* Vermelho */

        /* Custom styling for multi-select */
        select[multiple] {
            height: 100px;
            padding: 8px;
        }
         select[multiple] option {
            padding: 4px;
            border-radius: 4px;
        }
         select[multiple] option:checked {
            background-color: #3b82f6;
            color: white;
        }
        #globalLoader {
            background-color: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(4px);
        }

    </style>

<!-- ==== INTEGRA√á√ÉO FIREBASE (APP NOMEADO PARA N√ÉO CONFLITAR) ==== -->
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
<script>
  (function(){
    if (!window.__APP_INTEGRADO__) {
      const firebaseConfigIntegrado = {
        apiKey: "AIzaSyDsoutLk5gmxq5zlu548HWFrox37u1zrxk",
        authDomain: "appintegrado-ciente.firebaseapp.com",
        projectId: "appintegrado-ciente",
        storageBucket: "appintegrado-ciente.appspot.com",
        messagingSenderId: "487559108410",
        appId: "1:487559108410:web:08868011454e609ee52203"
      };
      try {
        window.__APP_INTEGRADO__ = firebase.initializeApp(firebaseConfigIntegrado, "appIntegrado");
        window.__DB_INTEGRADO__ = window.__APP_INTEGRADO__.firestore();
      } catch(e) {
        // Se j√° existe app com o mesmo nome, reaproveita
        window.__APP_INTEGRADO__ = firebase.app("appIntegrado");
        window.__DB_INTEGRADO__ = window.__APP_INTEGRADO__.firestore();
      }
    }

    // Utilit√°rio: simula o upload de CSV e aciona o fluxo nativo
    window.__simularUploadCSV = function(inputId, processHandlerName, fallbackBtnId, file){
      const input = document.getElementById(inputId);
      const dt = new DataTransfer();
      dt.items.add(file);
      if (input) {
        input.files = dt.files;
        input.dispatchEvent(new Event('change', { bubbles: true }));
      }
      const handler = window[processHandlerName];
      if (typeof handler === 'function') {
        handler();
      } else {
        const btn = document.getElementById(fallbackBtnId);
        if (btn) btn.click();
      }
    };

    // PRONTID√ÉO
    window.carregarFirebaseProntidao = async function(){
      try {
        const db = window.__DB_INTEGRADO__;
        const snap = await db.collection("prontidao").orderBy("data", "desc").get();
        const linhas = [];
        snap.forEach(doc => {
          const d = doc.data() || {};
          const linha = [d.equipe_id ?? "",(d.atleta_id ?? d.nome_atleta ?? ""),(d.posicao_grupo ?? ""),(d.data ?? ""),(d.semana_id ?? ""),(d.qualidade_sono ?? d.sono ?? ""),(d.niveis_stress ?? d.estresse ?? ""),(d.fadiga_geral ?? d.fadiga ?? ""),(d.dor_muscular ?? d.dor ?? ""),(d.hooper_score ?? ""),(d.salto_horizontal_cm ?? d.salto ?? ""),(d.vfc_rmssd ?? d.vfc ?? "")].join(",");
          linhas.push(linha);
        });
        const header = "equipe_id,atleta_id,posicao_grupo,data,semana_id,qualidade_sono,niveis_stress,fadiga_geral,dor_muscular,hooper_score,salto_horizontal_cm,vfc_rmssd";
        const csv = header + "\n" + linhas.join("\n");
        const blob = new Blob([csv], { type: "text/csv" });
        const file = new File([blob], "prontidao_firebase.csv", { type: "text/csv" });
        window.__simularUploadCSV("csvFileInput", "handleFileProcessing", "processBtn", file);
      } catch (e) {
        console.error("Erro carregarFirebaseProntidao:", e);
        alert("Erro ao carregar Prontid√£o do Firebase. Veja o console.");
      }
    };

    // CARGA
    window.carregarFirebaseCarga = async function(){
      try {
        const db = window.__DB_INTEGRADO__;
        const snap = await db.collection("carga").orderBy("data", "desc").get();
        const linhas = [];
        snap.forEach(doc => {
          const d = doc.data() || {};
          const linha = [
            d.equipe_id ?? "",
            (d.atleta_id ?? d.nome_atleta ?? ""),
            (d.posicao_grupo ?? ""),
            (d.data ?? ""),
            (d.microciclo_id ?? d.semana_id ?? ""),
            (d.pse_sessao ?? d.pse ?? ""), (d.duracao_sessao_min ?? d.duracao_sessao ?? d.tempo ?? d.duracao_min ?? d.duracao ?? "")].join(",");
          linhas.push(linha);
        });
        const header = "equipe_id,atleta_id,posicao_grupo,data,microciclo_id,pse_sessao,duracao_sessao_min";
        const csv = header + "\n" + linhas.join("\n");
        const blob = new Blob([csv], { type: "text/csv" });
        const file = new File([blob], "carga_firebase.csv", { type: "text/csv" });
        window.__simularUploadCSV("csvFileInputCarga", "handleFileProcessingCarga", "processBtnCarga", file);
      } catch (e) {
        console.error("Erro carregarFirebaseCarga:", e);
        alert("Erro ao carregar Carga do Firebase. Veja o console.");
      }
    };
  })();
</script>
<!-- ==== /FIM INTEGRA√á√ÉO FIREBASE ==== -->

</head>
<body class="bg-gray-50 text-gray-800 flex flex-col min-h-screen">

    <div id="globalLoader" class="fixed inset-0 z-50 flex flex-col items-center justify-center">
        <div class="loader" style="width: 50px; height: 50px;"></div>
        <p id="loaderText" class="mt-4 text-gray-600 font-semibold">Conectando...</p>
    </div>


    <div class="container mx-auto p-4 md:p-8 max-w-7xl flex-grow hidden" id="mainContent">
        <header class="text-center mb-6">
            <div class="flex justify-center items-center gap-4">
                <h1 class="text-3xl md:text-4xl font-bold text-gray-900">Monitoramento Integrado de Atletas</h1>
                 <div class="flex items-center gap-x-4">
                     <div id="authStatusContainer" class="bg-gray-100 p-2 rounded-lg text-sm">
                        <span id="authStatus"></span>
                    </div>
                </div>
            </div>
            <p class="text-gray-600 mt-2 text-lg">Analise a prontid√£o, controle a carga, planeje os treinos e monitore les√µes da sua equipe.</p>
        </header>

        <div class="mb-6 flex justify-center items-end gap-x-8">
            <div class="w-64">
                <label for="teamFilterSelect" class="block text-sm font-medium text-gray-700 mb-1 text-center">Selecione a Equipe</label>
                <div class="flex items-center gap-2"><select id="teamFilterSelect" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                <option value="all">Todas as Equipes</option>
                </select><button id="btnOcultarEquipe" title="Ocultar equipe" class="h-10 w-10 rounded-md bg-gray-100 text-gray-500 hover:bg-gray-200 hover:text-gray-700 flex items-center justify-center">üóëÔ∏è</button></div>
            </div>
            
            <div class="w-64">
                 <label for="athleteGroupFilterSelect" class="block text-sm font-medium text-gray-700 mb-1 text-center">Filtrar Atletas</label>
                 <div class="flex items-center gap-2"><select id="athleteGroupFilterSelect" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                    <option value="all" selected>Todos os Atletas</option>
                    <optgroup label="Posi√ß√µes">
                        <option value="Defesa">Defesa</option>
                        <option value="Meio">Meio-Campo</option>
                        <option value="Ataque">Ataque</option>
                    </optgroup>
                    <optgroup label="Atletas Individuais" id="individualAthleteOptions">
                        </optgroup>
                 </select><button id="btnOcultarAtleta" title="Ocultar atleta" class="h-10 w-10 rounded-md bg-gray-100 text-gray-500 hover:bg-gray-200 hover:text-gray-700 flex items-center justify-center">üóëÔ∏è</button></div>
            </div>
        </div>


        <div class="mb-8">
            <div class="flex border-b border-gray-200 flex-wrap justify-center">
                <button id="tabDashboardBtn" class="tab-btn active text-lg font-semibold py-3 px-6 border-b-2 border-transparent text-gray-500 hover:text-blue-600">
                    Dashboard Geral
                </button>
                <button id="tabProntidaoBtn" class="tab-btn text-lg font-semibold py-3 px-6 border-b-2 border-transparent text-gray-500 hover:text-blue-600">
                    An√°lise de Prontid√£o
                </button>
                <button id="tabCargaBtn" class="tab-btn text-lg font-semibold py-3 px-6 border-b-2 border-transparent text-gray-500 hover:text-blue-600">
                    Controle de Carga
                </button>
                <button id="tabPlanejamentoBtn" class="tab-btn text-lg font-semibold py-3 px-6 border-b-2 border-transparent text-gray-500 hover:text-blue-600">
                    Planejamento
                </button>
                <button id="tabLesoesBtn" class="tab-btn text-lg font-semibold py-3 px-6 border-b-2 border-transparent text-gray-500 hover:text-blue-600">
                    Les√µes
                </button>
            </div>
        </div>

        <div id="dashboardContent">
            <div class="space-y-10" id="pdf-content-dashboard">
                <div id="dashboardLesoes" class="bg-white p-6 rounded-2xl shadow-md border border-gray-200"></div>
                <div id="dashboardProntidao" class="bg-white p-6 rounded-2xl shadow-md border border-gray-200"></div>
                <div id="dashboardCarga" class="bg-white p-6 rounded-2xl shadow-md border border-gray-200"></div>
                <div id="dashboardPlanejamento" class="bg-white p-6 rounded-2xl shadow-md border border-gray-200"></div>
            </div>
             <div class="text-center mt-8">
                <button id="exportPdfBtnDashboard" class="btn bg-red-600 text-white font-semibold py-3 px-6 rounded-lg hover:bg-red-700 transition flex items-center mx-auto">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M4 4a2 2 0 012-2h4.586A2 2 0 0112 2.586L15.414 6A2 2 0 0116 7.414V16a2 2 0 01-2 2H6a2 2 0 01-2-2V4zm2 6a1 1 0 011-1h6a1 1 0 110 2H7a1 1 0 01-1-1zm1 3a1 1 0 100 2h6a1 1 0 100-2H7z" clip-rule="evenodd"></path></svg>
                    Exportar Dashboard como PDF
                </button>
            </div>
        </div>

        <div id="prontidaoContent" class="hidden">
             <div class="bg-white p-6 md:p-8 rounded-2xl shadow-md border border-gray-200">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8 items-start">
                    <div>
                        <h2 class="text-xl font-semibold text-gray-800 mb-3">1. Prepare seu arquivo de Prontid√£o</h2>
                        <p class="text-gray-600 mb-4">O arquivo CSV deve ter as colunas abaixo, incluindo `equipe_id`, `semana_id` e a nova coluna `posicao_grupo`.</p>
                        <div class="bg-gray-100 p-4 rounded-lg text-sm text-gray-700 font-mono border">
                            <p><strong class="text-blue-600">equipe_id</strong>,atleta_id,<strong class="text-red-600">posicao_grupo</strong>,data,<strong class="text-blue-600">semana_id</strong>,qualidade_sono,niveis_stress,fadiga_geral,dor_muscular,hooper_score,...</p>
                        </div>
                         <ul class="mt-4 space-y-2 text-gray-600 text-sm list-disc list-inside">
                             <li>O `semana_id` deve ser consistente (ex: "Sem25", "S26").</li>
                             <li>A `posicao_grupo` deve ser `Defesa`, `Meio` ou `Ataque`.</li>
                             <li>A an√°lise comparar√° o dado mais recente de um atleta na semana selecionada com todos os seus dados anteriores.</li>
                        </ul>
                    </div>

                    <div class="mt-6 md:mt-0">
                        <h2 class="text-xl font-semibold text-gray-800 mb-3">2. Importe o arquivo e analise</h2>
                        <div class="flex flex-col items-center justify-center w-full">
                             <label for="csvFileInput" class="flex flex-col items-center justify-center w-full h-32 border-2 border-dashed rounded-lg cursor-pointer bg-gray-50 hover:bg-gray-100">
                                <div class="flex flex-col items-center justify-center pt-5 pb-6">
                                    <svg class="w-10 h-10 mb-3 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path></svg>
                                    <p class="mb-2 text-sm text-gray-500"><span class="font-semibold">Clique para carregar</span> ou arraste</p>
                                    <p class="text-xs text-gray-500">Arquivo de Prontid√£o (.CSV)</p>
                                </div>
                                <input id="csvFileInput" type="file" class="hidden" accept=".csv" />
                            </label>
                            <p id="fileName" class="mt-2 text-sm text-gray-500"></p>
                        </div>
                        <button id="processBtn" class="btn mt-4 w-full bg-blue-600 text-white font-semibold py-3 px-6 rounded-lg shadow-md hover:bg-blue-700 transition duration-300 flex items-center justify-center text-lg" disabled>
                            <span id="btnText">Processar e Salvar Prontid√£o</span>
                            <div id="btnLoader" class="loader hidden ml-3"></div>
                        </button>
<button type="button" onclick="carregarFirebaseProntidao()" class="btn mt-2 w-full bg-indigo-600 text-white font-semibold py-3 px-6 rounded-lg shadow-md hover:bg-indigo-700 transition duration-300 flex items-center justify-center text-lg">
  üîÑ Atualizar do Firebase
</button>
                    </div>
                </div>
            </div>
            <div id="resultsSection" class="mt-10 hidden">
                <div id="pdf-content-prontidao">
                    <div id="filterContainerProntidao" class="mb-6"></div>
                    <div id="teamDashboard" class="mb-8"></div>
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-2xl md:text-3xl font-bold text-gray-900">Resultados Individuais de Prontid√£o</h2>
                         <div class="flex gap-x-2">
                             <button id="clearProntidaoDataBtn" class="btn bg-red-100 text-red-700 font-semibold py-2 px-4 rounded-lg hover:bg-red-200 transition flex items-center text-sm">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-2" viewBox="0 0 20 20" fill="currentColor">
                                  <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" />
                                </svg>
                                Limpar Dados de Prontid√£o
                            </button>
                            <button id="exportPdfBtnProntidao" class="btn bg-red-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-red-700 transition flex items-center">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M4 4a2 2 0 012-2h4.586A2 2 0 0112 2.586L15.414 6A2 2 0 0116 7.414V16a2 2 0 01-2 2H6a2 2 0 01-2-2V4zm2 6a1 1 0 011-1h6a1 1 0 110 2H7a1 1 0 01-1-1zm1 3a1 1 0 100 2h6a1 1 0 100-2H7z" clip-rule="evenodd" /></svg>
                                Exportar PDF
                            </button>
                         </div>
                    </div>
                    <div id="resultsContainer" class="bg-white rounded-lg shadow-md border overflow-hidden"></div>
                    <div id="legendsProntidao" class="mt-6 text-xs text-gray-500 grid grid-cols-1 md:grid-cols-3 gap-4"></div>
                </div>
            </div>
            <div id="placeholderSectionProntidao" class="mt-10 text-center py-16 px-6 bg-white rounded-lg shadow-md border">
                <svg xmlns="http://www.w3.org/2000/svg" class="mx-auto h-16 w-16 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" /></svg>
                <h3 class="mt-4 text-xl font-semibold text-gray-800">Aguardando dados de Prontid√£o</h3>
                <p class="mt-1 text-gray-500">Selecione uma equipe ou importe um novo arquivo para come√ßar.</p>
            </div>
        </div>

        <div id="cargaContent" class="hidden">
           <div class="bg-white p-6 md:p-8 rounded-2xl shadow-md border border-gray-200">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8 items-start">
                    <div>
                        <h2 class="text-xl font-semibold text-gray-800 mb-3">1. Prepare seu arquivo de Carga</h2>
                        <p class="text-gray-600 mb-4">O arquivo CSV deve ter as colunas abaixo, incluindo `equipe_id`, `microciclo_id` e a nova coluna `posicao_grupo`.</p>
                        <div class="bg-gray-100 p-4 rounded-lg text-sm text-gray-700 font-mono border">
                            <p><strong class="text-blue-600">equipe_id</strong>,atleta_id,<strong class="text-red-600">posicao_grupo</strong>,data,<strong class="text-blue-600">microciclo_id</strong>,pse_sessao,...</p>
                        </div>
                        <ul class="mt-4 space-y-2 text-gray-600 text-sm list-disc list-inside">
                            <li>O `microciclo_id` deve ser consistente (ex: "Sem25", "S26").</li>
                            <li>Para o c√°lculo do ACWR, forne√ßa dados de pelo menos <strong>4 microciclos</strong> anteriores.</li>
                        </ul>
                    </div>

                    <div class="mt-6 md:mt-0">
                        <h2 class="text-xl font-semibold text-gray-800 mb-3">2. Importe o arquivo e analise</h2>
                         <div class="flex flex-col items-center justify-center w-full">
                             <label for="csvFileInputCarga" class="flex flex-col items-center justify-center w-full h-32 border-2 border-dashed rounded-lg cursor-pointer bg-gray-50 hover:bg-gray-100">
                                <div class="flex flex-col items-center justify-center pt-5 pb-6">
                                    <svg class="w-10 h-10 mb-3 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path></svg>
                                    <p class="mb-2 text-sm text-gray-500"><span class="font-semibold">Clique para carregar</span> ou arraste</p>
                                    <p class="text-xs text-gray-500">Arquivo de Carga (.CSV)</p>
                                </div>
                                <input id="csvFileInputCarga" type="file" class="hidden" accept=".csv" />
                            </label>
                            <p id="fileNameCarga" class="mt-2 text-sm text-gray-500"></p>
                        </div>
                        <button id="processBtnCarga" class="btn mt-4 w-full bg-blue-600 text-white font-semibold py-3 px-6 rounded-lg shadow-md hover:bg-blue-700 transition duration-300 flex items-center justify-center text-lg" disabled>
                            <span id="btnTextCarga">Processar e Salvar Carga</span>
                            <div id="btnLoaderCarga" class="loader hidden ml-3"></div>
                        </button>
<button type="button" onclick="carregarFirebaseCarga()" class="btn mt-2 w-full bg-emerald-600 text-white font-semibold py-3 px-6 rounded-lg shadow-md hover:bg-emerald-700 transition duration-300 flex items-center justify-center text-lg">
  üîÑ Atualizar do Firebase
</button>
                    </div>
                </div>
            </div>
            <div id="resultsSectionCarga" class="mt-10 hidden">
                 <div id="pdf-content-carga">
                    <div id="filterContainer" class="mb-6"></div>
                    <div id="teamDashboardCarga" class="mb-8"></div>
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-2xl md:text-3xl font-bold text-gray-900">Resultados Individuais de Carga</h2>
                         <div class="flex gap-x-2">
                            <button id="clearCargaDataBtn" class="btn bg-red-100 text-red-700 font-semibold py-2 px-4 rounded-lg hover:bg-red-200 transition flex items-center text-sm">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-2" viewBox="0 0 20 20" fill="currentColor">
                                  <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" />
                                </svg>
                                Limpar Dados de Carga
                            </button>
                            <button id="exportPdfBtnCarga" class="btn bg-red-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-red-700 transition flex items-center">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M4 4a2 2 0 012-2h4.586A2 2 0 0112 2.586L15.414 6A2 2 0 0116 7.414V16a2 2 0 01-2 2H6a2 2 0 01-2-2V4zm2 6a1 1 0 011-1h6a1 1 0 110 2H7a1 1 0 01-1-1zm1 3a1 1 0 100 2h6a1 1 0 100-2H7z" clip-rule="evenodd" /></svg>
                                Exportar PDF
                            </button>
                         </div>
                    </div>
                    <div id="resultsContainerCarga" class="bg-white rounded-lg shadow-md border overflow-hidden"></div>
                    <div id="legendsCarga" class="mt-6 text-xs text-gray-500 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4"></div>
                </div>
            </div>
             <div id="placeholderSectionCarga" class="mt-10 text-center py-16 px-6 bg-white rounded-lg shadow-md border">
                <svg xmlns="http://www.w3.org/2000/svg" class="mx-auto h-16 w-16 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" /></svg>
                <h3 class="mt-4 text-xl font-semibold text-gray-800">Aguardando dados de Carga</h3>
                <p class="mt-1 text-gray-500">Selecione uma equipe ou importe um novo arquivo para come√ßar.</p>
            </div>
        </div>

        <div id="planejamentoContent" class="hidden">
            <div id="filterContainerPlanejamento" class="mb-6">
                 </div>
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                <div class="lg:col-span-1 space-y-8">
                    <div class="bg-white p-6 rounded-2xl shadow-md border border-gray-200">
                        <h3 class="text-xl font-bold text-gray-800 mb-4">Cadastrar Treino F√≠sico</h3>
                        <form id="formTreinoFisico" class="space-y-4">
                            <div>
                                <label for="equipeIdFisico" class="block text-sm font-medium text-gray-700 mb-1">ID da Equipe</label>
                                <input type="text" id="equipeIdFisico" class="w-full p-2 border border-gray-300 rounded-md shadow-sm bg-gray-100" readonly>
                            </div>
                            <div>
                                <label for="dataTreinoFisico" class="block text-sm font-medium text-gray-700 mb-1">Data</label>
                                <input type="date" id="dataTreinoFisico" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500" required>
                            </div>
                             <div>
                                <label for="semanaIdFisico" class="block text-sm font-medium text-gray-700 mb-1">ID da Semana (ex: Sem25)</label>
                                <input type="text" id="semanaIdFisico" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                            </div>
                            <div>
                                <label for="objPrincipalFisico" class="block text-sm font-medium text-gray-700 mb-1">Objetivo Principal</label>
                                <select id="objPrincipalFisico" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                                    <option>Neuromuscular</option>
                                    <option>Funcional</option>
                                </select>
                            </div>
                             <div>
                                <label for="objSecundarioFisico" class="block text-sm font-medium text-gray-700 mb-1">Objetivo Secund√°rio (segure Ctrl/Cmd para selecionar v√°rios)</label>
                                <select id="objSecundarioFisico" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500" multiple>
                                    <option>For√ßa Geral</option><option>For√ßa M√°xima</option><option>For√ßa Explosiva</option><option>For√ßa Especial</option><option>Velocidade</option><option>Agilidade</option><option>Resist√™ncia Aer√≥bia</option><option>Resist√™ncia Anaer√≥bia</option><option>Mobilidade</option><option>Flexibilidade</option><option>F√≠sico-T√©cnico</option><option>Recreativo</option><option>Jogo Treino</option><option>Jogo Oficial</option>
                                </select>
                            </div>
                            <div>
                                <label for="localTreinoFisico" class="block text-sm font-medium text-gray-700 mb-1">Local</label>
                                <select id="localTreinoFisico" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                                    <option>Campo</option>
                                    <option>Academia</option>
                                </select>
                            </div>
                            <div>
                                <label for="cargaTreinoFisico" class="block text-sm font-medium text-gray-700 mb-1">Carga</label>
                                <select id="cargaTreinoFisico" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                                    <option value="leve">Leve (0-40%)</option>
                                    <option value="moderada">Moderada (40-70%)</option>
                                    <option value="alta">Alta (70-90%)</option>
                                    <option value="maxima">M√°xima (90-100%)</option>
                                </select>
                            </div>
                            <button type="submit" id="submitTreinoFisico" class="w-full bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-blue-700 transition duration-300" disabled>Adicionar Treino F√≠sico</button>
                        </form>
                    </div>
                    <div class="bg-white p-6 rounded-2xl shadow-md border border-gray-200">
                        <h3 class="text-xl font-bold text-gray-800 mb-4">Cadastrar Treino de Campo</h3>
                        <form id="formTreinoCampo" class="space-y-4">
                           <div>
                                <label for="equipeIdCampo" class="block text-sm font-medium text-gray-700 mb-1">ID da Equipe</label>
                                <input type="text" id="equipeIdCampo" class="w-full p-2 border border-gray-300 rounded-md shadow-sm bg-gray-100" readonly>
                            </div>
                           <div>
                                <label for="dataTreinoCampo" class="block text-sm font-medium text-gray-700 mb-1">Data</label>
                                <input type="date" id="dataTreinoCampo" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500" required>
                            </div>
                             <div>
                                <label for="semanaIdCampo" class="block text-sm font-medium text-gray-700 mb-1">ID da Semana (ex: Sem25)</label>
                                <input type="text" id="semanaIdCampo" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                            </div>
                            <div>
                                <label for="objPrincipalCampo" class="block text-sm font-medium text-gray-700 mb-1">Objetivo Principal</label>
                                <select id="objPrincipalCampo" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                                    <option>T√©cnico</option>
                                    <option>T√°tico</option>
                                    <option>Jogadas Ensaiadas</option>
                                    <option>Recreativo</option>
                                    <option>Jogo Treino</option>
                                    <option>Jogo Oficial</option>
                                </select>
                            </div>
                             <div>
                                <label for="objSecundarioCampo" class="block text-sm font-medium text-gray-700 mb-1">Objetivo Secund√°rio (segure Ctrl/Cmd para selecionar v√°rios)</label>
                                <select id="objSecundarioCampo" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500" multiple>
                                    <option>Fundamentos</option><option>Cruzamentos</option><option>Finaliza√ß√£o</option><option>Posse de Bola</option><option>Posicionamento</option><option>Press√£o</option><option>Apoio</option><option>Sistema Defensivo</option><option>Sistema Ofensivo</option><option>Jogo</option>
                                </select>
                            </div>
                             <div>
                                <label for="campoTreinoCampo" class="block text-sm font-medium text-gray-700 mb-1">Campo</label>
                                <select id="campoTreinoCampo" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                                    <option>Campo Inteiro</option>
                                    <option>Meio-campo</option>
                                    <option>Espa√ßos Reduzidos</option>
                                </select>
                            </div>
                            <div>
                                <label for="cargaTreinoCampo" class="block text-sm font-medium text-gray-700 mb-1">Carga</label>
                                <select id="cargaTreinoCampo" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                                    <option value="leve">Leve (0-40%)</option>
                                    <option value="moderada">Moderada (40-70%)</option>
                                    <option value="alta">Alta (70-90%)</option>
                                    <option value="maxima">M√°xima (90-100%)</option>
                                </select>
                            </div>
                             <button type="submit" id="submitTreinoCampo" class="w-full bg-green-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-green-700 transition duration-300" disabled>Adicionar Treino de Campo</button>
                        </form>
                    </div>
                </div>

                <div class="lg:col-span-2" id="pdf-content-planejamento">
                    </div>
            </div>
        </div>
        
        <div id="lesoesContent" class="hidden">
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                <div class="lg:col-span-1">
                    <div class="bg-white p-6 rounded-2xl shadow-md border border-gray-200">
                        <h3 class="text-xl font-bold text-gray-800 mb-4">Registrar Les√£o</h3>
                        <form id="formLesao" class="space-y-4">
                            <div>
                                <label for="equipeIdLesao" class="block text-sm font-medium text-gray-700 mb-1">ID da Equipe</label>
                                <input type="text" id="equipeIdLesao" class="w-full p-2 border border-gray-300 rounded-md shadow-sm bg-gray-100" readonly>
                            </div>
                            <div>
                                <label for="atletaLesao" class="block text-sm font-medium text-gray-700 mb-1">Atleta</label>
                                <input list="atleta-list-options" type="text" id="atletaLesao" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500" required>
                                <datalist id="atleta-list-options"></datalist>
                            </div>
                            <div>
                                <label for="lesao" class="block text-sm font-medium text-gray-700 mb-1">Les√£o</label>
                                <input type="text" id="lesao" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500" required>
                            </div>
                             <div>
                                <label for="tratamento" class="block text-sm font-medium text-gray-700 mb-1">Tratamento</label>
                                <textarea id="tratamento" rows="3" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500"></textarea>
                            </div>
                            <div>
                                <label for="statusLesao" class="block text-sm font-medium text-gray-700 mb-1">Status</label>
                                <select id="statusLesao" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                                    <option value="nao-liberado">N√£o Liberado para Treinar</option>
                                    <option value="restricoes">Liberado com Restri√ß√µes</option>
                                    <option value="liberado">Liberado</option>
                                </select>
                            </div>
                            <button type="submit" id="submitLesao" class="w-full bg-orange-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-orange-700 transition duration-300" disabled>Registrar Les√£o</button>
                        </form>
                    </div>
                </div>
                <div class="lg:col-span-2">
                     <div class="bg-white p-6 rounded-2xl shadow-md border border-gray-200">
                        <h3 class="text-xl font-bold text-gray-800 mb-4">Atletas Lesionados ou em Transi√ß√£o</h3>
                        <div id="lesoesList" class="space-y-3">
                           </div>
                        <div class="mt-8">
                            <h3 class="text-xl font-bold text-gray-800 mb-4">Hist√≥rico Completo de Les√µes</h3>
                            <div id="lesoesHistoryList" class="bg-white rounded-lg shadow-sm border overflow-x-auto">
                                </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>


    </div>

    <footer class="text-center py-4 text-xs text-gray-400">
        Powered by Ciente - Intelig√™ncia Esportiva
    </footer>

    <div id="toast" class="fixed bottom-5 right-5 bg-red-500 text-white py-3 px-6 rounded-lg shadow-xl opacity-0 transition-all duration-300 transform translate-y-10"></div>
    
    <div id="confirmModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
      <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
        <div class="mt-3 text-center">
          <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-red-100">
            <svg class="h-6 w-6 text-red-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
            </svg>
          </div>
          <h3 id="modalTitle" class="text-lg leading-6 font-medium text-gray-900 mt-2">Remover Treino</h3>
          <div class="mt-2 px-7 py-3">
            <p id="modalText" class="text-sm text-gray-500"></p>
          </div>
          <div class="items-center px-4 py-3">
            <button id="cancelButton" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-md w-full sm:w-auto hover:bg-gray-300">Cancelar</button>
            <button id="confirmButton" class="px-4 py-2 bg-red-500 text-white rounded-md w-full sm:w-auto sm:ml-3 hover:bg-red-600">Confirmar</button>
          </div>
        </div>
      </div>
    </div>


    <script type="module">
        // --- Firebase v9+ modular imports ---
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-app.js";
import { getFirestore, collection, addDoc, onSnapshot, deleteDoc, doc, query, orderBy, serverTimestamp, writeBatch, getDocs, where, updateDoc } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-firestore.js";
import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-auth.js";


// --- FIREBASE SETUP ---
const firebaseConfig = {
    apiKey: "AIzaSyDsoutLk5gmxq5zlu548HWFrox37u1zrxk",
    authDomain: "appintegrado-ciente.firebaseapp.com",
    projectId: "appintegrado-ciente",
    storageBucket: "appintegrado-ciente.appspot.com",
    messagingSenderId: "487559108410",
    appId: "1:487559108410:web:08868011454e609ee52203"
};

// Initialize Firebase and services
let db, auth;
try {
    const app = initializeApp(firebaseConfig);
    db = getFirestore(app);
    auth = getAuth(app);
} catch (e) {
    console.error("Firebase initialization failed. Please check your firebaseConfig.", e);
    showToast("Erro na configura√ß√£o do Firebase. Verifique o console.");
}

// Firebase Collection References
const treinosFisicosCollection = collection(db, 'treinosFisicos');
const treinosCampoCollection = collection(db, 'treinosCampo');
const prontidaoCollection = collection(db, 'prontidao');
const cargaCollection = collection(db, 'carga');
const lesoesCollection = collection(db, 'lesoes');


// --- CONSTANTS AND GLOBAL STATE ---
const METRIC_NAMES = {
    qualidade_sono: 'Qualidade do Sono',
    niveis_stress: 'N√≠veis de Stress',
    fadiga_geral: 'Fadiga Geral',
    dor_muscular: 'Dor Muscular',
    hooper_score: 'Pontua√ß√£o Hooper',
    salto_horizontal_cm: 'Salto Horizontal',
    vfc_rmssd: 'VFC (RMSSD)'
};
const CARGA_PERCENTUAL = {
    leve: 40,
    moderada: 70,
    alta: 90,
    maxima: 100
};
let activeCharts = {};
let fullProntidaoData = [];
let fullCargaData = [];
let lesoesData = [];
let athleteMicrocycleData = {};
let treinosFisicos = [];
let treinosCampo = [];
let currentUser = null;
let latestProntidaoData = null;
let latestCargaData = null;
let selectedPlanningWeeks = [getWeekId(new Date())];
let isInitialLoadComplete = false;
let toastTimeout = null; 
let selectedTeam = 'all';
let selectedAthleteGroup = 'all'; 
let teamLogos = {};

// --- DOM ELEMENTS ---
const globalLoader = document.getElementById('globalLoader');
const loaderText = document.getElementById('loaderText');
const mainContent = document.getElementById('mainContent');
const authStatus = document.getElementById('authStatus');
const teamFilterSelect = document.getElementById('teamFilterSelect'); 
const athleteGroupFilterSelect = document.getElementById('athleteGroupFilterSelect'); 
const tabDashboardBtn = document.getElementById('tabDashboardBtn');
const tabProntidaoBtn = document.getElementById('tabProntidaoBtn');
const tabCargaBtn = document.getElementById('tabCargaBtn');
const tabPlanejamentoBtn = document.getElementById('tabPlanejamentoBtn');
const tabLesoesBtn = document.getElementById('tabLesoesBtn');
const dashboardContent = document.getElementById('dashboardContent');
const prontidaoContent = document.getElementById('prontidaoContent');
const cargaContent = document.getElementById('cargaContent');
const planejamentoContent = document.getElementById('planejamentoContent');
const lesoesContent = document.getElementById('lesoesContent');
const toast = document.getElementById('toast');
const confirmModal = document.getElementById('confirmModal');
// Prontid√£o Elements
const csvFileInput = document.getElementById('csvFileInput');
const fileNameEl = document.getElementById('fileName');
const processBtn = document.getElementById('processBtn');
const btnText = document.getElementById('btnText');
const btnLoader = document.getElementById('btnLoader');
const resultsSection = document.getElementById('resultsSection');
const placeholderSectionProntidao = document.getElementById('placeholderSectionProntidao');
const filterContainerProntidao = document.getElementById('filterContainerProntidao');
const teamDashboard = document.getElementById('teamDashboard');
const resultsContainer = document.getElementById('resultsContainer');
const exportPdfBtnProntidao = document.getElementById('exportPdfBtnProntidao');
const legendsProntidao = document.getElementById('legendsProntidao');
const clearProntidaoDataBtn = document.getElementById('clearProntidaoDataBtn');
// Carga Elements
const csvFileInputCarga = document.getElementById('csvFileInputCarga');
const fileNameCargaEl = document.getElementById('fileNameCarga');
const processBtnCarga = document.getElementById('processBtnCarga');
const btnTextCarga = document.getElementById('btnTextCarga');
const btnLoaderCarga = document.getElementById('btnLoaderCarga');
const resultsSectionCarga = document.getElementById('resultsSectionCarga');
const placeholderSectionCarga = document.getElementById('placeholderSectionCarga');
const filterContainer = document.getElementById('filterContainer');
const teamDashboardCarga = document.getElementById('teamDashboardCarga');
const resultsContainerCarga = document.getElementById('resultsContainerCarga');
const exportPdfBtnCarga = document.getElementById('exportPdfBtnCarga');
const legendsCarga = document.getElementById('legendsCarga');
const clearCargaDataBtn = document.getElementById('clearCargaDataBtn');
// Planejamento Elements
const formTreinoFisico = document.getElementById('formTreinoFisico');
const formTreinoCampo = document.getElementById('formTreinoCampo');
const submitTreinoFisicoBtn = document.getElementById('submitTreinoFisico');
const submitTreinoCampoBtn = document.getElementById('submitTreinoCampo');
const filterContainerPlanejamento = document.getElementById('filterContainerPlanejamento');
const pdfContentPlanejamento = document.getElementById('pdf-content-planejamento');
const equipeIdFisicoInput = document.getElementById('equipeIdFisico');
const equipeIdCampoInput = document.getElementById('equipeIdCampo');
// Les√µes Elements
const formLesao = document.getElementById('formLesao');
const submitLesaoBtn = document.getElementById('submitLesao');
const lesoesList = document.getElementById('lesoesList');
const dashboardLesoes = document.getElementById('dashboardLesoes');
const equipeIdLesaoInput = document.getElementById('equipeIdLesao');
// Dashboard Elements
const dashboardProntidao = document.getElementById('dashboardProntidao');
const dashboardCarga = document.getElementById('dashboardCarga');
const dashboardPlanejamento = document.getElementById('dashboardPlanejamento');
const exportPdfBtnDashboard = document.getElementById('exportPdfBtnDashboard');


// --- SETUP ---
Chart.register(ChartDataLabels);

const readinessZonePlugin = {
    id: 'readinessZonePlugin',
    beforeDraw: (chart) => {
        const { ctx, chartArea: { top, bottom, left, right }, scales: { y } } = chart;
        // ALTERA√á√ÉO: Permite que o plugin funcione em gr√°ficos de linha E de pontos.
        if (!['line', 'scatter'].includes(chart.config.type) || !y || !y.getPixelForValue) return;

        const greenZone = y.getPixelForValue(-0.90);
        const yellowZone = y.getPixelForValue(-2.0);

        ctx.save();
        // Zona Verde (√ìtima)
        ctx.fillStyle = 'rgba(34, 197, 94, 0.1)';
        ctx.fillRect(left, top, right - left, greenZone - top);
        // Zona Amarela (Aten√ß√£o)
        ctx.fillStyle = 'rgba(245, 158, 11, 0.1)';
        ctx.fillRect(left, greenZone, right - left, yellowZone - greenZone);
        // Zona Vermelha (Cr√≠tica)
        ctx.fillStyle = 'rgba(239, 68, 68, 0.1)';
        ctx.fillRect(left, yellowZone, right - left, bottom - yellowZone);
        ctx.restore();
    }
};
Chart.register(readinessZonePlugin);

Chart.defaults.set('plugins.datalabels', {
    color: '#333',
    font: {
        weight: 'bold'
    },
    formatter: (value, context) => value ? (context.dataset.label.includes('%') ? `${value}%` : Math.round(value * 100) / 100) : null
});


// --- AUTHENTICATION & DATA LOADING ---
onAuthStateChanged(auth, (user) => {
    if (user) {
        currentUser = user;
        authStatus.textContent = 'Conectado';
        authStatus.classList.add('text-green-600', 'font-semibold');
        authStatus.classList.remove('text-red-600');
        if (!isInitialLoadComplete) {
           loadInitialData();
        }
    } else {
        currentUser = null;
        authStatus.textContent = 'Offline';
        authStatus.classList.add('text-red-600', 'font-semibold');
        authStatus.classList.remove('text-green-600');
        submitTreinoFisicoBtn.disabled = true;
        submitTreinoCampoBtn.disabled = true;
        submitLesaoBtn.disabled = true;
        loaderText.textContent = "Voc√™ est√° desconectado. Por favor, recarregue a p√°gina.";
        showToast("Voc√™ est√° desconectado. Os dados n√£o ser√£o salvos ou carregados.");
    }
});

signInAnonymously(auth).catch((error) => {
    console.error("Anonymous sign-in failed", error);
    loaderText.textContent = "Falha na autentica√ß√£o. Verifique o console e recarregue.";
    showToast("Falha na autentica√ß√£o. Os dados n√£o ser√£o salvos.");
});

async function loadInitialData() {
    isInitialLoadComplete = true; 
    loaderText.textContent = 'Carregando dados...';
    try {
        const savedLogos = localStorage.getItem('teamLogos');
        if (savedLogos) {
            teamLogos = JSON.parse(savedLogos);
        }
    } catch (e) {
        console.error("Erro ao carregar logos do localStorage", e);
        teamLogos = {};
    }
    try {
        const [prontidaoSnap, cargaSnap, fisicoSnap, campoSnap, lesoesSnap] = await Promise.all([
            getDocs(query(prontidaoCollection, orderBy("data", "desc"))),
            getDocs(query(cargaCollection, orderBy("data", "desc"))),
            getDocs(query(treinosFisicosCollection, orderBy("date", "asc"))),
            getDocs(query(treinosCampoCollection, orderBy("date", "asc"))),
            getDocs(query(lesoesCollection, orderBy("createdAt", "desc"))),
        ]);

        fullProntidaoData = prontidaoSnap.docs.map(doc => ({ ...doc.data(), id: doc.id }));
        fullCargaData = cargaSnap.docs.map(doc => ({ ...doc.data(), id: doc.id }));
        treinosFisicos = fisicoSnap.docs.map(doc => ({ ...doc.data(), id: doc.id }));
        treinosCampo = campoSnap.docs.map(doc => ({ ...doc.data(), id: doc.id }));
        lesoesData = lesoesSnap.docs.map(doc => ({ ...doc.data(), id: doc.id }));
        
        populateTeamFilter(); 
        handleTeamChange();
        renderAllTabs();
        populateAthleteFilterOptions();
        setupLiveListeners(); 

        globalLoader.classList.add('hidden');
        mainContent.classList.remove('hidden');

    } catch (error) {
        console.error("Error loading initial data:", error);
        loaderText.textContent = "Erro ao carregar os dados. Verifique o console.";
        showToast("Erro cr√≠tico ao carregar os dados iniciais.");
    }
}

function setupLiveListeners() {
     onSnapshot(query(treinosFisicosCollection), (snapshot) => {
        treinosFisicos = snapshot.docs.map(doc => ({ ...doc.data(), id: doc.id }));
        if(document.getElementById('planejamentoContent').style.display !== 'none') {
            renderPlanningView();
        }
        updateDashboardView();
    });

    onSnapshot(query(treinosCampoCollection), (snapshot) => {
        treinosCampo = snapshot.docs.map(doc => ({ ...doc.data(), id: doc.id }));
         if(document.getElementById('planejamentoContent').style.display !== 'none') {
            renderPlanningView();
        }
        updateDashboardView();
    });

    onSnapshot(query(prontidaoCollection), (snapshot) => {
    fullProntidaoData = snapshot.docs.map(doc => {
        const d = { ...doc.data(), id: doc.id };

        // üîß Normaliza√ß√£o autom√°tica para evitar campos vazios
        if (!d.equipe_id && d.equipe) d.equipe_id = d.equipe.trim();
        if (!d.equipe_id && d.time) d.equipe_id = d.time.trim();
        if (!d.equipe_id && d.equipe_nome) d.equipe_id = d.equipe_nome.trim();

        if (!d.atleta_id && d.nome_atleta) d.atleta_id = d.nome_atleta.trim();
        if (!d.atleta_id && d.atleta) d.atleta_id = d.atleta.trim();

        if (!d.posicao_grupo && d.posicao) d.posicao_grupo = d.posicao.trim();
        if (!d.data && d.data_treino) d.data = d.data_treino;
        if (!d.semana_id && d.semana) d.semana_id = d.semana;

        return d;
    });

    populateAthleteDatalist();
    populateAthleteFilterOptions();
    if (document.getElementById('prontidaoContent').style.display !== 'none') {
        renderProntidaoTab();
    }
    updateDashboardView();
});
    
    onSnapshot(query(cargaCollection), (snapshot) => {
    fullCargaData = snapshot.docs.map(doc => {
        const d = { ...doc.data(), id: doc.id };
        if (!d.equipe_id && d.equipe) d.equipe_id = d.equipe.trim();
        if (!d.atleta_id && d.nome_atleta) d.atleta_id = d.nome_atleta.trim();
        if (!d.microciclo_id && d.microciclo) d.microciclo_id = d.microciclo;
        return d;
    });

    populateAthleteDatalist();
    if (document.getElementById('cargaContent').style.display !== 'none') {
        renderCargaTab();
    }
    updateDashboardView();
});

    onSnapshot(query(lesoesCollection), (snapshot) => {
        lesoesData = snapshot.docs.map(doc => ({ ...doc.data(), id: doc.id }));
        if(document.getElementById('lesoesContent').style.display !== 'none') {
            renderLesoesTab();
        }
        updateDashboardView();
    });
}


// --- EVENT LISTENERS ---
teamFilterSelect.addEventListener('change', (e) => {
    selectedTeam = e.target.value;
    handleTeamChange();
    renderAllTabs();
    populateAthleteFilterOptions();
});

athleteGroupFilterSelect.addEventListener('change', (e) => {
    selectedAthleteGroup = e.target.value;
    renderAllTabs();
});

function handleTeamChange() {
    const isTeamSelected = selectedTeam !== 'all';

    submitTreinoFisicoBtn.disabled = !isTeamSelected;
    submitTreinoCampoBtn.disabled = !isTeamSelected;
    submitLesaoBtn.disabled = !isTeamSelected;

    const teamIdForInputs = isTeamSelected ? selectedTeam : 'Selecione uma equipe';
    equipeIdLesaoInput.value = teamIdForInputs;
    equipeIdFisicoInput.value = teamIdForInputs;
    equipeIdCampoInput.value = teamIdForInputs;

    renderAllLogos();
}

tabDashboardBtn.addEventListener('click', () => switchTab('dashboard'));
tabProntidaoBtn.addEventListener('click', () => switchTab('prontidao'));
tabCargaBtn.addEventListener('click', () => switchTab('carga'));
tabPlanejamentoBtn.addEventListener('click', () => switchTab('planejamento'));
tabLesoesBtn.addEventListener('click', () => switchTab('lesoes'));

csvFileInput.addEventListener('change', () => handleFileSelect(csvFileInput, fileNameEl, processBtn));
processBtn.addEventListener('click', handleFileProcessing);
exportPdfBtnProntidao.addEventListener('click', () => exportToPDF('prontidao'));
resultsContainer.addEventListener('click', (e) => toggleDetails(e, 'prontidao'));
filterContainerProntidao.addEventListener('change', () => renderProntidaoTab());
clearProntidaoDataBtn.addEventListener('click', clearProntidaoData);

csvFileInputCarga.addEventListener('change', () => handleFileSelect(csvFileInputCarga, fileNameCargaEl, processBtnCarga));
processBtnCarga.addEventListener('click', handleFileProcessingCarga);
exportPdfBtnCarga.addEventListener('click', () => exportToPDF('carga'));
resultsContainerCarga.addEventListener('click', (e) => toggleDetails(e, 'carga'));
filterContainer.addEventListener('change', (e) => {
    if (e.target.classList.contains('microciclo-checkbox')) {
        renderCargaTab();
    }
});
clearCargaDataBtn.addEventListener('click', clearCargaData);

formTreinoFisico.addEventListener('submit', handleFormFisicoSubmit);
formTreinoCampo.addEventListener('submit', handleFormCampoSubmit);
document.getElementById('dataTreinoFisico').addEventListener('change', (e) => {
    const date = e.target.valueAsDate;
    if (date) {
        const timezoneOffset = date.getTimezoneOffset() * 60000;
        const utcDate = new Date(date.getTime() + timezoneOffset);
        document.getElementById('semanaIdFisico').value = getWeekId(utcDate) || '';
    }
});
document.getElementById('dataTreinoCampo').addEventListener('change', (e) => {
    const date = e.target.valueAsDate;
    if (date) {
        const timezoneOffset = date.getTimezoneOffset() * 60000;
        const utcDate = new Date(date.getTime() + timezoneOffset);
        document.getElementById('semanaIdCampo').value = getWeekId(utcDate) || '';
    }
});

formLesao.addEventListener('submit', handleFormLesaoSubmit);

filterContainerPlanejamento.addEventListener('change', (e) => {
     if (e.target.classList.contains('planning-week-checkbox')) {
        const selectedCheckboxes = document.querySelectorAll('.planning-week-checkbox:checked');
        selectedPlanningWeeks = Array.from(selectedCheckboxes).map(cb => cb.value);
        renderPlanningView();
        updateDashboardView();
    }
});

exportPdfBtnDashboard.addEventListener('click', () => exportToPDF('dashboard'));

// --- INITIALIZATION ---
document.getElementById('dataTreinoFisico').valueAsDate = new Date();
document.getElementById('dataTreinoFisico').dispatchEvent(new Event('change'));
document.getElementById('dataTreinoCampo').valueAsDate = new Date();
document.getElementById('dataTreinoCampo').dispatchEvent(new Event('change'));

function renderAllTabs() {
    populateTeamFilter(); 
    populateAthleteDatalist();
    renderProntidaoTab();
    renderCargaTab();
    renderPlanningView();
    renderLesoesTab();
    updateDashboardView();
}

// --- MAIN RENDER FUNCTIONS ---
function renderProntidaoTab() {
    let dataToRender = fullProntidaoData;
    if (selectedTeam !== 'all') {
        dataToRender = dataToRender.filter(d => d.equipe_id === selectedTeam);
    }
    if (selectedAthleteGroup !== 'all') {
        if (['Defesa', 'Meio', 'Ataque'].includes(selectedAthleteGroup)) {
            dataToRender = dataToRender.filter(d => d.posicao_grupo === selectedAthleteGroup);
        } else {
            dataToRender = dataToRender.filter(d => d.atleta_id === selectedAthleteGroup);
        }
    }

    if (dataToRender.length === 0) {
        placeholderSectionProntidao.classList.remove('hidden');
        resultsSection.classList.add('hidden');
        latestProntidaoData = null;
        filterContainerProntidao.innerHTML = '';
    } else {
        renderFilterProntidao(dataToRender); 
        placeholderSectionProntidao.classList.add('hidden');
        resultsSection.classList.remove('hidden');
        
        const selectedCheckboxes = document.querySelectorAll('.week-checkbox:checked');
        let selectedWeeks = Array.from(selectedCheckboxes).map(cb => cb.value);
        
        if(selectedWeeks.length === 0 && document.querySelectorAll('.week-checkbox').length > 0) {
                const lastWeekEl = document.querySelector('.week-checkbox:last-of-type');
                if(lastWeekEl) {
                    lastWeekEl.checked = true;
                    selectedWeeks = [lastWeekEl.value];
                }
        }
        // Se nenhuma semana foi selecionada manualmente, usar todas automaticamente
if (!selectedWeeks || selectedWeeks.length === 0) {
    const allWeeks = [...new Set(fullProntidaoData.map(d => d.semana_id))].filter(Boolean);
    selectedWeeks = sortWeeks(allWeeks);
}

        selectedWeeks = sortWeeks(selectedWeeks);
        
        const filteredDataForWeeks = dataToRender.filter(d => selectedWeeks.includes(d.semana_id));

        if (filteredDataForWeeks.length > 0) {
            displayFilteredProntidaoData(filteredDataForWeeks, selectedWeeks);
        } else {
            teamDashboard.innerHTML = '<p class="text-center text-gray-500">Nenhum dado de prontid√£o para a(s) semana(s) selecionada(s) neste filtro.</p>';
            resultsContainer.innerHTML = '';
            latestProntidaoData = null;
        }
    }
    updateDashboardView();
}

function renderCargaTab() {
    let dataToRender = fullCargaData;
    if (selectedTeam !== 'all') {
        dataToRender = dataToRender.filter(d => d.equipe_id === selectedTeam);
    }
    if (selectedAthleteGroup !== 'all') {
        if (['Defesa', 'Meio', 'Ataque'].includes(selectedAthleteGroup)) {
            dataToRender = dataToRender.filter(d => d.posicao_grupo === selectedAthleteGroup);
        } else {
            dataToRender = dataToRender.filter(d => d.atleta_id === selectedAthleteGroup);
        }
    }

    if (dataToRender.length === 0) {
        placeholderSectionCarga.classList.remove('hidden');
        resultsSectionCarga.classList.add('hidden');
        latestCargaData = null;
        filterContainer.innerHTML = '';
    } else {
        placeholderSectionCarga.classList.add('hidden');
        resultsSectionCarga.classList.remove('hidden');
        
        processAndStoreLoadData(dataToRender); 
        
        const selectedCheckboxes = document.querySelectorAll('.microciclo-checkbox:checked');
        let selectedIds = Array.from(selectedCheckboxes).map(cb => cb.value);
        
        if(selectedIds.length === 0 && document.querySelectorAll('.microciclo-checkbox').length > 0) {
                const lastMcEl = document.querySelector('.microciclo-checkbox:last-of-type');
                if(lastMcEl) {
                    lastMcEl.checked = true;
                    selectedIds = [lastMcEl.value];
                }
        }

        selectedIds = sortWeeks(selectedIds);
        
        if (selectedIds.length > 0) {
            displayFilteredLoadData(selectedIds, dataToRender); 
        } else {
            teamDashboardCarga.innerHTML = '<p class="text-center text-gray-500">Nenhum microciclo selecionado para este filtro.</p>';
            resultsContainerCarga.innerHTML = '';
            latestCargaData = null;
        }
    }
    updateDashboardView();
}

function renderLesoesTab() {
    let todasLesoes = lesoesData;
    
    let atletasDoGrupoFiltrado = [];
    let isGroupOrAthleteFiltered = selectedTeam !== 'all' || selectedAthleteGroup !== 'all';

    if (isGroupOrAthleteFiltered) {
        let baseAtletas = fullProntidaoData;

        if (selectedTeam !== 'all') {
            baseAtletas = baseAtletas.filter(d => d.equipe_id === selectedTeam);
        }

        if (selectedAthleteGroup !== 'all') {
            if (['Defesa', 'Meio', 'Ataque'].includes(selectedAthleteGroup)) {
                baseAtletas = baseAtletas.filter(d => d.posicao_grupo === selectedAthleteGroup);
            } else {
                baseAtletas = baseAtletas.filter(d => d.atleta_id === selectedAthleteGroup);
            }
        }
        
        atletasDoGrupoFiltrado = [...new Set(baseAtletas.map(d => d.atleta_id))];
        todasLesoes = todasLesoes.filter(l => atletasDoGrupoFiltrado.includes(l.atleta));
    }

    // --- 1. Renderiza a lista de ATIVOS (lesionados ou em transi√ß√£o) ---
    const activeLesoes = todasLesoes.filter(l => l.status !== 'liberado');
    if (activeLesoes.length === 0) {
        lesoesList.innerHTML = `<div class="text-center py-10 px-6 bg-gray-50 rounded-lg">
            <svg xmlns="http://www.w3.org/2000/svg" class="mx-auto h-12 w-12 text-green-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
                <path stroke-linecap="round" stroke-linejoin="round" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
            <h3 class="mt-2 text-lg font-medium text-gray-900">Nenhum atleta no departamento m√©dico</h3>
            <p class="mt-1 text-sm text-gray-500">Nenhum atleta deste grupo est√° lesionado ou em transi√ß√£o.</p>
        </div>`;
    } else {
        lesoesList.innerHTML = activeLesoes.map(createLesaoCard).join('');
    }

    // Adiciona os listeners aos bot√µes dos cards de les√µes ativas
    lesoesList.querySelectorAll('.btn-update-lesao').forEach(btn => {
        btn.addEventListener('click', async (e) => {
            const id = e.currentTarget.dataset.id;
            const newStatus = e.currentTarget.dataset.status;
            const atleta = e.currentTarget.dataset.atleta;
            const createdAtStr = e.currentTarget.dataset.createdat; // Captura a data de cria√ß√£o

            const text = newStatus === 'liberado' 
                ? `Tem certeza que deseja marcar a les√£o de ${atleta} como 'Liberado'?`
                : `Tem certeza que deseja remover o registro de les√£o de ${atleta}?`;
            const title = newStatus === 'liberado' ? 'Liberar Atleta' : 'Remover Registro';
            
            showConfirmationModal(text, async () => {
                if (newStatus === 'delete') {
                    await deleteDoc(doc(db, "lesoes", id));
                    showToast(`${atleta} removido dos registros de les√£o.`, 'success');
                } else if (newStatus === 'liberado') {
                    const lesaoRef = doc(db, "lesoes", id);
                    await updateDoc(lesaoRef, { 
                        status: newStatus,
                        liberadoAt: serverTimestamp()
                    });

                    // Calcula a dura√ß√£o e exibe na notifica√ß√£o
                    if (createdAtStr) {
                        const startDate = new Date(createdAtStr);
                        const endDate = new Date(); // Data atual √© a data de libera√ß√£o
                        const diffTime = Math.abs(endDate - startDate);
                        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                        showToast(`${atleta} foi liberado ap√≥s ${diffDays} dias afastado.`, 'success');
                    } else {
                        showToast(`${atleta} foi liberado.`, 'success'); // Mensagem padr√£o caso a data n√£o seja encontrada
                    }
                }
            }, title);
        });
    });

    // --- 2. Renderiza a tabela de HIST√ìRICO COMPLETO ---
    const historyContainer = document.getElementById('lesoesHistoryList');
    if (todasLesoes.length === 0) {
        historyContainer.innerHTML = `<p class="text-center text-gray-500 p-6">Nenhum hist√≥rico de les√£o encontrado para este filtro.</p>`;
    } else {
        const sortedHistory = todasLesoes.sort((a, b) => (b.createdAt?.toMillis() || 0) - (a.createdAt?.toMillis() || 0));
        
        const tableRows = sortedHistory.map(l => {
            const dataRegistro = l.createdAt ? l.createdAt.toDate().toLocaleDateString('pt-BR') : 'N/A';
            let statusClass = '';
            let statusText = '';
            switch(l.status) {
                case 'nao-liberado': statusClass = 'bg-red-100 text-red-800'; statusText = 'N√£o Liberado'; break;
                case 'restricoes': statusClass = 'bg-yellow-100 text-yellow-800'; statusText = 'Com Restri√ß√µes'; break;
                case 'liberado': statusClass = 'bg-green-100 text-green-800'; statusText = 'Liberado'; break;
                default: statusClass = 'bg-gray-100 text-gray-800'; statusText = l.status;
            }

            let diasAfastadoHtml = `<td class="p-3 text-sm text-center text-gray-500">-</td>`;
            if (l.status === 'liberado' && l.createdAt && l.liberadoAt) {
                const startDate = l.createdAt.toDate();
                const endDate = l.liberadoAt.toDate();
                const diffTime = Math.abs(endDate - startDate);
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                diasAfastadoHtml = `<td class="p-3 text-sm text-center font-semibold text-gray-800">${diffDays}</td>`;
            } else if (l.status !== 'liberado' && l.createdAt) {
                const startDate = l.createdAt.toDate();
                const diffTime = Math.abs(new Date() - startDate);
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                diasAfastadoHtml = `<td class="p-3 text-sm text-center text-gray-500 italic">(${diffDays} dias)</td>`;
            }

            return `
                <tr class="border-b last:border-0 hover:bg-gray-50">
                    <td class="p-3 text-sm text-gray-700">${dataRegistro}</td>
                    <td class="p-3 text-sm font-semibold text-gray-900">${l.atleta}</td>
                    <td class="p-3 text-sm text-gray-700">${l.lesao}</td>
                    <td class="p-3 text-sm text-gray-700"><span class="px-2 py-1 text-xs font-semibold rounded-full ${statusClass}">${statusText}</span></td>
                    ${diasAfastadoHtml}
                </tr>
            `;
        }).join('');

        historyContainer.innerHTML = `
            <table class="w-full text-left">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="p-3 text-xs font-semibold text-gray-600 uppercase tracking-wider">Data In√≠cio</th>
                        <th class="p-3 text-xs font-semibold text-gray-600 uppercase tracking-wider">Atleta</th>
                        <th class="p-3 text-xs font-semibold text-gray-600 uppercase tracking-wider">Les√£o</th>
                        <th class="p-3 text-xs font-semibold text-gray-600 uppercase tracking-wider">Status</th>
                        <th class="p-3 text-xs font-semibold text-gray-600 uppercase tracking-wider text-center">Dias Afastado</th>
                    </tr>
                </thead>
                <tbody>
                    ${tableRows}
                </tbody>
            </table>
        `;
    }
}
function updateDashboardView() {
    renderDashboardLesoes();
    renderDashboardProntidao();
    renderDashboardCarga();
    renderDashboardPlanejamento();
}

function renderDashboardLesoes() {
    let lesoesFiltradas = lesoesData;
    if (selectedTeam !== 'all' || selectedAthleteGroup !== 'all') {
         let atletasDoGrupo = [...new Set(fullProntidaoData.map(d => d.atleta_id))];
         if(selectedTeam !== 'all'){
             const atletasDaEquipe = [...new Set(fullProntidaoData.filter(d => d.equipe_id === selectedTeam).map(d => d.atleta_id))];
             atletasDoGrupo = atletasDoGrupo.filter(id => atletasDaEquipe.includes(id));
         }
         if(selectedAthleteGroup !== 'all'){
             if(['Defesa', 'Meio', 'Ataque'].includes(selectedAthleteGroup)){
                 const atletasNaPosicao = [...new Set(fullProntidaoData.filter(d => d.posicao_grupo === selectedAthleteGroup).map(d => d.atleta_id))];
                 atletasDoGrupo = atletasDoGrupo.filter(id => atletasNaPosicao.includes(id));
             } else {
                 atletasDoGrupo = [selectedAthleteGroup];
             }
         }
         lesoesFiltradas = lesoesData.filter(l => atletasDoGrupo.includes(l.atleta));
    }
    
    const activeLesoes = lesoesFiltradas.filter(l => l.status !== 'liberado');
    
    let contentHtml = '';
    if(activeLesoes.length === 0) {
        contentHtml = `<div class="text-center py-4">
            <p class="text-gray-500">Nenhum atleta no departamento m√©dico neste grupo.</p>
        </div>`;
    } else {
        const naoLiberadoHtml = activeLesoes.filter(l => l.status === 'nao-liberado').map(l => 
            `<li class="flex justify-between items-center text-sm py-1"><span class="font-semibold">${l.atleta}</span> <span class="text-red-600">${l.lesao}</span></li>`
        ).join('');

        const restricoesHtml = activeLesoes.filter(l => l.status === 'restricoes').map(l => 
            `<li class="flex justify-between items-center text-sm py-1"><span class="font-semibold">${l.atleta}</span> <span class="text-yellow-600">${l.lesao}</span></li>`
        ).join('');

        contentHtml = `
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <h4 class="font-semibold text-gray-700 text-center mb-2">N√£o Liberados</h4>
                    <ul class="space-y-1 bg-red-50 p-3 rounded-lg border border-red-200">
                        ${naoLiberadoHtml || '<li class="text-xs text-center text-gray-500">Nenhum</li>'}
                    </ul>
                </div>
                <div>
                    <h4 class="font-semibold text-gray-700 text-center mb-2">Treinando com Restri√ß√µes</h4>
                     <ul class="space-y-1 bg-yellow-50 p-3 rounded-lg border border-yellow-200">
                        ${restricoesHtml || '<li class="text-xs text-center text-gray-500">Nenhum</li>'}
                    </ul>
                </div>
            </div>
        `;
    }

    dashboardLesoes.innerHTML = `
        <h2 class="text-2xl font-bold text-gray-900 mb-4 text-center">Departamento M√©dico <span class="text-base font-normal text-gray-500">(${selectedTeam === 'all' ? 'Geral' : selectedTeam})</span></h2>
        ${contentHtml}
    `;
}

function renderDashboardProntidao() {
    if (!latestProntidaoData) {
         dashboardProntidao.innerHTML = `<h2 class="text-2xl font-bold text-gray-900 mb-4 text-center">Resumo da Prontid√£o <span class="text-base font-normal text-gray-500">(${selectedTeam === 'all' ? 'Geral' : selectedTeam})</span></h2><div class="text-center py-10 px-6"><svg xmlns="http://www.w3.org/2000/svg" class="mx-auto h-12 w-12 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg><h3 class="mt-2 text-lg font-medium text-gray-900">Sem dados de prontid√£o</h3><p class="mt-1 text-sm text-gray-500">V√° para a aba 'An√°lise de Prontid√£o' para importar ou selecionar dados.</p></div>`;
         return;
    }

    const selectedCheckboxes = document.querySelectorAll('.week-checkbox:checked');
    const selectedWeeks = sortWeeks(Array.from(selectedCheckboxes).map(cb => cb.value));
    
    if (latestProntidaoData && latestProntidaoData.teamStats) {
        if (selectedWeeks.length > 1 && latestProntidaoData.teamStats.evolutionData.length > 0) {
            dashboardProntidao.innerHTML = renderTeamDashboardProntidaoWithCharts(latestProntidaoData.teamStats, latestProntidaoData.latestDate, true, selectedWeeks.length, 'dashboard-');
            renderTeamIndexChart('dashboard-team-index-chart', latestProntidaoData.teamStats.evolutionData);
            renderTeamHooperChart('dashboard-team-hooper-chart', latestProntidaoData.teamStats.evolutionData);
            renderTeamSaltoChart('dashboard-team-salto-chart', latestProntidaoData.teamStats.evolutionData);
        } else if (selectedWeeks.length === 1 && latestProntidaoData.dailyStats) {
            dashboardProntidao.innerHTML = renderTeamDashboardProntidaoWithDailyCharts(latestProntidaoData.dailyStats, latestProntidaoData.teamStats, selectedWeeks[0], true, 'dashboard-');
            renderTeamDailyIndexChart('dashboard-team-index-chart', latestProntidaoData.dailyStats);
            renderTeamDailyHooperChart('dashboard-team-hooper-chart', latestProntidaoData.dailyStats);
        } else { 
            const overallStats = {
                averageIndex: latestProntidaoData.teamStats.averageIndex,
                averageHooper: latestProntidaoData.teamStats.averageHooper,
                averageSaltoDiff: latestProntidaoData.teamStats.averageSaltoDiff,
                zoneCounts: latestProntidaoData.teamStats.zoneCounts
            };
            dashboardProntidao.innerHTML = renderTeamDashboardProntidaoWithCards(overallStats, latestProntidaoData.latestDate);
        }
    } else {
        dashboardProntidao.innerHTML = `<h2 class="text-2xl font-bold text-gray-900 mb-4 text-center">Resumo da Prontid√£o <span class="text-base font-normal text-gray-500">(${selectedTeam === 'all' ? 'Geral' : selectedTeam})</span></h2><div class="text-center py-10 px-6"><svg xmlns="http://www.w3.org/2000/svg" class="mx-auto h-12 w-12 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg><h3 class="mt-2 text-lg font-medium text-gray-900">Nenhum dado de prontid√£o carregado</h3><p class="mt-1 text-sm text-gray-500">V√° para a aba 'An√°lise de Prontid√£o' para importar um arquivo.</p></div>`;
    }
}

function renderDashboardCarga() {
    if (latestCargaData) {
        dashboardCarga.innerHTML = renderTeamDashboardCarga(latestCargaData, true);
         if (latestCargaData.selectionCount > 1) {
            renderTeamWeeklyLoadChart(latestCargaData.evolutionData, 'dashboard-');
            renderTeamAcwrChart(latestCargaData.evolutionData, 'dashboard-');
            renderTeamStrainChart(latestCargaData.evolutionData, 'dashboard-');
        } else if (latestCargaData) {
            renderTeamDailyLoadChart(latestCargaData.dailyAverages, 'dashboard-');
        }
    } else {
        dashboardCarga.innerHTML = `<h2 class="text-2xl font-bold text-gray-900 mb-4 text-center">Resumo da Carga de Treino <span class="text-base font-normal text-gray-500">(${selectedTeam === 'all' ? 'Geral' : selectedTeam})</span></h2><div class="text-center py-10 px-6"><svg xmlns="http://www.w3.org/2000/svg" class="mx-auto h-12 w-12 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg><h3 class="mt-2 text-lg font-medium text-gray-900">Nenhum dado de carga carregado</h3><p class="mt-1 text-sm text-gray-500">V√° para a aba 'Controle de Carga' para importar um arquivo.</p></div>`;
    }
}

function renderDashboardPlanejamento() {
    const dataForTeamFisico = selectedTeam === 'all' ? treinosFisicos : treinosFisicos.filter(d => d.equipe_id === selectedTeam);
    const dataForTeamCampo = selectedTeam === 'all' ? treinosCampo : treinosCampo.filter(d => d.equipe_id === selectedTeam);

    const trainingsFisico = dataForTeamFisico.filter(t => selectedPlanningWeeks.includes(t.semana_id));
    const trainingsCampo = dataForTeamCampo.filter(t => selectedPlanningWeeks.includes(t.semana_id));
    const totalSessions = trainingsFisico.length + trainingsCampo.length;

    let mainContentHtml;

    if (selectedPlanningWeeks.length === 1) {
        const formatTrainingList = (trainings) => {
            if (trainings.length === 0) {
                return '<li class="text-xs text-gray-400">Nenhum treino na semana.</li>';
            }
            return trainings
                .sort((a, b) => new Date(a.date + 'T00:00:00') - new Date(b.date + 'T00:00:00'))
                .map(t => {
                    const dayOfWeek = new Date(t.date + 'T00:00:00').toLocaleDateString('pt-BR', { weekday: 'short' });
                    const objectives = t.objSecundario && t.objSecundario.length > 0 ? t.objSecundario.join(', ') : 'N/A';
                    return `<li class="text-xs text-gray-700"><strong class="font-semibold">${dayOfWeek.charAt(0).toUpperCase() + dayOfWeek.slice(1)}:</strong> ${objectives}</li>`;
                }).join('');
        };

        const weekTrainingsFisico = formatTrainingList(trainingsFisico);
        const weekTrainingsCampo = formatTrainingList(trainingsCampo);

        const detailsHtml = `
            <div class="mt-4 pt-4 border-t border-gray-200 grid grid-cols-1 sm:grid-cols-2 gap-x-6 gap-y-4">
                <div>
                    <h4 class="font-semibold text-gray-600 text-sm text-center mb-1">Treinos F√≠sicos (${trainingsFisico.length})</h4>
                    <ul class="text-left space-y-1 mb-2 p-2 bg-white rounded-md border">${weekTrainingsFisico}</ul>
                    <div class="h-24"><canvas id="dashboardLoadChartFisico"></canvas></div>
                </div>
                <div>
                    <h4 class="font-semibold text-gray-600 text-sm text-center mb-1">Treinos de Campo (${trainingsCampo.length})</h4>
                    <ul class="text-left space-y-1 mb-2 p-2 bg-white rounded-md border">${weekTrainingsCampo}</ul>
                    <div class="h-24"><canvas id="dashboardLoadChartCampo"></canvas></div>
                </div>
            </div>
        `;

        mainContentHtml = `
            <div class="lg:col-span-2 flex flex-col justify-center bg-gray-50 p-6 rounded-lg">
                 <div class="text-center">
                    <h3 class="font-semibold text-gray-800">Total de Sess√µes na Semana</h3>
                    <p class="text-6xl font-bold text-blue-600 text-center">${totalSessions}</p>
                </div>
                ${detailsHtml}
            </div>
        `;
    } else {
        mainContentHtml = `
            <div class="lg:col-span-1 flex flex-col justify-center items-center bg-gray-50 p-6 rounded-lg min-h-[350px]">
                <h3 class="font-semibold text-gray-800 mb-2 text-center">Total de Sess√µes Planejadas</h3>
                <p class="text-6xl font-bold text-blue-600">${totalSessions}</p>
            </div>
            <div class="lg:col-span-1 grid grid-cols-1 gap-6">
                <div>
                    <div class="h-64 bg-white p-2 rounded-lg border"><canvas id="dashboardObjectiveFisico"></canvas></div>
                </div>
                <div>
                    <div class="h-64 bg-white p-2 rounded-lg border"><canvas id="dashboardObjectiveCampo"></canvas></div>
                </div>
            </div>
        `;
    }

    dashboardPlanejamento.innerHTML = `
        <h2 class="text-2xl font-bold text-gray-900 mb-2 text-center">Resumo do Planejamento <span class="text-base font-normal text-gray-500">(${selectedTeam === 'all' ? 'Geral' : selectedTeam})</span></h2>
        <p class="text-center text-gray-600 mb-4">Semanas selecionadas: ${selectedPlanningWeeks.join(', ')}</p>
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 items-start">
           ${mainContentHtml}
        </div>
        <div class="mt-4 flex justify-center items-center gap-x-3 text-xs text-gray-500">
            <span class="font-semibold">Carga Esperada:</span>
            <span class="flex items-center"><span class="inline-block w-3 h-3 rounded-full bg-blue-500 mr-1 border border-blue-600"></span>Leve</span>
            <span class="flex items-center"><span class="inline-block w-3 h-3 rounded-full bg-yellow-400 mr-1 border border-yellow-500"></span>Moderada</span>
            <span class="flex items-center"><span class="inline-block w-3 h-3 rounded-full bg-orange-500 mr-1 border border-orange-600"></span>Alta</span>
            <span class="flex items-center"><span class="inline-block w-3 h-3 rounded-full bg-red-600 mr-1 border border-red-700"></span>M√°xima</span>
        </div>`;
    
    if (selectedPlanningWeeks.length === 1) {
        renderDailyLoadChart('dashboardLoadChartFisico', trainingsFisico, true);
        renderDailyLoadChart('dashboardLoadChartCampo', trainingsCampo, true);
    } else {
        renderObjectiveDistributionChart('dashboardObjectiveFisico', trainingsFisico, 'Distribui√ß√£o de Objetivos F√≠sicos (%)');
        renderObjectiveDistributionChart('dashboardObjectiveCampo', trainingsCampo, 'Distribui√ß√£o de Objetivos de Campo (%)');
    }
}

function renderObjectiveDistributionChart(canvasId, trainings, title) {
    const ctx = document.getElementById(canvasId);
    if (!ctx) return;
    if (activeCharts[canvasId]) activeCharts[canvasId].destroy();

    const objectiveCounts = trainings.flatMap(t => t.objSecundario || []).reduce((acc, obj) => {
        acc[obj] = (acc[obj] || 0) + 1;
        return acc;
    }, {});

    const totalObjectives = Object.values(objectiveCounts).reduce((sum, count) => sum + count, 0);
    if (totalObjectives === 0) {
        const context = ctx.getContext('2d');
        context.clearRect(0, 0, ctx.width, ctx.height);
        context.font = "16px 'Inter'";
        context.fillStyle = "#6b7280";
        context.textAlign = "center";
        context.fillText("Sem dados para esta sele√ß√£o.", ctx.width / 2, ctx.height / 2);
        return;
    };

    const labels = Object.keys(objectiveCounts);
    const data = labels.map(label => (objectiveCounts[label] / totalObjectives) * 100);

    activeCharts[canvasId] = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [{
                label: '% de Frequ√™ncia',
                data: data,
                backgroundColor: 'rgba(22, 163, 74, 0.7)',
            }]
        },
        options: {
            indexAxis: 'y',
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                x: { beginAtZero: true, max: 100, ticks: { callback: (value) => `${value}%` } },
                y: { grid: { display: false } }
            },
            plugins: {
                legend: { display: false },
                title: { display: true, text: title },
                datalabels: {
                    anchor: 'end', align: 'end',
                    formatter: (value) => `${value.toFixed(1)}%`,
                    color: '#4b5563'
                }
            }
        }
    });
}


// --- GENERAL HELPER FUNCTIONS ---
function showToast(message, type = 'error') {
    if (toastTimeout) {
        clearTimeout(toastTimeout);
    }
    toast.textContent = message;
    toast.className = `fixed bottom-5 right-5 text-white py-3 px-6 rounded-lg shadow-xl opacity-0 transition-all duration-300 transform translate-y-10 ${type === 'success' ? 'bg-green-500' : 'bg-red-500'}`;
    
    setTimeout(() => {
        toast.classList.remove('opacity-0', 'translate-y-10');
        toast.classList.add('opacity-100', 'translate-y-0');
    }, 10);

    toastTimeout = setTimeout(() => {
        toast.classList.remove('opacity-100', 'translate-y-0');
        toast.classList.add('opacity-0', 'translate-y-10');
    }, 5000);
}

function getStats(data) {
    const filteredData = data.filter(d => typeof d === 'number' && !isNaN(d));
    if (filteredData.length === 0) return { mean: NaN, stdDev: 0, sum: 0, count: 0 };
    const sum = filteredData.reduce((a, b) => a + b, 0);
    const mean = sum / filteredData.length;
    const stdDev = Math.sqrt(filteredData.map(x => Math.pow(x - mean, 2)).reduce((a, b) => a + b, 0) / (filteredData.length > 1 ? filteredData.length - 1 : 1));
    return { mean, stdDev, sum, count: filteredData.length };
}

function toggleDetails(event, type) {
    const button = event.target.closest('.toggle-details-btn');
    if (!button) return;
    const targetId = button.dataset.target;
    const detailsSection = document.getElementById(targetId);
    if (!detailsSection) return;

    const isOpen = detailsSection.classList.toggle('open');
    button.querySelector('.arrow-icon').classList.toggle('rotate-180');
    
    if (isOpen) {
        if (type === 'carga' && button.dataset.chartdata) {
            const athleteId = button.dataset.athlete;
            const canvasId = `chart-${athleteId}`;
            const data = JSON.parse(button.dataset.chartdata);
            renderAthleteChart(canvasId, data, 'Carga de Treino Di√°ria (u.a.)');
        }
        if (type === 'prontidao') {
            const uniqueId = targetId.replace('details-prontidao-', '');
            
            if (button.dataset.dailyHistory && button.dataset.dailyHistory.trim() !== '') {
                try {
                    const dailyHistoryData = JSON.parse(button.dataset.dailyHistory);
                    if (dailyHistoryData.hooper && dailyHistoryData.hooper.length > 0) {
                        renderAthleteDailyChart('hooper', `history-daily-hooper-${uniqueId}`, dailyHistoryData.hooper);
                    }
                    if (dailyHistoryData.salto && dailyHistoryData.salto.length > 0) {
                        renderAthleteDailyChart('salto', `history-daily-salto-${uniqueId}`, dailyHistoryData.salto);
                    }
                } catch(e) {
                    console.error("Failed to parse or render daily history chart", e, button.dataset.dailyHistory);
                }
            }
        }
    }
}

async function exportToPDF(type) {
    let pdfButtonId;
    if (type === 'prontidao') {
        pdfButtonId = 'exportPdfBtnProntidao';
    } else {
         pdfButtonId = `exportPdfBtn${type === 'dashboard' ? 'Dashboard' : type.charAt(0).toUpperCase() + type.slice(1)}`;
    }
    
    const pdfButton = document.getElementById(pdfButtonId);
    if (!pdfButton) {
        console.error(`PDF button with id ${pdfButtonId} not found.`);
        return;
    }
    const contentId = `pdf-content-${type}`;
    const fileName = `relatorio_${type}_${selectedTeam}_${new Date().toLocaleDateString('pt-BR').replace(/\//g, '-')}.pdf`;
    const contentToPrint = document.getElementById(contentId);
    if (!contentToPrint) {
        showToast(`Conte√∫do para PDF (id: ${contentId}) n√£o encontrado.`);
        return;
    }

    const originalText = pdfButton.innerHTML;
    pdfButton.innerHTML = `<svg class="animate-spin h-5 w-5 mr-3" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>Exportando...`;
    pdfButton.disabled = true;
    
    if (type !== 'prontidao') {
        const detailsSections = contentToPrint.querySelectorAll('.details-section');
        detailsSections.forEach(el => el.classList.add('open'));
    }

    await new Promise(resolve => setTimeout(resolve, 500)); 

    try {
        const { jsPDF } = window.jspdf;
        const pdf = new jsPDF('p', 'mm', 'a4');
        const canvas = await html2canvas(contentToPrint, { scale: 2, useCORS: true, backgroundColor: '#ffffff' });
        const imgData = canvas.toDataURL('image/jpeg', 0.95);
        
        const pdfWidth = pdf.internal.pageSize.getWidth();
        const pdfHeight = pdf.internal.pageSize.getHeight();
        const imgProps = pdf.getImageProperties(imgData);
        const imgHeight = (imgProps.height * pdfWidth) / imgProps.width;
        
        let heightLeft = imgHeight;
        let position = 0;
        
        pdf.addImage(imgData, 'JPEG', 0, position, pdfWidth, imgHeight);
        heightLeft -= pdfHeight;

        while (heightLeft > 0) {
            position -= pdfHeight;
            pdf.addPage();
            pdf.addImage(imgData, 'JPEG', 0, position, pdfWidth, imgHeight);
            heightLeft -= pdfHeight;
        }
        pdf.save(fileName);
    } catch (error) {
        console.error("Erro ao gerar PDF:", error);
        showToast("Falha ao gerar o PDF.");
    } finally {
        pdfButton.innerHTML = originalText;
        pdfButton.disabled = false;
         if (type !== 'prontidao') {
            const detailsSections = contentToPrint.querySelectorAll('.details-section');
            detailsSections.forEach(el => el.classList.remove('open')); 
        }
    }
}

function switchTab(tab) {
    dashboardContent.classList.toggle('hidden', tab !== 'dashboard');
    prontidaoContent.classList.toggle('hidden', tab !== 'prontidao');
    cargaContent.classList.toggle('hidden', tab !== 'carga');
    planejamentoContent.classList.toggle('hidden', tab !== 'planejamento');
    lesoesContent.classList.toggle('hidden', tab !== 'lesoes');


    tabDashboardBtn.classList.toggle('active', tab === 'dashboard');
    tabProntidaoBtn.classList.toggle('active', tab === 'prontidao');
    tabCargaBtn.classList.toggle('active', tab === 'carga');
    tabPlanejamentoBtn.classList.toggle('active', tab === 'planejamento');
    tabLesoesBtn.classList.toggle('active', tab === 'lesoes');
}

function handleFileSelect(fileInput, fileNameEl, processBtn) {
     if (fileInput.files.length > 0) {
        fileNameEl.textContent = fileInput.files[0].name;
        processBtn.disabled = false;
    } else {
        fileNameEl.textContent = '';
        processBtn.disabled = true;
    }
}

function parseCSV(text, requiredHeaders) {
    const lines = text.trim().replace(/\r/g, '').split('\n');
    if (lines.length < 2) throw new Error("O arquivo CSV est√° vazio ou cont√©m apenas o cabe√ßalho.");

    const firstLine = lines[0];
    const separator = firstLine.includes(';') ? ';' : ',';
    const headers = firstLine.split(separator).map(h => h.trim().toLowerCase()).filter(h => h);
    
    const missingHeaders = requiredHeaders.filter(h => !headers.includes(h));
    if (missingHeaders.length > 0) {
        throw new Error(`Cabe√ßalho inv√°lido. Colunas ausentes: ${missingHeaders.join(', ')}.`);
    }

    return lines.slice(1).map((line, i) => {
        if (line.trim() === '') return null;
        const values = line.split(separator);
        const entry = {};
        headers.forEach((header, index) => {
            if (header) { 
                const value = values[index] ? values[index].trim() : null;
                if (['equipe_id', 'atleta_id', 'data', 'microciclo_id', 'semana_id', 'posicao_grupo'].includes(header)) {
                     if (header === 'data' && value && /^\d{2}\/\d{2}\/\d{4}$/.test(value)) {
                        const parts = value.split('/');
                        entry[header] = `${parts[2]}-${parts[1]}-${parts[0]}`; 
                    } else {
                        entry[header] = value;
                    }
                } else {
                    const sanitizedValue = value ? value.replace(',', '.') : null;
                    entry[header] = sanitizedValue && !isNaN(parseFloat(sanitizedValue)) ? parseFloat(sanitizedValue) : null;
                }
            }
        });
        if (!entry.atleta_id || !entry.data || !entry.equipe_id || (requiredHeaders.includes('microciclo_id') && !entry.microciclo_id) || (requiredHeaders.includes('semana_id') && !entry.semana_id)) {
            console.warn(`Linha ${i + 2} ignorada por falta de dados essenciais (equipe, atleta, data, id da semana/microciclo).`);
            return null;
        };
        return entry;
    }).filter(Boolean);
}

// --- PRONTID√ÉO FUNCTIONS ---
function toggleLoading(isLoading, type = 'prontidao') {
    const textEl = type === 'prontidao' ? btnText : btnTextCarga;
    const loaderEl = type === 'prontidao' ? btnLoader : btnLoaderCarga;
    const buttonEl = type === 'prontidao' ? processBtn : processBtnCarga;
    textEl.classList.toggle('hidden', isLoading);
    loaderEl.classList.toggle('hidden', !isLoading);
    buttonEl.disabled = isLoading;
}

async function saveBatchData(collectionRef, data) {
    // Usa IDs determin√≠sticos para evitar duplicatas ao clicar em "Atualizar do Firebase" v√°rias vezes
    // Chave composta: equipe_id + atleta_id + data + microciclo_id
    const batch = writeBatch(db);
    for (const item of data) {
        const equipe = (item.equipe_id ?? '').toString().trim();
        const atleta = (item.atleta_id ?? '').toString().trim();
        const dataStr = (item.data ?? '').toString().trim(); // j√° vem normalizada (YYYY-MM-DD) pelo parseCSV quando poss√≠vel
        const micro = (item.microciclo_id ?? '').toString().trim();
        const compositeKey = `${equipe}__${atleta}__${dataStr}__${micro}`
            .replace(/[\s/\\.#$\[\]]+/g, '_')  // sanitiza caracteres inv√°lidos do Firestore ID
            .toLowerCase();

        const docRef = doc(collectionRef, compositeKey);
        // merge: true garante atualiza√ß√£o sem duplicar
        batch.set(docRef, item, { merge: true });
    }
    await batch.commit();
}

function clearProntidaoData() {
    showConfirmationModal(
        'Tem certeza que deseja apagar TODOS os dados de Prontid√£o? Esta a√ß√£o n√£o pode ser desfeita.',
        async () => {
            showToast('Limpando dados de prontid√£o...', 'success');
            const snapshot = await getDocs(query(prontidaoCollection));
            const batch = writeBatch(db);
            snapshot.docs.forEach(d => batch.delete(d.ref));
            await batch.commit();
            showToast('Dados de prontid√£o removidos.', 'success');
        }, 'Apagar Dados de Prontid√£o'
    );
}

function clearCargaData() {
    showConfirmationModal(
        'Tem certeza que deseja apagar TODOS os dados de Carga? Esta a√ß√£o n√£o pode ser desfeita.',
        async () => {
            showToast('Limpando dados de carga...', 'success');
            const snapshot = await getDocs(query(cargaCollection));
            const batch = writeBatch(db);
            snapshot.docs.forEach(d => batch.delete(d.ref));
            await batch.commit();
            showToast('Dados de carga removidos.', 'success');
        }, 'Apagar Dados de Carga'
    );
}

function handleFileProcessing() {
    const file = csvFileInput.files[0];
    if (!file) return showToast("Por favor, selecione um arquivo de prontid√£o.");
    toggleLoading(true, 'prontidao');
    const reader = new FileReader();
    reader.onload = async (event) => {
        try {
            const csvText = event.target.result;
            const required = ['equipe_id', 'atleta_id', 'posicao_grupo', 'data', 'semana_id', 'hooper_score'];
            const parsedData = parseCSV(csvText, required);
            await saveBatchData(prontidaoCollection, parsedData);
            showToast(`${parsedData.length} registros de prontid√£o salvos com sucesso!`, 'success');
        } catch (error) {
             console.error("Error during prontidao processing/saving:", error);
             showToast(`Erro: ${error.message}`);
        } finally {
            toggleLoading(false, 'prontidao');
        }
    };
    reader.onerror = () => {
        showToast("Erro ao ler o arquivo.");
        toggleLoading(false, 'prontidao');
    };
    reader.readAsText(file);
}

function getWeekId(date) {
    if (!date) return null;
    let d = date;
     if (typeof date === 'string') {
        d = new Date(date + 'T00:00:00'); 
    } else if (typeof date.getTime !== 'function') {
        d = new Date(date);
    }
    d.setUTCHours(0, 0, 0, 0);
    d.setDate(d.getDate() + 4 - (d.getDay()||7));
    const yearStart = new Date(d.getUTCFullYear(),0,1);
    const weekNo = Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
    return `Sem${String(weekNo).padStart(2, '0')}`;
}

function sortWeeks(arr) {
    return arr.sort((a, b) => {
        const numA = parseInt(a.replace(/[^0-9]/g, ''), 10);
        const numB = parseInt(b.replace(/[^0-9]/g, ''), 10);
        if (isNaN(numA) || isNaN(numB)) {
            return a.localeCompare(b);
        }
        return numA - numB;
    });
}

function renderFilterProntidao(data) {
    const weekIds = sortWeeks([...new Set(data.map(d => d.semana_id).filter(Boolean))]);
    if (weekIds.length === 0) {
        filterContainerProntidao.innerHTML = '';
        return;
    }
    const currentSelection = Array.from(document.querySelectorAll('.week-checkbox:checked')).map(cb => cb.value);
    const latestWeek = weekIds[weekIds.length - 1];
    
    filterContainerProntidao.innerHTML = `
         <div class="bg-white p-4 rounded-lg border shadow-sm">
            <label class="font-semibold text-gray-700 block mb-2">Selecione a(s) Semana(s) para An√°lise de Evolu√ß√£o:</label>
            <div class="grid grid-cols-3 sm:grid-cols-4 md:grid-cols-6 lg:grid-cols-8 gap-2">
                ${weekIds.map(week => `
                    <div class="flex items-center">
                        <input id="week-${week}" type="checkbox" value="${week}" class="week-checkbox h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500" ${currentSelection.length > 0 ? (currentSelection.includes(week) ? 'checked' : '') : (week === latestWeek ? 'checked' : '')}>
                        <label for="week-${week}" class="ml-2 block text-sm text-gray-900">${week}</label>
                    </div>
                `).join('')}
            </div>
        </div>`;
}

function displayFilteredProntidaoData(data, selectedWeeks) {
    const { individualResults, teamStats, latestDate, dailyStats } = analyzeProntidaoData(data, selectedWeeks);
    latestProntidaoData = { teamStats, latestDate, dailyStats };
    renderProntidaoResults(individualResults, teamStats, latestDate, selectedWeeks, dailyStats);
    updateDashboardView();
}

function analyzeProntidaoData(data, selectedWeeks) {
    const athletesData = data.reduce((acc, row) => {
        if (!acc[row.atleta_id]) acc[row.atleta_id] = [];
        acc[row.atleta_id].push(row);
        return acc;
    }, {});

    let latestDateOverall = null;

    const individualResults = Object.keys(athletesData).map(athleteId => {
        const entriesInSelection = athletesData[athleteId];
        if (entriesInSelection.length === 0) return null;

        const latestEntry = entriesInSelection.sort((a, b) => new Date(`${b.data}T00:00:00`) - new Date(`${a.data}T00:00:00`))[0];
        const latestDateInSelection = new Date(`${latestEntry.data}T00:00:00`);

        if (!latestDateOverall || latestDateInSelection > latestDateOverall) {
            latestDateOverall = latestDateInSelection;
        }

        const allHistoricalEntriesForAthlete = fullProntidaoData.filter(d => 
            d.atleta_id === athleteId && new Date(`${d.data}T00:00:00`) < latestDateInSelection
        );

        const result = calculateAthleteReadiness(athleteId, latestEntry, allHistoricalEntriesForAthlete, latestEntry.data);
        
        const dailyHistoryData = { hooper: [], salto: [] };
        entriesInSelection
            .sort((a, b) => new Date(`${a.data}T00:00:00`) - new Date(`${b.data}T00:00:00`))
            .forEach(entry => {
                if (entry.hooper_score != null) {
                    dailyHistoryData.hooper.push({ date: entry.data, value: entry.hooper_score });
                }
                if (entry.salto_horizontal_cm != null) {
                    dailyHistoryData.salto.push({ date: entry.data, value: entry.salto_horizontal_cm });
                }
            });

        if (result) {
            result.dailyHistory = dailyHistoryData;
        }

        return result;

    }).filter(Boolean).sort((a, b) => (a.index ?? Infinity) - (b.index ?? Infinity));
    
    const uniqueWeeksSorted = sortWeeks([...new Set(data.map(d => d.semana_id))]);
    const evolutionData = uniqueWeeksSorted.map(weekId => {
        const dataForThisWeek = data.filter(d => d.semana_id === weekId);
        const athletesInWeek = [...new Set(dataForThisWeek.map(d => d.atleta_id))];
        const resultsForThisWeek = athletesInWeek.map(athleteId => {
            const entriesInWeek = dataForThisWeek.filter(d => d.atleta_id === athleteId);
            if (entriesInWeek.length === 0) return null;
            const latestEntryInWeek = entriesInWeek.sort((a,b) => new Date(`${b.data}T00:00:00`) - new Date(`${a.data}T00:00:00`))[0];
            const historicalEntries = fullProntidaoData.filter(d => d.atleta_id === athleteId && new Date(`${d.data}T00:00:00`) < new Date(`${latestEntryInWeek.data}T00:00:00`));
            return calculateAthleteReadiness(athleteId, latestEntryInWeek, historicalEntries, latestEntryInWeek.data);
        }).filter(Boolean);
        
        const readyAthletesThisWeek = resultsForThisWeek.filter(r => r.status === 'ready');
        return {
            weekId,
            averageIndex: getStats(readyAthletesThisWeek.map(r => parseFloat(r.index))).mean,
            averageHooper: getStats(readyAthletesThisWeek.map(r => r.hooperScore.latest)).mean,
            averageSaltoDiff: getStats(readyAthletesThisWeek.map(r => r.saltoPercentDiff)).mean,
        };
    });

    const readyAthletesOverall = individualResults.filter(r => r.status === 'ready');
    const teamStats = {
        averageIndex: getStats(readyAthletesOverall.map(r => parseFloat(r.index))).mean,
        averageHooper: getStats(readyAthletesOverall.map(r => r.hooperScore.latest)).mean,
        averageSaltoDiff: getStats(readyAthletesOverall.map(r => r.saltoPercentDiff)).mean,
        zoneCounts: individualResults.reduce((acc, r) => {
            acc[r.zone || 'collecting'] = (acc[r.zone || 'collecting'] || 0) + 1;
            return acc;
        }, { green: 0, yellow: 0, red: 0, collecting: 0 }),
        evolutionData
    };
    
    let dailyStats = null;
    if (selectedWeeks.length === 1) {
        const weekData = data.filter(d => d.semana_id === selectedWeeks[0]);
        dailyStats = analyzeDailyProntidao(weekData);
    }
    
    const latestDate = latestDateOverall ? latestDateOverall.toISOString().split('T')[0] : null;
    return { individualResults, teamStats, latestDate, dailyStats };
}

function calculateAthleteReadiness(athleteId, latestEntry, historicalEntries, displayDate) {
    const getZScore = (key, value) => {
        let dataPoints = historicalEntries.map(e => e[key]).filter(v => v != null && !isNaN(v) && v > 0);
        if (dataPoints.length === 0) {
             dataPoints = fullProntidaoData
                .filter(d => d.atleta_id === athleteId && d.data !== displayDate)
                .map(e => e[key]).filter(v => v != null && !isNaN(v) && v > 0);
        }

        if (value == null || dataPoints.length < 2) return 0;
        const { mean, stdDev } = getStats(dataPoints);
        return stdDev === 0 ? 0 : (value - mean) / stdDev;
    };

    const cap = (val) => Math.max(-2.5, Math.min(2.5, val));
    
    const saltoValue = latestEntry['salto_horizontal_cm'];
    const vfcValue = latestEntry['vfc_rmssd'];

    const performanceScores = [
        (saltoValue != null && saltoValue > 0) ? getZScore('salto_horizontal_cm', saltoValue) : null,
        (vfcValue != null && vfcValue > 0) ? getZScore('vfc_rmssd', vfcValue) : null
    ].filter(s => s != null);
    
    let readinessIndex;
    let zone;

    if (performanceScores.length === 0 && latestEntry.hooper_score != null) {
        const hooper = latestEntry.hooper_score;
        if (hooper <= 9) {
            zone = 'green';
        } else if (hooper <= 17) {
            zone = 'yellow';
        } else {
            zone = 'red';
        }
        readinessIndex = null;

    } else {
        const performancePillar = performanceScores.length > 0 ? cap(getStats(performanceScores).mean) : 0;

        let hooperAdjustment = 0;
if (latestEntry.hooper_score != null) {
    const hooper = latestEntry.hooper_score;
    if (hooper < 10) {
        hooperAdjustment = 0.5; // B√¥nus para prontid√£o √≥tima
    } else if (hooper >= 10 && hooper <= 17) {
        hooperAdjustment = -0.50; // Penalidade para prontid√£o regular/aten√ß√£o
    } else if (hooper > 17) {
        hooperAdjustment = -1.0; // Penalidade maior para prontid√£o ruim
    }
}

        readinessIndex = performancePillar + hooperAdjustment;

        // Novos limites para as zonas de prontid√£o
        if (readinessIndex < -1.99) { // De -2.0 em diante √© cr√≠tico
            zone = 'red';
        } else if (readinessIndex < -0.90) { // De -0.90 at√© -1.99 √© aten√ß√£o
            zone = 'yellow';
        } else { // Acima de -0.90 √© √≥timo
            zone = 'green';
        }
    }

    const metricsDetail = Object.keys(METRIC_NAMES).reduce((acc, key) => {
         let dataPoints = historicalEntries.map(e => e[key]).filter(v => v != null && !isNaN(v));
         let mean = getStats(dataPoints).mean;

         if (dataPoints.length === 0) {
             const allOtherEntries = fullProntidaoData
                .filter(d => d.atleta_id === athleteId && d.data !== displayDate)
                .map(e => e[key])
                .filter(v => v != null && !isNaN(v));
            mean = getStats(allOtherEntries).mean;
         }
        acc[key] = { latest: latestEntry[key], mean: mean };
        return acc;
    }, {});
    
    const saltoMeanHistorical = metricsDetail.salto_horizontal_cm?.mean || 0;
    const saltoLatest = latestEntry.salto_horizontal_cm;
    const saltoDiff = (saltoLatest && saltoMeanHistorical > 0) ? ((saltoLatest - saltoMeanHistorical) / saltoMeanHistorical) * 100 : null;

    return { 
        athleteId, status: 'ready', 
        index: readinessIndex !== null ? readinessIndex.toFixed(2) : null, 
        zone, 
        metricsDetail, hooperScore: { latest: latestEntry.hooper_score }, 
        saltoPercentDiff: saltoDiff, latestDate: displayDate 
    };
}

function renderProntidaoResults(individualResults, teamStats, latestDate, selectedWeeks, dailyStats) {
    const selectedWeeksCount = selectedWeeks.length;
    if (selectedWeeksCount === 1 && dailyStats) {
        teamDashboard.innerHTML = renderTeamDashboardProntidaoWithDailyCharts(dailyStats, teamStats, selectedWeeks[0], false);
        renderTeamDailyIndexChart('team-index-chart', dailyStats);
        renderTeamDailyHooperChart('team-hooper-chart', dailyStats);

    } else {
         teamDashboard.innerHTML = renderTeamDashboardProntidaoWithCharts(teamStats, latestDate, false, selectedWeeksCount);
         if (teamStats.evolutionData && teamStats.evolutionData.length > 0) {
            renderTeamIndexChart('team-index-chart', teamStats.evolutionData);
            renderTeamHooperChart('team-hooper-chart', teamStats.evolutionData);
            renderTeamSaltoChart('team-salto-chart', teamStats.evolutionData);
        }
    }

    resultsContainer.innerHTML = `
        <div class="flex items-center p-4 bg-gray-50 border-b font-semibold text-gray-600 text-sm sticky top-0">
            <div class="w-1/3">Atleta (Dado Mais Recente)</div>
            <div class="w-1/6 text-center">√çndice Geral</div>
            <div class="w-1/6 text-center">Zona</div>
            <div class="w-1/6 text-center">Fadiga (Hooper)</div>
            <div class="w-1/6 text-center">Recup. Muscular (%)</div>
            <div class="w-12"></div>
        </div>
        <div>${individualResults.map(createProntidaoResultRow).join('')}</div>`;
    renderLegends('prontidao');
}

function analyzeDailyProntidao(data) {
    const dayNames = ["Dom", "Seg", "Ter", "Qua", "Qui", "Sex", "S√°b"];
    const dailyData = Array.from({length: 7}, () => []);

    data.forEach(row => {
        const dayOfWeek = new Date(row.data + 'T00:00:00').getUTCDay();
        const historicalEntries = fullProntidaoData.filter(d => d.atleta_id === row.atleta_id && new Date(d.data + 'T00:00:00') < new Date(row.data + 'T00:00:00'));
        const readiness = calculateAthleteReadiness(row.atleta_id, row, historicalEntries, row.data);
        if (readiness) {
            dailyData[dayOfWeek].push(readiness);
        }
    });

    return dayNames.map((name, i) => {
        const dayResults = dailyData[i];
        return {
            day: name,
            averageIndex: getStats(dayResults.map(r => parseFloat(r.index))).mean,
            averageHooper: getStats(dayResults.map(r => r.hooperScore.latest)).mean,
            averageSaltoDiff: getStats(dayResults.map(r => r.saltoPercentDiff)).mean
        };
    });
}

function renderTeamDashboardProntidaoWithDailyCharts(dailyStats, teamStats, weekId, isDashboard = false, idPrefix = '') {
     const title = isDashboard ? 'Resumo da Prontid√£o' : 'Painel da Equipe';
     const teamName = selectedTeam === 'all' ? 'Geral' : selectedTeam;
     const dateText = `Resumo Di√°rio (${weekId}) - ${teamName}`;
     const { green = 0, yellow = 0, red = 0 } = teamStats.zoneCounts || {};
     const saltoAvg = teamStats.averageSaltoDiff;
     const saltoTeamClass = saltoAvg >= 0 ? 'text-green-600' : 'text-red-600';

     return `
        <h2 class="text-2xl font-bold text-gray-900 mb-4 text-center">${title} <span class="text-base font-normal text-gray-500">${dateText}</span></h2>
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 items-stretch">
            <div class="bg-white p-3 rounded-lg border shadow-sm">
                <h3 class="font-semibold text-gray-700 text-center mb-2 text-sm">√çndice Geral (Di√°rio)</h3>
                <div class="h-48"><canvas id="${idPrefix}team-index-chart"></canvas></div>
            </div>
            <div class="bg-white p-3 rounded-lg border shadow-sm">
                <h3 class="font-semibold text-gray-700 text-center mb-2 text-sm">Fadiga Hooper (M√©dia Di√°ria)</h3>
                <div class="h-48"><canvas id="${idPrefix}team-hooper-chart"></canvas></div>
            </div>
            <div class="flex flex-col items-center justify-center p-4 bg-gray-50 rounded-lg border shadow-sm">
                <p class="text-sm font-medium text-gray-600 text-center">% Rec. Muscular M√©dia</p>
                <p class="text-5xl font-bold ${saltoTeamClass}">${!isNaN(saltoAvg) ? `${saltoAvg >= 0 ? '+' : ''}${saltoAvg.toFixed(1)}%` : '--'}</p>
            </div>
             <div class="p-4 bg-gray-50 rounded-lg h-full flex flex-col justify-center border shadow-sm">
                <p class="text-sm font-medium text-gray-600 mb-2 text-center">Distribui√ß√£o dos Atletas</p>
                <div class="flex-grow flex items-center justify-around w-full">
                    <div class="text-center">
                        <div class="w-12 h-12 mx-auto rounded-full bg-green-500 flex items-center justify-center text-white font-bold text-xl">${green}</div>
                        <p class="text-xs mt-1">√ìtimo</p>
                    </div>
                    <div class="text-center">
                        <div class="w-12 h-12 mx-auto rounded-full bg-yellow-500 flex items-center justify-center text-white font-bold text-xl">${yellow}</div>
                        <p class="text-xs mt-1">Aten√ß√£o</p>
                    </div>
                    <div class="text-center">
                        <div class="w-12 h-12 mx-auto rounded-full bg-red-500 flex items-center justify-center text-white font-bold text-xl">${red}</div>
                        <p class="text-xs mt-1">Cr√≠tico</p>
                    </div>
                </div>
            </div>
        </div>
        ${isDashboard ? `
        <div class="mt-4 pt-4 border-t border-gray-100">
            <div class="text-xs text-gray-500 bg-gray-50 p-3 rounded-lg">
                <h4 class="font-bold text-sm mb-1 text-gray-700">Legenda: √çndice Geral</h4>
                <p>O <strong>√çndice Geral</strong> √© calculado pela performance (Salto/VFC) e ajustado pela fadiga (Hooper).</p>
                <p class="mt-1"><strong class="text-green-600">> -0.90: √ìtimo</strong> | <strong class="text-yellow-600">-0.90 a -1.99: Aten√ß√£o</strong> | <strong class="text-red-600">< -2.0: Cr√≠tico</strong></p>
            </div>
        </div>
        ` : ''}
        `;
}
function renderTeamDailyIndexChart(canvasId, dailyData) {
    const ctx = document.getElementById(canvasId);
    if (!ctx) return;
    if (activeCharts[canvasId]) activeCharts[canvasId].destroy();

    const labels = dailyData.map(d => d.day);
    const data = dailyData.map(d => d.averageIndex.toFixed(2));

    activeCharts[canvasId] = new Chart(ctx, {
        type: 'line', data: { labels, datasets: [{ label: '√çndice Geral', data, borderColor: 'rgba(59, 130, 246, 1)', backgroundColor: 'rgba(59, 130, 246, 0.2)', fill: true, tension: 0.3 }] },
        options: { responsive: true, maintainAspectRatio: false, scales: { y: { min: -2.5, max: 2.5 } }, plugins: { legend: { display: false }, datalabels: { align: 'top', color: '#374151', font: { size: 10 } } } }
    });
}

function renderTeamDailyHooperChart(canvasId, dailyData) {
    const ctx = document.getElementById(canvasId);
    if (!ctx) return;
    if (activeCharts[canvasId]) activeCharts[canvasId].destroy();

    const labels = dailyData.map(d => d.day);
    const data = dailyData.map(d => d.averageHooper.toFixed(1));
    const backgroundColors = data.map(val => {
        if (val <= 9) return 'rgba(34, 197, 94, 0.7)'; if (val <= 17) return 'rgba(245, 158, 11, 0.7)'; return 'rgba(239, 68, 68, 0.7)';
    });

    activeCharts[canvasId] = new Chart(ctx, {
        type: 'bar', data: { labels, datasets: [{ label: 'Hooper', data, backgroundColor: backgroundColors }] },
        options: { responsive: true, maintainAspectRatio: false, scales: { y: { min: 4, max: 22 } }, plugins: { legend: { display: false }, datalabels: { anchor: 'end', align: 'top', font: { size: 10 } } } }
    });
}

function renderTeamDailySaltoChart(canvasId, dailyData) {
    const ctx = document.getElementById(canvasId);
    if (!ctx) return;
    if (activeCharts[canvasId]) activeCharts[canvasId].destroy();

    const labels = dailyData.map(d => d.day);
    const data = dailyData.map(d => d.averageSaltoDiff.toFixed(1));

    activeCharts[canvasId] = new Chart(ctx, {
        type: 'bar', data: { labels, datasets: [{ label: '% Recupera√ß√£o Muscular', data, backgroundColor: data.map(val => val >= 0 ? 'rgba(34, 197, 94, 0.7)' : 'rgba(239, 68, 68, 0.7)') }] },
        options: { responsive: true, maintainAspectRatio: false, scales: { y: { min: -20, max: 30, ticks: { callback: (value) => value + '%' } } },
            plugins: { legend: { display: false }, datalabels: { font: {size: 10}, formatter: (value) => value + '%', anchor: 'end', align: (context) => context.dataset.data[context.dataIndex] >= 0 ? 'top' : 'bottom', color: (context) => context.dataset.data[context.dataIndex] >= 0 ? '#166534' : '#991b1b' } }
        }
    });
}

function renderTeamDashboardProntidaoWithCards(stats, latestDate) {
     if(!stats) return '';
    const { green, yellow, red } = stats.zoneCounts;
    const hooperTeamClass = getHooperClassification(stats.averageHooper);
    const indexTeamClass = getIndexClassification(stats.averageIndex);
    const saltoTeamClass = stats.averageSaltoDiff >= 0 ? 'text-green-600' : 'text-red-600';
    const formattedDate = latestDate ? new Date(latestDate + 'T00:00:00').toLocaleDateString('pt-BR') : 'N/A';
    const title = 'Resumo da Prontid√£o';
    const teamName = selectedTeam === 'all' ? 'Geral' : selectedTeam;

    return `
            <h2 class="text-2xl font-bold text-gray-900 mb-4 text-center">${title} <span class="text-base font-normal text-gray-500">(${teamName} - ${formattedDate})</span></h2>
            <div class="grid grid-cols-1 md:grid-cols-4 gap-6 items-center">
                <div class="flex flex-col items-center justify-center p-4 bg-gray-50 rounded-lg min-h-[140px]"><p class="text-sm font-medium text-gray-600">√çndice Geral M√©dio</p><p class="text-5xl font-bold ${indexTeamClass.class}">${stats.averageIndex ? stats.averageIndex.toFixed(2) : '--'}</p></div>
                <div class="flex flex-col items-center justify-center p-4 rounded-lg border ${hooperTeamClass.border} ${hooperTeamClass.bg} min-h-[140px]"><p class="text-sm font-medium ${hooperTeamClass.class}">M√©dia de Fadiga (Hooper)</p><p class="text-5xl font-bold ${hooperTeamClass.class}">${stats.averageHooper ? stats.averageHooper.toFixed(1) : '--'}</p></div>
                <div class="flex flex-col items-center justify-center p-4 bg-gray-50 rounded-lg min-h-[140px]"><p class="text-sm font-medium text-gray-600">Recup. Muscular M√©dia</p><p class="text-5xl font-bold ${saltoTeamClass}">${!isNaN(stats.averageSaltoDiff) ? `${stats.averageSaltoDiff >= 0 ? '+' : ''}${stats.averageSaltoDiff.toFixed(1)}%` : '--'}</p></div>
                <div class="p-4 bg-gray-50 rounded-lg h-full flex flex-col min-h-[140px]"><p class="text-sm font-medium text-gray-600 mb-2 text-center">Distribui√ß√£o dos Atletas</p><div class="flex-grow flex items-center justify-around w-full"><div class="text-center"><div class="w-10 h-10 mx-auto rounded-full bg-green-500 flex items-center justify-center text-white font-bold text-lg">${green}</div></div><div class="text-center"><div class="w-10 h-10 mx-auto rounded-full bg-yellow-500 flex items-center justify-center text-white font-bold text-lg">${yellow}</div></div><div class="text-center"><div class="w-10 h-10 mx-auto rounded-full bg-red-500 flex items-center justify-center text-white font-bold text-lg">${red}</div></div></div></div>
            </div>
            <div class="mt-4 pt-4 border-t border-gray-100">
                <div class="text-xs text-gray-500 bg-gray-50 p-3 rounded-lg">
                    <h4 class="font-bold text-sm mb-1 text-gray-700">Legenda: √çndice Geral</h4>
                    <p>O <strong>√çndice Geral</strong> √© calculado pela performance (Salto/VFC) e ajustado pela fadiga (Hooper).</p>
                    <p class="mt-1"><strong class="text-green-600">> -0.90: √ìtimo</strong> | <strong class="text-yellow-600">-0.90 a -1.99: Aten√ß√£o</strong> | <strong class="text-red-600">< -2.0: Cr√≠tico</strong></p>
                </div>
            </div>
            `;
}

function renderTeamDashboardProntidaoWithCharts(stats, latestDate, isForDashboard = false, selectedWeeksCount = 1, idPrefix = '') {
    if (!stats) return '';
    const { green = 0, yellow = 0, red = 0 } = stats.zoneCounts || {};
    const title = isForDashboard ? 'Resumo da Prontid√£o' : 'Painel da Equipe';
    const teamName = selectedTeam === 'all' ? 'Geral' : selectedTeam;

    const dateText = selectedWeeksCount > 1 
        ? `Evolu√ß√£o Semanal - ${teamName}` 
        : `Dados de: ${latestDate ? new Date(latestDate + 'T00:00:00').toLocaleDateString('pt-BR') : 'N/A'} - ${teamName}`;

    return `
        <h2 class="text-2xl font-bold text-gray-900 mb-4 text-center">${title} <span class="text-base font-normal text-gray-500">(${dateText})</span></h2>
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 items-start">
            <div class="lg:col-span-1 bg-white p-3 rounded-lg border shadow-sm min-h-[220px]">
                <h3 class="font-semibold text-gray-700 text-center mb-2 text-sm">√çndice Geral (Semanal)</h3>
                <div class="h-48"><canvas id="${idPrefix}team-index-chart"></canvas></div>
            </div>
            <div class="lg:col-span-1 bg-white p-3 rounded-lg border shadow-sm min-h-[220px]">
                <h3 class="font-semibold text-gray-700 text-center mb-2 text-sm">Fadiga Hooper (M√©dia Semanal)</h3>
                <div class="h-48"><canvas id="${idPrefix}team-hooper-chart"></canvas></div>
            </div>
            <div class="lg:col-span-1 bg-white p-3 rounded-lg border shadow-sm min-h-[220px]">
                <h3 class="font-semibold text-gray-700 text-center mb-2 text-sm">% Rec. Muscular (M√©dia Semanal)</h3>
                <div class="h-48"><canvas id="${idPrefix}team-salto-chart"></canvas></div>
            </div>
            <div class="p-4 bg-gray-50 rounded-lg h-full flex flex-col justify-center min-h-[220px]">
                <p class="text-sm font-medium text-gray-600 mb-2 text-center">Distribui√ß√£o dos Atletas<br><span class="text-xs font-normal">(M√©dia do Per√≠odo)</span></p>
                <div class="flex-grow flex items-center justify-around w-full">
                    <div class="text-center">
                        <div class="w-12 h-12 mx-auto rounded-full bg-green-500 flex items-center justify-center text-white font-bold text-xl">${green}</div>
                        <p class="text-xs mt-1">√ìtimo</p>
                    </div>
                    <div class="text-center">
                        <div class="w-12 h-12 mx-auto rounded-full bg-yellow-500 flex items-center justify-center text-white font-bold text-xl">${yellow}</div>
                        <p class="text-xs mt-1">Aten√ß√£o</p>
                    </div>
                    <div class="text-center">
                        <div class="w-12 h-12 mx-auto rounded-full bg-red-500 flex items-center justify-center text-white font-bold text-xl">${red}</div>
                        <p class="text-xs mt-1">Cr√≠tico</p>
                    </div>
                </div>
            </div>
        </div>
        ${isForDashboard ? `
        <div class="mt-4 pt-4 border-t border-gray-100">
            <div class="text-xs text-gray-500 bg-gray-50 p-3 rounded-lg">
                <h4 class="font-bold text-sm mb-1 text-gray-700">Legenda: √çndice Geral</h4>
                <p>O <strong>√çndice Geral</strong> √© calculado pela performance (Salto/VFC) e ajustado pela fadiga (Hooper).</p>
                <p class="mt-1"><strong class="text-green-600">> -0.90: √ìtimo</strong> | <strong class="text-yellow-600">-0.90 a -1.99: Aten√ß√£o</strong> | <strong class="text-red-600">< -2.0: Cr√≠tico</strong></p>
            </div>
        </div>
        ` : ''}
        `;
}

function createProntidaoResultRow(result) {
    if (!result || !result.latestDate) {
        console.warn("Skipping invalid result row:", result);
        return '';
    }
    if (result.status === 'collecting') {
        return `<div class="flex items-center p-4 border-b last:border-b-0"><div class="w-1/3 font-bold text-gray-800">${result.athleteId}</div><div class="w-2/3 text-gray-500 text-sm">${result.message}</div></div>`;
    }
    let zoneClass, recommendation, statusText;
    if (result.zone === 'green') { zoneClass = 'text-green-600'; statusText = 'Zona √ìtima'; recommendation = "Atleta em bom estado. Treinar conforme o plano."; }
    else if (result.zone === 'yellow') { zoneClass = 'text-yellow-600'; statusText = 'Zona de Aten√ß√£o'; recommendation = "Sinais de alerta. A carga deve ser ajustada."; }
    else { zoneClass = 'text-red-600'; statusText = 'Zona Cr√≠tica'; recommendation = "Risco Elevado. Priorizar recupera√ß√£o ativa."; }

    const hooperScoreValue = result.hooperScore.latest != null ? result.hooperScore.latest.toFixed(1) : '--';
    const hooperClass = getHooperClassification(result.hooperScore.latest);
    const saltoClass = result.saltoPercentDiff == null ? 'text-gray-500' : (result.saltoPercentDiff >= 0 ? 'text-green-600' : 'text-red-600');
    
    const detailsHtml = Object.entries(result.metricsDetail).map(([key, data]) => {
        if (!METRIC_NAMES[key] || data.latest == null) return '';
        const latestValue = (data.latest && !isNaN(data.latest)) ? data.latest.toFixed(1) : 'N/A';
        const meanValue = (data.mean && !isNaN(data.mean)) ? data.mean.toFixed(1) : 'N/A';
        return `<li class="flex justify-between items-center text-sm py-1 border-b"><span class="text-gray-600">${METRIC_NAMES[key]}</span><span class="font-semibold text-gray-800">${latestValue} <span class="text-xs text-gray-500 font-normal">(M√©dia Hist.: ${meanValue})</span></span></li>`;
    }).join('');
    
    const uniqueId = `${result.athleteId}-${result.latestDate.replace(/[^a-zA-Z0-9]/g, "")}`;

    const dailyChartsHtml = (result.dailyHistory && (result.dailyHistory.hooper.length > 0 || result.dailyHistory.salto.length > 0)) ? `
        <div class="mt-4 pt-4 border-t col-span-full grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
                <h5 class="font-semibold text-xs text-center text-gray-600 mb-1">Hooper Di√°rio (na sele√ß√£o)</h5>
                <div class="h-40"><canvas id="history-daily-hooper-${uniqueId}"></canvas></div>
            </div>
             <div>
                <h5 class="font-semibold text-xs text-center text-gray-600 mb-1">Salto Di√°rio (na sele√ß√£o)</h5>
                <div class="h-40"><canvas id="history-daily-salto-${uniqueId}"></canvas></div>
            </div>
        </div>
    ` : '';
    
    const indexDisplay = result.index !== null ? result.index : '<span title="Definido apenas pelo Hooper">--</span>';

    return `<div class="border-b last:border-b-0">
                <div class="flex items-center p-4">
                    <div class="w-1/3 font-bold text-gray-800">${result.athleteId}<span class="ml-2 text-xs font-normal text-gray-500">${new Date(result.latestDate + 'T00:00:00').toLocaleDateString('pt-BR', {day: '2-digit', month: '2-digit'})}</span></div>
                    <div class="w-1/6 text-center font-semibold text-2xl ${zoneClass}">${indexDisplay}</div>
                    <div class="w-1/6 text-center"><span class="px-3 py-1 text-xs font-semibold rounded-full ${zoneClass.replace('text-', 'bg-').replace('-600', '-100')}">${statusText}</span></div>
                    <div class="w-1/6 text-center"><span class="font-bold text-lg ${hooperClass.class}">${hooperScoreValue}</span></div>
                    <div class="w-1/6 text-center font-semibold ${saltoClass}">${result.saltoPercentDiff != null ? `${result.saltoPercentDiff > 0 ? '+' : ''}${result.saltoPercentDiff.toFixed(1)}%` : '--'}</div>
                    <div class="w-12 text-center">
                        <button class="toggle-details-btn p-1 rounded-full hover:bg-gray-200" 
                                data-target="details-prontidao-${uniqueId}" 
                                data-daily-history='${result.dailyHistory ? JSON.stringify(result.dailyHistory) : ''}'>
                            <svg class="arrow-icon w-5 h-5 text-gray-500" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
                        </button>
                    </div>
                </div>
                <div class="details-section bg-gray-50" id="details-prontidao-${uniqueId}">
                    <div class="p-4 grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <h4 class="font-semibold text-sm mb-2">Detalhes (Valor mais recente vs. M√©dia Hist√≥rica):</h4>
                            <ul class="space-y-1">${detailsHtml}</ul>
                        </div>
                        <div class="bg-blue-50 border p-3 rounded-lg self-start">
                            <h4 class="font-semibold text-sm mb-1">Sugest√£o:</h4>
                            <p class="text-sm">${recommendation}</p>
                        </div>
                        ${dailyChartsHtml}
                    </div>
                </div>
            </div>`;
}

function renderTeamIndexChart(canvasId, evolutionData) {
    const ctx = document.getElementById(canvasId);
    if (!ctx) return;
    if (activeCharts[canvasId]) activeCharts[canvasId].destroy();

    // CORRE√á√ÉO 1: Garante que 'y' seja um N√öMERO, n√£o uma string.
    const scatterData = evolutionData.map(d => ({
        x: d.weekId,
        y: parseFloat(d.averageIndex) 
    }));

    activeCharts[canvasId] = new Chart(ctx, {
        type: 'scatter',
        data: {
            datasets: [{
                label: '√çndice Geral',
                data: scatterData,
                backgroundColor: 'rgba(59, 130, 246, 1)',
                pointRadius: 6,
                pointHoverRadius: 8
            }]
        },
        options: {
            responsive: true, maintainAspectRatio: false,
            scales: { 
                y: { 
                    min: -2.5, 
                    max: 2.5 
                },
                x: {
                    type: 'category',
                    ticks: {
                        autoSkip: true,
                        maxRotation: 45,
                        minRotation: 45
                    }
                }
            },
            plugins: { 
                legend: { display: false }, 
                datalabels: { 
                    display: evolutionData.length <= 12,
                    align: 'top', 
                    color: '#374151',
                    // CORRE√á√ÉO 2: Adiciona o 'formatter' para buscar o valor 'y' do ponto.
                    formatter: (value) => {
                        // value aqui √© o objeto {x: 'SemXX', y: -0.55}
                        return value.y.toFixed(2);
                    }
                } 
            }
        }
    });
}

function renderTeamHooperChart(canvasId, evolutionData) {
    const ctx = document.getElementById(canvasId);
    if (!ctx) return;
    if (activeCharts[canvasId]) activeCharts[canvasId].destroy();

    const labels = evolutionData.map(d => d.weekId);
    const data = evolutionData.map(d => d.averageHooper.toFixed(1));
    const backgroundColors = data.map(val => {
        if (val <= 9) return 'rgba(34, 197, 94, 0.7)';
        if (val <= 17) return 'rgba(245, 158, 11, 0.7)';
        return 'rgba(239, 68, 68, 0.7)';
    });

    activeCharts[canvasId] = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [{
                label: 'Hooper',
                data: data,
                backgroundColor: backgroundColors,
            }]
        },
        options: {
            responsive: true, maintainAspectRatio: false,
            // ALTERA√á√ÉO: Eixo Y agora come√ßa em 0.
            scales: { y: { min: 0, max: 28 } },
            plugins: { 
                legend: { display: false }, 
                datalabels: { 
                    display: evolutionData.length <= 12,
                    anchor: 'end', 
                    align: 'top' 
                } 
            }
        }
    });
}

function renderTeamSaltoChart(canvasId, evolutionData) {
    const ctx = document.getElementById(canvasId);
    if (!ctx) return;
    if (activeCharts[canvasId]) activeCharts[canvasId].destroy();
    
    // Formata os dados para o gr√°fico de dispers√£o e define a cor de cada ponto
    const scatterData = evolutionData.map(d => ({
        x: d.weekId,
        y: parseFloat(d.averageSaltoDiff).toFixed(1)
    }));
    
    const pointColors = scatterData.map(point => point.y >= 0 ? 'rgba(34, 197, 94, 1)' : 'rgba(239, 68, 68, 1)');

    activeCharts[canvasId] = new Chart(ctx, {
        type: 'scatter', // <-- TIPO DE GR√ÅFICO ALTERADO
        data: {
            datasets: [{
                label: '% Recupera√ß√£o Muscular',
                data: scatterData, // <-- USA OS DADOS FORMATADOS
                backgroundColor: pointColors, // <-- USA A LISTA DE CORES
                pointRadius: 6,
                pointHoverRadius: 8
            }]
        },
        options: {
            responsive: true, maintainAspectRatio: false,
            scales: {
                y: {
                    min: -20, max: 30,
                    ticks: { callback: (value) => value + '%' }
                },
                x: {
                    type: 'category',
                    ticks: {
                        autoSkip: true,
                        maxRotation: 45,
                        minRotation: 45
                    }
                }
            },
            plugins: {
                legend: { display: false },
                datalabels: {
                    display: evolutionData.length <= 12,
                    formatter: (value) => value.y + '%', // Ajusta o formatter para ler o valor y do ponto
                    align: (context) => context.dataset.data[context.dataIndex].y >= 0 ? 'top' : 'bottom',
                    color: (context) => context.dataset.data[context.dataIndex].y >= 0 ? '#166534' : '#991b1b'
                }
            }
        }
    });
}

function renderAthleteDailyChart(type, canvasId, data) {
    const ctx = document.getElementById(canvasId);
    if (!ctx || !data || data.length === 0) {
         if(ctx) {
            const context = ctx.getContext('2d');
            context.clearRect(0, 0, ctx.width, ctx.height);
            context.font = "14px 'Inter'";
            context.fillStyle = "#9ca3af";
            context.textAlign = "center";
            context.fillText("Sem dados di√°rios.", ctx.width / 2, ctx.height / 2);
         }
        return;
    };

    if (activeCharts[canvasId]) activeCharts[canvasId].destroy();

    const labels = data.map(d => new Date(d.date + 'T00:00:00').toLocaleDateString('pt-BR', {day: '2-digit', month: '2-digit'}));
    const values = data.map(d => d.value ? d.value.toFixed(type === 'salto' ? 1 : 0) : 0);

    let chartOptions = {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [{ data: values }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: { beginAtZero: false },
                x: { ticks: { font: { size: 10 } } }
            },
            plugins: {
                legend: { display: false },
                datalabels: {
                    display: data.length < 15,
                    anchor: 'end',
                    align: 'top',
                    font: { size: 10 }
                }
            }
        }
    };

    if (type === 'hooper') {
        chartOptions.data.datasets[0].backgroundColor = values.map(val => {
            if (val <= 9) return 'rgba(34, 197, 94, 0.7)';
            if (val <= 17) return 'rgba(245, 158, 11, 0.7)';
            return 'rgba(239, 68, 68, 0.7)';
        });
        chartOptions.options.scales.y.min = 0;
        chartOptions.options.scales.y.max = 20;
        chartOptions.data.datasets[0].label = 'Hooper Score';
    } else { 
        chartOptions.data.datasets[0].backgroundColor = 'rgba(59, 130, 246, 0.7)';
        chartOptions.options.scales.y.min = 200;
        chartOptions.options.scales.y.max = 320;
        chartOptions.data.datasets[0].label = 'Salto (cm)';
    }

    activeCharts[canvasId] = new Chart(ctx, chartOptions);
}


// --- CARGA DE TREINO FUNCTIONS ---
function handleFileProcessingCarga() {
    const file = csvFileInputCarga.files[0];
    if (!file) return showToast("Por favor, selecione um arquivo de carga.");
    toggleLoading(true, 'carga');
    const reader = new FileReader();
    reader.onload = async (event) => {
        try {
            const required = ['equipe_id', 'atleta_id', 'posicao_grupo', 'data', 'microciclo_id', 'pse_sessao', 'duracao_sessao_min'];
            const parsedData = parseCSV(event.target.result, required);
            await saveBatchData(cargaCollection, parsedData);
            showToast(`${parsedData.length} registros de carga salvos com sucesso!`, 'success');
        } catch (error) {
             console.error("Error during carga processing/saving:", error);
             showToast(`Erro na an√°lise: ${error.message}`);
        } finally {
            toggleLoading(false, 'carga');
        }
    };
    reader.onerror = () => {
        showToast("Erro ao ler o arquivo.");
        toggleLoading(false, 'carga');
    };
    reader.readAsText(file);
}

function processAndStoreLoadData(dataToProcess) {
    const dataByAthlete = dataToProcess.reduce((acc, row) => {
        if (!acc[row.atleta_id]) acc[row.atleta_id] = [];
        acc[row.atleta_id].push(row);
        return acc;
    }, {});

    let allMicrocyclesForTeam = new Set();
    Object.values(dataByAthlete).flat().forEach(row => {
        if(row.microciclo_id) allMicrocyclesForTeam.add(row.microciclo_id);
    });
    
    athleteMicrocycleData = {};

    for (const athleteId in dataByAthlete) {
        // AJUSTE 1: Coleta de todo o hist√≥rico de dados do atleta para o c√°lculo do desvio padr√£o.
        const allAthleteData = fullCargaData.filter(d => d.atleta_id === athleteId);
        const allDailyLoads = allAthleteData.map(e => (e.pse_sessao || 0) * (e.duracao_sessao_min || 0));
        const historicalStdDevForAthlete = getStats(allDailyLoads).stdDev;

        const microcycles = allAthleteData.reduce((acc, row) => {
            if (!row.microciclo_id) return acc;
            if (!acc[row.microciclo_id]) acc[row.microciclo_id] = { entries: [], minDate: row.data };
            acc[row.microciclo_id].entries.push(row);
            if (new Date(`${row.data}T00:00:00`) < new Date(`${acc[row.microciclo_id].minDate}T00:00:00`)) {
                acc[row.microciclo_id].minDate = row.data;
            }
            return acc;
        }, {});

        athleteMicrocycleData[athleteId] = Object.entries(microcycles)
            .sort(([, a], [, b]) => new Date(`${a.minDate}T00:00:00`) - new Date(`${b.minDate}T00:00:00`))
            .map(([id, cycleData]) => {
                const dailyEntries = cycleData.entries.map(e => ({
                    date: e.data,
                    load: (e.pse_sessao || 0) * (e.duracao_sessao_min || 0)
                }));
                
                // M√©dia e soma s√£o calculadas apenas para o microciclo atual.
                const loadStats = getStats(dailyEntries.map(e => e.load));
                
                // AJUSTE 2: C√°lculo da monotonia usando a m√©dia da semana e o desvio padr√£o hist√≥rico.
                let monotony = 0;
                if (loadStats.mean > 0 && historicalStdDevForAthlete > 0) {
                    monotony = loadStats.mean / historicalStdDevForAthlete;
                } else if (loadStats.mean > 0 && (historicalStdDevForAthlete === 0 || isNaN(historicalStdDevForAthlete)) && loadStats.count > 1) {
                    // Fallback para quando a varia√ß√£o hist√≥rica √© zero, mas h√° carga na semana atual.
                    // Isso indica uma mudan√ßa de um estado constante, ent√£o uma monotonia alta √© l√≥gica.
                    monotony = 10; 
                }

                return {
                    microciclo_id: id,
                    totalLoad: loadStats.sum, 
                    monotony: monotony,
                    // O c√°lculo do Strain √© corrigido automaticamente, pois agora usa a monotonia correta.
                    strain: loadStats.sum * monotony,
                    dailyEntries: dailyEntries
                };
            });
    }

    const sortedMicrocycles = sortWeeks([...allMicrocyclesForTeam]);
    renderFilter(sortedMicrocycles);
}
function renderFilter(microcycles) {
    if (microcycles.length === 0) {
        filterContainer.innerHTML = '';
        return;
    }
    const currentSelection = Array.from(document.querySelectorAll('.microciclo-checkbox:checked')).map(cb => cb.value);
    const latestMicrocycle = microcycles[microcycles.length -1];
    filterContainer.innerHTML = `
        <div class="bg-white p-4 rounded-lg border shadow-sm">
            <label class="font-semibold text-gray-700 block mb-2">Selecione o(s) Microciclo(s):</label>
            <div class="grid grid-cols-3 sm:grid-cols-4 md:grid-cols-6 lg:grid-cols-8 gap-2">
                ${microcycles.map(mc => `
                    <div class="flex items-center">
                        <input id="mc-${mc}" type="checkbox" value="${mc}" class="microciclo-checkbox h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500" ${currentSelection.length > 0 ? (currentSelection.includes(mc) ? 'checked' : '') : (mc === latestMicrocycle ? 'checked' : '')}>
                        <label for="mc-${mc}" class="ml-2 block text-sm text-gray-900">${mc}</label>
                    </div>
                `).join('')}
            </div>
        </div>`;
}

function displayFilteredLoadData(selectedIds, dataForTeam) {
    if (!selectedIds || selectedIds.length === 0) return;
    
    const individualResults = [];
    let allEntriesInCycles = [];
    let weeklyTeamData = [];
    const sortedSelectedIds = sortWeeks([...selectedIds]);
    
    const athletesInTeam = [...new Set(dataForTeam.map(d => d.atleta_id))];

    athletesInTeam.forEach(athleteId => {
         if (!athleteMicrocycleData[athleteId]) return;

        const allAthleteCycles = athleteMicrocycleData[athleteId];
        
        sortedSelectedIds.forEach(mc_id => {
            const cycleIndex = allAthleteCycles.findIndex(c => c.microciclo_id === mc_id);
            if (cycleIndex !== -1) {
                const cycle = allAthleteCycles[cycleIndex];
                const acuteLoad = cycle.totalLoad;
                const chronicCycles = allAthleteCycles.slice(Math.max(0, cycleIndex - 3), cycleIndex + 1);
                const chronicLoad = getStats(chronicCycles.map(c => c.totalLoad)).mean;
                const acwr = chronicLoad > 0 ? acuteLoad / chronicLoad : null;

                if (selectedIds.length > 1) {
                    weeklyTeamData.push({ microciclo_id: mc_id, totalLoad: cycle.totalLoad, strain: cycle.strain, acwr: acwr });
                }
            }
        });
        
        const selectedCycles = allAthleteCycles.filter(c => selectedIds.includes(c.microciclo_id));
        if(selectedCycles.length === 0) return;
        
        const avgMonotony = getStats(selectedCycles.map(c => c.monotony)).mean;
        const avgStrain = getStats(selectedCycles.map(c => c.strain)).mean;
        
        const aggregatedDailyEntries = selectedCycles.flatMap(c => c.dailyEntries);
        
        const lastSelectedCycleId = sortedSelectedIds[sortedSelectedIds.length - 1];
        const lastCycleIndex = allAthleteCycles.findIndex(c => c.microciclo_id === lastSelectedCycleId);
        
        let acwrForTable = null;
        let hasEnoughDataForAcwr = false;
        let totalLoadForTable = null; // Vari√°vel para a carga da √∫ltima semana

        if (lastCycleIndex > -1) {
            const lastCycleData = allAthleteCycles[lastCycleIndex];
            totalLoadForTable = lastCycleData.totalLoad; // Pega a carga total da √∫ltima semana selecionada

            const acuteLoad = lastCycleData.totalLoad;
            const chronicCycles = allAthleteCycles.slice(Math.max(0, lastCycleIndex - 3), lastCycleIndex + 1);
            const chronicLoad = getStats(chronicCycles.map(c => c.totalLoad)).mean;
            
            if (chronicLoad > 0) {
                acwrForTable = acuteLoad / chronicLoad;
            }
            hasEnoughDataForAcwr = chronicCycles.length >= 4;
        }
        
        individualResults.push({
            athleteId,
            totalLoad: totalLoadForTable, // Usa o novo valor espec√≠fico para a tabela
            monotony: avgMonotony,
            strain: avgStrain, 
            acwr: acwrForTable,
            hasEnoughDataForAcwr,
            chartData: {
                labels: aggregatedDailyEntries.sort((a,b) => new Date(`${a.date}T00:00:00`) - new Date(`${b.date}T00:00:00`)).map(e => new Date(`${e.date}T00:00:00`).toLocaleDateString('pt-BR', {day: '2-digit', month: '2-digit'})),
                loads: aggregatedDailyEntries.sort((a,b) => new Date(`${a.date}T00:00:00`) - new Date(`${b.date}T00:00:00`)).map(e => e.load)
            }
        });
        allEntriesInCycles.push(...aggregatedDailyEntries);
    });

    const loadsByDayOfWeek = allEntriesInCycles.reduce((acc, entry) => {
        const dayOfWeek = new Date(`${entry.date}T00:00:00`).getUTCDay();
        if (!acc[dayOfWeek]) acc[dayOfWeek] = [];
        acc[dayOfWeek].push(entry.load);
        return acc;
    }, {});
    const dailyAverages = [0,1,2,3,4,5,6].map(day => getStats(loadsByDayOfWeek[day] || []).mean);

    const evolutionData = sortedSelectedIds.map(mc_id => {
        const weekData = weeklyTeamData.filter(d => d.microciclo_id === mc_id);
        return {
            microciclo_id: mc_id,
            totalLoad: getStats(weekData.map(d=>d.totalLoad)).mean,
            strain: getStats(weekData.map(d=>d.strain)).mean,
            acwr: getStats(weekData.filter(d=>d.acwr != null).map(d=>d.acwr)).mean
        };
    });
    const teamStats = {
        avgAcwr: getStats(individualResults.filter(r => r.acwr != null).map(r => r.acwr)).mean,
        avgStrain: getStats(individualResults.map(r => r.strain)).mean,
        dailyAverages: dailyAverages, evolutionData: evolutionData,
        selectionCount: selectedIds.length, microcicloId: sortedSelectedIds.join(', ')
    };
    
    latestCargaData = teamStats;
    updateDashboardView();
    individualResults.sort((a, b) => (b.acwr ?? -1) - (a.acwr ?? -1));

    teamDashboardCarga.innerHTML = renderTeamDashboardCarga(teamStats);
    renderLoadTable(individualResults);
    renderLegends('carga');

    if (teamStats.selectionCount > 1) {
        renderTeamWeeklyLoadChart(teamStats.evolutionData);
        renderTeamAcwrChart(teamStats.evolutionData);
        renderTeamStrainChart(teamStats.evolutionData);
    } else {
         renderTeamDailyLoadChart(teamStats.dailyAverages);
    }
}
function renderTeamDashboardCarga(stats, isForDashboard = false) {
     if(!stats) return '';
    const avgAcwr = stats.avgAcwr ? stats.avgAcwr.toFixed(2) : '--';
    const avgStrain = stats.avgStrain ? Math.round(stats.avgStrain) : '--';
    const title = isForDashboard ? 'Resumo da Carga de Treino' : 'Painel da Equipe';
    const prefix = isForDashboard ? 'dashboard-' : '';
    const teamName = selectedTeam === 'all' ? 'Geral' : selectedTeam;

    let chartsHtml = '';
    if (stats.selectionCount > 1) {
         chartsHtml = `<div class="md:col-span-1 flex flex-col items-center justify-center p-4 bg-gray-50 rounded-lg min-h-[160px]"><p class="text-sm font-medium text-gray-600 mb-2">Carga Aguda por Semana</p><div class="w-full h-28"><canvas id="${prefix}team-weekly-load-chart"></canvas></div></div><div class="md:col-span-1 flex flex-col items-center justify-center p-4 bg-gray-50 rounded-lg min-h-[160px]"><p class="text-sm font-medium text-gray-600 mb-2">ACWR por Semana</p><div class="w-full h-28"><canvas id="${prefix}team-acwr-chart"></canvas></div></div><div class="md:col-span-1 flex flex-col items-center justify-center p-4 bg-gray-50 rounded-lg min-h-[160px]"><p class="text-sm font-medium text-gray-600 mb-2">Strain por Semana</p><div class="w-full h-28"><canvas id="${prefix}team-strain-chart"></canvas></div></div>`;
    } else {
        chartsHtml = `<div class="md:col-span-1 flex flex-col items-center justify-center p-4 bg-gray-50 rounded-lg min-h-[140px]"><p class="text-sm font-medium text-gray-600 mb-2">M√©dia Di√°ria de Carga</p><div class="w-full h-24"><canvas id="${prefix}team-daily-chart"></canvas></div></div><div class="md:col-span-1 flex flex-col items-center justify-center p-4 bg-gray-50 rounded-lg min-h-[140px]"><p class="text-sm font-medium text-gray-600">ACWR M√©dio</p><p class="text-5xl font-bold ${getAwcrClassification(stats.avgAcwr).class}">${avgAcwr}</p></div><div class="md:col-span-1 flex flex-col items-center justify-center p-4 bg-gray-50 rounded-lg min-h-[140px]"><p class="text-sm font-medium text-gray-600">Strain M√©dio</p><p class="text-5xl font-bold ${getStrainClassification(stats.avgStrain).class}">${avgStrain}</p></div>`;
    }

    return `<h2 class="text-2xl font-bold text-gray-900 mb-4 text-center">${title} <span class="text-base font-normal text-gray-500">(${teamName} - ${stats.microcicloId})</span></h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">${chartsHtml}</div>
            <div class="mt-4 flex flex-wrap justify-center items-center gap-x-4 gap-y-1 text-xs text-gray-500">
                 <span><strong class="text-green-600">ACWR Ideal:</strong> 0.8-1.3</span>
                 <span><strong class="text-yellow-600">Aten√ß√£o:</strong> &lt;0.8 ou 1.3-1.5</span>
                 <span><strong class="text-red-600">Perigo:</strong> >1.5</span>
            </div>`;
}

function renderTeamDailyLoadChart(dailyData, prefix = '') {
    const canvasId = `${prefix}team-daily-chart`;
    const ctx = document.getElementById(canvasId);
    if (!ctx) return;
    if (activeCharts[canvasId]) activeCharts[canvasId].destroy();

    const labels = ['Dom', 'Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'S√°b'];
    const data = labels.map((_, i) => dailyData[i] || 0);
    const backgroundColors = data.map(load => getCargaAgudaChartColor(load));

    activeCharts[canvasId] = new Chart(ctx, {
        type: 'bar', data: { labels, datasets: [{ label: 'M√©dia Di√°ria', data, backgroundColor: backgroundColors }] },
        options: { maintainAspectRatio: false, scales: { y: { display: false, beginAtZero: true, min: 0, max: 1000 }, x: { grid: { display: false } } }, plugins: { legend: { display: false }, datalabels: { anchor: 'center', align: 'center', color: 'white', formatter: (v) => v > 0 ? Math.round(v) : null } } }
    });
}

function renderTeamWeeklyLoadChart(evolutionData, prefix = '') {
    const canvasId = `${prefix}team-weekly-load-chart`;
    const ctx = document.getElementById(canvasId);
    if (!ctx) return;
    if (activeCharts[canvasId]) activeCharts[canvasId].destroy();

    const labels = evolutionData.map(d => d.microciclo_id);
    const data = evolutionData.map(d => d.totalLoad);
    const backgroundColors = data.map(load => getCargaAgudaChartColor(load));

    activeCharts[canvasId] = new Chart(ctx, {
        type: 'bar', data: { labels, datasets: [{ label: 'Carga Semanal', data, backgroundColor: backgroundColors }] },
        options: { maintainAspectRatio: false, scales: { y: { display: true, beginAtZero: true, min: 0, max: 5000 }, x: { grid: { display: false } } }, plugins: { legend: { display: false }, datalabels: { display: evolutionData.length <= 12, anchor: 'center', align: 'center', color: 'white', formatter: (v) => v > 0 ? Math.round(v) : null } } }
    });
}
function renderTeamAcwrChart(evolutionData, prefix = '') {
    const canvasId = `${prefix}team-acwr-chart`;
    const ctx = document.getElementById(canvasId);
    if (!ctx) return;
    if (activeCharts[canvasId]) activeCharts[canvasId].destroy();

    activeCharts[canvasId] = new Chart(ctx, {
        type: 'line', data: { labels: evolutionData.map(d => d.microciclo_id), datasets: [{ label: 'ACWR', data: evolutionData.map(d => d.acwr), borderColor: 'rgb(234, 179, 8)', fill: false, tension: 0.1 }] },
        options: { maintainAspectRatio: false, scales: { y: { beginAtZero: true, min: 0, max: 2 }, x: { grid: { display: false } } }, plugins: { legend: { display: false }, datalabels: { display: evolutionData.length <= 12, align: 'top' } } }
    });
}

function renderTeamStrainChart(evolutionData, prefix = '') {
    const canvasId = `${prefix}team-strain-chart`;
    const ctx = document.getElementById(canvasId);
    if (!ctx) return;
    if (activeCharts[canvasId]) activeCharts[canvasId].destroy();

    activeCharts[canvasId] = new Chart(ctx, {
        type: 'line', 
        data: { 
            labels: evolutionData.map(d => d.microciclo_id), 
            datasets: [{ 
                label: 'Strain', 
                data: evolutionData.map(d => d.strain), 
                borderColor: 'rgb(239, 68, 68)', 
                fill: false, 
                tension: 0.1 
            }] 
        },
        options: { 
            maintainAspectRatio: false, 
            scales: { 
                y: { beginAtZero: true, min: 0, max: 15000 }, 
                x: { grid: { display: false } } 
            }, 
            plugins: { 
                legend: { display: false }, 
                datalabels: { 
                    display: evolutionData.length <= 12,
                    align: 'top',
                    formatter: (value) => Math.round(value)
                } 
            } 
        }
    });
}

function renderLoadTable(results) {
     resultsContainerCarga.innerHTML = `<div class="flex items-center p-4 bg-gray-50 border-b font-semibold text-gray-600 text-sm sticky top-0"><div class="w-2/6">Atleta</div><div class="w-1/6 text-center">ACWR</div><div class="w-1/6 text-center">Carga Aguda (Semana)</div><div class="w-1/6 text-center">Monotonia</div><div class="w-1/6 text-center">Strain</div><div class="w-12"></div></div><div>${results.map(createLoadResultRow).join('')}</div>`;
}
function createLoadResultRow(result) {
    const cleanAthleteId = result.athleteId.replace(/\s+/g, '-');
    const acwrText = result.acwr != null ? result.acwr.toFixed(2) : '--';
    const cargaClass = getCargaAgudaClassification(result.totalLoad).class;
    const chartData = JSON.stringify(result.chartData);

    return `<div class="border-b last:border-b-0"><div class="flex items-center p-4"><div class="w-2/6 font-bold text-gray-800">${result.athleteId}</div><div class="w-1/6 text-center font-bold text-xl ${getAwcrClassification(result.acwr).class}">${acwrText} ${!result.hasEnoughDataForAcwr && result.acwr != null ? '*' : ''}</div><div class="w-1/6 text-center font-semibold text-lg ${cargaClass}">${Math.round(result.totalLoad)}</div><div class="w-1/6 text-center font-semibold text-lg ${getMonotonyClassification(result.monotony).class}">${result.monotony.toFixed(2)}</div><div class="w-1/6 text-center font-semibold text-lg ${getStrainClassification(result.strain).class}">${Math.round(result.strain)}</div><div class="w-12 text-center"><button class="toggle-details-btn p-1 rounded-full hover:bg-gray-200" data-target="details-carga-${cleanAthleteId}" data-athlete="${cleanAthleteId}" data-chartdata='${chartData}'><svg class="arrow-icon w-5 h-5 text-gray-500 transition-transform" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" /></svg></button></div></div><div class="details-section bg-gray-50" id="details-carga-${cleanAthleteId}"><div class="p-4"><h4 class="font-semibold text-sm mb-2 text-gray-700">Carga Di√°ria do(s) Microciclo(s):</h4><div class="h-64 w-full"><canvas id="chart-${cleanAthleteId}"></canvas></div></div></div></div>`;
}

function renderAthleteChart(canvasId, chartData, label) {
    const ctx = document.getElementById(canvasId);
    if (!ctx) return;
    if (activeCharts[canvasId]) activeCharts[canvasId].destroy();
    activeCharts[canvasId] = new Chart(ctx, {
        type: 'bar', data: { labels: chartData.labels, datasets: [{ label: label, data: chartData.loads, backgroundColor: 'rgba(59, 130, 246, 0.5)', borderColor: 'rgba(59, 130, 246, 1)', borderWidth: 1 }] },
        options: { maintainAspectRatio: false, scales: { y: { beginAtZero: true, min: 0, max: 1000, title: { display: true, text: 'Carga (PSE x Dura√ß√£o)' } }, x: { title: { display: true, text: 'Data' } } }, plugins: { legend: { display: false }, datalabels: { anchor: 'end', align: 'top' } } }
    });
}

// --- PLANEJAMENTO FUNCTIONS ---
function getSelectedOptions(selectElement) {
    return Array.from(selectElement.selectedOptions).map(option => option.value);
}

async function handleFormFisicoSubmit(e) {
    e.preventDefault();
    const equipeId = equipeIdFisicoInput.value;
    if(!equipeId || equipeId === 'Selecione uma equipe') {
        showToast("Selecione uma equipe para cadastrar o treino.");
        return;
    }
    const btn = e.target.querySelector('button[type="submit"]');
    btn.disabled = true;

    const treino = {
        equipe_id: equipeId,
        type: 'fisico', date: document.getElementById('dataTreinoFisico').value,
        semana_id: document.getElementById('semanaIdFisico').value,
        objPrincipal: document.getElementById('objPrincipalFisico').value,
        objSecundario: getSelectedOptions(document.getElementById('objSecundarioFisico')),
        local: document.getElementById('localTreinoFisico').value,
        carga: document.getElementById('cargaTreinoFisico').value,
        cargaText: document.getElementById('cargaTreinoFisico').options[document.getElementById('cargaTreinoFisico').selectedIndex].text,
        createdAt: serverTimestamp()
    };
    try {
        await addDoc(treinosFisicosCollection, treino);
        showToast('Treino F√≠sico adicionado!', 'success');
        formTreinoFisico.reset();
        equipeIdFisicoInput.value = equipeId;
        document.getElementById('dataTreinoFisico').valueAsDate = new Date();
        document.getElementById('dataTreinoFisico').dispatchEvent(new Event('change'));

    } catch (error) {
        showToast("Erro ao salvar o treino f√≠sico.");
    } finally {
        btn.disabled = false;
    }
}

async function handleFormCampoSubmit(e) {
    e.preventDefault();
    const equipeId = equipeIdCampoInput.value;
     if(!equipeId || equipeId === 'Selecione uma equipe') {
        showToast("Selecione uma equipe para cadastrar o treino.");
        return;
    }
    const btn = e.target.querySelector('button[type="submit"]');
    btn.disabled = true;

    const treino = {
        equipe_id: equipeId,
        type: 'campo', date: document.getElementById('dataTreinoCampo').value,
        semana_id: document.getElementById('semanaIdCampo').value,
        objPrincipal: document.getElementById('objPrincipalCampo').value,
        objSecundario: getSelectedOptions(document.getElementById('objSecundarioCampo')),
        campo: document.getElementById('campoTreinoCampo').value,
        carga: document.getElementById('cargaTreinoCampo').value,
        cargaText: document.getElementById('cargaTreinoCampo').options[document.getElementById('cargaTreinoCampo').selectedIndex].text,
        createdAt: serverTimestamp()
    };
    try {
        await addDoc(treinosCampoCollection, treino);
        showToast('Treino de Campo adicionado!', 'success');
        formTreinoCampo.reset();
        equipeIdCampoInput.value = equipeId;
        document.getElementById('dataTreinoCampo').valueAsDate = new Date();
        document.getElementById('dataTreinoCampo').dispatchEvent(new Event('change'));
    } catch (error) {
        showToast("Erro ao salvar o treino de campo.");
    } finally {
        btn.disabled = false;
    }
}

function renderAllLogos() {
    const printableAreaIds = [
        'pdf-content-dashboard',
        'pdf-content-prontidao',
        'pdf-content-carga',
        'pdf-content-planejamento'
    ];

    let logoHtml = '';
    if (selectedTeam !== 'all' && teamLogos[selectedTeam]) {
        logoHtml = `
            <div class="printable-logo-container flex justify-start mb-4">
                <img src="${teamLogos[selectedTeam]}" alt="Logo da Equipe" class="max-h-16 object-contain">
            </div>
        `;
    }

    printableAreaIds.forEach(id => {
        const container = document.getElementById(id);
        if (container) {
            const existingLogo = container.querySelector('.printable-logo-container');
            if (existingLogo) {
                existingLogo.remove();
            }
            if (logoHtml) {
                container.insertAdjacentHTML('afterbegin', logoHtml);
            }
        }
    });
}

function handleLogoUpload(event) {
    const file = event.target.files[0];
    if (!file || !file.type.startsWith('image/')) {
        showToast("Por favor, selecione um arquivo de imagem v√°lido.");
        return;
    }
    if (selectedTeam === 'all') {
        showToast("Selecione uma equipe espec√≠fica para adicionar um logo.");
        return;
    }
    const reader = new FileReader();
    reader.onload = () => {
        teamLogos[selectedTeam] = reader.result;
        localStorage.setItem('teamLogos', JSON.stringify(teamLogos));
        showToast("Logo da equipe atualizado com sucesso!", "success");
        renderAllLogos();
    };
    reader.readAsDataURL(file);
}

function renderPlanningFilter() {
    const allTrainings = [...treinosFisicos, ...treinosCampo];
    const existingWeeks = [...new Set(allTrainings.map(t => t.semana_id))];
    const futureWeeks = Array.from({length: 5}, (_, i) => {
        const d = new Date();
        d.setDate(d.getDate() + (i * 7));
        return getWeekId(d);
    });

    const allWeeks = sortWeeks([...new Set([...existingWeeks, ...futureWeeks, getWeekId(new Date())])].filter(Boolean));
    
    let logoButtonHtml = '';
    if (selectedTeam !== 'all') {
        logoButtonHtml = `
            <div class="mt-4 text-center">
                <button id="addLogoBtn" class="btn bg-gray-200 text-gray-800 font-semibold py-2 px-4 rounded-lg hover:bg-gray-300 transition text-sm">Adicionar/Alterar Logo</button>
                <input type="file" id="logoFileInput" class="hidden" accept="image/*">
            </div>
        `;
    }

    filterContainerPlanejamento.innerHTML = `
         <div class="bg-white p-4 rounded-lg border shadow-sm">
            <div class="flex justify-between items-center mb-2">
                <label class="font-semibold text-gray-700">Selecione a(s) Semana(s) para Planejamento:</label>
                <button id="deletePlanningWeeksBtn" class="btn bg-red-100 text-red-700 font-semibold py-1 px-3 rounded-lg hover:bg-red-200 transition text-sm">Excluir Semanas</button>
            </div>
            <div class="grid grid-cols-3 sm:grid-cols-4 md:grid-cols-6 lg:grid-cols-8 gap-2">
                ${allWeeks.map(week => `
                    <div class="flex items-center">
                        <input id="plan-week-${week}" type="checkbox" value="${week}" class="planning-week-checkbox h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500" ${selectedPlanningWeeks.includes(week) ? 'checked' : ''}>
                        <label for="plan-week-${week}" class="ml-2 block text-sm text-gray-900">${week}</label>
                    </div>
                `).join('')}
            </div>
            ${logoButtonHtml}
        </div>`;

    document.getElementById('deletePlanningWeeksBtn').addEventListener('click', deleteSelectedPlanningWeeks);
    if (selectedTeam !== 'all') {
        document.getElementById('addLogoBtn').addEventListener('click', () => {
            document.getElementById('logoFileInput').click();
        });
        document.getElementById('logoFileInput').addEventListener('change', handleLogoUpload);
    }
}

function renderPlanningView() {
    renderPlanningFilter();

    const dataForTeamFisico = selectedTeam === 'all' ? treinosFisicos : treinosFisicos.filter(d => d.equipe_id === selectedTeam);
    const dataForTeamCampo = selectedTeam === 'all' ? treinosCampo : treinosCampo.filter(d => d.equipe_id === selectedTeam);

    const fisicoSemana = dataForTeamFisico.filter(t => selectedPlanningWeeks.includes(t.semana_id));
    const campoSemana = dataForTeamCampo.filter(t => selectedPlanningWeeks.includes(t.semana_id));

    pdfContentPlanejamento.innerHTML = `
        <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
            <div class="space-y-4">
                 <h3 class="text-2xl font-bold text-gray-900">Treinos F√≠sicos</h3>
                 <div id="timelineFisico" class="p-2 bg-gray-50 rounded-lg min-h-[10rem]"></div>
                 <div class="mt-6 bg-white p-4 rounded-lg shadow-sm border h-64"><canvas id="chartCargaFisico"></canvas></div>
            </div>
            <div class="space-y-4">
                <h3 class="text-2xl font-bold text-gray-900">Treinos de Campo</h3>
                <div id="timelineCampo" class="p-2 bg-gray-50 rounded-lg min-h-[10rem]"></div>
                <div class="mt-6 bg-white p-4 rounded-lg shadow-sm border h-64"><canvas id="chartCargaCampo"></canvas></div>
            </div>
        </div>
        <div class="text-center mt-8">
            <button id="exportPdfBtnPlanejamento" class="btn bg-red-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-red-700 transition flex items-center mx-auto">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M4 4a2 2 0 012-2h4.586A2 2 0 0112 2.586L15.414 6A2 2 0 0116 7.414V16a2 2 0 01-2 2H6a2 2 0 01-2-2V4zm2 6a1 1 0 011-1h6a1 1 0 110 2H7a1 1 0 01-1-1zm1 3a1 1 0 100 2h6a1 1 0 100-2H7z" clip-rule="evenodd" /></svg>
                Exportar Planejamento
            </button>
        </div>
    `;
    
    document.getElementById('exportPdfBtnPlanejamento').addEventListener('click', () => exportToPDF('planejamento'));

    renderTimeline('timelineFisico', fisicoSemana, `Nenhum treino f√≠sico cadastrado para esta sele√ß√£o.`);
    renderTimeline('timelineCampo', campoSemana, `Nenhum treino de campo cadastrado para esta sele√ß√£o.`);
    renderDailyLoadChart('chartCargaFisico', fisicoSemana);
    renderDailyLoadChart('chartCargaCampo', campoSemana);
}

async function deleteSelectedPlanningWeeks() {
    const selectedCheckboxes = document.querySelectorAll('.planning-week-checkbox:checked');
    const weeksToDelete = Array.from(selectedCheckboxes).map(cb => cb.value);

    if (weeksToDelete.length === 0) {
        showToast("Nenhuma semana selecionada para excluir.");
        return;
    }

    showConfirmationModal(
        `Tem certeza que deseja apagar todos os treinos da(s) semana(s) ${weeksToDelete.join(', ')}? Esta a√ß√£o n√£o pode ser desfeita.`,
        async () => {
            showToast('Excluindo treinos...', 'success');
            const batch = writeBatch(db);
            
            const qFisico = query(treinosFisicosCollection, where("semana_id", "in", weeksToDelete));
            const qCampo = query(treinosCampoCollection, where("semana_id", "in", weeksToDelete));

            const [fisicoSnap, campoSnap] = await Promise.all([getDocs(qFisico), getDocs(qCampo)]);

            fisicoSnap.docs.forEach(d => batch.delete(d.ref));
            campoSnap.docs.forEach(d => batch.delete(d.ref));

            await batch.commit();
            showToast('Semanas e treinos associados removidos.', 'success');
        
            // Atualiza dados locais e UI sem reload
            treinosFisicos = treinosFisicos.filter(t => !weeksToDelete.includes(t.semana_id));
            treinosCampo = treinosCampo.filter(t => !weeksToDelete.includes(t.semana_id));
            selectedPlanningWeeks = selectedPlanningWeeks.filter(w => !weeksToDelete.includes(w));
            renderPlanningView();
    },
        'Excluir Semanas de Planejamento'
    );
}

function renderTimeline(containerId, treinos, emptyMessage) {
    const container = document.getElementById(containerId);
    if (!container) return;
    
    container.innerHTML = '';
    if (treinos.length === 0) {
         container.innerHTML = `<p class="col-span-full text-gray-500 text-center w-full py-8">${emptyMessage}</p>`;
        return;
    }

    const trainingsByDate = treinos.reduce((acc, treino) => {
        if (!acc[treino.date]) {
            acc[treino.date] = [];
        }
        acc[treino.date].push(treino);
        return acc;
    }, {});

    const sortedDates = Object.keys(trainingsByDate).sort((a, b) => new Date(a) - new Date(b));

    sortedDates.forEach(date => {
        const dayTrainings = trainingsByDate[date];
        const dayElement = document.createElement('div');
        dayElement.className = 'mb-4'; 

        const formattedDate = new Date(date + 'T00:00:00').toLocaleDateString('pt-BR', { weekday: 'long', day: '2-digit', month: 'short' });

        const trainingsHtml = dayTrainings.map(treino => {
            const borderColorClass = `carga-${treino.carga}`;
            const objSecundarioText = Array.isArray(treino.objSecundario) && treino.objSecundario.length > 0 ? treino.objSecundario.join(', ') : 'N/A';
            const bgColor = treino.type === 'fisico' ? 'bg-blue-50' : 'bg-green-50';
            const iconColor = treino.type === 'fisico' ? 'text-blue-600' : 'text-green-600';
            const iconLetter = treino.type === 'fisico' ? 'F' : 'C';

            return `
                <li class="flex items-center gap-x-3 p-2 rounded-lg ${bgColor} border-l-4 ${borderColorClass}">
                    <div class="flex-shrink-0 flex items-center justify-center h-8 w-8 rounded-full ${iconColor} bg-white font-bold text-sm shadow-sm">
                        ${iconLetter}
                    </div>
                    <div class="flex-grow">
                        <p class="font-semibold text-gray-800 text-sm leading-tight">${treino.objPrincipal} <span class="text-xs font-normal text-gray-500">(${treino.local || treino.campo})</span></p>
                        <p class="text-xs text-gray-600 leading-tight" title="${objSecundarioText}">
                            ${objSecundarioText}
                        </p>
                    </div>
                    <div class="flex-shrink-0 text-right w-28">
                        <p class="text-xs font-semibold text-gray-700">${treino.cargaText}</p>
                    </div>
                    <div class="flex-shrink-0">
                        <button class="remove-training-btn text-gray-400 hover:text-red-500 text-xl font-bold leading-none p-1" data-id="${treino.id}" data-type="${treino.type}">&times;</button>
                    </div>
                </li>
            `;
        }).join('');

        dayElement.innerHTML = `
            <div>
                <h4 class="font-bold text-gray-500 text-sm tracking-wider uppercase mb-2">${formattedDate}</h4>
                <ul class="space-y-2">
                    ${trainingsHtml}
                </ul>
            </div>
        `;
        container.appendChild(dayElement);
    });
}

planejamentoContent.addEventListener('click', (e) => {
    const removeButton = e.target.closest('.remove-training-btn');
    if (removeButton) {
        const { id, type } = removeButton.dataset;
        showConfirmationModal(`Tem certeza que deseja remover este treino de ${type}?`, () => removeTraining(id, type));
    }
});


function renderDailyLoadChart(canvasId, treinos, isDashboard = false) {
    const ctx = document.getElementById(canvasId);
    if (!ctx) return;
    if (activeCharts[canvasId]) activeCharts[canvasId].destroy();

    const dailyMaxLoad = {};
    treinos.forEach(t => {
        const dayOfWeek = new Date(t.date + 'T00:00:00').getUTCDay();
        const loadValue = CARGA_PERCENTUAL[t.carga];
        if (!dailyMaxLoad[dayOfWeek] || loadValue > dailyMaxLoad[dayOfWeek]) {
            dailyMaxLoad[dayOfWeek] = loadValue;
        }
    });

    const labels = ['Dom', 'Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'S√°b'];
    const data = labels.map((_, i) => dailyMaxLoad[i] || 0);

    const backgroundColors = data.map(load => {
        if (load === 100) return 'rgba(239, 68, 68, 0.7)'; if (load === 90) return 'rgba(249, 115, 22, 0.7)';
        if (load === 70) return 'rgba(245, 158, 11, 0.7)'; if (load > 0) return 'rgba(59, 130, 246, 0.7)';
        return '#e5e7eb';
    });
    
    const options = {
         responsive: true, maintainAspectRatio: false, 
         scales: { 
            y: { 
                beginAtZero: true, min: 0, max: 100, 
                display: !isDashboard,
                title: { display: !isDashboard, text: 'Carga (%)' } 
            }, 
            x: { 
                grid: { display: false },
                ticks: { font: { size: isDashboard ? 8 : 12 } }
            } 
         }, 
         plugins: { 
            legend: { display: false }, 
            datalabels: { display: false } 
         } 
    };
    if(isDashboard){
         options.scales.y.ticks = { display: false };
    }

    activeCharts[canvasId] = new Chart(ctx, {
        type: 'bar', data: { labels, datasets: [{ label: 'Carga Planejada (%)', data, backgroundColor: backgroundColors }] },
        options: options
    });
}

// --- LES√ïES FUNCTIONS ---
async function handleFormLesaoSubmit(e) {
    e.preventDefault();
    
    const equipeId = equipeIdLesaoInput.value;
    if(!equipeId || equipeId === 'Selecione uma equipe') {
        showToast("Por favor, selecione uma equipe antes de registrar uma les√£o.");
        return;
    }

    submitLesaoBtn.disabled = true;

    const lesao = {
        equipe_id: equipeId,
        atleta: document.getElementById('atletaLesao').value,
        lesao: document.getElementById('lesao').value,
        tratamento: document.getElementById('tratamento').value,
        status: document.getElementById('statusLesao').value,
        createdAt: serverTimestamp()
    };

    try {
        await addDoc(lesoesCollection, lesao);
        showToast('Registro de les√£o salvo!', 'success');
        formLesao.reset();
        equipeIdLesaoInput.value = equipeId;
    } catch (error) {
        console.error("Erro ao salvar les√£o: ", error);
        showToast("Erro ao salvar o registro de les√£o.");
    } finally {
        submitLesaoBtn.disabled = false;
    }
}

function createLesaoCard(lesao) {
    let statusClass = '';
    let statusText = '';
    switch(lesao.status) {
        case 'nao-liberado':
            statusClass = 'bg-red-100 text-red-800';
            statusText = 'N√£o Liberado';
            break;
        case 'restricoes':
            statusClass = 'bg-yellow-100 text-yellow-800';
            statusText = 'Com Restri√ß√µes';
            break;
    }

    // Adiciona a data de cria√ß√£o como uma string ISO para ser usada no c√°lculo
    const createdAtISO = lesao.createdAt ? lesao.createdAt.toDate().toISOString() : '';

    return `
         <div class="bg-white p-4 rounded-lg shadow-sm border-l-4 ${lesao.status === 'nao-liberado' ? 'border-red-500' : 'border-yellow-500'}">
            <div class="flex justify-between items-start">
                <div>
                    <p class="font-bold text-lg text-gray-800">${lesao.atleta}</p>
                    <p class="text-sm text-gray-600 font-medium">${lesao.lesao}</p>
                </div>
                <span class="text-xs font-semibold px-2 py-1 rounded-full ${statusClass}">${statusText}</span>
            </div>
            <div class="mt-2 pt-2 border-t">
                <p class="text-sm text-gray-700 whitespace-pre-wrap">${lesao.tratamento || 'Nenhum tratamento especificado.'}</p>
            </div>
            <div class="flex justify-end gap-x-2 mt-3">
                <button class="btn-update-lesao text-xs bg-green-100 text-green-700 hover:bg-green-200 px-3 py-1 rounded-md" data-id="${lesao.id}" data-status="liberado" data-atleta="${lesao.atleta}" data-createdat="${createdAtISO}">Marcar como Liberado</button>
                <button class="btn-update-lesao text-xs bg-gray-100 text-gray-700 hover:bg-gray-200 px-3 py-1 rounded-md" data-id="${lesao.id}" data-status="delete" data-atleta="${lesao.atleta}">Remover</button>
            </div>
        </div>
    `;
}
function populateTeamFilter() {
    const allData = [...fullProntidaoData, ...fullCargaData, ...lesoesData];
    const teams = [...new Set(allData.map(d => d.equipe_id).filter(Boolean))].sort();
    
    const currentSelectedTeam = teamFilterSelect.value;
    
    teamFilterSelect.innerHTML = `<option value="all">Todas as Equipes</option>`;
    teams.forEach(team => {
        const option = document.createElement('option');
        option.value = team;
        option.textContent = team;
        teamFilterSelect.appendChild(option);
    });

    if(teams.includes(currentSelectedTeam)){
        teamFilterSelect.value = currentSelectedTeam;
    } else {
         teamFilterSelect.value = 'all';
         selectedTeam = 'all';
    }
}


function populateAthleteDatalist() {
    const dataForTeamProntidao = selectedTeam === 'all' ? fullProntidaoData : fullProntidaoData.filter(d => d.equipe_id === selectedTeam);
    const dataForTeamCarga = selectedTeam === 'all' ? fullCargaData : fullCargaData.filter(d => d.equipe_id === selectedTeam);

    const athleteNamesFromProntidao = dataForTeamProntidao.map(d => d.atleta_id);
    const athleteNamesFromCarga = dataForTeamCarga.map(d => d.atleta_id);
    const allNames = [...new Set([...athleteNamesFromProntidao, ...athleteNamesFromCarga])].sort();
    
    const datalist = document.getElementById('atleta-list-options');
    datalist.innerHTML = allNames.map(name => `<option value="${name}"></option>`).join('');
}

function showConfirmationModal(text, onConfirm, title = "Confirmar A√ß√£o") {
    document.getElementById('modalTitle').textContent = title;
    document.getElementById('modalText').textContent = text;
    confirmModal.classList.remove('hidden');

    const confirmBtn = document.getElementById('confirmButton');
    const cancelBtn = document.getElementById('cancelButton');

    const confirmHandler = () => {
        onConfirm();
        hideModal();
    };
    
    const cancelHandler = () => {
        hideModal();
    };

    const hideModal = () => {
        confirmModal.classList.add('hidden');
        confirmBtn.removeEventListener('click', confirmHandler);
        cancelBtn.removeEventListener('click', cancelHandler);
    };

    confirmBtn.addEventListener('click', confirmHandler);
    cancelBtn.addEventListener('click', cancelHandler);
}

async function removeTraining(id, type) {
    showToast(`Removendo treino...`, 'success');
    try {
        const collectionName = type === 'fisico' ? 'treinosFisicos' : 'treinosCampo';
        await deleteDoc(doc(db, collectionName, id));
    } catch (error) {
        showToast("Erro ao remover o treino.");
    }
};

// --- CLASSIFICATION & LEGENDS ---
const getHooperClassification = score => {
    if (score == null) return { class: 'text-gray-700', bg: 'bg-gray-100', border: 'border-gray-200' };
    if (score <= 9) return { class: 'text-green-700', bg: 'bg-green-100', border: 'border-green-200' };
    if (score <= 17) return { class: 'text-yellow-700', bg: 'bg-yellow-100', border: 'border-yellow-200' };
    return { class: 'text-red-700', bg: 'bg-red-100', border: 'border-red-200' };
};
const getIndexClassification = index => {
    if (index == null) return { class: 'text-gray-700' };
    if (index < -1.5) return { class: 'text-red-600' };
    if (index < -0.5) return { class: 'text-yellow-600' };
    return { class: 'text-green-600' };
};
const getCargaAgudaClassification = load => {
    if (load == null) return { class: 'text-gray-700' };
    if (load <= 2500) return { class: 'text-blue-600' };
    if (load <= 5000) return { class: 'text-green-600' };
    return { class: 'text-red-600' };
};
const getCargaAgudaChartColor = load => {
    if (load == null || load === 0) return '#cbd5e1'; 
    if (load <= 2500) return 'rgba(59, 130, 246, 0.7)'; 
    if (load <= 5000) return 'rgba(34, 197, 94, 0.7)'; 
    return 'rgba(239, 68, 68, 0.7)';
}
const getStrainClassification = strain => {
    if (strain == null) return { class: 'text-gray-700' };
    if (strain > 10000) return { class: 'text-red-600' };
    if (strain > 6000) return { class: 'text-yellow-600' };
    return { class: 'text-green-600' };
};
const getMonotonyClassification = monotony => {
    if (monotony == null) return { class: 'text-gray-700' };
    if (monotony > 2.0) return { class: 'text-red-600' };
    if (monotony > 1.5) return { class: 'text-yellow-600' };
    return { class: 'text-green-600' };
};
const getAwcrClassification = acwr => {
    if (acwr == null) return { class: 'text-gray-700' };
    if (acwr > 1.5) return { class: 'text-red-600' };
    if (acwr >= 0.8 && acwr <= 1.3) return { class: 'text-green-600' };
    return { class: 'text-yellow-600' };
};

function renderLegends(type) {
     if (type === 'prontidao') {
        legendsProntidao.innerHTML = `
            <div class="bg-white p-3 rounded-lg border">
                <h4 class="font-bold text-sm mb-1 text-gray-700">√çndice Geral</h4>
                <p>Calculado pela performance (Salto/VFC) e ajustado pela fadiga (Hooper).</p>
                <p><strong class="text-green-600">> -0.90 (√ìtimo)</strong></p>
                <p><strong class="text-yellow-600">-0.90 a -1.99 (Aten√ß√£o)</strong></p>
                <p><strong class="text-red-600">< -2.0 (Cr√≠tico)</strong></p>
            </div>
            <div class="bg-white p-3 rounded-lg border">
                <h4 class="font-bold text-sm mb-1 text-gray-700">Fadiga (Hooper)</h4>
                <p><strong class="text-green-700">4-9 (Bom)</strong></p>
                <p><strong class="text-yellow-700">10-17 (Regular)</strong></p>
                <p><strong class="text-red-700">18-28 (Ruim)</strong></p>
            </div>
            <div class="bg-white p-3 rounded-lg border">
                <h4 class="font-bold text-sm mb-1 text-gray-700">% Recupera√ß√£o Muscular</h4>
                <p>Varia√ß√£o do Salto Horizontal em rela√ß√£o √† m√©dia hist√≥rica do atleta.</p>
                <p><strong class="text-green-600">> 0% (Melhor)</strong></p>
                <p><strong class="text-red-600">< 0% (Pior)</strong></p>
            </div>
        `;
     } else {
        legendsCarga.innerHTML = `<div class="bg-white p-3 rounded-lg border"><h4 class="font-bold text-sm mb-1 text-gray-700">Carga Aguda M√©dia (u.a.)</h4><p>M√©dia da carga total dos microciclos selecionados.</p><p><strong class="text-blue-600">< 2500 (Baixa)</strong></p><p><strong class="text-green-600">2500-5000 (Moderada)</strong></p><p><strong class="text-red-600">> 5000 (Alta)</strong></p></div><div class="bg-white p-3 rounded-lg border"><h4 class="font-bold text-sm mb-1 text-gray-700">ACWR (Acute:Chronic Workload Ratio)</h4><p>Carga Aguda / M√©dia das 4 semanas anteriores. <br><em>* <4 semanas de dados cr√¥nicos.</em></p><p><strong class="text-green-600">0.8-1.3 (Ideal)</strong></p><p><strong class="text-yellow-600"><0.8 ou 1.3-1.5 (Aten√ß√£o)</strong></p><p><strong class="text-red-600">>1.5 (Perigo)</strong></p></div><div class="bg-white p-3 rounded-lg border"><h4 class="font-bold text-sm mb-1 text-gray-700">Monotonia</h4><p>M√©dia da carga di√°ria / Desvio Padr√£o. Variabilidade da carga semanal.</p><p><strong class="text-green-600">< 1.5 (Ideal)</strong></p><p><strong class="text-yellow-600">1.5-2.0 (Aten√ß√£o)</strong></p><p><strong class="text-red-600">> 2.0 (Elevado)</strong></p></div><div class="bg-white p-3 rounded-lg border"><h4 class="font-bold text-sm mb-1 text-gray-700">Strain (Tens√£o)</h4><p>Carga total da semana x Monotonia. Estresse geral da semana.</p><p><strong class="text-green-600">< 6000 (Ideal)</strong></p><p><strong class="text-yellow-600">6000-10000 (Aten√ß√£o)</strong></p><p><strong class="text-red-600">> 10000 (Elevado)</strong></p></div>`;
     }
}

function populateAthleteFilterOptions() {
    const individualOptionsContainer = document.getElementById('individualAthleteOptions');
    let atletas = fullProntidaoData;
    if (selectedTeam !== 'all') {
        atletas = atletas.filter(d => d.equipe_id === selectedTeam);
    }
    
    const nomesUnicos = [...new Set(atletas.map(d => d.atleta_id))];
    
    individualOptionsContainer.innerHTML = ''; // Limpa op√ß√µes antigas
    nomesUnicos.sort().forEach(atleta => {
        const option = document.createElement('option');
        option.value = atleta;
        option.textContent = atleta;
        individualOptionsContainer.appendChild(option);
    });
}

    </script>

<script>
// Ao carregar DOM, garante defaults e aplica oculta√ß√£o local
document.addEventListener("DOMContentLoaded", () => {
  ensureDefaultHiddenTeams();
  applyHiddenTeams();
  // Observa mudan√ßas no select de equipes (repopula√ß√£o din√¢mica)
  const teamSel = document.getElementById("teamFilterSelect");
  if (teamSel) {
    const observer = new MutationObserver(() => applyHiddenTeams());
    observer.observe(teamSel, { childList: true });
  }
});

// ===== 2) Override: Excluir todas as semanas no Planejamento =====
function deleteSelectedPlanningWeeks() {
  openConfirmModal("Remover todas as semanas", "Isso vai excluir TODAS as semanas e treinos associados. Deseja continuar?", async () => {
    try {
      const allWeeksFis = Array.from(new Set((window.treinosFisicos || []).map(t => t.semana_id).filter(Boolean)));
      const allWeeksCampo = Array.from(new Set((window.treinosCampo || []).map(t => t.semana_id).filter(Boolean)));
      const weeksToDelete = Array.from(new Set([...allWeeksFis, ...allWeeksCampo]));
      if (weeksToDelete.length === 0) {
        showToast('N√£o h√° semanas para excluir.', 'warning');
        return;
      }
      // Usa objetos globais j√° importados no app
      const batch = writeBatch(db);
      for (const t of (window.treinosFisicos || [])) {
        if (t.semana_id && weeksToDelete.includes(t.semana_id) && t.__ref) batch.delete(t.__ref);
      }
      for (const t of (window.treinosCampo || [])) {
        if (t.semana_id && weeksToDelete.includes(t.semana_id) && t.__ref) batch.delete(t.__ref);
      }
      await batch.commit();
      // Atualiza estado local e UI
      window.treinosFisicos = (window.treinosFisicos || []).filter(t => !weeksToDelete.includes(t.semana_id));
      window.treinosCampo = (window.treinosCampo || []).filter(t => !weeksToDelete.includes(t.semana_id));
      window.selectedPlanningWeeks = [];
      if (typeof renderPlanningView === "function") renderPlanningView();
      showToast('Todas as semanas e treinos foram removidos.', 'success');
    } catch (e) {
      console.error("Erro ao excluir semanas:", e);
      showToast('Erro ao excluir semanas. Veja o console.', 'error');
    }
  });
}

// ===== 3) Fallback do Loader: se demorar demais, mostra a UI assim mesmo =====
document.addEventListener("DOMContentLoaded", () => {
  try {
    const globalLoader = document.getElementById('globalLoader');
    const mainContent = document.getElementById('mainContent');
    const loaderText = document.getElementById('loaderText');
    setTimeout(() => {
      // Se passados 7s e ainda est√° "Conectando...", libera a UI
      if (globalLoader && !globalLoader.classList.contains('hidden')) {
        if (loaderText) loaderText.textContent = "Conex√£o lenta. Carregando interface local...";
        globalLoader.classList.add('hidden');
        if (mainContent) mainContent.classList.remove('hidden');
        if (typeof showToast === "function") showToast("Conex√£o lenta: exibindo UI", "warning");
      }
    }, 7000);
  } catch (e) {
    console.warn("Falha no fallback do loader", e);
  }
});
</script>



<script>
// ==== Rebuild weeks in Planejamento strictly from data (treinosFisicos/treinosCampo) ====
(function(){
  function getExistingWeeksSorted() {
    const fmt = w => String(w||"").trim();
    const fis = (window.treinosFisicos || []).map(t => fmt(t.semana_id)).filter(Boolean);
    const cam = (window.treinosCampo || []).map(t => fmt(t.semana_id)).filter(Boolean);
    const set = new Set([...fis, ...cam]);
    // simple sort: natural by SemXX numbers if present
    const arr = [...set];
    arr.sort((a,b) => {
      const na = parseInt((a.match(/\d+/)||[])[0] || "0", 10);
      const nb = parseInt((b.match(/\d+/)||[])[0] || "0", 10);
      if (!isNaN(na) && !isNaN(nb) && na !== nb) return na - nb;
      return a.localeCompare(b);
    });
    return arr;
  }

  function rebuildWeekSelects() {
    const container = document.getElementById("filterContainerPlanejamento");
    if (!container) return;
    const weeks = getExistingWeeksSorted();

    const selects = container.querySelectorAll("select");
    selects.forEach(sel => {
      const current = sel.value;
      // Preserve placeholder (first option) if present
      const firstOptLabel = sel.options.length ? sel.options[0].textContent : "Selecione";
      // Reset options
      sel.innerHTML = "";
      // Add placeholder
      const ph = document.createElement("option");
      ph.value = "";
      ph.textContent = firstOptLabel || "Selecione";
      sel.appendChild(ph);
      // Add weeks
      weeks.forEach(w => {
        const opt = document.createElement("option");
        opt.value = w;
        opt.textContent = w;
        sel.appendChild(opt);
      });
      // Reset selection if previous is gone
      if (!weeks.includes(current)) {
        sel.value = "";
        sel.dispatchEvent(new Event("change"));
      } else {
        sel.value = current;
      }
    });

    // If there is a global selection array, sync it
    if (Array.isArray(window.selectedPlanningWeeks)) {
      window.selectedPlanningWeeks = window.selectedPlanningWeeks.filter(w => weeks.includes(w));
    }
  }

  // Rebuild on initial load and whenever the filter UI mutates
  let rebuildTimer;
  function scheduleRebuild(){ clearTimeout(rebuildTimer); rebuildTimer = setTimeout(rebuildWeekSelects, 50); }

  document.addEventListener("DOMContentLoaded", () => {
    const container = document.getElementById("filterContainerPlanejamento");
    if (container) {
      const obs = new MutationObserver(scheduleRebuild);
      obs.observe(container, { childList: true, subtree: true });
    }
    scheduleRebuild();
  });

  // After deletions, rebuild again
  const _oldDeleteWeeks = window.deleteSelectedPlanningWeeks;
  window.deleteSelectedPlanningWeeks = function(){
    if (typeof _oldDeleteWeeks === "function") {
      _oldDeleteWeeks();
      setTimeout(scheduleRebuild, 300);
    }
  };
})();
</script>

</body>
</html>
