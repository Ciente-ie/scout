function getPlayersOnFieldAndBench(match) {
            let onField = new Set(Object.values(match.lineup || {}).filter(Boolean));
            const subs = (match.events || []).filter(e => e.action === 'substituicao').sort((a,b) => a.time - b.time);
            subs.forEach(sub => {
                if (sub.playerOutId) onField.delete(sub.playerOutId);
                if (sub.playerInId) onField.add(sub.playerInId);
            });
            const onBench = (match.squadPlayerIds || []).filter(pid => !onField.has(pid));
            return { onField: Array.from(onField), onBench };
        }

        function renderMatchList() {
            const listEl = document.getElementById('match-list');
            if(!listEl) return;
            listEl.innerHTML = '';
            [...appState.matches].sort((a,b) => new Date(b.date) - new Date(a.date)).forEach(match => {
                const card = document.createElement('div');
                card.className = 'bg-gray-800 p-4 rounded-lg flex justify-between items-center';
                let content = `<span class="font-bold text-2xl">${match.myTeamScore} - ${match.opponentScore}</span>`;
                if(match.status === 'live') {
                    content = `<button class="bg-yellow-600 text-white font-bold py-2 px-4 rounded" onclick="startLiveMatch('${match.id}')">Continuar</button>`;
                } else if (match.status === 'scheduled') {
                    content = `<button class="bg-green-600 text-white font-bold py-2 px-4 rounded" onclick="startLiveMatch('${match.id}')">Iniciar Scout</button>`;
                }
                card.innerHTML = `<div><p class="text-xl font-bold">${match.myTeamName} vs ${match.opponentName}</p><p class="text-sm text-gray-400">${new Date(match.date).toLocaleDateString('pt-BR', {timeZone: 'UTC'})}</p></div><div class="flex items-center gap-4">${content}</div>`;
                listEl.appendChild(card);
            });
        }
        
        window.startLiveMatch = async function(matchId) {
            appState.activeMatchId = matchId;
            const match = appState.matches.find(m => m.id === matchId);
            if(!match) return;
            if (match.status !== 'live') { await updateMatchData(matchId, { status: 'live' }); }
            
            liveState = { 
                timerInterval: null, possessionInterval: null, 
                seconds: match.timerSeconds || 0, 
                currentPeriod: match.timerPeriod || 0, 
                currentPossessionHolder: null, activeSubAction: null,
                secondHalfStartSeconds: match.secondHalfStartSeconds || -1,
                awaitingPlayerSelection: null, selectedZone: 'meio', isFieldInverted: false
            };
            
            navigateTo('live-match');
            renderOnFieldPlayers();
            setupInteractiveField();
            renderLiveScoreAndTimer();
        }
        
        function renderLiveScoreAndTimer() {
            const match = appState.matches.find(m => m.id === appState.activeMatchId);
            if (!match || !ui.liveMatch.header) return;
            let displaySeconds = liveState.seconds;
            if (liveState.currentPeriod === 2 && liveState.secondHalfStartSeconds !== -1) {
                displaySeconds = liveState.seconds - liveState.secondHalfStartSeconds;
            }
            ui.liveMatch.header.innerHTML = `<div class="flex justify-between items-center text-white"><p>${match.myTeamName}</p><p class="text-2xl font-bold">${match.myTeamScore} - ${match.opponentScore}</p><p>${match.opponentName}</p></div><div id="live-timer" class="text-5xl text-center font-bold">${formatTime(displaySeconds)}</div><div class="flex justify-center gap-2"><button class="bg-blue-600 px-3 py-1 rounded" onclick="timerControl('start1')">1T</button><button class="bg-gray-500 px-3 py-1 rounded" onclick="timerControl('pause')">Pausa</button><button class="bg-blue-600 px-3 py-1 rounded" onclick="timerControl('start2')">2T</button><button class="bg-red-600 px-3 py-1 rounded" onclick="timerControl('end')">Fim</button></div>`;
        }

        function renderLiveLog() {
            const match = appState.matches.find(m => m.id === appState.activeMatchId);
            if (!match || !match.events || !ui.liveMatch.logBody) return;
            ui.liveMatch.logBody.innerHTML = '';
            match.events.forEach(ev => {
                const row = ui.liveMatch.logBody.insertRow();
                row.className = "text-xs";
                row.innerHTML = `<td class="p-1">${formatTime(ev.time)}</td><td>${ev.period}T</td><td>${ev.zone}</td><td>${ev.action.replace(/_/g, ' ')}</td><td>${ev.detail.replace(/_/g, ' ')}</td><td>${ev.playerName}</td>`;
            });
        }
        
        function formatTime(s) { const min = Math.floor(s / 60).toString().padStart(2, '0'); const sec = (s % 60).toString().padStart(2, '0'); return `${min}:${sec}`; }

        window.timerControl = function(action) {
            clearInterval(liveState.timerInterval);
            if(action === 'start1' || action === 'start2') {
                if(action === 'start1' && liveState.currentPeriod === 0) liveState.currentPeriod = 1;
                if(action === 'start2') {
                    liveState.currentPeriod = 2;
                    if(liveState.secondHalfStartSeconds === -1) liveState.secondHalfStartSeconds = liveState.seconds;
                }
                liveState.timerInterval = setInterval(() => {
                    liveState.seconds++;
                    renderLiveScoreAndTimer();
                    if(liveState.seconds % 10 === 0) {
                        updateMatchData(appState.activeMatchId, { timerSeconds: liveState.seconds, timerPeriod: liveState.currentPeriod });
                    }
                }, 1000);
            } else if (action === 'end') {
                updateMatchData(appState.activeMatchId, { status: 'finished', timerSeconds: liveState.seconds });
                navigateTo('matches');
            }
        };

        document.getElementById('player-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const form = e.target;
            const id = form.querySelector('#player-id').value;
            const playerData = { name: form.querySelector('#player-name').value, dob: form.querySelector('#player-dob').value, position: form.querySelector('#player-position').value };
            const collectionRef = collection(db, `artifacts/${appId}/users/${userId}/players`);
            if (id) { await setDoc(doc(collectionRef, id), playerData); } else { await addDoc(collectionRef, playerData); }
            form.reset();
            form.querySelector('#player-id').value = '';
        });

        function renderPlayersTable() {
            const tableBody = document.getElementById('players-table');
            if(!tableBody) return;
            tableBody.innerHTML = '';
            appState.players.forEach(player => {
                const row = tableBody.insertRow();
                row.innerHTML = `<td class="p-3">${player.name}</td><td class="p-3">${player.position}</td><td class="p-3"><button class="text-red-400" onclick="deletePlayer('${player.id}')">Excluir</button></td>`;
            });
        }

        window.deletePlayer = async function(id) {
            if (confirm("Tem certeza que deseja excluir este jogador?")) {
                await deleteDoc(doc(db, `artifacts/${appId}/users/${userId}/players`, id));
            }
        }
        
        window.renderDashboard = function() {
            const container = document.getElementById('dashboard');
            if (!container) return;
            container.innerHTML = `<h2 class="text-3xl font-bold text-white mb-6">Dashboard</h2><p>Seja bem-vindo! Use o menu de navegação para gerenciar jogadores e partidas.</p>`;
        }
        
        // --- INICIALIZAÇÃO ---
        window.addEventListener('DOMContentLoaded', firebaseAuth);

    </script>
</body>
</html>
