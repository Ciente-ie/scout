<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scout Free - Análise de Futebol</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #0c111d; color: #e0e0e0; padding-bottom: 40px; /* Space for footer */ }
        .view { display: none; }
        .view.active { display: block; }
        #live-match.active {
            display: flex; flex-direction: column;
            gap: 1rem;
        }
        .nav-link-top {
            transition: all 0.2s; border-bottom: 3px solid transparent;
            padding: 0.5rem 1rem;
        }
        .nav-link-top:hover {
            background-color: #1f2937; border-bottom-color: #3b82f6;
        }
        .nav-link-top.active {
            background-color: #111827; color: white;
            border-bottom-color: #60a5fa;
            font-weight: 600;
        }
        .field {
            position: relative; background-color: #166534;
            background-image:
                linear-gradient(rgba(255,255,255,0.07) 1px, transparent 1px),
                linear-gradient(90deg, rgba(255,255,255,0.07) 1px, transparent 1px),
                radial-gradient(circle at center, rgba(255,255,255,0.08) 0, rgba(255,255,255,0.08) 2px, transparent 2px),
                radial-gradient(circle at center, rgba(255,255,255,0.1) 0, rgba(255,255,255,0.1) 1px, transparent 1px);
            background-size: 40px 40px, 40px 40px, 100% 100%, 100% 100%;
            background-position: center center, center center, center center, center center; border: 2px solid #a0aec0;
            padding: 1rem;
        }
        .zone {
            border: 1px dashed rgba(255,255,255,0.3); padding: 0.5rem;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        .action-buttons-container {
            flex-grow: 1; display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 0.5rem;
            align-content: end;
        }
        .pass-buttons {
            border-top: 2px solid rgba(255,255,255,0.1); padding-top: 0.5rem;
            margin-top: auto;
        }
        .action-btn {
            transition: all 0.2s; padding: 0.5rem 0.25rem;
            font-size: 0.75rem;
            line-height: 1.2;
            font-weight: 600;
            border-radius: 0.375rem;
            width: 100%;
            text-align: center; }
        .action-btn:hover { transform: translateY(-2px); box-shadow: 0 4px 10px rgba(0,0,0,0.2); }
        .action-btn.clicked { background-color: #f59e0b !important; transform: scale(1.05); }
        .pass-btn { background-color: #16a34a; color: white; }
        .pass-btn:hover { background-color: #15803d; }
        .pass-btn-errado { background-color: #991b1b; }
        .pass-btn-errado:hover { background-color: #b91c1c; }
        .possession-btn { padding: 0.5rem; }
        .possession-btn.main-team { flex-grow: 1; font-size: 1rem; }
        .possession-btn.active { box-shadow: 0 0 0 3px #fbbf24; background-color: #d97706; }
        input, select { background-color: #1f2937; color: white; border-color: #4b5563; border-radius: 0.375rem; }
        input:focus, select:focus { background-color: #374151; border-color: #60a5fa; box-shadow: none; outline: none;}
        #report-content-wrapper, #pdf-temp-container { background-color: #ffffff; color: #111827; }
        .report-page { page-break-after: always; position: relative; padding: 60px 20px 30px 20px; }
        .report-page:last-child { page-break-after: auto; }
        .report-header { position: absolute; top: 10px; left: 20px; right: 20px; display: flex; justify-content: space-between; align-items: center; }
        .report-logo { max-height: 40px; max-width: 150px; }
        .report-section { page-break-inside: avoid; }
        .dashboard-card { background-color: #1f2937; border: 1px solid #374151; position: relative;}
        .performance-main-row { cursor: pointer; transition: background-color 0.2s; }
        .performance-main-row:hover { background-color: #2d3748; }
        .performance-details-row.hidden { display: none; }
        .details-icon { transition: transform 0.3s; }
        .performance-main-row.open .details-icon { transform: rotate(90deg); }
        
        #log-chevron {
            transition: transform 0.3s; }
        #live-log-container.open #log-chevron {
            transform: rotate(180deg); }

        /* --- Fullscreen Styles --- */
        body.fullscreen-active nav,
        body.fullscreen-active footer {
            display: none; }
        body.fullscreen-active main {
            padding: 0; height: 100vh;
            max-height: 100vh;
            overflow: hidden;
        }

        body.fullscreen-active #live-match.active {
            display: flex; flex-direction: column;
            height: 100%;
            padding: 0.5rem;
            gap: 0.5rem;
            overflow-y: auto; }
        body.fullscreen-active #live-match > * {
            margin: 0 !important; }
        body.fullscreen-active #live-match > #live-match-controls {
            flex-shrink: 0; }
        body.fullscreen-active #live-match > .field {
            flex-grow: 1; min-height: 300px;
        }
        
        @media (orientation: landscape) {
            body.fullscreen-active #live-match.active {
                display: grid; overflow: hidden;
                grid-template-columns: minmax(300px, 1fr) 2.5fr;
                grid-template-rows: 1fr;
                gap: 1rem; }
            body.fullscreen-active #live-match-controls {
                display: flex; flex-direction: column;
                min-height: 0;
                gap: 0.5rem;
                overflow-y: auto;
            }
             body.fullscreen-active #live-match .field {
                height: 100%; min-height: 0;
            }
             body.fullscreen-active #live-match .field > .grid {
                height: 100%; }
        }

        /* --- Role-based UI visibility --- */
        body:not(.is-admin) .admin-only {
            display: none !important; }
        /* Show performance tab for guests */
        body.is-guest #performance-nav-link {
            display: inline-block !important; }

        /* --- NOVOS ESTILOS --- */
        .field-zone-btn {
            transition: all 0.3s ease;
            transform: scale(1);
        }
        .selected-zone {
            background-color: #f59e0b !important;
            box-shadow: 0 0 15px rgba(251, 191, 36, 0.7);
            color: #111827 !important;
            transform: scale(1.08);
            z-index: 10;
        }
        .flash-feedback {
            animation: flash 0.4s ease-out;
        }
        @keyframes flash {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); background-color: #f59e0b; }
        }
        #live-player-list-container.awaiting-selection {
            display: block !important;
            border: 3px solid #60a5fa;
            box-shadow: 0 0 20px rgba(96, 165, 250, 0.5);
        }
        #awaiting-action-info {
            display: none;
        }
        #live-player-list-container.awaiting-selection #awaiting-action-info {
             display: block;
        }

    </style>
</head>
<body class="flex flex-col h-screen antialiased">

    <nav class="w-full bg-gray-900 shadow-md flex items-center justify-between p-3 flex-shrink-0 z-20">
        <div class="flex items-center gap-3">
             <span id="nav-logo-container">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-9 w-9 text-blue-400">
                    <path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"></path>
                    <rect x="8" y="2" width="8" height="4" rx="1" ry="1"></rect>
                    <path d="M12 18v-6"></path><path d="m9 15 3-3 3 3"></path>
                </svg>
            </span>
            <h1 class="text-white text-2xl font-bold hidden sm:block">Scout Free</h1>
        </div>
        <div id="main-nav-links" class="hidden md:flex items-center gap-1">
            <a href="#" class="nav-link-top active" data-view="dashboard" onclick="navigateTo('dashboard')">Dashboard</a>
            <a href="#" class="nav-link-top admin-only" data-view="management" onclick="navigateTo('management')">Jogadores</a>
            <a href="#" id="performance-nav-link" class="nav-link-top admin-only" data-view="performance" onclick="navigateTo('performance')">Desempenho</a>
            <a href="#" class="nav-link-top admin-only" data-view="matches" onclick="navigateTo('matches')">Partidas</a>
            <a href="#" class="nav-link-top" data-view="reports" onclick="navigateTo('reports')">Relatórios</a>
        </div>
        <div class="flex items-center gap-4">
            <button id="share-button" onclick="shareProfile()" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg items-center gap-2 admin-only" style="display:inline-flex;">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M15 8a3 3 0 10-2.977-2.63l-4.94 2.47a3 3 0 100 4.319l4.94 2.47a3 3 0 10.895-1.789l-4.94-2.47a3.027 3.027 0 000-.74l4.94-2.47C13.456 7.68 14.19 8 15 8z" /></svg>
                <span class="hidden sm:inline">Compartilhar</span>
            </button>
            <div id="user-id-container" class="admin-only hidden md:block text-center text-xs text-gray-500"><p>ID do Usuário:</p><p id="user-id-display" class="break-words font-mono">Carregando...</p></div>
            <button onclick="toggleMobileMenu()" class="md:hidden p-2 rounded-md text-gray-300 hover:bg-gray-700"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7" /></svg></button>
        </div>
    </nav>
    <div id="mobile-menu" class="hidden md:hidden bg-gray-800 p-2"></div>

<main class="flex-1 p-4 md:p-8 overflow-y-auto">
        <div id="dashboard" class="view active"></div>
        <div id="management" class="view">
            <h2 class="text-3xl font-bold text-white mb-6">Gerenciamento de Jogadores</h2>
            <div class="bg-gray-800 p-4 md:p-6 rounded-lg"><div class="grid grid-cols-1 lg:grid-cols-3 gap-8"><div class="lg:col-span-1"><div class="bg-gray-900 p-4 rounded-lg h-full"><h3 class="text-xl font-semibold text-white mb-4">Adicionar / Editar Jogador</h3><form id="player-form" class="space-y-4"><input type="hidden" id="player-id"><div><label for="player-name" class="block mb-2 text-sm font-medium text-gray-300">Nome</label><input type="text" id="player-name" class="w-full p-2.5" required></div><div><label for="player-dob" class="block mb-2 text-sm font-medium text-gray-300">Nascimento</label><input type="date" id="player-dob" class="w-full p-2.5" required></div><div><label for="player-position" class="block mb-2 text-sm font-medium text-gray-300">Posição</label><input type="text" id="player-position" placeholder="Ex: Zagueiro" class="w-full p-2.5" required></div><button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2.5 px-4 rounded-lg">Salvar Jogador</button></form></div></div><div class="lg:col-span-2"><div class="bg-gray-900 p-4 rounded-lg h-full"><h3 class="text-xl font-semibold text-white mb-4">Jogadores Cadastrados</h3><div class="overflow-y-auto max-h-[60vh]"><table class="w-full text-left"><thead class="text-gray-400 sticky top-0 bg-gray-900"><tr><th class="p-3">Nome</th><th class="p-3">Posição</th><th class="p-3">Ações</th></tr></thead><tbody id="players-table" class="divide-y divide-gray-700"></tbody></table></div></div></div></div></div>
        </div>
        <div id="performance" class="view"></div>
        <div id="matches" class="view">
            <div class="flex justify-between items-center mb-6"><h2 class="text-3xl font-bold text-white">Partidas</h2><button class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-5 rounded-lg admin-only" onclick="openModal('new-match-modal')">Nova Partida</button></div>
            <div id="match-list" class="space-y-4"></div>
        </div>
        
        <div id="live-match" class="view">
            <div id="live-match-controls" class="space-y-2">
                <div class="bg-gray-800 p-4 rounded-lg"></div> 
                <div id="possession-area"></div>

                <div id="live-player-list-container" class="bg-gray-900/70 p-3 rounded-lg mt-2 hidden">
                    <div id="awaiting-action-info" class="p-2 mb-2 text-center bg-blue-900 rounded-md">
                        <p class="font-bold text-white text-sm">SELECIONE O JOGADOR</p>
                        <p id="awaiting-action-label" class="text-xs text-blue-200"></p>
                    </div>
                    <div id="on-field-players" class="grid grid-cols-3 sm:grid-cols-4 gap-2">
                        </div>
                    <button onclick="cancelPlayerSelection()" class="w-full mt-3 bg-red-800 hover:bg-red-700 text-white font-bold py-1 px-3 rounded-lg text-xs">Cancelar Ação</button>
                </div>
                <div id="sub-action-container"></div>
                <div id="live-log-container" class="bg-gray-800 rounded-lg">
                    <div class="p-2 flex justify-between items-center cursor-pointer" onclick="toggleLog()">
                        <h4 class="font-bold text-white text-sm">Histórico de Ações</h4>
                        <div class="flex items-center gap-2">
                             <button onclick="event.stopPropagation(); undoLastAction()" class="bg-yellow-600 hover:bg-yellow-700 text-white font-bold py-1 px-3 rounded-lg text-xs">Desfazer</button>
                            <svg id="log-chevron" class="h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                              <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" />
                            </svg>
                        </div>
                    </div>
                    <div id="live-log-content" class="hidden">
                         <div class="p-2 border-t border-gray-700 overflow-y-auto" style="max-height: 150px;">
                            <table class="w-full text-left text-xs">
                                <thead class="text-gray-400 sticky top-0 bg-gray-800">
                                     <tr><th>Tempo</th><th>P.</th><th>Setor</th><th>Ação</th><th>Detalhe</th><th>Jogador</th></tr>
                                </thead>
                                <tbody id="live-log-body" class="divide-y divide-gray-700"></tbody>
                             </table>
                         </div>
                    </div>
                </div>
            </div>

            <div class="field rounded-lg">
                <div class="flex flex-col h-full gap-4">
                    <div id="interactive-field-selector" class="bg-green-900/50 border border-white/20 p-2 rounded-lg">
                        <div class="flex justify-between items-center mb-1">
                            <h4 class="text-center font-bold text-white text-xs tracking-wider">SELECIONE O SETOR DA AÇÃO</h4>
                            <button id="invert-field-btn" class="bg-gray-600 hover:bg-gray-500 text-white font-bold py-1 px-2 rounded-lg text-xs">Inverter Lado</button>
                        </div>
                        <div id="field-zones" class="grid grid-cols-3 gap-1 h-12 text-white font-semibold">
                            <div id="field-zone-defesa" class="field-zone-btn flex items-center justify-center rounded-l-lg cursor-pointer bg-blue-900/50 hover:bg-blue-800/80">
                                <span class="label">Defesa</span>
                            </div>
                            <div id="field-zone-meio" class="field-zone-btn flex items-center justify-center cursor-pointer bg-gray-900/50 hover:bg-gray-800/80">
                                <span class="label">Meio</span>
                            </div>
                            <div id="field-zone-ataque" class="field-zone-btn flex items-center justify-center rounded-r-lg cursor-pointer bg-red-900/50 hover:bg-red-800/80">
                                <span class="label">Ataque</span>
                            </div>
                        </div>
                    </div>
            
                    <div id="single-action-container" class="flex-grow grid grid-cols-2 sm:grid-cols-4 gap-2">
                        <button class="action-btn bg-green-500" onclick="logEvent(event, 'finalizacao')">Finalização</button>
                        <button class="action-btn bg-green-500" onclick="logEvent(event, 'chance_clara')">Chance Clara</button>
                        <button class="action-btn bg-purple-600" onclick="logEvent(event, 'finalizacao_adv')">Fin. Adv.</button>
                        <button class="action-btn bg-purple-600" onclick="logEvent(event, 'chance_clara_adv')">Chance Adv.</button>
                        <button class="action-btn bg-blue-500" onclick="logEvent(event, 'cruzamento')">Cruzamento</button>
                        <button class="action-btn bg-red-500" onclick="logEvent(event, 'falta')">Falta</button>
                        <button class="action-btn bg-yellow-500" onclick="logEvent(event, 'duelo_ganho')">Duelo Ganho</button>
                        <button class="action-btn bg-yellow-500" onclick="logEvent(event, 'duelo_perdido')">Duelo Perdido</button>
                        <div class="col-span-2 sm:col-span-4 grid grid-cols-2 gap-2 border-t-2 border-white/10 pt-2 mt-auto">
                            <button class="action-btn pass-btn" onclick="logEvent(event, 'passe_certo')">Passe Certo</button>
                            <button class="action-btn pass-btn-errado" onclick="logEvent(event, 'passe_errado')">Passe Errado</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="reports" class="view">
            <h2 class="text-3xl font-bold text-white mb-6">Relatórios de Partida</h2>
            <div class="bg-gray-800 p-4 rounded-lg mb-6 admin-only">
                <h3 class="text-lg font-semibold text-white mb-3">Configurar Logo para Relatórios</h3>
                <div class="space-y-3 max-w-lg">
                    <div>
                        <label for="team-logo-upload" class="block mb-1 text-xs font-medium text-gray-400">Arquivo da Logo (PNG, JPG)</label>
                        <input type="file" id="team-logo-upload" accept="image/*" class="w-full text-sm text-gray-400 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-gray-700 file:text-gray-200 hover:file:bg-gray-600">
                    </div>
                    <img id="logo-preview" class="hidden my-2 max-h-16 rounded bg-gray-900 p-1" alt="Prévia da logo">
                    <div>
                        <button onclick="saveTeamSettings()" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg text-sm">Salvar Logo</button>
                    </div>
                </div>
            </div>
            <div class="bg-gray-800 p-4 rounded-lg mb-6"><label for="report-match-select" class="mr-2 text-gray-300">Selecione uma Partida:</label><select id="report-match-select" class="w-full md:w-1/2 p-2 rounded mt-1" onchange="generateReports(this.value)"></select></div>
            <div id="report-content-wrapper" class="p-4 md:p-8 rounded-lg mt-6"><div id="report-content" class="hidden space-y-8"></div></div>
            <div class="mt-6 flex justify-end gap-2 admin-only" id="reports-buttons" style="display: none;">
                <button id="txt-export-button" class="bg-gray-700 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg" onclick="exportActionsToTXT()">Exportar Ações (TXT)</button>
                <button id="pdf-export-button" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg flex items-center" onclick="exportReportToPDF()"><span id="pdf-export-text">Exportar Relatório (PDF)</span><div id="pdf-export-loader" class="hidden ml-2 w-5 h-5 border-2 border-gray-400 border-t-white border-solid rounded-full animate-spin"></div></button>
            </div>
        </div>
    </main>

<footer class="fixed bottom-0 left-0 w-full bg-gray-900 z-10"><div class="text-center text-xs text-gray-400 p-2 border-t border-gray-700">Powered by Ciente - Inteligência Esportiva / Contato: assessoria@cienteesportes.com.br</div></footer>
    
    <div id="modal-container" class="fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center p-4 z-50 hidden" onclick="closeAllModals(event)">
        <div id="new-match-modal" class="modal-content bg-gray-800 text-white rounded-lg w-full max-w-4xl hidden flex flex-col max-h-[90vh]">
            <div class="p-6 pb-4"><h3 class="text-2xl font-bold text-center">Criar Nova Partida</h3></div>
            <div class="overflow-y-auto px-6 pb-6 flex-grow">
                <form id="new-match-form" class="space-y-6">
                    <div class="bg-gray-900 p-4 rounded-lg"><h4 class="font-semibold text-lg mb-3">Detalhes da Partida</h4><div class="grid grid-cols-1 sm:grid-cols-2 gap-4"><div><label>Sua equipe:</label><input type="text" id="match-my-team-name" placeholder="Ex: Principal, Sub-20" class="w-full p-2.5 mt-1" required></div><div><label>Adversário:</label><input type="text" id="match-opponent-name" placeholder="Nome do Adversário" class="w-full p-2.5 mt-1" required></div><div><label>Data:</label><input type="date" id="match-date" class="w-full p-2.5 mt-1" required></div><div><label>Local:</label><input type="text" id="match-location" placeholder="Local da Partida" class="w-full p-2.5 mt-1" required></div></div></div>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div class="bg-gray-900 p-4 rounded-lg md:col-span-1"><h4 class="font-semibold text-lg mb-2">Convocados</h4><div id="match-squad-list" class="h-96 overflow-y-auto border border-gray-700 p-3 rounded space-y-2"></div></div>
                        <div class="bg-gray-900 p-4 rounded-lg md:col-span-1"><h4 class="font-semibold text-lg mb-2">Titulares (4-3-3)</h4><div id="match-lineup-selection" class="h-96 overflow-y-auto border border-gray-700 p-3 rounded space-y-3"></div></div>
                        <div class="bg-gray-900 p-4 rounded-lg md:col-span-1"><h4 class="font-semibold text-lg mb-2">Reservas (Máx. 10)</h4><div id="match-substitutes-list" class="h-96 overflow-y-auto border border-gray-700 p-3 rounded space-y-3"></div></div>
                    </div>
                </form>
            </div>
            <div class="p-6 pt-4"><button type="submit" form="new-match-form" class="w-full bg-blue-600 hover:bg-blue-700 p-3 rounded text-lg font-bold">Criar Partida</button></div>
        </div>
        <div id="goal-modal" class="modal-content bg-gray-800 text-white rounded-lg p-6 w-full max-w-lg hidden"></div>
        
        <div id="substitution-modal" class="modal-content bg-gray-800 text-white rounded-lg p-6 w-full max-w-lg hidden">
            <h3 class="text-2xl font-bold mb-4">Realizar Substituição</h3>
            <form id="substitution-form" class="space-y-4">
                <div>
                    <label for="player-out" class="block mb-1 font-semibold text-gray-300">Sai:</label>
                    <select id="player-out" class="w-full p-2.5" required></select>
                </div>
                <div>
                    <label for="player-in" class="block mb-1 font-semibold text-gray-300">Entra:</label>
                    <select id="player-in" class="w-full p-2.5" required></select>
                </div>
                <div class="flex gap-4 mt-6">
                    <button type="button" class="w-full bg-gray-600 hover:bg-gray-700 p-2.5 rounded" onclick="closeModal('substitution-modal')">Cancelar</button>
                    <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 p-2.5 rounded">Confirmar</button>
                </div>
            </form>
        </div>
        
        <div id="rating-modal" class="modal-content bg-gray-800 text-white rounded-lg p-6 w-full max-w-4xl hidden">
            <h3 class="text-2xl font-bold mb-4">Avaliação de Desempenho Pós-Jogo</h3>
            <div id="rating-player-list" class="space-y-6 max-h-[60vh] overflow-y-auto p-2"></div>
            <div class="mt-4 p-4 bg-gray-900 rounded-lg text-sm"><h4 class="font-bold mb-2 text-white">Legenda de Notas:</h4><div class="grid grid-cols-2 md:grid-cols-5 gap-2 text-gray-300"><p><span class="font-bold">1-2:</span> Muito abaixo</p><p><span class="font-bold">3-4:</span> Abaixo</p><p><span class="font-bold">5-6:</span> Dentro do Esperado</p><p><span class="font-bold">7-8:</span> Acima do Esperado</p><p><span class="font-bold">9-10:</span> Muito Acima</p></div></div>
            <button class="w-full bg-blue-600 p-2.5 rounded mt-4" onclick="saveRatings()">Salvar Avaliações e Finalizar Partida</button>
        </div>
        <div id="halftime-report-modal" class="modal-content bg-white text-gray-800 rounded-lg w-full max-w-4xl hidden flex flex-col max-h-[90vh]">
            <div class="p-4 border-b flex justify-between items-center">
                <h3 class="text-2xl font-bold">Relatório do 1º Tempo</h3>
                <button onclick="closeModal('halftime-report-modal')" class="text-gray-500 hover:text-gray-800 font-bold text-2xl">&times;</button>
            </div>
            <div id="halftime-report-content" class="p-6 overflow-y-auto">
                </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        let appState = { players: [], matches: [], settings: {}, activeMatchId: null, currentView: 'dashboard', listenersAttached: false, isGuestMode: false };
        let liveState = { timerInterval: null, possessionInterval: null, seconds: 0, currentPeriod: 0, currentPossessionHolder: null, activeSubAction: null, secondHalfStartSeconds: -1, awaitingPlayerSelection: null, selectedZone: 'meio', isFieldInverted: false };
        let charts = {};
        const { jsPDF } = window.jspdf;
        let userId;
        let db, auth;
        const firebaseConfig = {
          apiKey: "AIzaSyCSxaH-QFQbhrCttS-J8KmVN1MXmjXqY1s",
          authDomain: "meu-scout-pro.firebaseapp.com",
          projectId: "meu-scout-pro",
          storageBucket: "meu-scout-pro.appspot.com",
          messagingSenderId: "303977649743",
          appId: "1:303977649743:web:4e81e55c7180390ec97c3a"
        };
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'scout-pro-futebol-v2';
        function showUserFacingError(viewId, message) {
            const container = document.getElementById(viewId);
            if (container) {
                container.innerHTML = `<div class="p-8 text-center text-yellow-300 bg-yellow-900 bg-opacity-50 rounded-lg">
                    <h1 class="text-3xl font-bold mb-4">Aviso</h1>
                    <p class="text-lg">${message}</p>
                </div>`;
            }
        }
        
        window.toggleAdvancedStats = function() {
            const container = document.getElementById('advanced-stats-container');
            const button = document.getElementById('advanced-stats-toggle');
            const isHidden = container.classList.contains('hidden');

            if (isHidden) {
                container.classList.remove('hidden');
                button.innerHTML = 'Esconder Estatísticas Avançadas ▲';
            } else {
                container.classList.add('hidden');
                button.innerHTML = 'Ver Estatísticas Avançadas ▼';
            }
        }

        async function firebaseAuth() {
            try {
                const urlParams = new URLSearchParams(window.location.search);
                const guestId = urlParams.get('guest_id');
                appState.isGuestMode = !!guestId;

                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                
                function setupInteractiveField() {
                    const zones = ['defesa', 'meio', 'ataque'];
                    
                    const updateSelection = (selectedZoneId) => {
                        document.querySelectorAll('.field-zone-btn').forEach(btn => {
                            btn.classList.remove('selected-zone');
                        });
                        const selectedBtn = document.getElementById(selectedZoneId);
                        if(selectedBtn) {
                             selectedBtn.classList.add('selected-zone');
                             liveState.selectedZone = selectedBtn.id.split('-')[2];
                        }
                    };

                    document.querySelectorAll('.field-zone-btn').forEach(btn => {
                        btn.addEventListener('click', () => updateSelection(btn.id));
                    });
                    
                    updateSelection('field-zone-meio'); // Set initial selection

                    document.getElementById('invert-field-btn').addEventListener('click', () => {
                        liveState.isFieldInverted = !liveState.isFieldInverted;
                        const fieldContainer = document.getElementById('field-zones');
                        const zoneElements = Array.from(fieldContainer.children);
                        
                        zoneElements.reverse().forEach(el => fieldContainer.appendChild(el));
                        
                        // Temporarily map original IDs to new positions
                        const originalIds = zoneElements.map(el => el.id);
                        zoneElements.forEach((el, index) => {
                            const newZoneName = liveState.isFieldInverted ? zones.slice().reverse()[index] : zones[index];
                            el.id = `field-zone-${newZoneName}`;
                            const labelEl = el.querySelector('.label');
                            if(labelEl) labelEl.textContent = newZoneName.charAt(0).toUpperCase() + newZoneName.slice(1);
                        });
                        
                        updateSelection(`field-zone-${liveState.selectedZone}`);
                    });
                }
                
                document.addEventListener('DOMContentLoaded', setupInteractiveField);

                auth = getAuth(app);
                document.addEventListener('fullscreenchange', () => {
                    document.body.classList.toggle('fullscreen-active', !!document.fullscreenElement);
                    if (appState.currentView === 'live-match') {
                        renderLiveLog();
                    }
                });

                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        console.log("Auth state changed. User authenticated with UID:", user.uid);
                        if (appState.isGuestMode) {
                            userId = guestId;
                            console.log("Guest mode active. Using guest_id as userId for data fetching:", userId);
                        } else {
                            userId = user.uid;
                            console.log("Admin mode active. Using auth.currentUser.uid as userId:", userId);
                        }
                        
                        setupUIMode();

                        if (!appState.listenersAttached) {
                            console.log("Attaching Firestore listeners...");
                            setupListeners();
                            appState.listenersAttached = true;
                        }
                        
                        const initialView = appState.isGuestMode ? 'dashboard' : (appState.currentView || 'dashboard');
                        navigateTo(initialView);
                    } else {
                        console.log("Auth state changed. User is not authenticated. Waiting for sign-in...");
                    }
                });
                if (!auth.currentUser) {
                    if (appState.isGuestMode) {
                        console.log("Guest mode: signing in anonymously.");
                        await signInAnonymously(auth);
                    } else {
                        console.log("Admin mode: attempting to sign in.");
                        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                            await signInWithCustomToken(auth, __initial_auth_token);
                        } else {
                            await signInAnonymously(auth);
                        }
                    }
                }

            } catch (error) {
                console.error("ERRO DE INICIALIZAÇÃO DO FIREBASE:", error);
                const mainContent = document.querySelector('main');
                if (mainContent) {
                    mainContent.innerHTML = `<div class="p-8 text-center text-red-300 bg-red-900 bg-opacity-50 rounded-lg"><h1 class="text-3xl font-bold mb-4">Erro Crítico</h1><p class="text-lg mb-2">A aplicação não conseguiu conectar-se à base de dados (Firebase).</p><div class="text-left bg-gray-900 p-4 rounded-md font-mono text-xs overflow-x-auto"><p><strong class="text-red-400">Mensagem:</strong> ${error.message}</p></div></div>`;
                }
            }
        }
function setupUIMode() {
            const mobileMenu = document.getElementById('mobile-menu');
            if (appState.isGuestMode) {
                document.body.classList.add('is-guest');
                document.body.classList.remove('is-admin');
                mobileMenu.innerHTML = `
                    <a href="#" class="nav-link-top active block text-center" data-view="dashboard" onclick="navigateTo('dashboard')">Dashboard</a>
                    <a href="#" class="nav-link-top block text-center" data-view="performance" onclick="navigateTo('performance')">Desempenho</a>
                    <a href="#" class="nav-link-top block text-center" data-view="reports" onclick="navigateTo('reports')">Relatórios</a>`;
            } else {
                 document.body.classList.remove('is-guest');
                 document.body.classList.add('is-admin');
                 document.getElementById('user-id-display').textContent = userId;
                 mobileMenu.innerHTML = document.getElementById('main-nav-links').innerHTML + `<div class="text-center text-xs text-gray-500 pt-2 border-t border-gray-700 mt-2 admin-only"><p>ID do Usuário:</p><p id="user-id-display-mobile" class="break-words font-mono">${userId}</p></div>`;
            }
        }
        
        window.shareProfile = function() {
            const shareUrl = `${window.location.origin}${window.location.pathname}?guest_id=${userId}`;
            navigator.clipboard.writeText(shareUrl).then(() => {
                alert("Link de compartilhamento copiado para a área de transferência!");
            }).catch(err => {
                showErrorMessage('Falha ao copiar o link. Por favor, copie manualmente: ' + shareUrl, err);
            });
        }

        function setupListeners() {
            if (!userId) {
                console.error("setupListeners called without a userId!");
                return;
            }
            console.log(`Setting up listeners for userId: ${userId}`);
            let dataLoaded = { players: false, matches: false };
            let timeoutTriggered = false;
            setTimeout(() => {
                if (appState.isGuestMode && (!dataLoaded.players || !dataLoaded.matches)) {
                    timeoutTriggered = true;
                    console.warn("Data did not load within 5 seconds for guest. This is likely a permissions issue with Firestore security rules.");
                    showUserFacingError('dashboard', 'Não foi possível carregar os dados compartilhados. O link pode ser inválido ou o acesso pode não ser permitido.');
                    showUserFacingError('performance', 'Não foi possível carregar os dados de desempenho.');
                    showUserFacingError('reports', 'Não foi possível carregar os dados para os relatórios.');
                }
            }, 5000);
            onSnapshot(collection(db, "artifacts", appId, "users", userId, "players"), (snapshot) => {
                if (timeoutTriggered) return;
                console.log(`Players snapshot received. Found ${snapshot.docs.length} players.`);
                dataLoaded.players = true;
                appState.players = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                refreshCurrentView(); 
            }, (error) => {
                console.error("Erro ao carregar jogadores (verifique as regras de segurança do Firestore):", error);
                showUserFacingError('dashboard', `Erro ao carregar dados: ${error.message}`);
            });
            onSnapshot(query(collection(db, "artifacts", appId, "users", userId, "matches")), (snapshot) => {
                if (timeoutTriggered) return;
                console.log(`Matches snapshot received. Found ${snapshot.docs.length} matches.`);
                dataLoaded.matches = true;
                appState.matches = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                refreshCurrentView();
            }, (error) => {
                console.error("Erro ao carregar partidas (verifique as regras de segurança do Firestore):", error);
                showUserFacingError('dashboard', `Erro ao carregar dados: ${error.message}`);
            });
            onSnapshot(doc(db, "artifacts", appId, "users", userId, "settings", "profile"), (doc) => {
                if (timeoutTriggered) return;
                console.log(`Settings snapshot received. Document exists: ${doc.exists()}`);
                appState.settings = doc.exists() ? doc.data() : {};
                refreshCurrentView();
            }, (error) => {
                console.error("Erro ao carregar configurações:", error);
            });
        }
        
        function refreshCurrentView() {
            if (!appState.currentView) return;
            const activeView = document.getElementById(appState.currentView);
            if (!activeView || !activeView.classList.contains('active')) return;

            switch(appState.currentView) {
                case 'live-match': 
                    if (appState.activeMatchId) {
                        renderLiveScoreAndTimer();
                        renderLiveLog();
                        renderOnFieldPlayers();
                    }
                    break;
                case 'matches': renderMatchList(); break;
                case 'dashboard': renderDashboard(); break;
                case 'performance': renderPerformancePage(); break;
                case 'management': renderPlayersTable(); break;
                case 'reports': renderReportMatchSelect(); break;
            }
        }

        const ui = {
            views: document.querySelectorAll('.view'),
            modalContainer: document.getElementById('modal-container'),
            liveMatch: {
                header: document.querySelector('#live-match #live-match-controls > .bg-gray-800'),
                logBody: document.getElementById('live-log-body'),
                subActionContainer: document.getElementById('sub-action-container'),
                playerListContainer: document.getElementById('live-player-list-container')
            }
        };
        window.navigateTo = function(viewId) {
            if (appState.currentView === 'live-match' && viewId !== 'live-match') {
                appState.activeMatchId = null;
                cancelPlayerSelection(); // Garante que o estado seja limpo ao sair
            }
            
            const blockGuest = ['management', 'matches', 'live-match'];
            if (appState.isGuestMode && blockGuest.includes(viewId)) {
                return;
            }

            if (viewId === 'live-match' && !appState.activeMatchId) {
                console.error("Tentativa de navegar para live-match sem partida ativa.");
                navigateTo('matches'); 
                return;
            }
            
            appState.currentView = viewId;
            document.querySelectorAll('.view').forEach(v => {
                 v.classList.remove('active');
            });
            const targetView = document.getElementById(viewId);
            if(targetView){
                targetView.classList.add('active');
            }

            const mobileMenu = document.getElementById('mobile-menu');
            if (mobileMenu && !mobileMenu.classList.contains('hidden')) { mobileMenu.classList.add('hidden'); }
            
            document.querySelectorAll('.nav-link-top').forEach(l => { 
                l.classList.toggle('active', l.getAttribute('data-view') === viewId);
            });
            refreshCurrentView();
        }


        window.toggleMobileMenu = function() { document.getElementById('mobile-menu').classList.toggle('hidden'); }

        window.openModal = function(modalId) {
            if (modalId === 'new-match-modal') prepareNewMatchModal();
            ui.modalContainer.classList.add('flex');
            ui.modalContainer.classList.remove('hidden');
            document.getElementById(modalId)?.classList.remove('hidden');
        }
        window.closeModal = function(modalId) { 
            ui.modalContainer.classList.add('hidden');
            ui.modalContainer.classList.remove('flex');
            if(modalId) { 
                const modal = document.getElementById(modalId);
                modal?.classList.add('hidden'); 
                if (modalId === 'halftime-report-modal') {
                    document.getElementById('halftime-report-content').innerHTML = '';
                }
            } 
            else { ui.modalContainer.querySelectorAll('.modal-content').forEach(m => m.classList.add('hidden')); }
        }
        window.closeAllModals = function(event) { if (event.target === ui.modalContainer) { closeModal(); }}
        
        function showErrorMessage(message, error) {
            console.error("Erro na Aplicação:", message, error);
            alert(`⚠️ Erro: ${message}`);
        }

        document.getElementById('player-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const form = e.target;
            const id = form.querySelector('#player-id').value;
            const playerData = { name: form.querySelector('#player-name').value, dob: form.querySelector('#player-dob').value, position: form.querySelector('#player-position').value };
            try {
                const collectionRef = collection(db, "artifacts", appId, "users", userId, "players");
                if (id) { await setDoc(doc(collectionRef, id), playerData); } else { await addDoc(collectionRef, playerData); }
                form.reset();
                form.querySelector('#player-id').value = '';
            } catch (error) { showErrorMessage("Não foi possível salvar o jogador", error); }
        });
        window.saveTeamSettings = function() {
            const fileInput = document.getElementById('team-logo-upload');
            const file = fileInput.files[0];
            if (!file) {
                alert("Nenhuma nova imagem de logo selecionada.");
                return;
            }
            if (file.size > 1048576) { // 1MB limit
                alert("O arquivo da logo é muito grande. Por favor, escolha um arquivo menor que 1MB.");
                return;
            }

            const reader = new FileReader();
            reader.onload = async (e) => {
                const logoDataUrl = e.target.result;
                try {
                    await setDoc(doc(db, "artifacts", appId, "users", userId, "settings", "profile"), { logoDataUrl });
                    alert("Logo salva com sucesso!");
                    appState.settings.logoDataUrl = logoDataUrl;
                } catch(err) {
                    showErrorMessage("Não foi possível salvar a logo.", err);
                }
            };
            reader.onerror = () => {
                showErrorMessage("Falha ao ler o arquivo da imagem.");
            };
            reader.readAsDataURL(file);
        }

        document.getElementById('team-logo-upload').addEventListener('change', (event) => {
            const file = event.target.files[0];
            const preview = document.getElementById('logo-preview');
            if (file) {
                preview.src = URL.createObjectURL(file);
                preview.classList.remove('hidden');
            } else {
                preview.classList.add('hidden');
            }
        });
        function renderPlayersTable() {
            const tableBody = document.getElementById('players-table');
            if(!tableBody) return;
            tableBody.innerHTML = !appState.players.length ? '<tr><td colspan="3" class="text-center p-4 text-gray-400">Nenhum jogador cadastrado.</td></tr>' : '';
            [...appState.players].sort((a,b) => a.name.localeCompare(b.name)).forEach(player => {
                const row = tableBody.insertRow();
                row.innerHTML = `<td class="p-3">${player.name}</td><td class="p-3">${player.position}</td><td class="p-3"><button class="text-blue-400 hover:text-blue-300 mr-4 font-semibold" onclick="editPlayer('${player.id}')">Editar</button><button class="text-red-400 hover:text-red-300 font-semibold" onclick="deletePlayer('${player.id}')">Excluir</button></td>`;
            });
        }
        window.editPlayer = function(id) {
            const player = appState.players.find(p => p.id === id);
            const form = document.getElementById('player-form');
            form.querySelector('#player-id').value = player.id;
            form.querySelector('#player-name').value = player.name;
            form.querySelector('#player-dob').value = player.dob;
            form.querySelector('#player-position').value = player.position;
            form.scrollIntoView({ behavior: 'smooth' });
        }
        window.deletePlayer = async function(id) {
            if (confirm("Tem certeza que deseja excluir este jogador?")) {
                try { await deleteDoc(doc(db, "artifacts", appId, "users", userId, "players", id)); } 
                catch (error) { showErrorMessage("Não foi possível excluir o jogador.", error); }
            }
        }
        
        const lineupPositions = { gk: 'Goleiro', rb: 'Lateral Direito', rcb: 'Zagueiro (Dir)', lcb: 'Zagueiro (Esq)', lb: 'Lateral Esquerdo', dm: 'Volante', rcm: 'Meia (Dir)', lcm: 'Meia (Esq)', rw: 'Atacante (Dir)', st: 'Centroavante', lw: 'Atacante (Esq)' };
        function prepareNewMatchModal() {
            document.getElementById('new-match-form').reset();
            const squadList = document.getElementById('match-squad-list');
            squadList.innerHTML = !appState.players.length ? '<p class="text-gray-400">Cadastre jogadores primeiro.</p>' : '';
            [...appState.players].sort((a,b) => a.name.localeCompare(b.name)).forEach(player => { 
                squadList.innerHTML += `<div class="flex items-center"><input type="checkbox" id="squad-${player.id}" value="${player.id}" class="mr-2 h-4 w-4" onchange="updateMatchCreationLists()"><label for="squad-${player.id}">${player.name} (${player.position})</label></div>`; 
            });
            document.getElementById('match-date').valueAsDate = new Date();
            updateMatchCreationLists();
        }

        window.updateMatchCreationLists = () => {
            const lineupContainer = document.getElementById('match-lineup-selection');
            const substitutesContainer = document.getElementById('match-substitutes-list');
            const convocadosCheckboxes = document.querySelectorAll('#match-squad-list input:checked');
            const convocadosIds = new Set(Array.from(convocadosCheckboxes).map(i => i.value));
            const convocadosPlayers = [...appState.players.filter(p => convocadosIds.has(p.id))];

            const allSelects = document.querySelectorAll('#match-lineup-selection select, #match-substitutes-list select');
            const selections = new Map();
            allSelects.forEach(s => { if (s.value) selections.set(s.id, s.value); });
            
            const renderOptions = (currentSelectId) => {
                const currentVal = selections.get(currentSelectId);
                return convocadosPlayers.map(p => {
                    const isSelectedElsewhere = [...selections.values()].includes(p.id) && p.id !== currentVal;
                    return `<option value="${p.id}" ${isSelectedElsewhere ? 'disabled' : ''}>${p.name}</option>`;
                }).join('');
            };
            
            lineupContainer.innerHTML = Object.entries(lineupPositions).map(([key, label]) => {
                const selectId = `lineup-${key}`;
                return `<div class="grid grid-cols-3 items-center gap-2"><label for="${selectId}" class="text-sm col-span-1">${label}:</label><select id="${selectId}" class="w-full p-2 mt-1 col-span-2" onchange="updateMatchCreationLists()"><option value="">Selecione...</option>${renderOptions(selectId)}</select></div>`;
            }).join('');
            substitutesContainer.innerHTML = Array.from({length: 10}).map((_, i) => {
                const selectId = `sub-${i}`;
                return `<div class="grid grid-cols-3 items-center gap-2"><label for="${selectId}" class="text-sm col-span-1">Reserva ${i+1}:</label><select id="${selectId}" class="w-full p-2 mt-1 col-span-2" onchange="updateMatchCreationLists()"><option value="">Vazio</option>${renderOptions(selectId)}</select></div>`;
            }).join('');
            selections.forEach((playerId, selectId) => {
                const selectElement = document.getElementById(selectId);
                if (selectElement) selectElement.value = playerId;
            });
        };

        document.getElementById('new-match-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const lineup = {};
            const lineupPlayerIds = new Set();
            for (const key of Object.keys(lineupPositions)) { 
                const selectElement = document.getElementById(`lineup-${key}`); 
                lineup[key] = selectElement ? selectElement.value : ""; 
                if (lineup[key]) lineupPlayerIds.add(lineup[key]);
            }
            const substitutePlayerIds = new Set();
            for(let i=0; i<10; i++){
                const subSelect = document.getElementById(`sub-${i}`);
                if(subSelect && subSelect.value) substitutePlayerIds.add(subSelect.value);
            }
            const finalSquadIds = [...new Set([...lineupPlayerIds, ...substitutePlayerIds])];
            if (finalSquadIds.length === 0) { return showErrorMessage('Selecione pelo menos um jogador para a partida.'); }
            
            const matchData = { 
                myTeamName: document.getElementById('match-my-team-name').value || "Minha Equipe", 
                opponentName: document.getElementById('match-opponent-name').value, 
                date: document.getElementById('match-date').value, 
                location: document.getElementById('match-location').value, 
                squadPlayerIds: finalSquadIds, 
                lineup, 
                substitutes: Array.from(substitutePlayerIds),
                myTeamScore: 0, 
                opponentScore: 0, 
                status: 'scheduled', 
                events: [], 
                possession: { myTeam: 0, opponent: 0, stopped: 0 }, 
                ratings: {} 
            };
            try { await addDoc(collection(db, "artifacts", appId, "users", userId, "matches"), matchData); e.target.reset(); closeModal('new-match-modal'); } 
            catch (error) { showErrorMessage("Não foi possível criar a partida.", error); }
        });
        
        function renderMatchList() {
            const listEl = document.getElementById('match-list');
            if(!listEl) return;
            listEl.innerHTML = '';
            [...appState.matches].sort((a,b) => new Date(b.date) - new Date(a.date)).forEach(match => {
                const card = document.createElement('div');
                card.className = 'bg-gray-800 p-4 rounded-lg flex justify-between items-center transition hover:bg-gray-700 flex-wrap gap-4';
                const statusConfig = {
                    finished: { content: `<span class="font-bold text-2xl">${match.myTeamScore} - ${match.opponentScore}</span>` },
                    live: { content: `<button class="bg-yellow-600 hover:bg-yellow-700 text-white font-bold py-2 px-4 rounded" onclick="startLiveMatch('${match.id}')">Continuar</button>` },
                    scheduled: { content: `<button class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded" onclick="startLiveMatch('${match.id}')">Iniciar Scout</button>` }
                };
                card.innerHTML = `<div><p class="text-xl font-bold">${match.myTeamName} vs ${match.opponentName}</p><p class="text-sm text-gray-400">${new Date(match.date).toLocaleDateString('pt-BR', {timeZone: 'UTC'})} - ${match.location || 'Local não definido'}</p></div><div class="flex items-center gap-4">${statusConfig[match.status]?.content || ''}<button onclick="deleteMatch('${match.id}')" title="Excluir" class="text-red-500 hover:text-red-400 p-2 rounded-full admin-only"><svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg></button></div>`;
                listEl.appendChild(card);
            });
        }
        
        window.deleteMatch = async function(id) { 
            if (confirm("Tem certeza que deseja excluir esta partida?")) {
                try { await deleteDoc(doc(db, "artifacts", appId, "users", userId, "matches", id)); } 
                catch (e) { showErrorMessage("Não foi possível excluir a partida.", e); }
            } 
        }
        
        function formatTime(s) { const min = Math.floor(s / 60).toString().padStart(2, '0'); const sec = (s % 60).toString().padStart(2, '0'); return `${min}:${sec}`; }
        async function updateMatchData(matchId, data) { try { await updateDoc(doc(db, "artifacts", appId, "users", userId, "matches", matchId), data); } catch (e) { showErrorMessage("Não foi possível atualizar dados.", e); } }
        
        function toggleFullScreen() {
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen().catch(err => {
                    alert(`Não foi possível ativar o modo tela cheia: ${err.message}`);
                });
            } else {
                if (document.exitFullscreen) {
                    document.exitFullscreen();
                }
            }
        }
        window.toggleFullScreen = toggleFullScreen;
        window.startLiveMatch = async function(matchId) {
            appState.activeMatchId = matchId;
            const match = appState.matches.find(m => m.id === matchId);
            if(!match) return;
            if (match.status !== 'live') { await updateMatchData(matchId, { status: 'live' }); }
            liveState = { 
                timerInterval: null, 
                possessionInterval: null, 
                seconds: match.timerSeconds || 0, 
                currentPeriod: match.timerPeriod || 0, 
                currentPossessionHolder: null, 
                activeSubAction: null,
                secondHalfStartSeconds: match.secondHalfStartSeconds || -1,
                awaitingPlayerSelection: null, 
                selectedZone: 'meio', 
                isFieldInverted: false
            };
            navigateTo('live-match');
        }
        
        function renderLiveScoreAndTimer() {
            const match = appState.matches.find(m => m.id === appState.activeMatchId);
            if (!match || !ui.liveMatch.header) return;

            let displaySeconds = liveState.seconds;
            if (liveState.currentPeriod === 2 && liveState.secondHalfStartSeconds !== -1) {
                displaySeconds = liveState.seconds - liveState.secondHalfStartSeconds;
            }

            ui.liveMatch.header.innerHTML = `<div class="flex justify-between items-center text-white gap-2"><div class="text-base font-bold text-center truncate flex-1">${match.myTeamName}</div><div class="text-2xl font-black whitespace-nowrap">${match.myTeamScore} - ${match.opponentScore}</div><div class="text-base font-bold text-center truncate flex-1">${match.opponentName}</div></div><div class="text-center text-5xl font-black text-white my-2" id="live-timer">${formatTime(displaySeconds)}</div><div class="flex justify-center items-center gap-2 flex-wrap"><button class="bg-green-600 px-2 py-1 rounded text-xs" onclick="timerControl('start1')">▶ 1ºT</button><button class="bg-yellow-500 px-2 py-1 rounded text-xs" onclick="timerControl('pause')">⏸ Int.</button><button class="bg-green-600 px-2 py-1 rounded text-xs" onclick="timerControl('start2')">▶ 2ºT</button><button class="bg-orange-500 px-2 py-1 rounded text-xs" onclick="prepareSubstitutionModal()">🔃 Substituição</button><button class="bg-blue-600 px-2 py-1 rounded text-xs" onclick="showHalftimeReport()">Rel. 1ºT</button><button class="bg-red-600 px-2 py-1 rounded text-xs" onclick="timerControl('end')">⏹ Fim</button><button onclick="toggleFullScreen()" class="p-2 rounded-md text-gray-300 hover:bg-gray-700 md:hidden" title="Tela Cheia"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M3 4a1 1 0 011-1h4a1 1 0 110 2H5v2a1 1 0 11-2 0V4zm14 0a1 1 0 00-1-1h-4a1 1 0 100 2h3v2a1 1 0 102 0V4zm-2 10v2h-3a1 1 0 100 2h4a1 1 0 001-1v-4a1 1 0 10-2 0zM5 14v2h3a1 1 0 110 2H4a1 1 0 01-1-1v-4a1 1 0 112 0z" clip-rule="evenodd" /></svg></button></div><div class="flex gap-2 mt-2"><button class="w-1/2 bg-green-700 hover:bg-green-800 p-2 rounded-lg text-white font-bold" onclick="prepareGoalModal('myTeam')">GOL PRÓ</button><button class="w-1/2 bg-red-800 hover:bg-red-900 p-2 rounded-lg text-white font-bold" onclick="logGoal('opponent')">GOL CONTRA</button></div>`;
            const possessionArea = document.getElementById('possession-area');
            if (possessionArea) {
                const myTeamActiveClass = liveState.currentPossessionHolder === 'myTeam' ? 'active' : '';
                const opponentActiveClass = liveState.currentPossessionHolder === 'opponent' ? 'active' : '';
                const stoppedActiveClass = liveState.currentPossessionHolder === 'stopped' ? 'active' : '';

                possessionArea.innerHTML = `
                    <div class="bg-gray-900/70 p-3 rounded-lg">
                        <div class="flex items-stretch gap-2">
                            <button id="possession-myTeam" onclick="togglePossession('myTeam')" class="possession-btn main-team bg-red-600 text-white rounded flex-grow text-base py-2 ${myTeamActiveClass}">${match.myTeamName}</button>
                            <button id="possession-opponent" onclick="togglePossession('opponent')" class="possession-btn main-team bg-blue-600 text-white rounded flex-grow text-base py-2 ${opponentActiveClass}">${match.opponentName}</button>
                            <button id="possession-stopped" onclick="togglePossession('stopped')" class="possession-btn bg-gray-500 text-white rounded px-4 ${stoppedActiveClass}">Parada</button>
                        </div>
                         <h3 class="text-center text-sm font-bold text-white mt-2">Controle de Posse de Bola</h3>
                    </div>`;
            }
        }

        document.getElementById('substitution-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const match = appState.matches.find(m => m.id === appState.activeMatchId);
            if (!match) return;

            const playerOutId = document.getElementById('player-out').value;
            const playerInId = document.getElementById('player-in').value;

            if (playerOutId === playerInId) {
                return showErrorMessage("O jogador que entra não pode ser o mesmo que sai.");
            }

            const playerOut = appState.players.find(p => p.id === playerOutId);
            const playerIn = appState.players.find(p => p.id === playerInId);

            const newEvent = {
                time: liveState.seconds,
                period: liveState.currentPeriod,
                action: 'substituicao',
                detail: `Sai ${playerOut?.name || 'N/A'}, Entra ${playerIn?.name || 'N/A'}`,
                playerOutId: playerOutId,
                playerInId: playerInId,
                playerName: `Sai: ${playerOut?.name} / Entra: ${playerIn?.name}`
            };
            try {
                await updateMatchData(appState.activeMatchId, { events: [newEvent, ...(match.events || [])] });
                closeModal('substitution-modal');
                renderOnFieldPlayers();
            } catch (error) {
                showErrorMessage("Não foi possível salvar a substituição.", error);
            }
        });

        function getPlayersOnFieldAndBench(match) {
            let onField = new Set(Object.values(match.lineup).filter(Boolean));
            const subs = (match.events || []).filter(e => e.action === 'substituicao').sort((a,b) => a.time - b.time);
            subs.forEach(sub => {
                if (sub.playerOutId) onField.delete(sub.playerOutId);
                if (sub.playerInId) onField.add(sub.playerInId);
            });
            const onBench = match.squadPlayerIds.filter(pid => !onField.has(pid));
            
            return { onField: Array.from(onField), onBench };
        }

        window.prepareSubstitutionModal = function() {
            const match = appState.matches.find(m => m.id === appState.activeMatchId);
            if (!match || liveState.currentPeriod === 0) {
                return showErrorMessage("Inicie o cronômetro para fazer substituições.");
            }
            cancelPlayerSelection();

            const { onField, onBench } = getPlayersOnFieldAndBench(match);
            const getPlayerOptions = (playerIds) => {
                return playerIds.map(pid => {
                    const player = appState.players.find(p => p.id === pid);
                    return player ? `<option value="${pid}">${player.name}</option>` : '';
                }).join('');
            };

            document.getElementById('player-out').innerHTML = getPlayerOptions(onField);
            document.getElementById('player-in').innerHTML = getPlayerOptions(onBench);

            openModal('substitution-modal');
        }

        window.toggleLog = function() {
            const container = document.getElementById('live-log-container');
            const content = document.getElementById('live-log-content');
            container.classList.toggle('open');
            content.classList.toggle('hidden');
        }

        window.timerControl = function(action) {
            clearInterval(liveState.timerInterval);
            let shouldStartTimer = false;
            const match = appState.matches.find(m => m.id === appState.activeMatchId);
            cancelPlayerSelection();

            if (action === 'start1') { 
                liveState.currentPeriod = 1;
                liveState.secondHalfStartSeconds = -1;
                updateMatchData(appState.activeMatchId, { secondHalfStartSeconds: -1 });
                shouldStartTimer = true;
            }
            else if (action === 'start2') { 
                liveState.currentPeriod = 2;
                if (match && !match.possession1T) {
                    updateMatchData(appState.activeMatchId, { possession1T: match.possession });
                }
                if (liveState.secondHalfStartSeconds === -1) {
                    liveState.secondHalfStartSeconds = liveState.seconds;
                    updateMatchData(appState.activeMatchId, { secondHalfStartSeconds: liveState.seconds });
                }
                shouldStartTimer = true;
            } 
            else if (action === 'pause') {
                if (liveState.currentPeriod === 1 && match) {
                    updateMatchData(appState.activeMatchId, { possession1T: match.possession });
                }
            }
            else if (action === 'end') { 
                togglePossession(null);
                updateMatchData(appState.activeMatchId, { timerSeconds: liveState.seconds, timerPeriod: liveState.currentPeriod }); 
                prepareRatingModal(); 
                openModal('rating-modal'); 
            }
            
            if (shouldStartTimer) {
                liveState.timerInterval = setInterval(() => { 
                    liveState.seconds++; 
                    const timerEl = document.getElementById('live-timer');
                    
                    let displaySeconds = liveState.seconds;
                    if (liveState.currentPeriod === 2 && liveState.secondHalfStartSeconds > -1) {
                         displaySeconds = liveState.seconds - liveState.secondHalfStartSeconds;
                    }

                    if (timerEl) timerEl.textContent = formatTime(displaySeconds);
                    
                    if (liveState.seconds % 10 === 0) { 
                        updateMatchData(appState.activeMatchId, { timerSeconds: liveState.seconds, timerPeriod: liveState.currentPeriod }); 
                    }
                }, 1000);
            }
            updateMatchData(appState.activeMatchId, { timerSeconds: liveState.seconds, timerPeriod: liveState.currentPeriod });
        }

        window.togglePossession = function(team) {
            clearInterval(liveState.possessionInterval);
            if (team && liveState.currentPossessionHolder !== team) {
                liveState.currentPossessionHolder = team;
                liveState.possessionInterval = setInterval(() => { 
                    const match = appState.matches.find(m => m.id === appState.activeMatchId);
                    if(match) { const updatedPossession = { ...match.possession }; updatedPossession[team]++; updateMatchData(appState.activeMatchId, { possession: updatedPossession }); }
                }, 1000);
            } else { 
                liveState.currentPossessionHolder = null;
            }
            renderLiveScoreAndTimer();
        }
        
        const eventConfig = {
            finalizacao: { title: "Finalização", player: true, sub: [{label: "Dentro da área", value: "dentro_area"},{label: "Fora da área", value: "fora_area"},{label: "Cabeceio", value: "cabeceio"}] },
            finalizacao_adv: { title: "Finalização Adv.", player: false, sub: [{label: "Dentro da Área", value: "dentro_area"},{label: "Fora da Área", value: "fora_area"},{label: "Cabeceio", value: "cabeceio"}] },
            chance_clara: { title: "Chance Clara", player: true },
            chance_clara_adv: { title: "Chance Adv.", player: false },
            duelo_ganho: { title: "Duelo Ganho", player: true },
            duelo_perdido: { title: "Duelo Perdido", player: true },
            falta: { title: "Tipo de Falta", player: true, sub: [{label: "Sofrida", value: "falta_sofrida"}, {label:"Cometida", value:"falta_cometida"}] },
            cruzamento: { title: "Lado do Cruzamento", player: true, sub: [{label: "Direita", value: "cruzamento_dir"}, {label:"Esquerda", value:"cruzamento_esq"}] },
            passe_certo: { title: "Passe Certo", player: true },
            passe_errado: { title: "Passe Errado", player: true }
        };

        function flashButton(btn) {
            if (!btn) return;
            btn.classList.add('flash-feedback');
            setTimeout(() => {
                btn.classList.remove('flash-feedback');
            }, 400);
        }

        window.logEvent = (event, action) => {
            const button = event.currentTarget;
            flashButton(button);

            const zone = liveState.selectedZone;
            const match = appState.matches.find(m => m.id === appState.activeMatchId);
            if (!match || liveState.currentPeriod === 0) return showErrorMessage("Inicie o cronômetro para registrar eventos.");
            
            if (liveState.awaitingPlayerSelection) {
                cancelPlayerSelection();
            }

            const config = eventConfig[action];
            if (!config) return console.error(`Ação não configurada: ${action}`);

            if (config.sub) {
                liveState.activeSubAction = { zone, action, config };
                renderSubActions();
            } else if (config.player) {
                liveState.awaitingPlayerSelection = { zone, action, detail: 'N/A', config };
                showPlayerSelection();
            } else {
                finalizeEvent(zone, action, 'N/A', null);
            }
        };

        function renderSubActions() {
            ui.liveMatch.subActionContainer.innerHTML = '';
            if (!liveState.activeSubAction) return;
            const { config } = liveState.activeSubAction;
            let subActionsHTML = `<div class="flex justify-center items-center gap-3 bg-gray-900 p-3 rounded-lg"><span class="font-bold text-white">${config.title}:</span>`;
            config.sub.forEach(opt => { subActionsHTML += `<button class="action-btn bg-blue-600" onclick="handleSubActionClick(event, '${opt.value}')">${opt.label}</button>`; });
            subActionsHTML += `</div>`;
            ui.liveMatch.subActionContainer.innerHTML = subActionsHTML;
        }

        window.handleSubActionClick = (event, value) => {
            flashButton(event.currentTarget);
            const { zone, action, config } = liveState.activeSubAction;
            ui.liveMatch.subActionContainer.innerHTML = ''; 

            const isComplexAction = action === 'falta' || action === 'cruzamento';
            const finalAction = isComplexAction ? value : action;
            const finalDetail = isComplexAction ? 'N/A' : value;
            const finalConfig = eventConfig[finalAction] || config;

            if (finalConfig.player) {
                liveState.awaitingPlayerSelection = { zone, action: finalAction, detail: finalDetail, config: finalConfig };
                showPlayerSelection();
            } else { 
                finalizeEvent(zone, finalAction, finalDetail, null);
            }
            liveState.activeSubAction = null;
        }
        
        window.selectPlayerForAction = (playerId) => {
            if (!liveState.awaitingPlayerSelection) return;
            const { zone, action, detail } = liveState.awaitingPlayerSelection;
            finalizeEvent(zone, action, detail, playerId);
            cancelPlayerSelection(); // Limpa e esconde a lista
        }

        window.cancelPlayerSelection = () => {
             liveState.awaitingPlayerSelection = null;
             if (ui.liveMatch.playerListContainer) {
                 ui.liveMatch.playerListContainer.classList.remove('awaiting-selection');
             }
        }

        function showPlayerSelection() {
            if (!ui.liveMatch.playerListContainer || !liveState.awaitingPlayerSelection) return;
            const { config } = liveState.awaitingPlayerSelection;
            const labelEl = document.getElementById('awaiting-action-label');
            if(labelEl) labelEl.textContent = `AÇÃO: ${config.title}`;
            ui.liveMatch.playerListContainer.classList.add('awaiting-selection');
            ui.liveMatch.playerListContainer.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }


        async function finalizeEvent(zone, action, detail, playerId) {
            const match = appState.matches.find(m => m.id === appState.activeMatchId);
            if(!match) return;
            const player = playerId ? appState.players.find(p => p.id === playerId) : null;
            const newEvent = { time: liveState.seconds, period: liveState.currentPeriod, zone, action, detail, playerId, playerName: player?.name || 'N/A' };
            await updateMatchData(appState.activeMatchId, { events: [newEvent, ...(match.events || [])] });
        }

        function renderLiveLog() {
            const match = appState.matches.find(m => m.id === appState.activeMatchId);
            if (!match || !match.events || !ui.liveMatch.logBody) return;
            ui.liveMatch.logBody.innerHTML = '';

            const eventsToShow = match.events;
            eventsToShow.forEach(ev => {
                const row = ui.liveMatch.logBody.insertRow();
                const detailText = (ev.detail && ev.detail !== 'N/A') ? ev.detail.replace(/_/g, ' ') : '';
                row.innerHTML = `<td class="p-1 text-xs">${formatTime(ev.time)}</td><td class="p-1 text-xs">${ev.period}ºT</td><td class="p-1 text-xs">${ev.zone}</td><td class="p-1 text-xs">${(ev.action || '').replace(/_/g, ' ')}</td><td class="p-1 text-xs">${detailText}</td><td class="p-1 text-xs">${ev.playerName}</td>`;
            });
        }
window.undoLastAction = async function() {
            if (!appState.activeMatchId) return;
            const match = appState.matches.find(m => m.id === appState.activeMatchId);
            if (!match || !match.events || match.events.length === 0) {
                alert("Nenhuma ação para desfazer.");
                return;
            }
            cancelPlayerSelection();

            const lastEvent = match.events[0];
            const updatedEvents = match.events.slice(1);
            
            const updateData = {
                events: updatedEvents
            };
            if (lastEvent.action === 'gol') {
                updateData.myTeamScore = Math.max(0, match.myTeamScore - 1);
            } else if (lastEvent.action === 'gol_contra') {
                updateData.opponentScore = Math.max(0, match.opponentScore - 1);
            }
            
            try {
                await updateMatchData(appState.activeMatchId, updateData);
            } catch(e) {
                showErrorMessage("Não foi possível desfazer a ação.", e);
            }
        }
        
        window.logGoal = async (teamType) => {
            const match = appState.matches.find(m => m.id === appState.activeMatchId);
            if(!match || liveState.currentPeriod === 0) return showErrorMessage("Inicie o cronômetro.");
            cancelPlayerSelection();
            if (teamType === 'opponent') {
                const newEvent = { time: liveState.seconds, period: liveState.currentPeriod, zone: 'ataque', action: 'gol_contra', detail: 'N/A', playerId: null, playerName: 'Adversário', scoringTeam: 'opponent' };
                const updatedEvents = [newEvent, ...(match.events || [])];
                await updateMatchData(appState.activeMatchId, { events: updatedEvents, opponentScore: match.opponentScore + 1 });
            }
        };
        
        window.prepareGoalModal = (teamType) => {
            const match = appState.matches.find(m => m.id === appState.activeMatchId);
            if(!match || liveState.currentPeriod === 0) return showErrorMessage("Inicie o cronômetro.");
            cancelPlayerSelection();

            const modal = document.getElementById('goal-modal');
            const players = match.squadPlayerIds.map(pid => appState.players.find(p => p.id === pid)).filter(Boolean);
            const playerOptions = [...players].sort((a,b) => a.name.localeCompare(b.name)).map(p => `<option value="${p.id}">${p.name}</option>`).join('');
            modal.innerHTML = `<h3 class="text-2xl font-bold mb-4">Registrar Gol</h3><form id="goal-form"><div><label class="block mb-1">Jogador:</label><select id="goal-player" class="w-full p-2 rounded mb-2">${playerOptions}</select></div><div><label class="block mb-1">Assistência:</label><select id="goal-assist" class="w-full p-2 rounded mb-2"><option value="">Nenhuma</option>${playerOptions}</select></div><div><label class="block mb-1">Tipo de Gol:</label><select id="goal-type" class="w-full p-2 rounded mb-2"><option>Dentro da Área</option><option>Bola Parada</option><option>Pênalti</option><option>Cabeça</option><option>Chute Fora da Área</option></select></div><button type="submit" class="w-full bg-green-600 p-2.5 rounded mt-4">Confirmar Gol</button></form>`;
            openModal('goal-modal');
            document.getElementById('goal-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const data = { goalPlayerId: e.target.elements['goal-player'].value, assistPlayerId: e.target.elements['goal-assist'].value, goalType: e.target.elements['goal-type'].value };
                const goalPlayer = appState.players.find(p => p.id === data.goalPlayerId);
                const assistPlayer = data.assistPlayerId ? appState.players.find(p => p.id === data.assistPlayerId) : null;
   
                const newEvent = { time: liveState.seconds, period: liveState.currentPeriod, zone: 'ataque', action: 'gol', detail: data.goalType, playerId: data.goalPlayerId, playerName: goalPlayer?.name || 'N/A', assistId: data.assistPlayerId || null, assistName: assistPlayer?.name || null, scoringTeam: 'myTeam' };
                await updateMatchData(appState.activeMatchId, { events: [newEvent, ...(match.events || [])], myTeamScore: match.myTeamScore + 1 });
                closeModal('goal-modal');
            });
        };

        window.updateRatingValue = function(slider) { const valueSpan = document.getElementById(slider.id.replace('rating-', 'rating-value-')); if (valueSpan) { valueSpan.textContent = slider.value; } }

        window.togglePlayerRatingInputs = function(playerId) {
            const checkbox = document.getElementById(`did-not-play-${playerId}`);
            const inputsContainer = document.getElementById(`rating-inputs-${playerId}`);
            const sliders = inputsContainer.querySelectorAll('input[type="range"]');
            
            if (checkbox.checked) {
                sliders.forEach(slider => slider.disabled = true);
                inputsContainer.style.opacity = '0.5';
            } else {
                sliders.forEach(slider => slider.disabled = false);
                inputsContainer.style.opacity = '1';
            }
        }
        
        function prepareRatingModal() {
            const match = appState.matches.find(m => m.id === appState.activeMatchId);
            if (!match) return;

            const lineupOrder = ['gk', 'rb', 'rcb', 'lcb', 'lb', 'dm', 'rcm', 'lcm', 'rw', 'st', 'lw'];
            const lineupPlayerIds = new Set();

            const starters = lineupOrder
                .map(posKey => match.lineup[posKey])
                .filter(Boolean)
                .map(playerId => {
                    lineupPlayerIds.add(playerId);
                    return appState.players.find(p => p.id === playerId);
                })
                .filter(Boolean);
            const substitutes = match.squadPlayerIds
                .filter(playerId => !lineupPlayerIds.has(playerId))
                .map(playerId => appState.players.find(p => p.id === playerId))
                .filter(Boolean)
                .sort((a, b) => a.name.localeCompare(b.name));
            const orderedPlayers = [...starters, ...substitutes];
            
            const listEl = document.getElementById('rating-player-list');
            listEl.innerHTML = orderedPlayers.map(p => `
                <div class="bg-gray-700 p-3 rounded-lg">
                    <div class="flex items-center justify-between mb-2">
                         <h4 class="text-lg font-bold">${p.name}</h4>
                        <div class="flex items-center">
                            <label for="did-not-play-${p.id}" class="text-sm mr-2 text-gray-300">Não jogou</label>
                            <input type="checkbox" id="did-not-play-${p.id}" onchange="togglePlayerRatingInputs('${p.id}')" class="h-4 w-4">
                        </div>
                    </div>
                    <div id="rating-inputs-${p.id}" class="grid grid-cols-2 md:grid-cols-4 gap-4 mt-2 transition-opacity duration-300">
                        ${['Técnico', 'Tático', 'Físico', 'Comportamental'].map(cat => `
                            <div>
                                <div class="flex justify-between text-sm">
                                    <label for="rating-${p.id}-${cat.toLowerCase()}">${cat}</label>
                                    <span id="rating-value-${p.id}-${cat.toLowerCase()}" class="font-bold">5</span>
                                </div>
                                <input type="range" id="rating-${p.id}-${cat.toLowerCase()}" min="1" max="10" value="5" class="w-full mt-1" oninput="updateRatingValue(this)">
                            </div>
                        `).join('')}
                    </div>
                </div>
            `).join('');
        }
        
        window.saveRatings = async function() {
            const match = appState.matches.find(m => m.id === appState.activeMatchId);
            if(!match) return;
            const ratings = {};
            match.squadPlayerIds.forEach(pid => {
                const didNotPlayCheckbox = document.getElementById(`did-not-play-${pid}`);
                if (didNotPlayCheckbox && didNotPlayCheckbox.checked) {
                    ratings[pid] = { played: false };
                } else {
                    ratings[pid] = {
                        played: true,
                        tecnico: document.getElementById(`rating-${pid}-técnico`)?.value || 5,
                        tatico: document.getElementById(`rating-${pid}-tático`)?.value || 5,
                        fisico: document.getElementById(`rating-${pid}-físico`)?.value || 5,
                        comportamental: document.getElementById(`rating-${pid}-comportamental`)?.value || 5,
                    };
                }
            });
            await updateMatchData(appState.activeMatchId, { status: 'finished', ratings: ratings });
            
            closeModal('rating-modal'); 
            navigateTo('matches');
            if (document.fullscreenElement) {
                document.exitFullscreen();
            }
        }

        function renderDashboard() {
            const container = document.getElementById('dashboard');
            if(!container) return;
            const finishedMatches = appState.matches.filter(m => m.status === 'finished');
            const totalGames = finishedMatches.length;
            const totalGoalsScored = finishedMatches.reduce((acc, m) => acc + (m.myTeamScore || 0), 0);
            const totalGoalsConceded = finishedMatches.reduce((acc, m) => acc + (m.opponentScore || 0), 0);
            let wins = 0, draws = 0, losses = 0;
            finishedMatches.forEach(m => { if (m.myTeamScore > m.opponentScore) wins++; else if (m.myTeamScore < m.opponentScore) losses++; else draws++; });
            const aproveitamento = totalGames > 0 ? (((wins * 3 + draws) / (totalGames * 3)) * 100).toFixed(0) : 0;
            const last5Matches = [...finishedMatches].sort((a,b) => new Date(b.date) - new Date(a.date)).slice(0,5).map(m => { let result = 'E', color = 'bg-yellow-500'; if (m.myTeamScore > m.opponentScore) { result = 'V'; color = 'bg-green-500'; } if (m.myTeamScore < m.opponentScore) { result = 'D'; color = 'bg-red-500'; } return `<span class="w-8 h-8 flex items-center justify-center text-white font-bold rounded-full ${color}">${result}</span>`; }).join('');
            let totalPossessionPercent = 0;
            let totalTeamShots = 0;
            let totalTeamClearChances = 0;
            let totalOpponentShots = 0;
            let totalOpponentClearChances = 0;
            finishedMatches.forEach(m => {
                const possession = m.possession || { myTeam: 0, opponent: 0, stopped: 0 };
                const totalPossessionSeconds = possession.myTeam + possession.opponent;
                if (totalPossessionSeconds > 0) {
                    totalPossessionPercent += (possession.myTeam / totalPossessionSeconds) * 100;
                }
                if (m.events && m.events.length > 0) {
                    totalTeamShots += m.events.filter(e => e.action === 'finalizacao').length;
                    totalTeamClearChances += m.events.filter(e => e.action === 'chance_clara').length;
                    totalOpponentShots += m.events.filter(e => e.action === 'finalizacao_adv').length;
                    totalOpponentClearChances += m.events.filter(e => e.action === 'chance_clara_adv').length;
                }
            });
            const avgPossession = totalGames > 0 ? (totalPossessionPercent / totalGames).toFixed(1) : '0.0';
            const avgTeamShots = totalGames > 0 ? (totalTeamShots / totalGames).toFixed(1) : '0.0';
            const avgTeamClearChances = totalGames > 0 ? (totalTeamClearChances / totalGames).toFixed(1) : '0.0';
            const avgOpponentShots = totalGames > 0 ? (totalOpponentShots / totalGames).toFixed(1) : '0.0';
            const avgOpponentClearChances = totalGames > 0 ? (totalOpponentClearChances / totalGames).toFixed(1) : '0.0';
            
            const allPerformances = [];
            finishedMatches.forEach(m => { 
                if(!m.ratings) return; 
                Object.entries(m.ratings).forEach(([pid, rates]) => { 
                    if (!rates.played) return; 
                    const avg = (parseFloat(rates.tecnico) + parseFloat(rates.tatico) + parseFloat(rates.fisico) + parseFloat(rates.comportamental)) / 4;
                    const player = appState.players.find(p => p.id === pid); 
                    if(player) allPerformances.push({ name: player.name, score: avg, date: m.date }); 
                }); 
            });
            const topPerformances = [...allPerformances].sort((a,b) => b.score - a.score).slice(0, 5).map(p => `<li class="flex justify-between items-center text-gray-300 py-1"><div>${p.name}<p class="text-xs text-gray-500">${new Date(p.date).toLocaleDateString('pt-BR', {timeZone: 'UTC'})}</p></div><strong class="text-white">Nota ${p.score.toFixed(1)}</strong></li>`).join('');
            container.innerHTML = `<h2 class="text-3xl font-bold text-white mb-6">Dashboard</h2>
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <div id="team-stats-card" class="lg:col-span-3 dashboard-card p-6 rounded-lg flex flex-col items-center gap-6">
                        <div id="dashboard-logo-container" class="hidden flex-shrink-0">
                            <img id="dashboard-logo" src="" class="max-h-24 rounded-lg bg-white/10 p-2" alt="Logo do Time">
                        </div>
                        <div class="flex-1 w-full">
                             <h3 class="font-bold text-xl mb-4 text-white text-center md:text-left">Estatísticas Gerais</h3>
                             <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-5 lg:grid-cols-9 gap-4 text-center">
                                <div><p class="text-4xl font-extrabold">${totalGames}</p><p class="text-gray-400">Jogos</p></div><div class="text-green-400"><p class="text-4xl font-extrabold">${wins}</p><p class="text-gray-400">Vitórias</p></div><div class="text-yellow-400"><p class="text-4xl font-extrabold">${draws}</p><p class="text-gray-400">Empates</p></div><div class="text-red-400"><p class="text-4xl font-extrabold">${losses}</p><p class="text-gray-400">Derrotas</p></div><div class="text-blue-400"><p class="text-4xl font-extrabold">${aproveitamento}%</p><p class="text-gray-400">Aproveitamento</p></div><div><p class="text-4xl font-extrabold text-green-400">${totalGoalsScored}</p><p class="text-gray-400">Gols Marcados</p></div><div><p class="text-4xl font-extrabold text-red-400">${totalGoalsConceded}</p><p class="text-gray-400">Gols Sofridos</p></div><div><p class="text-4xl font-extrabold">${(totalGames > 0 ? (totalGoalsScored/totalGames).toFixed(2) : '0.00')}</p><p class="text-gray-400">Gols p/ Jogo</p></div><div><p class="text-4xl font-extrabold">${(totalGames > 0 ? (totalGoalsConceded/totalGames).toFixed(2) : '0.00')}</p><p class="text-gray-400">Sofridos p/ Jogo</p></div>
                            </div>
                            <div class="mt-6 pt-4 border-t border-gray-700 w-full">
                                 <button onclick="toggleAdvancedStats()" id="advanced-stats-toggle" class="text-blue-400 hover:text-blue-300 w-full text-center p-2 bg-gray-800 rounded-md transition">Ver Estatísticas Avançadas ▼</button>
                                <div id="advanced-stats-container" class="hidden mt-4 grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-5 gap-4 text-center">
                                     <div><p class="text-3xl font-bold">${avgPossession}%</p><p class="text-gray-400 text-sm">Posse/Jogo</p></div>
                                    <div><p class="text-3xl font-bold text-green-400">${avgTeamShots}</p><p class="text-gray-400 text-sm">Finalizações/Jogo</p></div>
                                    <div><p class="text-3xl font-bold text-green-400">${avgTeamClearChances}</p><p class="text-gray-400 text-sm">Chances Claras/Jogo</p></div>
                                    <div><p class="text-3xl font-bold text-red-400">${avgOpponentShots}</p><p class="text-gray-400 text-sm">Fin. Adv./Jogo</p></div>
                                    <div><p class="text-3xl font-bold text-red-400">${avgOpponentClearChances}</p><p class="text-gray-400 text-sm">Chances Adv./Jogo</p></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="dashboard-card p-6 rounded-lg lg:col-span-1"><h3 class="font-bold text-lg mb-4">Últimos 5 Resultados</h3><div class="flex justify-center gap-3">${last5Matches || '<p class="text-gray-400">Nenhuma partida finalizada.</p>'}</div></div>
                    <div id="performance-history-card" class="dashboard-card p-6 rounded-lg lg:col-span-2"><h3 class="font-bold text-lg mb-4">Melhores Desempenhos Recentes</h3><ul class="space-y-2">${topPerformances || '<p class="text-gray-400">Nenhuma avaliação registrada.</p>'}</ul></div>
                </div>`;
            const logoContainer = document.getElementById('dashboard-logo-container');
            const logoImg = document.getElementById('dashboard-logo');
            if (appState.settings.logoDataUrl && logoContainer && logoImg) {
                logoImg.src = appState.settings.logoDataUrl;
                logoContainer.classList.remove('hidden');
            }
        }

        window.togglePerformanceDetails = function(row) {
            const detailsRow = row.nextElementSibling;
            if (detailsRow && detailsRow.classList.contains('performance-details-row')) {
                detailsRow.classList.toggle('hidden');
                row.classList.toggle('open');
            }
        }
        
        function calculateMinutesPlayed(match) {
            if (!match || !match.lineup || match.status !== 'finished') {
                return {};
            }

            const playerMinutes = {};
            const onFieldStints = {};
            Object.values(match.lineup).forEach(playerId => {
                if (playerId) {
                    onFieldStints[playerId] = 0;
                }
            });
            const subEvents = (match.events || [])
                .filter(e => e.action === 'substituicao')
                .sort((a, b) => a.time - b.time);
            subEvents.forEach(sub => {
                const { time, playerOutId, playerInId } = sub;

                if (playerOutId && onFieldStints.hasOwnProperty(playerOutId)) {
                    const duration = time - onFieldStints[playerOutId];
                    playerMinutes[playerOutId] = (playerMinutes[playerOutId] || 0) + duration;
                    delete onFieldStints[playerOutId];
                }

                if (playerInId) {
                    onFieldStints[playerInId] = time;
                }
            });

            const matchEndTime = match.timerSeconds || 0;
            Object.keys(onFieldStints).forEach(playerId => {
                const duration = matchEndTime - onFieldStints[playerId];
                playerMinutes[playerId] = (playerMinutes[playerId] || 0) + duration;
            });
            for (const pid in playerMinutes) {
                playerMinutes[pid] = Math.round(playerMinutes[pid] / 60);
            }

            return playerMinutes;
        }

        function renderPerformancePage() {
            const container = document.getElementById('performance');
            if (!container) return;

            const performances = {};
            appState.players.forEach(p => {
                performances[p.id] = { name: p.name, position: p.position, matchPerformances: [] };
            });
            const finishedMatches = appState.matches.filter(m => m.status === 'finished' && m.ratings);
            const minutesByMatch = finishedMatches.reduce((acc, match) => {
                acc[match.id] = calculateMinutesPlayed(match);
                return acc;
            }, {});
            finishedMatches.forEach(match => {
                const matchEvents = match.events || [];
                const matchMinutes = minutesByMatch[match.id] || {};
                
                Object.entries(match.ratings).forEach(([playerId, rates]) => {
                    if (performances[playerId] && rates.played) {
                        const playerEvents = matchEvents.filter(e => e.playerId === playerId);
                        const goals = playerEvents.filter(e => e.action === 'gol').length;
                        const assists = matchEvents.filter(e => e.assistId === playerId).length;
                        const shots = playerEvents.filter(e => e.action === 'finalizacao').length;
                        const duelsWon = playerEvents.filter(e => e.action === 'duelo_ganho').length;
                        const duelsLost = playerEvents.filter(e => e.action === 'duelo_perdido').length;
   
                        const avg = (parseFloat(rates.tecnico) + parseFloat(rates.tatico) + parseFloat(rates.fisico) + parseFloat(rates.comportamental)) / 4;
                        performances[playerId].matchPerformances.push({
                            matchDate: new Date(match.date).toLocaleDateString('pt-BR', { timeZone: 'UTC' }),
                            opponentName: match.opponentName,
                            overall: avg,
                            minutesPlayed: matchMinutes[playerId] || 0,
                            goals,
                            assists,
                            shots,
                            duelsWon,
                            duelsLost
                        });
                    }
                });
            });
            const sortedPerformances = Object.values(performances).map(p => {
                const overallScores = p.matchPerformances.map(mp => mp.overall);
                const overallAvg = overallScores.length > 0 ? (overallScores.reduce((a, b) => a + b, 0) / overallScores.length) : 0;
                const totalMinutesPlayed = p.matchPerformances.reduce((acc, mp) => acc + mp.minutesPlayed, 0);
                const totalGoals = p.matchPerformances.reduce((acc, mp) => acc + mp.goals, 0);
                const totalAssists = p.matchPerformances.reduce((acc, mp) => acc + mp.assists, 0);
                const totalShots = p.matchPerformances.reduce((acc, mp) => acc + mp.shots, 0);
                const totalDuelsWon = p.matchPerformances.reduce((acc, mp) => acc + mp.duelsWon, 0);
                const totalDuelsLost = p.matchPerformances.reduce((acc, mp) => acc + mp.duelsLost, 0);
                return { ...p, overallAvg, totalMinutesPlayed, totalGoals, totalAssists, totalShots, totalDuelsWon, totalDuelsLost };
            }).sort((a, b) => b.overallAvg - a.overallAvg);

            let tableHTML = '';
            if (sortedPerformances.length === 0 || finishedMatches.length === 0) {
                 tableHTML = '<tbody><tr><td colspan="9" class="text-center p-8 text-gray-400">Nenhuma avaliação de desempenho encontrada. Finalize uma partida com avaliações para ver os dados.</td></tr></tbody>';
            } else {
                 tableHTML = sortedPerformances.map(p => {
                    if (p.matchPerformances.length === 0) return '';
                    
                    const detailsRows = p.matchPerformances.sort((a,b) => new Date(b.matchDate) - new Date(a.matchDate)).map(mp => `
                        <tr class="bg-gray-800 border-t border-gray-700 text-center">
                            <td class="py-2 px-3 text-sm text-left">${mp.matchDate}</td>
                            <td class="py-2 px-3 text-sm text-left">${mp.opponentName}</td>
                            <td class="py-2 px-3 text-sm font-bold text-blue-300">${mp.overall.toFixed(1)}</td>
                            <td class="py-2 px-3 text-sm">${mp.minutesPlayed}</td>
                            <td class="py-2 px-3 text-sm">${mp.goals}</td>
                            <td class="py-2 px-3 text-sm">${mp.assists}</td>
                            <td class="py-2 px-3 text-sm">${mp.shots}</td>
                            <td class="py-2 px-3 text-sm">${mp.duelsWon} / ${mp.duelsLost}</td>
                        </tr>
                    `).join('');
                    return `<tbody class="border-b border-gray-700">
                                <tr class="performance-main-row" onclick="togglePerformanceDetails(this)">
                                    <td class="p-3 font-semibold text-white">${p.name} <span class="text-xs text-gray-400">${p.position}</span></td>
                                    <td class="p-3 text-center font-bold text-blue-400">${p.overallAvg.toFixed(1)}</td>
                                    <td class="p-3 text-center">${p.matchPerformances.length}</td>
                                    <td class="p-3 text-center">${p.totalMinutesPlayed}</td>
                                    <td class="p-3 text-center">${p.totalGoals}</td>
                                    <td class="p-3 text-center">${p.totalAssists}</td>
                                    <td class="p-3 text-center">${p.totalShots}</td>
                                    <td class="p-3 text-center">${p.totalDuelsWon} / ${p.totalDuelsLost}</td>
                                    <td class="p-3 text-center">
                                         <svg class="details-icon h-5 w-5 text-gray-400 inline-block" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd" /></svg>
                                    </td>
                               </tr>
                                <tr class="performance-details-row hidden">
                                    <td colspan="9">
                                        <div class="p-4 bg-gray-900">
                                            <table class="w-full text-left">
                                                 <thead class="text-xs text-gray-400 uppercase">
                                                    <tr class="text-center">
                                                         <th class="py-2 px-3 text-left">Data</th>
                                                         <th class="py-2 px-3 text-left">Adversário</th>
                                                        <th class="py-2 px-3">Nota</th>
                                                         <th class="py-2 px-3">Minutos</th>
                                                        <th class="py-2 px-3">Gols</th>
                                                         <th class="py-2 px-3">Assist.</th>
                                                        <th class="py-2 px-3">FIN</th>
                                                        <th class="py-2 px-3">Duelos G/P</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    ${detailsRows}
                                                </tbody>
                                            </table>
                                        </div>
                                    </td>
                                </tr>
                            </tbody>`;
                }).join('');
            }

            container.innerHTML = `
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-3xl font-bold text-white">Desempenho Geral dos Jogadores</h2>
                    <button class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg admin-only" onclick="exportPerformancesToTXT()">Exportar para TXT</button>
                </div>
                <div class="bg-gray-800 rounded-lg overflow-x-auto">
                    <table class="w-full text-left min-w-[900px]">
                        <thead class="bg-gray-900">
                            <tr>
                                <th class="p-3 w-1/3">Jogador</th>
                                <th class="p-3 text-center">Média Geral</th>
                                <th class="p-3 text-center">Jogos</th>
                                <th class="p-3 text-center" title="Minutos Jogados">Minutos</th>
                                <th class="p-3 text-center" title="Gols">Gols</th>
                                <th class="p-3 text-center" title="Assistências">Assist.</th>
                                <th class="p-3 text-center" title="Finalizações">FIN</th>
                                <th class="p-3 text-center" title="Duelos Ganhos / Perdidos">Duelos G/P</th>
                                <th class="p-3 text-center">Detalhes</th>
                            </tr>
                        </thead>
                        ${tableHTML}
                    </table>
                </div>
            `;
        }

        function renderReportMatchSelect() {
            const select = document.getElementById('report-match-select');
            if(!select) return;
            const currentVal = select.value;
            const finishedMatches = [...appState.matches].filter(m => m.status === 'finished').sort((a,b) => new Date(b.date) - new Date(a.date));
            select.innerHTML = '<option value="">Selecione uma partida</option>' + finishedMatches.map(m => `<option value="${m.id}">${m.myTeamName} vs ${m.opponentName} - ${new Date(m.date).toLocaleDateString('pt-BR', {timeZone: 'UTC'})}</option>`).join('');
            select.value = currentVal;
            if(currentVal) {
                document.getElementById('reports-buttons').style.display = 'flex';
            } else {
                document.getElementById('reports-buttons').style.display = 'none';
            }
        }
        
        function hideReportContent() {
            const reportContent = document.getElementById('report-content');
            if(reportContent) reportContent.classList.add('hidden');
            document.getElementById('reports-buttons').style.display = 'none';
        }
        
        Chart.register(ChartDataLabels);
        window.generateReports = function(matchId) {
            destroyCharts();
            const reportContentEl = document.getElementById('report-content');
            const reportsButtons = document.getElementById('reports-buttons');
            if (!matchId) { 
                hideReportContent();
                return; 
            }
            reportContentEl.classList.remove('hidden');
            reportsButtons.style.display = 'flex';
            const match = appState.matches.find(m => m.id === matchId);
            if (!match) return;
            reportContentEl.innerHTML = renderReportContentForPDF(match);
            setTimeout(() => {
                renderChartsForReport(match);
            }, 100);
        }

        function renderChartsForReport(match, period = null) {
            const suffix = period ? `_${period}T` : '';
            const possessionData = period == 1 ? match.possession1T : match.possession;
            renderPossessionChart(match, `possessionChart${suffix}`, possessionData);
            renderActionMapChart(match, `actionMapChart${suffix}`, period);
            if (!period) {
                renderActionMapChart(match, 'actionMapChart_1T', 1);
                renderActionMapChart(match, 'actionMapChart_2T', 2);
                renderReportSummaryTable(match, 'report-summary-table', null);
                renderReportSummaryTable(match, 'report-summary-table-1T', 1);
                renderReportSummaryTable(match, 'report-summary-table-2T', 2);
                renderManOfTheMatch(match);
                renderTopStatsTable(match);
                renderFormation(match);
            }
        }
        
        function getReportSummaryTableHTML(match, period) {
            const allEvents = period ? match.events.filter(e => e.period == period) : match.events;

            if (allEvents.length === 0 && period) {
                return '<p class="text-center text-gray-500 p-4">Nenhum dado neste período.</p>';
            }

            const myEvents = allEvents.filter(e => e.scoringTeam !== 'opponent' && !e.action.endsWith('_adv'));
            const oppEvents = allEvents.filter(e => e.scoringTeam === 'opponent' || e.action.endsWith('_adv'));
            const count = (arr, action, detail) => arr.filter(e => e.action === action && (detail ? e.detail === detail : true)).length;
            const calculateChancesBreakdown = (eventsToAnalyze) => {
                const breakdown = {
                    myTeam: { '0-15': 0, '15-30': 0, '30+': 0 },
                    opponent: { '0-15': 0, '15-30': 0, '30+': 0 }
                };
                const chanceEvents = eventsToAnalyze.filter(e => e.action === 'chance_clara' || e.action === 'chance_clara_adv');
                chanceEvents.forEach(e => {
                    const team = e.action === 'chance_clara' ? 'myTeam' : 'opponent';
                    let timeInPeriod = e.time;
                    if (e.period === 2 && match.secondHalfStartSeconds > -1) {
                        timeInPeriod -= match.secondHalfStartSeconds;
                    }
                    const minute = timeInPeriod / 60;
                    let bucket;
                    if (minute <= 15) bucket = '0-15';
                    else if (minute <= 30) bucket = '15-30';
                    else bucket = '30+';
                    breakdown[team][bucket]++;
                });
                return breakdown;
            };
            
            const chancesBreakdown = calculateChancesBreakdown(allEvents);

            const passesCerto = count(myEvents, 'passe_certo'); const passesErrado = count(myEvents, 'passe_errado');
            const totalPasses = passesCerto + passesErrado;
            const percCerto = totalPasses > 0 ? `(${(passesCerto/totalPasses*100).toFixed(0)}%)` : '';
            const percErrado = totalPasses > 0 ? `(${(passesErrado/totalPasses*100).toFixed(0)}%)` : '';
            const duelosGanhos = count(myEvents, 'duelo_ganho');
            const duelosPerdidos = count(myEvents, 'duelo_perdido');
            const duelosTotais = duelosGanhos + duelosPerdidos;

            let tableHTML = `<table class="w-full text-sm"><tbody>`;
            const statsConfig = [
                { label: 'Finalizações', action: 'finalizacao', oppAction: 'finalizacao_adv' },
                { label: '• Dentro da Área', action: 'finalizacao', detail: 'dentro_area', oppAction: 'finalizacao_adv', oppDetail: 'dentro_area', isSub: true },
                { label: '• Fora da Área', action: 'finalizacao', detail: 'fora_area', oppAction: 'finalizacao_adv', oppDetail: 'fora_area', isSub: true },
                { label: '• Cabeceio', action: 'finalizacao', detail: 'cabeceio', oppAction: 'finalizacao_adv', oppDetail: 'cabeceio', isSub: true },
                { label: 'Chances Claras', action: 'chance_clara', oppAction: 'chance_clara_adv', hasBreakdown: true },
                { label: 'Total de Duelos', my: duelosTotais, opp: duelosTotais },
                { label: '• Duelos Ganhos', my: duelosGanhos, opp: duelosPerdidos, isSub: true },
                { label: '• Duelos Perdidos', my: duelosPerdidos, opp: duelosGanhos, isSub: true },
                { label: 'Total de Passes', my: totalPasses, opp: '–' },
                { label: '• Passes Certos', my: `${passesCerto} <span class="text-xs">${percCerto}</span>`, opp: '–', isSub: true },
                { label: '• Passes Errados', my: `${passesErrado} <span class="text-xs">${percErrado}</span>`, opp: '–', isSub: true },
                { label: 'Faltas Cometidas', action: 'falta_cometida', oppAction: 'falta_sofrida'},
                { label: 'Faltas Sofridas', action: 'falta_sofrida', oppAction: 'falta_cometida' },
                { label: 'Cruzamentos (Dir)', action: 'cruzamento_dir', opp: '–' },
                { label: 'Cruzamentos (Esq)', action: 'cruzamento_esq', opp: '–' },
            ];

            let mainRowIndex = 0;
            statsConfig.forEach(stat => {
                const myVal = stat.my ?? count(myEvents, stat.action, stat.detail);
                const oppVal = stat.opp ?? (stat.oppAction ? count(oppEvents, stat.oppAction, stat.oppDetail) : '–');
                const rowClass = !stat.isSub && mainRowIndex++ % 2 === 0 ? 'bg-gray-50' : '';
                
                tableHTML += `<tr class="${rowClass}">
                                <td class="p-2 ${stat.isSub ? 'pl-6 text-gray-600' : 'font-semibold border-t border-gray-200'}">${stat.label}</td>
                                <td class="p-2 text-center font-medium ${stat.isSub ? 'text-gray-600' : 'border-t border-gray-200'}">${myVal}</td>
                                <td class="p-2 text-center font-medium ${stat.isSub ? 'text-gray-600' : 'border-t border-gray-200'}">${oppVal}</td>
                             </tr>`;
                
                if (stat.hasBreakdown) {
                    const myChances = chancesBreakdown.myTeam;
                    const oppChances = chancesBreakdown.opponent;
                    const subRowClass = !stat.isSub && (mainRowIndex - 1) % 2 === 0 ? 'bg-gray-50' : '';
                    tableHTML += `
                        <tr class="${subRowClass}">
                            <td class="pt-0 pb-1 px-2 pl-8 text-gray-500 text-xs font-normal">↳ Até 15'</td>
                            <td class="pt-0 pb-1 px-2 text-center font-normal text-gray-500 text-xs">${myChances['0-15']}</td>
                            <td class="pt-0 pb-1 px-2 text-center font-normal text-gray-500 text-xs">${oppChances['0-15']}</td>
                        </tr>
                        <tr class="${subRowClass}">
                             <td class="pt-0 pb-1 px-2 pl-8 text-gray-500 text-xs font-normal">↳ 15' a 30'</td>
                            <td class="pt-0 pb-1 px-2 text-center font-normal text-gray-500 text-xs">${myChances['15-30']}</td>
                            <td class="pt-0 pb-1 px-2 text-center font-normal text-gray-500 text-xs">${oppChances['15-30']}</td>
                         </tr>
                        <tr class="${subRowClass}">
                            <td class="pt-0 pb-1 px-2 pl-8 text-gray-500 text-xs font-normal">↳ Após 30'</td>
                             <td class="pt-0 pb-1 px-2 text-center font-normal text-gray-500 text-xs">${myChances['30+']}</td>
                            <td class="pt-0 pb-1 px-2 text-center font-normal text-gray-500 text-xs">${oppChances['30+']}</td>
                        </tr>`;
                }
            });
            tableHTML += `</tbody><thead class="text-xs text-gray-500"><tr><th class="p-2 text-left">Estatística</th><th class="p-2 text-center">${match.myTeamName}</th><th class="p-2 text-center">${match.opponentName}</th></tr></thead></table>`;
            return tableHTML;
        }

        function renderReportSummaryTable(match, containerId, period) {
            const container = document.getElementById(containerId);
            if(!container) return;
            container.innerHTML = getReportSummaryTableHTML(match, period);
        }
        
        function renderReportContentForPDF(match, specificPeriod = null) {
            const logoDataUrl = appState.settings.logoDataUrl;
            const logoImg = logoDataUrl ? `<img src="${logoDataUrl}" class="report-logo" crossorigin="anonymous" />` : '';
            const reportHeader = `<div class="report-header">${logoImg}<p class="text-right text-xs text-gray-500">Relatório de Análise de Desempenho</p></div>`;
            const reportFooter = `<div class="absolute bottom-0 left-1/2 -translate-x-1/2 text-center text-xs text-gray-400 p-2 w-full">Powered by Ciente - Inteligência Esportiva</div>`;
            if (specificPeriod) {
                const myTeamScore = match.events.filter(e => e.period == specificPeriod && e.action === 'gol').length;
                const opponentScore = match.events.filter(e => e.period == specificPeriod && e.action === 'gol_contra').length;
                const summaryTableHTML = getReportSummaryTableHTML(match, specificPeriod);
                return `<div class="report-page">
                    ${reportHeader}
                    <div class="text-center mb-4"><h1 class="text-3xl font-bold">Relatório do ${specificPeriod}º Tempo</h1><p class="text-lg text-gray-600">${match.myTeamName} vs ${match.opponentName}</p></div>
                    <div class="text-center mb-6"><h2 class="text-2xl font-bold">Placar do Período: ${myTeamScore} x ${opponentScore}</h2></div>
                     <div class="space-y-8 report-section">
                        <div class="bg-gray-50 p-3 rounded-lg border"><h3 class="text-xl font-bold text-center mb-2">Posse de Bola (1ºT)</h3><div class="chart-container h-20"><canvas id="possessionChart_${specificPeriod}T"></canvas></div></div>
                        <div class="bg-gray-50 p-3 rounded-lg border"><h3 class="text-xl font-bold text-center mb-2">Resumo de Ações</h3>${summaryTableHTML}</div>
                    </div>
                    ${reportFooter}
                </div>`;
            }
            
            const page1 = `<div class="report-page">
                ${reportHeader}
                <div class="text-center mb-6"><h1 class="text-4xl font-bold">${match.myTeamName} ${match.myTeamScore} x ${match.opponentScore} ${match.opponentName}</h1><p class="text-lg text-gray-600">${new Date(match.date).toLocaleDateString('pt-BR', {timeZone: 'UTC'})} - ${match.location}</p></div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4 report-section">
                     <div class="bg-gray-50 p-3 rounded-lg border"><h3 class="text-xl font-bold text-center mb-2">Posse de Bola (Total)</h3><div class="chart-container h-20"><canvas id="possessionChart"></canvas></div><p class="text-center text-sm text-gray-600 mt-2">Tempo Total: ${formatTime(match.timerSeconds || 0)}</p></div>
                    <div class="bg-gray-50 p-3 rounded-lg border"><h3 class="text-xl font-bold text-center mb-2">Destaque da Partida</h3><div id="report-motm"></div></div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4 report-section">
                    <div class="bg-gray-50 p-3 rounded-lg border"><h3 class="text-xl font-bold text-center mb-4">Volume de Ações (Total)</h3><div class="chart-container" style="background-color: #166534; min-height: 240px; height: 240px;"><canvas id="actionMapChart"></canvas></div><div class="flex justify-between items-center mt-2 px-4"><span class="font-semibold text-gray-700">Defesa</span><svg class="w-full h-8 text-gray-500" viewBox="0 0 100 10" preserveAspectRatio="none"><path d="M0,5 h100 l-10,-4 m10,4 l-10,4" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" /></svg><span class="font-semibold text-gray-700">Ataque</span></div></div>
                    <div class="bg-gray-50 p-3 rounded-lg border"><h3 class="text-xl font-bold text-center mb-2">Destaques Individuais</h3><div id="report-top-stats"></div></div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 report-section">
                    <div class="bg-gray-50 p-3 rounded-lg border"><h3 class="text-xl font-bold text-center mb-2">Resumo de Ações (Total)</h3><div id="report-summary-table"></div></div>
                    <div class="bg-gray-50 p-3 rounded-lg border"><div id="report-formation"></div></div>
                </div>
                ${reportFooter}
            </div>`;
            const page2 = `<div class="report-page">
                ${reportHeader}
                <div class="text-center mb-8 pt-8"><h1 class="text-3xl font-bold">Scout por Período</h1></div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8 report-section">
                    <div class="bg-gray-50 p-4 rounded-lg border"><h3 class="text-xl font-bold text-center mb-4">1º Tempo</h3><div class="chart-container" style="background-color: #166534; min-height: 240px;"><canvas id="actionMapChart_1T"></canvas></div><div class="flex justify-between items-center mt-2 px-4"><span class="font-semibold text-gray-700">Defesa</span><svg class="w-full h-8 text-gray-500" viewBox="0 0 100 10" preserveAspectRatio="none"><path d="M0,5 h100 l-10,-4 m10,4 l-10,4" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" /></svg><span class="font-semibold text-gray-700">Ataque</span></div><div id="report-summary-table-1T" class="mt-4"></div></div>
                    <div class="bg-gray-50 p-4 rounded-lg border"><h3 class="text-xl font-bold text-center mb-4">2º Tempo</h3><div class="chart-container" style="background-color: #166534; min-height: 240px;"><canvas id="actionMapChart_2T"></canvas></div><div class="flex justify-between items-center mt-2 px-4"><span class="font-semibold text-gray-700">Defesa</span><svg class="w-full h-8 text-gray-500" viewBox="0 0 100 10" preserveAspectRatio="none"><path d="M0,5 h100 l-10,-4 m10,4 l-10,4" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" /></svg><span class="font-semibold text-gray-700">Ataque</span></div><div id="report-summary-table-2T" class="mt-4"></div></div>
                </div>
                ${reportFooter}
            </div>`;
            
            return page1 + page2;
        }

        function destroyCharts() { Object.values(charts).forEach(chart => chart?.destroy()); }
        
        const fieldLinesPlugin = { id: 'fieldLines', beforeDraw: (chart) => { const { ctx, chartArea: { top, bottom, left, right }, scales: { x } } = chart; ctx.save(); ctx.strokeStyle = 'rgba(255, 255, 255, 0.3)'; ctx.lineWidth = 1; const defenseZoneEnd = x.getPixelForValue(1);
        const midfieldZoneEnd = x.getPixelForValue(2); ctx.beginPath(); ctx.moveTo(defenseZoneEnd, top); ctx.lineTo(defenseZoneEnd, bottom); ctx.moveTo(midfieldZoneEnd, top); ctx.lineTo(midfieldZoneEnd, bottom); ctx.stroke(); ctx.restore(); } };
        function renderPossessionChart(match, canvasId, possessionData) {
            const ctx = document.getElementById(canvasId)?.getContext('2d');
            if(!ctx) return;
            const dataToUse = possessionData || {myTeam: 0, opponent: 0, stopped: 0};
            charts[canvasId] = new Chart(ctx, { type: 'bar', data: { labels: ['Posse'], datasets: [ { label: match.myTeamName, data: [dataToUse.myTeam], backgroundColor: '#ef4444' }, { label: match.opponentName, data: [dataToUse.opponent], backgroundColor: '#3b82f6' } ]}, options: { indexAxis: 'y', responsive: true, maintainAspectRatio: false, scales: { x: { stacked: true, display: false }, y: { stacked: true, display: false } }, plugins: { legend: { display: true, position: 'top', labels: {color: '#374151'} }, datalabels: { color: 'white', font: { weight: 'bold' }, formatter: (v,c) => { const t = c.chart.data.datasets.reduce((s, ds) => s + (ds.data[0]||0), 0); return t > 0 ? (v/t*100).toFixed(0)+'%' : '0%'; }}}}});
        }

        function renderActionMapChart(match, canvasId, period) {
            const ctx = document.getElementById(canvasId)?.getContext('2d');
            if(!ctx) return;
            const events = period ? match.events.filter(e => e.period == period) : match.events;
            if (events.length === 0) {
                const chartContainer = ctx.canvas.parentElement;
                if(chartContainer) chartContainer.innerHTML = '<p class="text-center text-gray-500 p-8 h-full flex items-center justify-center">Nenhuma ação registrada neste período.</p>';
                return;
            }
            const sectorCounts = { defesa: 0, meio: 0, ataque: 0 };
            events.forEach(e => { if (sectorCounts.hasOwnProperty(e.zone)) sectorCounts[e.zone]++; });
            const totalActions = Object.values(sectorCounts).reduce((a, b) => a + b, 0);
            const maxActions = Math.max(...Object.values(sectorCounts), 1);
            const getColor = (count) => `rgba(220, 38, 38, ${Math.min(0.2 + (count / maxActions) * 0.8, 1)})`;
            const getRadius = (count) => 10 + Math.sqrt(count) * 4;
            charts[canvasId] = new Chart(ctx, { 
                type: 'bubble', 
                plugins: [fieldLinesPlugin], 
                data: { 
                    datasets: [{ 
                        label: 'Volume', 
                        data: [
                            { x: 0.5, y: 5, r: getRadius(sectorCounts.defesa) }, 
                            { x: 1.5, y: 5, r: getRadius(sectorCounts.meio) }, 
                            { x: 2.5, y: 5, r: getRadius(sectorCounts.ataque) }
                        ], 
                        backgroundColor: [getColor(sectorCounts.defesa), getColor(sectorCounts.meio), getColor(sectorCounts.ataque)], 
                        borderColor: 'rgba(153, 27, 27, 1)', 
                        borderWidth: 1 
                    }] 
                }, 
                options: { 
                    responsive: true, 
                    maintainAspectRatio: false, 
                    layout: { padding: 10 }, 
                    scales: { 
                        x: { min: 0, max: 3, grid: { display: false }, ticks: { display: false } }, 
                        y: { display: false, min: 0, max: 10 } 
                    }, 
                    plugins: { 
                        legend: { display: false }, 
                        datalabels: { 
                            color: 'white', 
                            textAlign: 'center',
                            font: { weight: 'bold', size: 14 },
                            formatter: (value, context) => {
                                const count = Object.values(sectorCounts)[context.dataIndex];
                                if (totalActions === 0) return '0\n(0%)';
                                const percentage = ((count / totalActions) * 100).toFixed(0);
                                return `${count}\n(${percentage}%)`;
                            }
                        }
                    }
                }
            });
        }
        
        function getRatingLegend(score) {
            const s = parseFloat(score);
            if (s >= 9) return "Muito Acima";
            if (s >= 7) return "Acima do Esperado";
            if (s >= 5) return "Dentro do Esperado";
            if (s >= 3) return "Abaixo";
            if (s >= 1) return "Muito abaixo";
            return ""; 
        }

        function renderManOfTheMatch(match) {
            const container = document.getElementById('report-motm');
            if(!container || !match.ratings || Object.keys(match.ratings).length === 0) { if(container) container.innerHTML = '<p class="text-gray-500 text-center py-8">Nenhuma avaliação registrada.</p>'; return; }
            const performers = Object.entries(match.ratings).filter(([,r]) => r.played).map(([pid, r]) => ({ pid, avg: (parseFloat(r.tecnico) + parseFloat(r.tatico) + parseFloat(r.fisico) + parseFloat(r.comportamental)) / 4, rates: r }));
            if (performers.length === 0) { container.innerHTML = '<p class="text-gray-500 text-center py-8">Nenhum jogador avaliado.</p>'; return; }
            const topPlayer = performers.reduce((a, b) => a.avg > b.avg ? a : b);
            const player = appState.players.find(p => p.id === topPlayer.pid);
            if(player) {
                const legendText = getRatingLegend(topPlayer.avg);
                container.innerHTML = `<div class="flex flex-col items-center justify-center h-full bg-blue-50 rounded-lg p-3">
                    <svg class="h-10 w-10 text-yellow-400 mb-1" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z" /></svg>
                    <p class="text-xl font-bold text-gray-800">${player.name}</p>
                     <p class="text-md text-gray-600">
                        Nota Média: <span class="font-bold text-blue-600">${topPlayer.avg.toFixed(1)}</span>
                        <span class="text-sm text-gray-500 font-semibold">(${legendText})</span>
                    </p>
                    <div class="w-full space-y-1 mt-2 pt-2 border-t border-gray-300 text-xs">
                         <div class="flex justify-between items-center">
                            <span class="font-semibold text-gray-500">Técnico:</span>
                            <span class="font-bold text-gray-700 text-right">${topPlayer.rates.tecnico} (${getRatingLegend(topPlayer.rates.tecnico)})</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="font-semibold text-gray-500">Tático:</span>
                            <span class="font-bold text-gray-700 text-right">${topPlayer.rates.tatico} (${getRatingLegend(topPlayer.rates.tatico)})</span>
                        </div>
                        <div class="flex justify-between items-center">
                             <span class="font-semibold text-gray-500">Físico:</span>
                            <span class="font-bold text-gray-700 text-right">${topPlayer.rates.fisico} (${getRatingLegend(topPlayer.rates.fisico)})</span>
                        </div>
                        <div class="flex justify-between items-center">
                             <span class="font-semibold text-gray-500">Comport.:</span>
                            <span class="font-bold text-gray-700 text-right">${topPlayer.rates.comportamental} (${getRatingLegend(topPlayer.rates.comportamental)})</span>
                        </div>
                    </div>
                </div>`;
            }
        }
        
        function renderTopStatsTable(match) {
            const container = document.getElementById('report-top-stats');
            if (!container) return;

            const myEvents = match.events.filter(e => e.scoringTeam !== 'opponent' && !e.action.endsWith('_adv'));
            const opponentGoalEvents = match.events.filter(e => e.action === 'gol_contra').sort((a,b) => a.time - b.time);
            const goalEvents = myEvents.filter(e => e.action === 'gol').sort((a,b) => a.time - b.time);
            let teamGoalsHTML = '';
            if (goalEvents.length > 0) {
                 teamGoalsHTML = goalEvents.map(goal => {
                    const player = appState.players.find(p => p.id === goal.playerId);
                    let minute;
                    if(goal.period === 2 && match.secondHalfStartSeconds > -1) {
                        minute = Math.floor((goal.time - match.secondHalfStartSeconds) / 60);
                    } else {
                        minute = Math.floor(goal.time / 60);
                    }
                    return `<li class="flex justify-between"><span>${player?.name || 'Desconhecido'}</span> <strong>${goal.period}T - ${minute}'</strong></li>`;
                }).join('');
            } else {
                teamGoalsHTML = '<li>Nenhum gol marcado.</li>';
            }

            let opponentGoalsHTML = '';
            if (opponentGoalEvents.length > 0) {
                 opponentGoalsHTML = opponentGoalEvents.map(goal => {
                    let minute;
                     if(goal.period === 2 && match.secondHalfStartSeconds > -1) {
                        minute = Math.floor((goal.time - match.secondHalfStartSeconds) / 60);
                    } else {
                        minute = Math.floor(goal.time / 60);
                    }
                    return `<li class="flex justify-between"><span>Adversário</span> <strong>${goal.period}T - ${minute}'</strong></li>`;
                }).join('');
            } else {
                opponentGoalsHTML = '<li>Nenhum gol sofrido.</li>';
            }

            const getTopStats = (action, key) => { 
                const counts = myEvents
                    .filter(e => e.action === action && e[key])
                    .reduce((acc, e) => { 
                        acc[e[key]] = (acc[e[key]] || 0) + 1; 
                        return acc; 
                    }, {});
                return Object.entries(counts).sort(([,a],[,b]) => b-a); 
            };
            const assists = getTopStats('gol', 'assistId'); 
            const shots = getTopStats('finalizacao', 'playerId');
            const duelsWon = getTopStats('duelo_ganho', 'playerId');

            const renderList = (title, data, icon) => { let listHTML = `<div class="bg-white p-3 rounded-lg shadow-sm"><div class="flex items-center gap-3 mb-2"><span class="bg-gray-200 p-2 rounded-full">${icon}</span><h4 class="font-semibold text-gray-800 text-lg">${title}</h4></div><ul class="text-sm text-gray-600 space-y-1 pl-1">`;
            if (data.length === 0) { listHTML += '<li>Nenhum registro.</li>'; } else { data.slice(0, 3).forEach(([id, count]) => { const player = appState.players.find(p => p.id === id); listHTML += `<li class="flex justify-between"><span>${player?.name || 'Desconhecido'}</span> <strong>${count}</strong></li>`; });
            } listHTML += '</ul></div>'; return listHTML; };
            const renderSingleStat = (title, data, icon) => { const [playerId, count] = data.length > 0 ? data[0] : [null, 0]; const player = appState.players.find(p => p.id === playerId);
            return `<div class="bg-white p-3 rounded-lg shadow-sm flex items-center gap-3"><span class="bg-gray-200 p-2 rounded-full">${icon}</span><div><h4 class="font-semibold text-gray-500 text-sm">${title}</h4><p class="font-bold text-gray-800 text-base">${player?.name || 'N/A'}</p></div><strong class="ml-auto text-xl font-black text-gray-800">${count > 0 ? count : '-'}</strong></div>`; };
            const goalIcon = `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-600" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.79 4 4s-1.79 4-4 4-4-1.79-4-4c0-1.165.451-2.223 1.172-3.001L8.228 9z" /><path stroke-linecap="round" stroke-linejoin="round" d="M12 21a9 9 0 100-18 9 9 0 000 18z" /></svg>`;
            const assistIcon = `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-600" viewBox="0 0 24 24" fill="currentColor"><path d="M21.51,2.05A1.23,1.23,0,0,0,20.29,2L4.7,6.85a1.24,1.24,0,0,0-.7,2.2L9.45,11,7.21,14.49a1.24,1.24,0,0,0,.4,1.75l5.09,3.18a1.23,1.23,0,0,0,1.75-.4L22,3.76A1.24,1.24,0,0,0,21.51,2.05Z"/></svg>`;
            const shotIcon = `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-600" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10" /><circle cx="12" cy="12" r="6" /><circle cx="12" cy="12" r="2" /></svg>`;
            const duelIcon = `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-600" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z" /></svg>`;
            container.innerHTML = `
                <div class="space-y-3">
                    <div class="bg-white p-3 rounded-lg shadow-sm">
                        <div class="flex items-center gap-3 mb-2">
                            <span class="bg-gray-200 p-2 rounded-full">${goalIcon}</span>
                            <h4 class="font-semibold text-gray-800 text-lg">Gols da Equipe</h4>
                        </div>
                        <ul class="text-sm text-gray-600 space-y-1 pl-1">${teamGoalsHTML}</ul>
                    </div>
                     <div class="bg-white p-3 rounded-lg shadow-sm">
                        <div class="flex items-center gap-3 mb-2">
                            <span class="bg-gray-200 p-2 rounded-full">${goalIcon}</span>
                            <h4 class="font-semibold text-gray-800 text-lg">Gols do Adversário</h4>
                        </div>
                        <ul class="text-sm text-gray-600 space-y-1 pl-1">${opponentGoalsHTML}</ul>
                    </div>
                    ${renderList('Assistências', assists, assistIcon)}
                    ${renderSingleStat('Mais Finalizações', shots, shotIcon)}
                    ${renderSingleStat('Mais Duelos Ganhos', duelsWon, duelIcon)}
                </div>`;
        }
        
        function renderFormation(match) {
            const container = document.getElementById('report-formation');
            if (!container || !match.lineup || !match.squadPlayerIds) {
                if (container) container.innerHTML = '<p class="text-gray-500 text-center p-4">Escalação não definida.</p>';
                return;
            }

            const shirtNumbers = {
                gk: 1, rb: 2, rcb: 3, lcb: 4, dm: 5, lb: 6, rw: 7, rcm: 8, st: 9, lcm: 10, lw: 11
            };
            const lineupPlayerIds = new Set();
            const startersList = [];

            for (const posKey in match.lineup) {
                const playerId = match.lineup[posKey];
                if (playerId) {
                    lineupPlayerIds.add(playerId);
                    startersList.push({
                        playerId: playerId,
                        shirtNumber: shirtNumbers[posKey] || '?'
                    });
                }
            }

            startersList.sort((a, b) => a.shirtNumber - b.shirtNumber);
            let startersHTML = startersList.map(starter => {
                const player = appState.players.find(p => p.id === starter.playerId);
                return `<tr class="border-b border-white/20">
                    <td class="p-1.5 font-bold text-center w-8">${starter.shirtNumber}</td>
                    <td class="p-1.5">${player ? player.name : '<i class="opacity-50">Vazio</i>'}</td>
                 </tr>`;
            }).join('');
            if (startersList.length === 0) {
                 startersHTML = '<tr><td colspan="2" class="text-center p-2 opacity-50">Nenhum titular definido.</td></tr>';
            }

            const substitutes = (match.squadPlayerIds || [])
                .filter(pid => !lineupPlayerIds.has(pid))
                .map(subId => appState.players.find(p => p.id === subId))
                .filter(Boolean)
                .sort((a, b) => a.name.localeCompare(b.name));
            let reservesHTML = '';
            for (let i = 0; i < 10; i++) {
                const player = substitutes[i];
                reservesHTML += `<tr class="border-b border-white/20">
                    <td class="p-1.5 font-bold text-center w-8">${i + 12}</td>
                    <td class="p-1.5">${player ? player.name : '<i class="opacity-50">Vazio</i>'}</td>
                </tr>`;
            }

            const formationHTML = `<h4 class="text-center font-bold mb-3 text-xl">Escalação da Equipe</h4>
                <div class="bg-green-800 p-3 rounded-lg text-white">
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-x-4">
                        <div>
                             <h5 class="font-bold text-center mb-2 pb-1 border-b border-white/30">TITULARES</h5>
                            <table class="w-full text-left text-sm">${startersHTML}</table>
                        </div>
                         <div class="mt-4 sm:mt-0">
                            <h5 class="font-bold text-center mb-2 pb-1 border-b border-white/30">RESERVAS</h5>
                            <table class="w-full text-left text-sm">${reservesHTML}</table>
                        </div>
                    </div>
                </div>`;
            container.innerHTML = formationHTML;
        }
        
        async function exportReportToPDF() {
            const button = document.getElementById('pdf-export-button');
            const text = document.getElementById('pdf-export-text');
            const loader = document.getElementById('pdf-export-loader');

            text.classList.add('hidden');
            loader.classList.remove('hidden');
            button.disabled = true;
            console.log("Exportação para PDF: Iniciando...");
            const matchId = document.getElementById('report-match-select').value;
            const match = appState.matches.find(m => m.id === matchId);
            if (!match) {
                showErrorMessage("Partida não encontrada para exportar.");
                text.classList.remove('hidden');
                loader.classList.add('hidden');
                button.disabled = false;
                return;
            }
            
            generateReports(matchId);
            await new Promise(resolve => setTimeout(resolve, 300));
            
            const tempContainer = document.createElement('div');
            tempContainer.style.position = 'absolute';
            tempContainer.style.left = '-9999px';
            tempContainer.style.width = '1122px';
            document.body.appendChild(tempContainer);
            try {
                const pdf = new jsPDF({ orientation: 'l', unit: 'mm', format: 'a4' });
                const visiblePages = document.querySelectorAll('#report-content .report-page');
                
                for (let i = 0; i < visiblePages.length; i++) {
                    const originalPage = visiblePages[i];
                    const pageClone = originalPage.cloneNode(true);
                    tempContainer.innerHTML = '';
                    tempContainer.appendChild(pageClone);
                    
                    const originalCanvases = originalPage.querySelectorAll('canvas');
                    const clonedCanvases = pageClone.querySelectorAll('canvas');
                    for (let j = 0; j < clonedCanvases.length; j++) {
                        const canvasToReplace = clonedCanvases[j];
                        const chartId = originalCanvases[j].id;
                        if (charts[chartId] && charts[chartId].ctx) {
                            const imgData = charts[chartId].toBase64Image();
                            const img = document.createElement('img');
                            img.src = imgData;
                            img.style.width = '100%';
                            img.style.height = 'auto';
                            img.style.display = 'block';
                            canvasToReplace.parentNode.replaceChild(img, canvasToReplace);
                        }
                    }

                    await new Promise(resolve => setTimeout(resolve, 200));
                    console.log(`Exportação para PDF: Capturando página ${i + 1}...`);
                    const pageCanvas = await html2canvas(pageClone, {
                        scale: 2,
                        useCORS: true,
                        backgroundColor: '#ffffff'
                    });
                    
                    const pageImgData = pageCanvas.toDataURL('image/jpeg', 0.92);
                    if (i > 0) {
                        pdf.addPage();
                    }

                    const pdfWidth = pdf.internal.pageSize.getWidth();
                    const pdfHeight = pdf.internal.pageSize.getHeight();
                    
                    const canvasWidth = pageCanvas.width;
                    const canvasHeight = pageCanvas.height;
                    const canvasRatio = canvasWidth / canvasHeight;
                    let finalWidth = pdfWidth;
                    let finalHeight = pdfWidth / canvasRatio;
                    if (finalHeight > pdfHeight) {
                        finalHeight = pdfHeight;
                        finalWidth = pdfHeight * canvasRatio;
                    }

                    const x = (pdfWidth - finalWidth) / 2;
                    const y = (pdfHeight - finalHeight) / 2;
                    
                    pdf.addImage(pageImgData, 'JPEG', x, y, finalWidth, finalHeight);
                }

                pdf.save(`Relatorio_${match.myTeamName}_vs_${match.opponentName}.pdf`);
            } catch (e) {
                showErrorMessage("Erro ao gerar o arquivo PDF. Tente novamente. Se o erro persistir, verifique o console para mais detalhes.", e);
                console.error("Falha na exportação para PDF:", e);
            } finally {
                document.body.removeChild(tempContainer);
                console.log("Exportação para PDF: Finalizando e resetando UI.");
                text.classList.remove('hidden');
                loader.classList.add('hidden');
                button.disabled = false;
            }
        }
        window.exportReportToPDF = exportReportToPDF;
        async function showHalftimeReport() {
            const match = appState.matches.find(m => m.id === appState.activeMatchId);
            if (!match) {
                showErrorMessage("Nenhuma partida ativa para gerar relatório.");
                return;
            }
            cancelPlayerSelection();
            
            destroyCharts();
            const contentContainer = document.getElementById('halftime-report-content');
            const eventsForPeriod = match.events.filter(e => e.period == 1);
            if (eventsForPeriod.length === 0) {
                contentContainer.innerHTML = `<div class="p-8 text-center text-gray-500">Nenhum dado registrado para o 1º tempo.</div>`;
            } else {
                contentContainer.innerHTML = renderReportContentForPDF(match, 1);
            }
            
            openModal('halftime-report-modal');
            if (eventsForPeriod.length > 0) {
                await new Promise(resolve => setTimeout(resolve, 200));
                const possession1T = match.possession1T || {myTeam: 0, opponent: 0, stopped: 0};
                renderPossessionChart(match, `possessionChart_1T`, possession1T);
            }
        }
        window.showHalftimeReport = showHalftimeReport;
        function downloadFile(content, fileName) {
            const blob = new Blob([content], { type: 'text/plain;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement("a");
            link.setAttribute("href", url); link.setAttribute("download", fileName);
            document.body.appendChild(link); link.click(); document.body.removeChild(link);
        }

        window.exportActionsToTXT = function() {
            const matchId = document.getElementById('report-match-select').value;
            if (!matchId) return showErrorMessage("Por favor, selecione uma partida primeiro.");
            const match = appState.matches.find(m => m.id === matchId);
            if (!match || !match.events) return;
            const headers = ["Tempo", "Periodo", "Setor", "Acao", "Detalhe", "Jogador", "Equipa"];
            let txtContent = headers.join("\t") + "\r\n";
            [...match.events].reverse().forEach(ev => {
                const teamName = (ev.action.endsWith('_adv') || ev.scoringTeam === 'opponent') ? match.opponentName : match.myTeamName;
                const row = [formatTime(ev.time), `${ev.period}T`, ev.zone, ev.action, ev.detail, ev.playerName, teamName];
                txtContent += row.join("\t") + "\r\n";
            });
            downloadFile(txtContent, `historico_acoes_${match.myTeamName}_vs_${match.opponentName}.txt`);
        }
        
        window.exportPerformancesToTXT = function() {
            const performances = {};
            appState.players.forEach(p => {
                performances[p.id] = { name: p.name, position: p.position, matchPerformances: [] };
            });
            const finishedMatches = appState.matches.filter(m => m.status === 'finished' && m.ratings);
            finishedMatches.forEach(match => {
                 const matchEvents = match.events || [];
                 const matchMinutes = calculateMinutesPlayed(match);
                 Object.entries(match.ratings).forEach(([playerId, rates]) => {
                     if (performances[playerId] && rates.played) {
                         const playerEvents = matchEvents.filter(e => e.playerId === playerId);

                        const avg = (parseFloat(rates.tecnico) + parseFloat(rates.tatico) + parseFloat(rates.fisico) + parseFloat(rates.comportamental)) / 4;
                        
                         performances[playerId].matchPerformances.push({
                            overall: avg,
                            minutesPlayed: matchMinutes[playerId] || 0,
                            goals: playerEvents.filter(e => e.action === 'gol').length,
                            assists: matchEvents.filter(e => e.assistId === playerId).length,
                            shots: playerEvents.filter(e => e.action === 'finalizacao').length,
                            duelsWon: playerEvents.filter(e => e.action === 'duelo_ganho').length,
                            duelsLost: playerEvents.filter(e => e.action === 'duelo_perdido').length,
                        });
                    }
                 });
            });
            const aggregatedPerformances = Object.values(performances).map(p => {
                const overallScores = p.matchPerformances.map(mp => mp.overall);
                const overallAvg = overallScores.length > 0 ? (overallScores.reduce((a, b) => a + b, 0) / overallScores.length) : 0;
                const totalMinutesPlayed = p.matchPerformances.reduce((acc, mp) => acc + mp.minutesPlayed, 0);
                const totalGoals = p.matchPerformances.reduce((acc, mp) => acc + mp.goals, 0);
                const totalAssists = p.matchPerformances.reduce((acc, mp) => acc + mp.assists, 0);
                const totalShots = p.matchPerformances.reduce((acc, mp) => acc + mp.shots, 0);
                const totalDuelsWon = p.matchPerformances.reduce((acc, mp) => acc + mp.duelsWon, 0);
                const totalDuelsLost = p.matchPerformances.reduce((acc, mp) => acc + mp.duelsLost, 0);
                return { ...p, overallAvg, totalMinutesPlayed, totalGoals, totalAssists, totalShots, totalDuelsWon, totalDuelsLost };
            }).sort((a,b) => b.overallAvg - a.overallAvg);

            const headers = ["Jogador", "Média Geral", "Posição", "Jogos", "Minutos", "Gols", "Assist.", "Finalizações", "Duelos Ganhos", "Duelos Perdidos"];
            let txtContent = headers.join("\t") + "\r\n";

            aggregatedPerformances.forEach(p => {
                if(p.matchPerformances.length > 0) {
                     const row = [
                        p.name,
                        p.overallAvg.toFixed(1),
                        p.position,
                        p.matchPerformances.length,
                        p.totalMinutesPlayed,
                        p.totalGoals,
                        p.totalAssists,
                        p.totalShots,
                        p.totalDuelsWon,
                        p.totalDuelsLost
                     ];
                     txtContent += row.join("\t") + "\r\n";
                }
            });
            downloadFile(txtContent, 'historico_desempenho_jogadores.txt');
        }

        function renderOnFieldPlayers() {
            const match = appState.matches.find(m => m.id === appState.activeMatchId);
            const container = document.getElementById('on-field-players');
            if (!match || !container) return;
    
            container.innerHTML = '';
    
            const { onField } = getPlayersOnFieldAndBench(match);
            const playersOnField = onField
                .map(pid => appState.players.find(p => p.id === pid))
                .filter(Boolean);
    
            playersOnField.sort((a,b) => a.name.localeCompare(b.name));
    
            if (playersOnField.length === 0) {
                 container.innerHTML = '<p class="text-gray-400 text-center col-span-full">Nenhum jogador em campo.</p>';
            } else {
                 playersOnField.forEach(player => {
                    const button = document.createElement('button');
                    button.className = 'action-btn bg-gray-700 hover:bg-gray-600 text-white truncate';
                    button.textContent = player.name;
                    button.onclick = () => selectPlayerForAction(player.id);
                    container.appendChild(button);
                 });
            }
        }

        firebaseAuth();
    </script>

</body>
</html>
