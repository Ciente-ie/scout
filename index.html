<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scout Pro - Análise de Futebol</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #0c111d; color: #e0e0e0; }
        .view { display: none; }
        .view.active { display: block; }
        .nav-link { transition: all 0.2s; border-left: 3px solid transparent; }
        .nav-link:hover { background-color: #1f2937; border-left-color: #3b82f6; }
        .nav-link.active { background-color: #111827; color: white; border-left-color: #60a5fa; font-weight: 600; }
        .field { 
            background-color: #166534; 
            background-image: linear-gradient(rgba(255,255,255,0.07) 1px, transparent 1px), linear-gradient(90deg, rgba(255,255,255,0.07) 1px, transparent 1px);
            background-size: 40px 40px; 
            border: 2px solid #a0aec0;
            padding: 1rem;
        }
        .zone { border: 1px dashed rgba(255,255,255,0.3); padding: 0.75rem; }
        .action-btn { 
            transition: all 0.2s; 
            padding: 0.75rem 0.5rem; 
            font-size: 0.8rem; 
            line-height: 1.2;
            font-weight: 600;
            border-radius: 0.375rem;
            width: 100%;
            text-align: center;
        }
        .action-btn:hover { transform: translateY(-2px); box-shadow: 0 4px 10px rgba(0,0,0,0.2); }
        .action-btn.clicked { background-color: #f59e0b !important; transform: scale(1.05); }
        
        /* Highlighted pass buttons */
        .pass-btn { background-color: #1d4ed8; color: white; }
        .pass-btn:hover { background-color: #2563eb; }
        .pass-btn-errado { background-color: #991b1b; }
        .pass-btn-errado:hover { background-color: #b91c1c; }

        .possession-btn.active { box-shadow: 0 0 0 3px #fbbf24; background-color: #d97706; }
        input, select { background-color: #1f2937; color: white; border-color: #4b5563; border-radius: 0.375rem; }
        input:focus, select:focus { background-color: #374151; border-color: #60a5fa; box-shadow: none; outline: none;}
        #report-content-wrapper { background-color: #ffffff; color: #111827; }
        #report-content-wrapper th, #report-content-wrapper td { border-color: #e5e7eb; }
        .report-table { border: 1px solid #e5e7eb; border-radius: 0.5rem; overflow: hidden; }
        .report-table th, .report-table td { padding: 0.5rem 1rem; }
        .report-table thead { background-color: #f3f4f6; }
        .chart-container { position: relative; width: 100%; min-height: 300px; background-color: #f9fafb; padding: 1rem; border-radius: 0.5rem; border: 1px solid #e5e7eb;}
        .dashboard-card { background-color: #1f2937; border: 1px solid #374151; }
        
        /* Tactical Formation Styles */
        .formation-grid {
            background-color: #166534;
            background-image: linear-gradient(rgba(255,255,255,0.1) 2px, transparent 2px), linear-gradient(90deg, rgba(255,255,255,0.1) 2px, transparent 2px);
            background-size: 50px 50px;
            border: 2px solid #4ade80;
            padding: 1rem;
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            grid-template-rows: repeat(4, 1fr);
            gap: 1rem;
            height: 100%;
            border-radius: 0.5rem;
        }
        .player-position { text-align: center; }
        .player-position .pos-label { font-size: 0.75rem; font-weight: bold; color: #a0aec0; text-transform: uppercase; }
        .player-position .player-name { font-weight: 600; color: white; background: rgba(0,0,0,0.4); padding: 0.25rem; border-radius: 0.25rem; }
        .gk { grid-row: 4; grid-column: 2; }
        .lb { grid-row: 3; grid-column: 1; }
        .lcb { grid-row: 3; grid-column: 2; transform: translateX(-30%);}
        .rcb { grid-row: 3; grid-column: 2; transform: translateX(30%);}
        .rb { grid-row: 3; grid-column: 3; }
        .dm { grid-row: 2; grid-column: 2; }
        .lcm { grid-row: 2; grid-column: 1; transform: translateY(50%); }
        .rcm { grid-row: 2; grid-column: 3; transform: translateY(50%); }
        .lw { grid-row: 1; grid-column: 1; }
        .st { grid-row: 1; grid-column: 2; }
        .rw { grid-row: 1; grid-column: 3; }
    </style>
</head>
<body class="flex h-screen antialiased">

    <!-- Sidebar Navigation -->
    <nav class="w-64 bg-gray-900 p-4 flex flex-col flex-shrink-0">
        <div class="flex items-center gap-3 mb-10 pl-2">
            <svg class="h-8 w-8 text-blue-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" d="M12 6.042A8.967 8.967 0 0 0 6 3.75c-1.052 0-2.062.18-3 .512v14.25A8.987 8.987 0 0 1 6 18c2.305 0 4.408.867 6 2.292m0-14.25a8.966 8.966 0 0 1 6-2.292c1.052 0 2.062.18 3 .512v14.25A8.987 8.987 0 0 0 18 18a8.967 8.967 0 0 0-6 2.292m0-14.25v14.25" />
            </svg>
            <h1 class="text-white text-2xl font-bold">Scout Pro</h1>
        </div>
        <a href="#" class="nav-link active text-lg p-3 rounded-r-lg mb-2" onclick="navigateTo('dashboard')">Dashboard</a>
        <a href="#" class="nav-link text-lg p-3 rounded-r-lg mb-2" onclick="navigateTo('management')">Jogadores</a>
        <a href="#" class="nav-link text-lg p-3 rounded-r-lg mb-2" onclick="navigateTo('matches')">Partidas</a>
        <a href="#" class="nav-link text-lg p-3 rounded-r-lg mb-2" onclick="navigateTo('reports')">Relatórios</a>
         <div class="mt-auto text-center text-xs text-gray-500">
            <p>ID do Usuário:</p>
            <p id="user-id-display" class="break-words font-mono">Carregando...</p>
        </div>
    </nav>

    <!-- Main Content Area -->
    <main class="flex-1 p-8 overflow-y-auto">
        <!-- Dashboard View -->
        <div id="dashboard" class="view active">
            <!-- Content will be rendered by JS -->
        </div>

        <!-- Management View -->
        <div id="management" class="view">
            <h2 class="text-3xl font-bold text-white mb-6">Gerenciamento de Jogadores</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
                <div class="md:col-span-1">
                    <h3 class="text-2xl font-semibold text-white mb-4">Adicionar / Editar Jogador</h3>
                    <form id="player-form" class="bg-gray-800 p-6 rounded-lg space-y-4">
                        <input type="hidden" id="player-id">
                        <div>
                            <label for="player-name" class="block mb-2 text-sm font-medium text-gray-300">Nome do Jogador</label>
                            <input type="text" id="player-name" class="w-full p-2.5" required>
                        </div>
                        <div>
                             <label for="player-dob" class="block mb-2 text-sm font-medium text-gray-300">Data de Nascimento</label>
                            <input type="date" id="player-dob" class="w-full p-2.5" required>
                        </div>
                         <div>
                            <label for="player-position" class="block mb-2 text-sm font-medium text-gray-300">Posição Principal</label>
                            <input type="text" id="player-position" placeholder="Ex: Zagueiro, Atacante" class="w-full p-2.5" required>
                        </div>
                        <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2.5 px-4 rounded-lg">Salvar Jogador</button>
                    </form>
                </div>
                 <div class="md:col-span-2">
                     <div class="bg-gray-800 p-6 rounded-lg">
                         <h3 class="text-2xl font-semibold text-white mb-4">Jogadores Cadastrados</h3>
                         <table class="w-full text-left"><thead class="text-gray-400"><tr><th class="p-3">Nome</th><th class="p-3">Posição</th><th class="p-3">Ações</th></tr></thead><tbody id="players-table" class="divide-y divide-gray-700"></tbody></table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Matches View -->
        <div id="matches" class="view">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-3xl font-bold text-white">Partidas</h2>
                <button class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-5 rounded-lg" onclick="openModal('new-match-modal')">Nova Partida</button>
            </div>
            <div id="match-list" class="space-y-4"></div>
        </div>
        
        <!-- Live Match View -->
        <div id="live-match" class="view">
            <div class="bg-gray-800 p-4 rounded-lg mb-4">
                <!-- Score and Timer -->
            </div>
            
            <div class="field rounded-lg mb-4">
                <div class="grid grid-cols-3 gap-4">
                    <!-- Defensive Zone -->
                    <div class="zone rounded-lg">
                        <h4 class="text-center font-bold text-white mb-3 text-sm tracking-wider">DEFESA</h4>
                        <div class="grid grid-cols-2 gap-2" id="defensive-actions">
                             <button class="action-btn bg-purple-600" onclick="logEvent(event, 'defesa', 'finalizacao_adv')">Fin. Adv.</button>
                             <button class="action-btn bg-purple-600" onclick="logEvent(event, 'defesa', 'chance_clara_adv')">Chance Adv.</button>
                             <button class="action-btn bg-yellow-500" onclick="logEvent(event, 'defesa', 'duelo')">Duelo</button>
                             <button class="action-btn bg-red-600" onclick="logEvent(event, 'defesa', 'falta_sofrida')">Falta Sofrida</button>
                             <button class="action-btn bg-red-400" onclick="logEvent(event, 'defesa', 'falta_cometida')">Falta Cometida</button>
                             <button class="action-btn pass-btn" onclick="logEvent(event, 'defesa', 'passe_certo')">Passe Certo</button>
                             <button class="action-btn pass-btn-errado" onclick="logEvent(event, 'defesa', 'passe_errado')">Passe Errado</button>
                        </div>
                    </div>
                    <!-- Midfield Zone -->
                    <div class="zone rounded-lg">
                        <h4 class="text-center font-bold text-white mb-3 text-sm tracking-wider">MEIO-CAMPO</h4>
                        <div class="grid grid-cols-2 gap-2" id="midfield-actions">
                            <button class="action-btn bg-yellow-500" onclick="logEvent(event, 'meio', 'duelo')">Duelo</button>
                            <button class="action-btn bg-red-600" onclick="logEvent(event, 'meio', 'falta_sofrida')">F. Sofrida</button>
                            <button class="action-btn bg-red-400" onclick="logEvent(event, 'meio', 'falta_cometida')">F. Cometida</button>
                            <button class="action-btn pass-btn" onclick="logEvent(event, 'meio', 'passe_certo')">Passe Certo</button>
                            <button class="action-btn pass-btn-errado" onclick="logEvent(event, 'meio', 'passe_errado')">Passe Errado</button>
                        </div>
                    </div>
                    <!-- Attack Zone -->
                    <div class="zone rounded-lg">
                        <h4 class="text-center font-bold text-white mb-3 text-sm tracking-wider">ATAQUE</h4>
                        <div class="grid grid-cols-2 gap-2" id="attack-actions">
                            <button class="action-btn bg-green-500" onclick="logEvent(event, 'ataque', 'finalizacao')">Finalização</button>
                             <button class="action-btn bg-green-500" onclick="logEvent(event, 'ataque', 'chance_clara')">Chance Clara</button>
                             <button class="action-btn bg-yellow-500" onclick="logEvent(event, 'ataque', 'duelo')">Duelo</button>
                             <button class="action-btn bg-blue-500" onclick="logEvent(event, 'ataque', 'cruzamento_dir')">Cruz. Dir</button>
                             <button class="action-btn bg-blue-500" onclick="logEvent(event, 'ataque', 'cruzamento_esq')">Cruz. Esq</button>
                             <button class="action-btn bg-red-600" onclick="logEvent(event, 'ataque', 'falta_sofrida')">F. Sofrida</button>
                             <button class="action-btn bg-red-400" onclick="logEvent(event, 'ataque', 'falta_cometida')">F. Cometida</button>
                             <button class="action-btn pass-btn" onclick="logEvent(event, 'ataque', 'passe_certo')">Passe Certo</button>
                             <button class="action-btn pass-btn-errado" onclick="logEvent(event, 'ataque', 'passe_errado')">Passe Errado</button>
                        </div>
                    </div>
                </div>
                 <!-- Container for sub-action buttons -->
                <div id="sub-action-container" class="mt-3"></div>
            </div>

            <div class="bg-gray-800 p-2 rounded-lg h-56 overflow-y-auto">
                 <table class="w-full text-left text-sm"><thead class="text-gray-400 sticky top-0 bg-gray-800"><tr><th>Tempo</th><th>P.</th><th>Setor</th><th>Ação</th><th>Detalhe</th><th>Jogador</th></tr></thead><tbody id="live-log-body" class="divide-y divide-gray-700"></tbody></table>
            </div>
        </div>

        <!-- Reports View -->
        <div id="reports" class="view">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-3xl font-bold text-white">Relatórios de Partida</h2>
                <div>
                     <button id="csv-export-button" class="bg-gray-700 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg mr-2" onclick="exportActionsToCSV()">Exportar Ações (CSV)</button>
                     <button id="pdf-export-button" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg flex items-center" onclick="exportReportToPDF()">
                        <span id="pdf-export-text">Exportar Relatório (PDF)</span>
                        <div id="pdf-export-loader" class="hidden ml-2 w-5 h-5 border-4 border-gray-400 border-solid rounded-full animate-spin"></div>
                     </button>
                </div>
            </div>
            <div class="bg-gray-800 p-4 rounded-lg mb-6">
                <label for="report-match-select" class="mr-2 text-gray-300">Selecione uma Partida:</label>
                <select id="report-match-select" class="w-full md:w-1/2 p-2 rounded mt-1" onchange="generateReports(this.value)"></select>
            </div>

            <div id="report-content-wrapper" class="p-8 rounded-lg mt-6">
                <div id="report-content" class="hidden space-y-8">
                    <!-- Match Report Content -->
                </div>
            </div>
        </div>
    </main>
    
    <!-- Modals -->
    <div id="modal-container" class="fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center p-4 z-50 hidden" onclick="closeAllModals(event)">
        <!-- New Match Modal -->
        <div id="new-match-modal" class="modal-content bg-gray-800 text-white rounded-lg p-6 w-full max-w-3xl hidden">
            <h3 class="text-2xl font-bold mb-6">Criar Nova Partida</h3>
            <form id="new-match-form" class="grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-4">
                <div class="md:col-span-2 grid grid-cols-2 gap-4">
                    <div><label>Nome da sua equipe:</label><input type="text" id="match-my-team-name" placeholder="Ex: Principal, Sub-20" class="w-full p-2.5 mt-1" required></div>
                    <div><label>Adversário:</label><input type="text" id="match-opponent-name" placeholder="Nome do Adversário" class="w-full p-2.5 mt-1" required></div>
                    <div><label>Data:</label><input type="date" id="match-date" class="w-full p-2.5 mt-1" required></div>
                    <div><label>Local:</label><input type="text" id="match-location" placeholder="Local da Partida" class="w-full p-2.5 mt-1" required></div>
                </div>
                <div class="md:col-span-1">
                    <h4 class="font-bold mb-2">Jogadores Convocados:</h4>
                    <div id="match-squad-list" class="h-64 overflow-y-auto border border-gray-600 p-3 rounded space-y-2"></div>
                </div>
                 <div class="md:col-span-1">
                    <h4 class="font-bold mb-2">Escalação Tática (4-3-3):</h4>
                    <div id="match-lineup-selection" class="h-64 overflow-y-auto border border-gray-600 p-3 rounded space-y-3"></div>
                </div>
                <button type="submit" class="md:col-span-2 w-full bg-blue-600 p-3 rounded text-lg">Criar Partida</button>
            </form>
        </div>
        
        <!-- Player Selection Modal for Events -->
        <div id="player-selection-modal" class="modal-content bg-gray-800 text-white rounded-lg p-6 w-full max-w-sm hidden">
             <h3 class="text-2xl font-bold mb-4">Selecionar Jogador</h3>
             <form id="player-selection-form">
                <input type="hidden" id="event-zone-player">
                <input type="hidden" id="event-action-player">
                <input type="hidden" id="event-detail-player">
                <label>Jogador:</label>
                <select id="event-player-select" class="w-full p-2.5 mt-1"></select>
                <button type="submit" class="w-full bg-blue-600 p-2.5 rounded mt-4">Confirmar</button>
            </form>
        </div>
        
        <!-- Goal Modal -->
        <div id="goal-modal" class="modal-content bg-gray-800 text-white rounded-lg p-6 w-full max-w-lg hidden">
            <!-- Goal modal content will be populated by JS -->
        </div>
        
        <!-- Post-Match Rating Modal -->
        <div id="rating-modal" class="modal-content bg-gray-800 text-white rounded-lg p-6 w-full max-w-3xl hidden">
            <h3 class="text-2xl font-bold mb-4">Avaliação de Desempenho Pós-Jogo</h3>
            <div id="rating-player-list" class="space-y-6 max-h-[60vh] overflow-y-auto p-2"></div>
            <button class="w-full bg-blue-600 p-2.5 rounded mt-4" onclick="saveRatings()">Salvar Avaliações e Finalizar Partida</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- GLOBAL STATE ---
        let appState = { players: [], matches: [], activeMatchId: null, currentView: 'dashboard', listenersAttached: false };
        let liveState = { timerInterval: null, possessionInterval: null, seconds: 0, currentPeriod: 0, currentPossessionHolder: null, activeSubAction: null };
        let charts = {};
        const { jsPDF } = window.jspdf;
        let userId;
        let db, auth;

        // --- FIREBASE SETUP ---
        // More robust Firebase config initialization
        let firebaseConfig = {};
        try {
            if (typeof __firebase_config !== 'undefined' && __firebase_config) {
                firebaseConfig = JSON.parse(__firebase_config);
            } else {
                console.warn("Variável global __firebase_config não encontrada. A inicialização pode falhar.");
                firebaseConfig = { apiKey: "PLACEHOLDER", authDomain: "PLACEHOLDER", projectId: "PLACEHOLDER" };
            }
        } catch (e) {
            console.error("Falha ao analisar __firebase_config JSON:", e);
            firebaseConfig = { apiKey: "PARSE_ERROR", authDomain: "PARSE_ERROR", projectId: "PARSE_ERROR" };
        }
        
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'scout-pro-futebol-v2';
        
        async function firebaseAuth() {
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) { await signInWithCustomToken(auth, __initial_auth_token); } 
                else { await signInAnonymously(auth); }
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        document.getElementById('user-id-display').textContent = userId;
                        if (!appState.listenersAttached) { setupListeners(); appState.listenersAttached = true; }
                        navigateTo(appState.currentView || 'dashboard');
                    }
                });
            } catch (error) {
                console.error("ERRO DE INICIALIZAÇÃO DO FIREBASE:", error);
                console.error("Configuração do Firebase utilizada:", firebaseConfig);
                showErrorMessage("Falha na inicialização do Firebase. Verifique o console para mais detalhes (F12).", false);
            }
        }
        
        function setupListeners() {
            if (!userId) return;
            const playersRef = collection(db, "artifacts", appId, "users", userId, "players");
            onSnapshot(playersRef, (snapshot) => {
                appState.players = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                if(appState.currentView === 'management') { renderPlayersTable(); }
            }, (error) => { showErrorMessage("Erro ao carregar jogadores.", error); });

            const matchesRef = collection(db, "artifacts", appId, "users", userId, "matches");
            onSnapshot(query(matchesRef), (snapshot) => {
                appState.matches = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                refreshCurrentView();
            }, (error) => { showErrorMessage("Erro ao carregar partidas.", error); });
        }
        
        function refreshCurrentView() {
            switch(appState.currentView) {
                case 'live-match':
                    renderLiveScoreAndTimer();
                    renderLiveLog();
                    updatePossessionDisplay();
                    break;
                case 'matches':
                    renderMatchList();
                    break;
                case 'dashboard':
                    renderDashboard();
                    break;
                case 'reports':
                    renderReportMatchSelect();
                    const selectedMatchId = document.getElementById('report-match-select').value;
                    if(selectedMatchId) { generateReports(selectedMatchId); }
                    else { hideReportContent(); }
                    break;
            }
        }

        // --- UI ELEMENTS ---
        const ui = {
            views: document.querySelectorAll('.view'),
            navLinks: document.querySelectorAll('.nav-link'),
            modalContainer: document.getElementById('modal-container'),
            liveMatch: {
                header: document.querySelector('#live-match .bg-gray-800'),
                logBody: document.getElementById('live-log-body'),
                subActionContainer: document.getElementById('sub-action-container')
            },
            playerSelectionModal: {
                form: document.getElementById('player-selection-form'),
                zone: document.getElementById('event-zone-player'),
                action: document.getElementById('event-action-player'),
                detail: document.getElementById('event-detail-player'),
                select: document.getElementById('event-player-select')
            }
        };

        // --- NAVIGATION ---
        window.navigateTo = function(viewId) {
            appState.currentView = viewId;
            ui.views.forEach(v => v.classList.remove('active'));
            document.getElementById(viewId)?.classList.add('active');
            ui.navLinks.forEach(l => {
                const isActive = l.getAttribute('onclick') === `navigateTo('${viewId}')`;
                l.classList.toggle('active', isActive);
            });
            refreshCurrentView();
        }

        // --- MODAL HANDLING ---
        window.openModal = function(modalId) {
            if (modalId === 'new-match-modal') prepareNewMatchModal();
            ui.modalContainer.classList.remove('hidden');
            ui.modalContainer.classList.add('flex');
            document.getElementById(modalId)?.classList.remove('hidden');
        }
        function closeModal(modalId) { 
            ui.modalContainer.classList.add('hidden');
            ui.modalContainer.classList.remove('flex');
            if(modalId) { document.getElementById(modalId)?.classList.add('hidden'); } 
            else { ui.modalContainer.querySelectorAll('.modal-content').forEach(m => m.classList.add('hidden')); }
        }
        window.closeAllModals = function(event) { if (event.target === ui.modalContainer) { closeModal(); }}
        
        function showErrorMessage(message, error) {
            if (error) console.error(message, error);
            const errorBar = document.createElement('div');
            errorBar.textContent = `⚠️ Erro: ${message}`;
            errorBar.style.position = 'fixed';
            errorBar.style.top = '1rem';
            errorBar.style.left = '50%';
            errorBar.style.transform = 'translateX(-50%)';
            errorBar.style.backgroundColor = '#ef4444'; // red-500
            errorBar.style.color = 'white';
            errorBar.style.padding = '0.75rem 1.5rem';
            errorBar.style.borderRadius = '0.5rem';
            errorBar.style.boxShadow = '0 4px 6px rgba(0, 0, 0, 0.1)';
            errorBar.style.zIndex = '1000';
            errorBar.style.fontWeight = '600';
            document.body.appendChild(errorBar);

            setTimeout(() => {
                errorBar.style.transition = 'opacity 0.5s';
                errorBar.style.opacity = '0';
                setTimeout(() => document.body.removeChild(errorBar), 500);
            }, 5000);
        }

        // --- PLAYER MANAGEMENT ---
        document.getElementById('player-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const form = e.target;
            const id = form.querySelector('#player-id').value;
            const playerData = {
                name: form.querySelector('#player-name').value,
                dob: form.querySelector('#player-dob').value,
                position: form.querySelector('#player-position').value
            };
            try {
                const collectionRef = collection(db, "artifacts", appId, "users", userId, "players");
                if (id) { await setDoc(doc(collectionRef, id), playerData); } 
                else { await addDoc(collectionRef, playerData); }
                form.reset();
                form.querySelector('#player-id').value = '';
            } catch (error) { showErrorMessage("Não foi possível salvar o jogador", error); }
        });

        function renderPlayersTable() {
            const tableBody = document.getElementById('players-table');
            tableBody.innerHTML = '';
            if (appState.players.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="3" class="text-center p-4 text-gray-400">Nenhum jogador cadastrado.</td></tr>';
                return;
            }
            [...appState.players].sort((a,b) => a.name.localeCompare(b.name)).forEach(player => {
                const row = tableBody.insertRow();
                row.innerHTML = `<td class="p-3">${player.name}</td><td class="p-3">${player.position}</td><td class="p-3"><button class="text-blue-400 hover:text-blue-300 mr-4 font-semibold" onclick="editPlayer('${player.id}')">Editar</button><button class="text-red-400 hover:text-red-300 font-semibold" onclick="deletePlayer('${player.id}')">Excluir</button></td>`;
            });
        }
        window.editPlayer = function(id) {
            const player = appState.players.find(p => p.id === id);
            const form = document.getElementById('player-form');
            form.querySelector('#player-id').value = player.id;
            form.querySelector('#player-name').value = player.name;
            form.querySelector('#player-dob').value = player.dob;
            form.querySelector('#player-position').value = player.position;
            form.scrollIntoView({ behavior: 'smooth' });
        }
        window.deletePlayer = async function(id) {
            try { await deleteDoc(doc(db, "artifacts", appId, "users", userId, "players", id)); } 
            catch (error) { showErrorMessage("Não foi possível excluir o jogador", error); }
        }
        
        // --- MATCH MANAGEMENT ---
        const lineupPositions = {
            gk: 'Goleiro', rb: 'Lateral Direito', rcb: 'Zagueiro (Dir)', lcb: 'Zagueiro (Esq)', lb: 'Lateral Esquerdo',
            dm: 'Volante', rcm: 'Meia (Dir)', lcm: 'Meia (Esq)', rw: 'Atacante (Dir)', st: 'Centroavante', lw: 'Atacante (Esq)'
        };
        
        function prepareNewMatchModal() {
            const squadList = document.getElementById('match-squad-list');
            squadList.innerHTML = appState.players.length === 0 ? '<p class="text-gray-400">Cadastre jogadores primeiro.</p>' : '';
            [...appState.players].sort((a,b) => a.name.localeCompare(b.name)).forEach(player => { 
                squadList.innerHTML += `<div class="flex items-center"><input type="checkbox" id="squad-${player.id}" value="${player.id}" class="mr-2 h-4 w-4" onchange="updateLineupSelectors()"><label for="squad-${player.id}">${player.name} (${player.position})</label></div>`; 
            });
            document.getElementById('match-date').valueAsDate = new Date();
            updateLineupSelectors();
        }

        window.updateLineupSelectors = () => {
            const lineupContainer = document.getElementById('match-lineup-selection');
            lineupContainer.innerHTML = '';
            const selectedPlayerIds = Array.from(document.querySelectorAll('#match-squad-list input:checked')).map(i => i.value);
            const selectedPlayers = selectedPlayerIds.map(id => appState.players.find(p => p.id === id)).filter(Boolean);

            if (selectedPlayers.length === 0) {
                lineupContainer.innerHTML = '<p class="text-gray-400 text-center mt-4">Selecione jogadores convocados para montar a escalação.</p>';
                return;
            }

            const playerOptions = selectedPlayers.map(p => `<option value="${p.id}">${p.name}</option>`).join('');
            
            Object.entries(lineupPositions).forEach(([key, label]) => {
                lineupContainer.innerHTML += `
                    <div class="grid grid-cols-3 items-center">
                        <label for="lineup-${key}" class="text-sm col-span-1">${label}:</label>
                        <select id="lineup-${key}" name="lineup-${key}" class="w-full p-2 mt-1 col-span-2">
                           <option value="">Selecione...</option>
                           ${playerOptions}
                        </select>
                    </div>`;
            });
        };

        document.getElementById('new-match-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const squadPlayerIds = Array.from(document.querySelectorAll('#match-squad-list input:checked')).map(i => i.value);
            if (squadPlayerIds.length === 0) return showErrorMessage('Selecione pelo menos um jogador para a partida.');
            
            const lineup = {};
            for (const key in lineupPositions) {
                lineup[key] = document.getElementById(`lineup-${key}`).value;
            }

            const matchData = {
                myTeamName: document.getElementById('match-my-team-name').value || "Minha Equipe", 
                opponentName: document.getElementById('match-opponent-name').value,
                date: document.getElementById('match-date').value, 
                location: document.getElementById('match-location').value,
                squadPlayerIds,
                lineup,
                myTeamScore: 0, opponentScore: 0, status: 'scheduled', events: [], 
                possession: { myTeam: 0, opponent: 0, stopped: 0 }, ratings: {}
            };
            try {
                await addDoc(collection(db, "artifacts", appId, "users", userId, "matches"), matchData);
                e.target.reset(); 
                closeModal('new-match-modal'); 
            } catch (error) { showErrorMessage("Não foi possível criar a partida", error); }
        });
        
        function renderMatchList() {
            const listEl = document.getElementById('match-list');
            listEl.innerHTML = '';
             [...appState.matches].sort((a,b) => new Date(b.date) - new Date(a.date)).forEach(match => {
                const card = document.createElement('div');
                card.className = 'bg-gray-800 p-4 rounded-lg flex justify-between items-center transition hover:bg-gray-700';
                const statusConfig = {
                    finished: {
                        content: `<span class="font-bold text-2xl">${match.myTeamScore} - ${match.opponentScore}</span>`,
                        color: ''
                    },
                    live: {
                        content: `<button class="bg-yellow-600 hover:bg-yellow-700 text-white font-bold py-2 px-4 rounded" onclick="startLiveMatch('${match.id}')">Continuar Scout</button>`,
                    },
                    scheduled: {
                         content: `<button class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded" onclick="startLiveMatch('${match.id}')">Iniciar Scout</button>`,
                    }
                };
                card.innerHTML = `
                    <div>
                        <p class="text-xl font-bold">${match.myTeamName} vs ${match.opponentName}</p>
                        <p class="text-sm text-gray-400">${new Date(match.date).toLocaleDateString('pt-BR', {timeZone: 'UTC'})} - ${match.location || 'Local não definido'}</p>
                    </div>
                    <div class="flex items-center gap-4">
                        ${statusConfig[match.status]?.content || ''}
                        <button onclick="deleteMatch('${match.id}')" title="Excluir partida" class="text-red-500 hover:text-red-400 p-2 rounded-full">
                            <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                        </button>
                    </div>`;
                listEl.appendChild(card);
            });
        }
        
        window.deleteMatch = async function(id) {
            try { await deleteDoc(doc(db, "artifacts", appId, "users", userId, "matches", id)); } 
            catch (error) { showErrorMessage("Não foi possível excluir a partida.", error); }
        }
        
        // --- LIVE MATCH ---
        function formatTime(s) { const min = Math.floor(s / 60).toString().padStart(2, '0'); const sec = (s % 60).toString().padStart(2, '0'); return `${min}:${sec}`; }
        
        async function updateMatchData(matchId, data) {
            try { await updateDoc(doc(db, "artifacts", appId, "users", userId, "matches", matchId), data); } 
            catch (error) { showErrorMessage("Não foi possível atualizar os dados da partida.", error); }
        }

        window.startLiveMatch = async function(matchId) {
            appState.activeMatchId = matchId;
            const match = appState.matches.find(m => m.id === matchId);
            if(!match) return;
            if (match.status !== 'live') { await updateMatchData(matchId, { status: 'live' }); }
            
            liveState = { 
                timerInterval: null, possessionInterval: null, 
                seconds: match.timerSeconds || 0, 
                currentPeriod: match.timerPeriod || 0, 
                currentPossessionHolder: null, activeSubAction: null
            };
            navigateTo('live-match');
        }

        function renderLiveScoreAndTimer() {
            const match = appState.matches.find(m => m.id === appState.activeMatchId);
            if (!match) return;
            const header = ui.liveMatch.header;
            header.innerHTML = `
                <div class="flex justify-between items-center text-white">
                    <div class="text-2xl font-bold">${match.myTeamName}</div>
                    <div class="text-4xl font-black">${match.myTeamScore} - ${match.opponentScore}</div>
                    <div class="text-2xl font-bold">${match.opponentName}</div>
                </div>
                <div class="text-center text-6xl font-black text-white my-4" id="live-timer">${formatTime(liveState.seconds)}</div>
                <div class="flex justify-center gap-2">
                    <button class="bg-green-600 px-3 py-1 rounded" onclick="timerControl('start1')">▶ 1ºT</button>
                    <button class="bg-yellow-500 px-3 py-1 rounded" onclick="timerControl('pause')">⏸ Intervalo</button>
                    <button class="bg-green-600 px-3 py-1 rounded" onclick="timerControl('start2')">▶ 2ºT</button>
                    <button class="bg-red-600 px-3 py-1 rounded" onclick="timerControl('end')">⏹ Fim de Jogo</button>
                </div>
                 <div class="bg-gray-900 p-3 rounded-lg mt-4">
                    <h3 class="text-center text-base font-bold text-white mb-2">Controle de Posse de Bola</h3>
                    <div class="flex justify-center gap-4">
                        <button id="possession-myTeam" class="possession-btn bg-blue-600 text-white p-2 rounded" onclick="togglePossession('myTeam')">${match.myTeamName}</button>
                        <button id="possession-opponent" class="possession-btn bg-red-600 text-white p-2 rounded" onclick="togglePossession('opponent')">${match.opponentName}</button>
                        <button id="possession-stopped" class="possession-btn bg-gray-500 text-white p-2 rounded" onclick="togglePossession('stopped')">Bola Parada</button>
                    </div>
                    <div class="text-center text-white mt-2" id="possession-display"></div>
                </div>
                <div class="flex gap-2 mt-4">
                    <button class="w-1/2 bg-green-700 hover:bg-green-800 p-3 rounded-lg text-white font-bold" onclick="prepareGoalModal('myTeam')">GOL PRÓ</button>
                    <button class="w-1/2 bg-red-800 hover:bg-red-900 p-3 rounded-lg text-white font-bold" onclick="logGoal('opponent')">GOL CONTRA</button>
                </div>
            `;
            updatePossessionDisplay();
        }

        window.timerControl = function(action) {
            clearInterval(liveState.timerInterval);
            let shouldStartTimer = false;
            
            if (action === 'start1') { liveState.currentPeriod = 1; shouldStartTimer = true; }
            else if (action === 'start2') {
                liveState.currentPeriod = 2;
                if (liveState.seconds < 2700) liveState.seconds = 2700; // Jump to halftime
                shouldStartTimer = true;
            } 
            else if (action === 'end') {
                togglePossession(null);
                prepareRatingModal(); openModal('rating-modal');
            }

            if (shouldStartTimer) {
                liveState.timerInterval = setInterval(() => { 
                    liveState.seconds++; 
                    const timerEl = document.getElementById('live-timer');
                    if (timerEl) timerEl.textContent = formatTime(liveState.seconds);
                    if (liveState.seconds % 10 === 0) {
                        updateMatchData(appState.activeMatchId, { timerSeconds: liveState.seconds, timerPeriod: liveState.currentPeriod });
                    }
                }, 1000);
            }
            // On pause or end, ensure last timer state is saved
            updateMatchData(appState.activeMatchId, { timerSeconds: liveState.seconds, timerPeriod: liveState.currentPeriod });
        }

        window.togglePossession = function(team) {
            clearInterval(liveState.possessionInterval);
            document.querySelectorAll('.possession-btn').forEach(b => b.classList.remove('active'));
            
            if (team && liveState.currentPossessionHolder !== team) {
                liveState.currentPossessionHolder = team;
                document.getElementById(`possession-${team}`)?.classList.add('active');
                liveState.possessionInterval = setInterval(() => { 
                    const match = appState.matches.find(m => m.id === appState.activeMatchId);
                    if(match) { 
                        const updatedPossession = { ...match.possession };
                        updatedPossession[team]++;
                        updateMatchData(appState.activeMatchId, { possession: updatedPossession });
                    }
                }, 1000);
            } else { liveState.currentPossessionHolder = null; }
        }

        function updatePossessionDisplay() {
            const match = appState.matches.find(m => m.id === appState.activeMatchId);
            const display = document.getElementById('possession-display');
            if(!match || !match.possession || !display) return;
            const total = match.possession.myTeam + match.possession.opponent || 1;
            const myTeamPerc = ((match.possession.myTeam / total) * 100).toFixed(0);
            const opponentPerc = ((match.possession.opponent / total) * 100).toFixed(0);
            display.textContent = `Posse: ${match.myTeamName} ${myTeamPerc}% | ${match.opponentName} ${opponentPerc}%`;
        }
        
        // --- EVENT LOGGING V2 (SUB-ACTIONS) ---
        const eventConfig = {
            finalizacao: { title: "Finalização", player: true, sub: [{label: "No Gol", value: "no_gol"},{label: "Fora", value: "fora"}, {label:"Bloqueada", value:"bloqueada"}] },
            duelo: { title: "Duelo", player: true, sub: [{label: "Ganho", value: "ganho"}, {label:"Perdido", value:"perdido"}] },
            // Simple events do not need configuration
        };
        
        window.logEvent = (event, zone, action) => {
            const match = appState.matches.find(m => m.id === appState.activeMatchId);
            if (!match || liveState.currentPeriod === 0) return showErrorMessage("Inicie o cronômetro para registrar eventos.");

            const config = eventConfig[action];
            if (config && config.sub) {
                // Show sub-actions
                liveState.activeSubAction = { zone, action, config };
                renderSubActions();
            } else {
                // For simple events, decide if player selection is needed
                const simpleEventNeedsPlayer = ['passe_certo', 'passe_errado', 'falta_cometida', 'falta_sofrida', 'cruzamento_dir', 'cruzamento_esq'];
                if(simpleEventNeedsPlayer.includes(action)) {
                     showPlayerSelectionModal(zone, action, 'N/A');
                } else {
                    // Log event with no player
                    finalizeEvent(zone, action, 'N/A', null);
                }
            }
        };

        function renderSubActions() {
            ui.liveMatch.subActionContainer.innerHTML = '';
            if (!liveState.activeSubAction) return;

            const { config } = liveState.activeSubAction;
            const buttonGroup = document.createElement('div');
            buttonGroup.className = 'flex justify-center items-center gap-3 bg-gray-900 p-3 rounded-lg';
            buttonGroup.innerHTML = `<span class="font-bold text-white">${config.title}:</span>`;
            
            config.sub.forEach(opt => {
                const btn = document.createElement('button');
                btn.className = 'action-btn bg-blue-600';
                btn.textContent = opt.label;
                btn.onclick = () => handleSubActionClick(opt.value);
                buttonGroup.appendChild(btn);
            });
            ui.liveMatch.subActionContainer.appendChild(buttonGroup);
        }

        function handleSubActionClick(detail) {
            const { zone, action, config } = liveState.activeSubAction;
            liveState.activeSubAction = null;
            renderSubActions(); // Clear sub-actions from UI
            
            if (config.player) {
                showPlayerSelectionModal(zone, action, detail);
            } else {
                finalizeEvent(zone, action, detail, null);
            }
        }
        
        function showPlayerSelectionModal(zone, action, detail) {
            const match = appState.matches.find(m => m.id === appState.activeMatchId);
            if (!match) return;

            ui.playerSelectionModal.zone.value = zone;
            ui.playerSelectionModal.action.value = action;
            ui.playerSelectionModal.detail.value = detail;

            const players = match.squadPlayerIds.map(pid => appState.players.find(p => p.id === pid)).filter(Boolean);
            const sortedPlayers = [...players].sort((a,b) => a.name.localeCompare(b.name));
            ui.playerSelectionModal.select.innerHTML = sortedPlayers.map(p => `<option value="${p.id}">${p.name}</option>`).join('');
            openModal('player-selection-modal');
        }

        ui.playerSelectionModal.form.addEventListener('submit', (e) => {
            e.preventDefault();
            const form = e.target;
            const zone = form.querySelector('#event-zone-player').value;
            const action = form.querySelector('#event-action-player').value;
            const detail = form.querySelector('#event-detail-player').value;
            const playerId = form.querySelector('#event-player-select').value;
            
            finalizeEvent(zone, action, detail, playerId);
            closeModal('player-selection-modal');
        });

        async function finalizeEvent(zone, action, detail, playerId) {
            const match = appState.matches.find(m => m.id === appState.activeMatchId);
            if(!match) return;

            const player = playerId ? appState.players.find(p => p.id === playerId) : null;
            const newEvent = {
                time: liveState.seconds, period: liveState.currentPeriod, zone, action, detail,
                playerId: playerId || null,
                playerName: player?.name || 'N/A'
            };
            const updatedEvents = [newEvent, ...(match.events || [])];
            await updateMatchData(appState.activeMatchId, { events: updatedEvents });
            const btn = document.querySelector(`[onclick="logEvent(event, '${zone}', '${action}')"]`);
            if(btn) {
                btn.classList.add('clicked');
                setTimeout(() => btn.classList.remove('clicked'), 200);
            }
        }

        function renderLiveLog() {
            const match = appState.matches.find(m => m.id === appState.activeMatchId);
            if(!match || !match.events) return;
            const logBody = ui.liveMatch.logBody;
            logBody.innerHTML = '';
            match.events.forEach(ev => {
                const row = logBody.insertRow(0); // Insert at the top
                row.innerHTML = `<td class="p-2 text-xs">${formatTime(ev.time)}</td><td class="p-2 text-xs">${ev.period}ºT</td><td class="p-2 text-xs">${ev.zone}</td><td class="p-2 text-xs">${(ev.action || '').replace(/_/g, ' ')}</td><td class="p-2 text-xs">${ev.detail}</td><td class="p-2 text-xs">${ev.playerName}</td>`;
            });
        }
        
        // --- GOAL LOGGING ---
        window.logGoal = async (teamType) => {
            const match = appState.matches.find(m => m.id === appState.activeMatchId);
            if(!match || liveState.currentPeriod === 0) return showErrorMessage("Inicie o cronômetro para registrar um gol.");

            if (teamType === 'opponent') {
                const updatedEvents = [{
                    time: liveState.seconds, period: liveState.currentPeriod, zone: 'ataque', action: 'gol_contra',
                    detail: 'N/A', playerId: null, playerName: 'Adversário', scoringTeam: 'opponent'
                }, ...(match.events || [])];
                await updateMatchData(appState.activeMatchId, { events: updatedEvents, opponentScore: match.opponentScore + 1 });
            }
        };
        
        window.prepareGoalModal = (teamType) => {
            const match = appState.matches.find(m => m.id === appState.activeMatchId);
            if(!match || liveState.currentPeriod === 0) return showErrorMessage("Inicie o cronômetro para registrar um gol.");

            const modal = document.getElementById('goal-modal');
            const players = match.squadPlayerIds.map(pid => appState.players.find(p => p.id === pid)).filter(Boolean);
            const playerOptions = [...players].sort((a,b) => a.name.localeCompare(b.name)).map(p => `<option value="${p.id}">${p.name}</option>`).join('');
            
            modal.innerHTML = `
                <h3 class="text-2xl font-bold mb-4">Registrar Gol</h3>
                <form id="goal-form">
                     <div id="my-team-goal-details">
                         <label class="block mb-1">Jogador:</label><select id="goal-player" class="w-full p-2 rounded mb-2">${playerOptions}</select>
                         <label class="block mb-1">Assistência:</label><select id="goal-assist" class="w-full p-2 rounded mb-2"><option value="">Nenhuma</option>${playerOptions}</select>
                     </div>
                     <label class="block mb-1">Tipo de Gol:</label><select id="goal-type" class="w-full p-2 rounded mb-2"><option>Bola Rolando</option><option>Bola Parada</option><option>Pênalti</option><option>Cabeça</option><option>Chute Fora da Área</option></select>
                     <button type="submit" class="w-full bg-green-600 p-2.5 rounded mt-4">Confirmar Gol</button>
                </form>`;
            openModal('goal-modal');

            document.getElementById('goal-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const goalPlayerId = document.getElementById('goal-player').value;
                const assistPlayerId = document.getElementById('goal-assist').value;
                const goalType = document.getElementById('goal-type').value;

                const goalPlayer = appState.players.find(p => p.id === goalPlayerId);
                const assistPlayer = assistPlayerId ? appState.players.find(p => p.id === assistPlayerId) : null;
                
                const newEvent = {
                    time: liveState.seconds, period: liveState.currentPeriod, zone: 'ataque', action: 'gol', detail: goalType,
                    playerId: goalPlayerId, playerName: goalPlayer?.name || 'N/A',
                    assistId: assistPlayerId || null, assistName: assistPlayer?.name || null, scoringTeam: 'myTeam'
                };
                const updatedEvents = [newEvent, ...(match.events || [])];
                await updateMatchData(appState.activeMatchId, { events: updatedEvents, myTeamScore: match.myTeamScore + 1 });
                closeModal('goal-modal');
            });
        };

        // --- POST-MATCH RATING ---
        function prepareRatingModal() {
            const match = appState.matches.find(m => m.id === appState.activeMatchId);
            const players = match.squadPlayerIds.map(pid => appState.players.find(p => p.id === pid)).filter(Boolean);
            const listEl = document.getElementById('rating-player-list');
            listEl.innerHTML = '';
            [...players].sort((a,b) => a.name.localeCompare(b.name)).forEach(p => { 
                listEl.innerHTML += `<div class="bg-gray-700 p-3 rounded-lg"><h4 class="text-lg font-bold">${p.name}</h4><div class="grid grid-cols-2 md:grid-cols-4 gap-4 mt-2">${['Técnico', 'Tático', 'Físico', 'Comportamental'].map(cat => `<div><label for="rating-${p.id}-${cat.toLowerCase()}">${cat}</label><input type="range" id="rating-${p.id}-${cat.toLowerCase()}" min="1" max="10" value="5" class="w-full mt-1"></div>`).join('')}</div></div>`; 
            });
        }
        window.saveRatings = async function() {
            const match = appState.matches.find(m => m.id === appState.activeMatchId);
            if(!match) return;
            const ratings = {};
            match.squadPlayerIds.forEach(pid => {
                ratings[pid] = {
                    tecnico: document.getElementById(`rating-${pid}-técnico`)?.value || 5, tatico: document.getElementById(`rating-${pid}-tático`)?.value || 5,
                    fisico: document.getElementById(`rating-${pid}-físico`)?.value || 5, comportamental: document.getElementById(`rating-${pid}-comportamental`)?.value || 5,
                };
            });
            await updateMatchData(appState.activeMatchId, { status: 'finished', ratings: ratings });
            closeModal('rating-modal'); 
            navigateTo('matches');
        }

        // --- DASHBOARD & REPORTS ---
        function renderDashboard() {
            const container = document.getElementById('dashboard');
            container.innerHTML = '<h2 class="text-3xl font-bold text-white mb-6">Dashboard</h2><div id="dashboard-grid" class="grid grid-cols-1 md:grid-cols-3 gap-6"></div>';
            const grid = document.getElementById('dashboard-grid');
            
            const finishedMatches = appState.matches.filter(m => m.status === 'finished');
            const totalGoalsScored = appState.matches.reduce((acc, m) => acc + (m.myTeamScore || 0), 0);
            const totalGoalsConceded = appState.matches.reduce((acc, m) => acc + (m.opponentScore || 0), 0);

            grid.innerHTML = `
                <div class="dashboard-card p-6 rounded-lg col-span-1"><h3 class="font-bold text-lg mb-4 text-gray-400">Total de Partidas</h3><p class="text-5xl font-extrabold">${finishedMatches.length}</p></div>
                <div class="dashboard-card p-6 rounded-lg col-span-1"><h3 class="font-bold text-lg mb-4 text-gray-400">Gols Marcados</h3><p class="text-5xl font-extrabold text-green-400">${totalGoalsScored}</p></div>
                <div class="dashboard-card p-6 rounded-lg col-span-1"><h3 class="font-bold text-lg mb-4 text-gray-400">Gols Sofridos</h3><p class="text-5xl font-extrabold text-red-400">${totalGoalsConceded}</p></div>
            `;
        }

        function renderReportMatchSelect() {
            const select = document.getElementById('report-match-select');
            select.innerHTML = ''; // Clear previous options
            const finishedMatches = [...appState.matches].filter(m => m.status === 'finished').sort((a,b) => new Date(b.date) - new Date(a.date));
            select.innerHTML = '<option value="">Selecione uma partida</option>';
            finishedMatches.forEach(m => { select.innerHTML += `<option value="${m.id}">${m.myTeamName} vs ${m.opponentName} - ${new Date(m.date).toLocaleDateString('pt-BR', {timeZone: 'UTC'})}</option>`; });
        }
        
        function hideReportContent() {
            document.getElementById('report-content').classList.add('hidden');
            document.getElementById('csv-export-button').style.display = 'none';
            document.getElementById('pdf-export-button').style.display = 'none';
        }
        
        function destroyCharts() { Object.values(charts).forEach(chart => chart?.destroy()); }
        
        Chart.register(ChartDataLabels);
        
        window.generateReports = function(matchId) {
            destroyCharts();
            const reportContentEl = document.getElementById('report-content');
            if (!matchId) { hideReportContent(); return; }
            
            reportContentEl.classList.remove('hidden');
            document.getElementById('csv-export-button').style.display = 'inline-flex';
            document.getElementById('pdf-export-button').style.display = 'inline-flex';
            
            const match = appState.matches.find(m => m.id === matchId);
            if (!match) return;

            reportContentEl.innerHTML = `
                <div class="text-center mb-8">
                    <h1 class="text-4xl font-bold">${match.myTeamName} ${match.myTeamScore} x ${match.opponentScore} ${match.opponentName}</h1>
                    <p class="text-lg text-gray-600">${new Date(match.date).toLocaleDateString('pt-BR', {timeZone: 'UTC'})} - ${match.location}</p>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
                    <div class="bg-gray-50 p-4 rounded-lg border"><h3 class="text-xl font-bold text-center mb-2">Posse de Bola</h3><div class="chart-container h-24"><canvas id="possessionChart"></canvas></div></div>
                    <div class="bg-gray-50 p-4 rounded-lg border"><h3 class="text-xl font-bold text-center mb-2">Destaque da Partida</h3><div id="report-motm" class="text-center"></div></div>
                </div>

                <div class="bg-gray-50 p-4 rounded-lg border mb-8">
                    <h3 class="text-xl font-bold text-center mb-4">Volume de Ações por Setor</h3>
                    <div class="chart-container"><canvas id="actionMapChart"></canvas></div>
                    <div class="flex justify-between items-center mt-2 px-4">
                        <span class="font-semibold text-gray-700">Zona de Defesa</span>
                        <svg class="w-full h-8 text-gray-500" viewBox="0 0 100 10" preserveAspectRatio="none"><path d="M0,5 h100 l-10,-4 m10,4 l-10,4" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" /></svg>
                        <span class="font-semibold text-gray-700">Zona de Ataque</span>
                    </div>
                     <p class="text-center text-sm text-gray-500 mt-1">Contagem total das ações por zona.</p>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <div class="bg-gray-50 p-4 rounded-lg border"><h3 class="text-xl font-bold text-center mb-2">Resumo de Ações</h3><div id="report-summary-table"></div></div>
                    <div class="bg-gray-50 p-4 rounded-lg border"><h3 class="text-xl font-bold text-center mb-2">Escalação Tática</h3><div id="report-formation" class="h-full"></div></div>
                </div>`;
            
            // --- Chart: Possession ---
            const posCtx = document.getElementById('possessionChart').getContext('2d');
            charts.possession = new Chart(posCtx, {
                type: 'bar',
                data: { labels: ['Posse'], datasets: [ { label: match.myTeamName, data: [match.possession.myTeam], backgroundColor: '#3b82f6' }, { label: match.opponentName, data: [match.possession.opponent], backgroundColor: '#ef4444' } ]},
                options: { indexAxis: 'y', responsive: true, maintainAspectRatio: false, scales: { x: { stacked: true, display: false }, y: { stacked: true, display: false } }, plugins: { legend: { display: true, position: 'top', labels: {color: '#374151'} }, datalabels: { color: 'white', font: { weight: 'bold' }, formatter: (v, ctx) => {
                    const total = ctx.chart.data.datasets.reduce((s, ds) => s + (ds.data[0] || 0), 0);
                    return total > 0 ? (v / total * 100).toFixed(0) + '%' : '0%';
                }}}}
            });

            // --- Chart: Action Map ---
            const sectorCounts = { defesa: 0, meio: 0, ataque: 0 };
            match.events.forEach(e => { if (sectorCounts.hasOwnProperty(e.zone)) { sectorCounts[e.zone]++; }});
            const mapCtx = document.getElementById('actionMapChart').getContext('2d');
            charts.actionMap = new Chart(mapCtx, {
                type: 'bar',
                data: { labels: ['Defesa', 'Meio-Campo', 'Ataque'], datasets: [{ label: 'Volume de Ação', data: [sectorCounts.defesa, sectorCounts.meio, sectorCounts.ataque], backgroundColor: ['#3b82f6', '#f59e0b', '#22c55e'] }] },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false }, datalabels: { color: 'white', font: {size: 14, weight: 'bold'} } } }
            });

            // --- Render other report components ---
            renderManOfTheMatch(match);
            renderReportSummaryTable(match);
            renderFormation(match);
        }
        
        function renderReportSummaryTable(match) {
            const container = document.getElementById('report-summary-table');
            let tableHTML = `<table class="w-full text-sm"><tbody>`;
            const stats = {
                'Finalizações': { my: match.events.filter(e => e.action === 'finalizacao').length, opp: match.events.filter(e => e.action === 'finalizacao_adv').length },
                'Duelos Ganhos': { my: match.events.filter(e => e.action === 'duelo' && e.detail === 'ganho').length, opp: match.events.filter(e => e.action === 'duelo' && e.detail === 'perdido').length },
                'Passes Certos': { my: match.events.filter(e => e.action === 'passe_certo').length, opp: '–'},
                'Faltas Cometidas': { my: match.events.filter(e => e.action === 'falta_cometida').length, opp: match.events.filter(e => e.action === 'falta_sofrida').length }
            };
            for (const [label, values] of Object.entries(stats)) {
                tableHTML += `<tr class="border-b border-gray-200"><td class="p-2 font-semibold">${label}</td><td class="p-2 text-center">${values.my}</td><td class="p-2 text-center">${values.opp}</td></tr>`;
            }
            tableHTML += `</tbody><thead class="text-xs text-gray-500"><tr><th class="p-2 text-left">Estatística</th><th class="p-2 text-center">${match.myTeamName}</th><th class="p-2 text-center">${match.opponentName}</th></tr></thead></table>`;
            container.innerHTML = tableHTML;
        }
        
        function renderManOfTheMatch(match) {
            const container = document.getElementById('report-motm');
            if(!match.ratings || Object.keys(match.ratings).length === 0) {
                 container.innerHTML = '<p class="text-gray-500 text-center py-8">Nenhuma avaliação registrada.</p>'; return;
            }
            const performers = Object.entries(match.ratings).map(([pid, r]) => ({ pid, avg: (Object.values(r).reduce((a,b) => a + parseFloat(b), 0)) / 4 }));
            const topPlayer = performers.reduce((a, b) => a.avg > b.avg ? a : b);
            const player = appState.players.find(p => p.id === topPlayer.pid);
            if(player) {
                container.innerHTML = `<div class="flex flex-col items-center justify-center h-full"><p class="text-2xl font-bold">${player.name}</p><p class="text-lg text-gray-600">Nota Média: <span class="font-bold text-blue-600">${topPlayer.avg.toFixed(1)}</span></p></div>`;
            }
        }

        function renderFormation(match) {
            const container = document.getElementById('report-formation');
            if (!match.lineup) {
                 container.innerHTML = '<p class="text-gray-500 text-center">Escalação não definida.</p>';
                 return;
            }
            container.innerHTML = '<div class="formation-grid"></div>';
            const grid = container.querySelector('.formation-grid');

            Object.entries(match.lineup).forEach(([posKey, playerId]) => {
                 const player = appState.players.find(p => p.id === playerId);
                 const posEl = document.createElement('div');
                 posEl.className = `player-position ${posKey}`;
                 posEl.innerHTML = `<div class="pos-label">${lineupPositions[posKey]}</div><div class="player-name">${player?.name || 'Vazio'}</div>`;
                 grid.appendChild(posEl);
            });
        }
        
        window.exportReportToPDF = function() { /* ... PDF export logic, can be improved ... */ }
        window.exportActionsToCSV = function() { /* ... CSV export logic ... */ }
        window.exportPerformancesToCSV = function() { /* ... CSV export logic ... */ }
        window.exportPerformancesToPDF = function() { /* ... PDF export logic ... */ }

        // --- INITIALIZATION ---
        window.addEventListener('DOMContentLoaded', firebaseAuth);
    </script>
</body>
</html>
