<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scout Pro - Análise de Futebol</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700;900&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Roboto', sans-serif; background-color: #111827; color: #d1d5db; }
        .view { display: none; }
        .view.active { display: block; }
        .nav-link { transition: all 0.2s; }
        .nav-link.active { background-color: #374151; color: white; }
        .field { background-color: #1e6b42; background-image: linear-gradient(rgba(255,255,255,0.1) 1px, transparent 1px), linear-gradient(90deg, rgba(255,255,255,0.1) 1px, transparent 1px); background-size: 20px 20px; border: 2px solid white; }
        .zone { border: 1px dashed rgba(255,255,255,0.5); }
        .action-btn { 
            transition: all 0.2s; 
            padding: 0.75rem 0.5rem;
            font-size: 0.875rem;
            line-height: 1.25rem;
            font-weight: 500;
            text-align: center;
        }
        .action-btn:hover { transform: scale(1.05); }
        .action-btn.clicked { background-color: #f59e0b !important; transform: scale(1.05); transition: all 0.1s; }
        .possession-btn.active { box-shadow: 0 0 0 3px #fbbf24; }
        input, select { background-color: #374151; color: white; border-color: #4b5563; }
        input:focus, select:focus { background-color: #4b5563; border-color: #60a5fa; box-shadow: none; outline: none;}
        table { border-collapse: collapse; width: 100%; }
        th, td { border-bottom: 1px solid #4b5563; padding: 0.75rem; }
        #report-content-wrapper { background-color: #ffffff; color: #111827; }
        #report-content-wrapper th, #report-content-wrapper td { border-color: #e5e7eb; }
        .report-table { border: 1px solid #e5e7eb; border-radius: 0.5rem; overflow: hidden; }
        .report-table th, .report-table td { padding: 0.5rem 1rem; }
        .report-table thead { background-color: #f3f4f6; }
        .report-table .stat-label { font-weight: 500; text-align: center; }
        .report-table .stat-value { font-weight: 700; font-size: 1.125rem; }
        .report-table .sub-stat-label { font-size: 0.875rem; color: #6b7280; text-align: center; }
        .report-table .sub-stat-value { font-size: 0.875rem; color: #374151; }
        .chart-container { position: relative; width: 100%; height: 300px; max-height: 400px; background-color: #f9fafb; padding: 1rem; border-radius: 0.5rem; border: 1px solid #e5e7eb;}
        #pdf-export-loader { border-top-color: #3498db; }
        .dashboard-card { background-color: #1f2937; border: 1px solid #374151; }
        .highlight-green { background-color: #e6f7ec !important; }
        .highlight-red { background-color: #ffebee !important; }
        .highlight-blue { background-color: #e3f2fd !important; }
    </style>
</head>
<body class="flex h-screen antialiased">

    <!-- Sidebar Navigation -->
    <nav class="w-64 bg-gray-900 p-4 flex flex-col flex-shrink-0">
        <h1 class="text-white text-2xl font-bold mb-8">Scout Pro ⚽</h1>
        <a href="#" class="nav-link active text-lg p-3 rounded-lg mb-2" onclick="navigateTo('dashboard')">Dashboard</a>
        <a href="#" class="nav-link text-lg p-3 rounded-lg mb-2" onclick="navigateTo('management')">Gerenciar Jogadores</a>
        <a href="#" class="nav-link text-lg p-3 rounded-lg mb-2" onclick="navigateTo('matches')">Partidas</a>
        <a href="#" class="nav-link text-lg p-3 rounded-lg mb-2" onclick="navigateTo('reports')">Relatórios</a>
         <div class="mt-auto text-center text-xs text-gray-500">
            <p>ID do Usuário:</p>
            <p id="user-id-display" class="break-words">Carregando...</p>
        </div>
    </nav>

    <!-- Main Content Area -->
    <main class="flex-1 p-6 overflow-y-auto">
        <!-- Dashboard View -->
        <div id="dashboard" class="view active">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-3xl font-bold text-white">Dashboard</h2>
                <div class="flex items-center">
                     <button onclick="exportPerformancesToCSV()" title="Exportar para CSV" class="bg-gray-700 hover:bg-gray-600 text-white font-bold p-2 rounded-full">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM6.293 6.707a1 1 0 010-1.414l3-3a1 1 0 011.414 0l3 3a1 1 0 01-1.414 1.414L11 5.414V13a1 1 0 11-2 0V5.414L7.707 6.707a1 1 0 01-1.414 0z" clip-rule="evenodd" />
                        </svg>
                    </button>
                    <button onclick="exportPerformancesToPDF()" title="Exportar para PDF" class="bg-gray-700 hover:bg-gray-600 text-white font-bold p-2 rounded-full ml-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M4 4a2 2 0 012-2h4.586A2 2 0 0112 2.586L15.414 6A2 2 0 0116 7.414V16a2 2 0 01-2 2H6a2 2 0 01-2-2V4zm2 6a1 1 0 011-1h6a1 1 0 110 2H7a1 1 0 01-1-1zm1 3a1 1 0 100 2h6a1 1 0 100-2H7z" clip-rule="evenodd" />
                        </svg>
                    </button>
                </div>
            </div>
            <div id="dashboard-grid" class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <!-- Dashboard content will be rendered here -->
            </div>
        </div>

        <!-- Management View -->
        <div id="management" class="view">
            <h2 class="text-3xl font-bold text-white mb-6">Gerenciamento de Jogadores</h2>
            <div class="grid grid-cols-1 gap-8">
                <div>
                    <h3 class="text-2xl font-bold text-white mb-4">Adicionar / Editar Jogador</h3>
                    <form id="player-form" class="bg-gray-800 p-4 rounded-lg mb-4 grid grid-cols-2 gap-4">
                        <input type="hidden" id="player-id">
                        <input type="text" id="player-name" placeholder="Nome do Jogador" class="p-2 rounded-md col-span-2" required>
                        <input type="date" id="player-dob" class="p-2 rounded-md" required>
                        <input type="text" id="player-position" placeholder="Posição (Ex: Zagueiro, Atacante)" class="p-2 rounded-md" required>
                        <button type="submit" class="col-span-2 bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg">Salvar Jogador</button>
                    </form>
                    <div class="bg-gray-800 p-4 rounded-lg">
                         <h3 class="text-xl font-bold text-white mb-4">Jogadores Cadastrados</h3>
                         <table class="w-full text-left"><thead class="text-gray-400"><tr><th class="p-2">Nome</th><th class="p-2">Posição</th><th class="p-2">Ações</th></tr></thead><tbody id="players-table"></tbody></table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Matches View -->
        <div id="matches" class="view">
            <h2 class="text-3xl font-bold text-white mb-6">Partidas</h2>
            <button class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg mb-6" onclick="openModal('new-match-modal')">Nova Partida</button>
            <div id="match-list" class="space-y-4"></div>
        </div>
        
        <!-- Live Match View -->
        <div id="live-match" class="view">
            <div class="bg-gray-800 p-4 rounded-lg mb-4 flex-shrink-0">
                <div class="flex justify-between items-center text-white">
                    <div id="live-my-team" class="text-2xl font-bold">Minha Equipe</div>
                    <div id="live-score" class="text-4xl font-black">0 - 0</div>
                    <div id="live-opponent" class="text-2xl font-bold">Adversário</div>
                </div>
                <div class="text-center text-6xl font-black text-white my-2" id="live-timer">00:00</div>
                <div class="flex justify-center gap-2">
                    <button class="bg-green-600 px-3 py-1 rounded" onclick="timerControl('start1')">▶ Iniciar 1ºT</button>
                    <button class="bg-yellow-500 px-3 py-1 rounded" onclick="timerControl('pause')">⏸ Intervalo</button>
                    <button class="bg-green-600 px-3 py-1 rounded" onclick="timerControl('start2')">▶ Iniciar 2ºT</button>
                    <button class="bg-red-600 px-3 py-1 rounded" onclick="timerControl('end')">⏹ Fim de Jogo</button>
                </div>
                 <div class="bg-gray-900 p-3 rounded-lg mt-4">
                    <h3 class="text-center text-base font-bold text-white mb-2">Controle de Posse de Bola</h3>
                    <div class="flex justify-center gap-4">
                        <button id="possession-myTeam" class="possession-btn bg-blue-600 text-white p-2 rounded" onclick="togglePossession('myTeam')">Minha Equipe</button>
                        <button id="possession-opponent" class="possession-btn bg-red-600 text-white p-2 rounded" onclick="togglePossession('opponent')">Adversário</button>
                        <button id="possession-stopped" class="possession-btn bg-gray-500 text-white p-2 rounded" onclick="togglePossession('stopped')">Bola Parada</button>
                    </div>
                    <div class="text-center text-white mt-2" id="possession-display">Posse: Minha Equipe 0% | Adversário 0%</div>
                </div>
            </div>
            
            <div class="field grid grid-cols-3 gap-2 p-2 rounded-lg mb-4">
                <div class="zone p-2 rounded bg-black bg-opacity-20 flex-grow">
                    <h4 class="text-center font-bold text-white mb-2 text-sm">DEFESA</h4>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-2">
                         <button class="action-btn bg-purple-500 rounded" onclick="logEvent(event, 'defesa', 'finalizacao_adv')">Fin. Adv.</button>
                        <button class="action-btn bg-purple-500 rounded" onclick="logEvent(event, 'defesa', 'chance_clara_adv')">Chance Adv.</button>
                        <button class="action-btn bg-yellow-500 rounded" onclick="logEvent(event, 'defesa', 'duelo')">Duelo</button>
                        <button class="action-btn bg-red-600 rounded" onclick="logEvent(event, 'defesa', 'falta_sofrida')">Falta Sofrida</button>
                        <button class="action-btn bg-red-400 rounded" onclick="logEvent(event, 'defesa', 'falta_cometida')">Falta Cometida</button>
                        <button class="action-btn bg-gray-400 rounded" onclick="logEvent(event, 'defesa', 'passe_certo')">Passe Certo</button>
                        <button class="action-btn bg-gray-600 rounded" onclick="logEvent(event, 'defesa', 'passe_errado')">Passe Errado</button>
                    </div>
                </div>
                <div class="zone p-2 rounded bg-black bg-opacity-20 flex-grow">
                    <h4 class="text-center font-bold text-white mb-2 text-sm">MEIO-CAMPO</h4>
                     <div class="grid grid-cols-1 sm:grid-cols-2 gap-2">
                        <button class="action-btn bg-yellow-500 rounded" onclick="logEvent(event, 'meio', 'duelo')">Duelo</button>
                        <button class="action-btn bg-red-600 rounded" onclick="logEvent(event, 'meio', 'falta_sofrida')">F. Sofrida</button>
                        <button class="action-btn bg-red-400 rounded" onclick="logEvent(event, 'meio', 'falta_cometida')">F. Cometida</button>
                        <button class="action-btn bg-gray-400 rounded" onclick="logEvent(event, 'meio', 'passe_certo')">Passe Certo</button>
                        <button class="action-btn bg-gray-600 rounded" onclick="logEvent(event, 'meio', 'passe_errado')">Passe Errado</button>
                    </div>
                </div>
                <div class="zone p-2 rounded bg-black bg-opacity-20 flex-grow">
                    <h4 class="text-center font-bold text-white mb-2 text-sm">ATAQUE</h4>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-2">
                        <button class="action-btn bg-green-500 rounded" onclick="logEvent(event, 'ataque', 'finalizacao')">Finalização</button>
                        <button class="action-btn bg-green-500 rounded" onclick="logEvent(event, 'ataque', 'chance_clara')">Chance Clara</button>
                        <button class="action-btn bg-yellow-500 rounded" onclick="logEvent(event, 'ataque', 'duelo')">Duelo</button>
                        <button class="action-btn bg-blue-500 rounded" onclick="logEvent(event, 'ataque', 'cruzamento_dir')">Cruz. Dir</button>
                        <button class="action-btn bg-blue-500 rounded" onclick="logEvent(event, 'ataque', 'cruzamento_esq')">Cruz. Esq</button>
                        <button class="action-btn bg-red-600 rounded" onclick="logEvent(event, 'ataque', 'falta_sofrida')">Falta Sofrida</button>
                        <button class="action-btn bg-red-400 rounded" onclick="logEvent(event, 'ataque', 'falta_cometida')">Falta Cometida</button>
                        <button class="action-btn bg-gray-400 rounded" onclick="logEvent(event, 'ataque', 'passe_certo')">Passe Certo</button>
                        <button class="action-btn bg-gray-600 rounded" onclick="logEvent(event, 'ataque', 'passe_errado')">Passe Errado</button>
                    </div>
                </div>
            </div>
             <div class="flex gap-2 mb-4">
                <button class="w-1/2 bg-green-700 p-2 rounded-lg text-white font-bold" onclick="prepareGoalModal('myTeam')">GOL PRÓ</button>
                <button class="w-1/2 bg-red-800 p-2 rounded-lg text-white font-bold" onclick="prepareGoalModal('opponent')">GOL CONTRA</button>
             </div>
            <div class="bg-gray-800 p-2 rounded-lg h-48 overflow-y-auto">
                 <table class="w-full text-left text-sm"><thead class="text-gray-400"><tr><th>Tempo</th><th>P.</th><th>Setor</th><th>Ação</th><th>Detalhe</th><th>Jogador</th></tr></thead><tbody id="live-log-body"></tbody></table>
            </div>
        </div>

        <!-- Reports View -->
        <div id="reports" class="view">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-3xl font-bold text-white">Relatórios</h2>
                <div>
                     <button id="csv-export-button" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg mr-2" onclick="exportActionsToCSV()">Exportar Ações (CSV)</button>
                     <button id="pdf-export-button" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg flex items-center" onclick="exportReportToPDF()">
                        <span id="pdf-export-text">Exportar Relatório (PDF)</span>
                        <div id="pdf-export-loader" class="hidden ml-2 w-5 h-5 border-4 border-gray-400 border-solid rounded-full animate-spin"></div>
                     </button>
                </div>
            </div>
            <div class="bg-gray-800 p-4 rounded-lg">
                <div class="mb-4">
                    <label for="report-match-select" class="mr-2">Selecione uma Partida:</label>
                    <select id="report-match-select" class="w-full p-2 rounded" onchange="generateReports(this.value)"></select>
                </div>
            </div>

            <div id="report-content-wrapper" class="p-8 rounded-lg mt-6">
                <div id="report-content" class="hidden space-y-8">
                    <!-- Match Report Content -->
                    <div id="match-report-content">
                         <div class="text-center mb-8">
                            <h1 id="report-title" class="text-4xl font-bold"></h1>
                            <p id="report-subtitle" class="text-lg text-gray-600"></p>
                        </div>
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
                            <div class="bg-gray-50 p-4 rounded-lg border">
                                <h3 class="text-xl font-bold text-center mb-2">Posse de Bola</h3>
                                <div class="chart-container h-24"><canvas id="possessionChart"></canvas></div>
                            </div>
                             <div class="bg-gray-50 p-4 rounded-lg border">
                                <h3 class="text-xl font-bold text-center mb-2">Destaque da Partida</h3>
                                <div id="report-motm" class="text-center"></div>
                            </div>
                        </div>

                         <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
                            <div class="bg-gray-50 p-4 rounded-lg border flex flex-col">
                                <h3 class="text-xl font-bold text-center mb-2">Destaques Individuais</h3>
                                <div id="report-player-highlights" class="overflow-x-auto flex-grow"></div>
                            </div>
                            <div class="bg-gray-50 p-4 rounded-lg border">
                                <h3 class="text-xl font-bold text-center mb-2">Volume de Ações por Setor</h3>
                                <div class="chart-container h-80"><canvas id="actionMapChart"></canvas></div>
                                <div class="text-center text-gray-600 font-bold mt-2">
                                    <span>Direção do Ataque →</span>
                                </div>
                            </div>
                        </div>
                        <div class="bg-gray-50 p-4 rounded-lg border">
                            <h3 class="text-xl font-bold text-center mb-2">Resumo Geral de Ações</h3>
                            <div id="report-summary-table" class="overflow-x-auto"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>
    
    <!-- Modals -->
    <div id="modal-container" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-50 hidden" onclick="closeAllModals(event)">
        <!-- New Match Modal -->
        <div id="new-match-modal" class="modal-content bg-gray-800 text-white rounded-lg p-6 w-full max-w-lg hidden">
            <h3 class="text-2xl font-bold mb-4">Criar Nova Partida</h3>
            <form id="new-match-form">
                <label>Nome da sua equipe:</label><input type="text" id="match-my-team-name" placeholder="Ex: Principal, Sub-20" class="w-full p-2 rounded mb-2" required>
                <label>Adversário:</label><input type="text" id="match-opponent-name" placeholder="Nome do Adversário" class="w-full p-2 rounded mb-2" required>
                <label>Data:</label><input type="date" id="match-date" class="w-full p-2 rounded mb-2" required>
                <label>Local:</label><input type="text" id="match-location" placeholder="Local da Partida" class="w-full p-2 rounded mb-4" required>
                <h4 class="font-bold mb-2">Jogadores Convocados:</h4>
                <div id="match-squad-list" class="h-48 overflow-y-auto border border-gray-600 p-2 rounded mb-4"></div>
                <button type="submit" class="w-full bg-blue-600 p-2 rounded">Criar Partida</button>
            </form>
        </div>

        <!-- Event Detail Modal -->
        <div id="event-detail-modal" class="modal-content bg-gray-800 text-white rounded-lg p-6 w-full max-w-md hidden">
             <h3 id="event-modal-title" class="text-2xl font-bold mb-4">Detalhes da Ação</h3>
             <form id="event-detail-form">
                <input type="hidden" id="event-zone">
                <input type="hidden" id="event-action">
                <div id="event-sub-action-group" class="space-y-2"></div>
                <div id="event-player-group" class="mt-4"></div>
                <button type="submit" class="w-full bg-blue-600 p-2 rounded mt-4">Registrar</button>
            </form>
        </div>
        
        <!-- Confirmation Modal -->
        <div id="confirmation-modal" class="modal-content bg-gray-800 text-white rounded-lg p-6 w-full max-w-md hidden">
            <h3 class="text-xl font-bold mb-4">Confirmar Ação</h3>
            <p id="confirmation-message" class="mb-6"></p>
            <div class="flex justify-end gap-4">
                <button id="confirm-cancel-btn" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg">Cancelar</button>
                <button id="confirm-ok-btn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg">Confirmar</button>
            </div>
        </div>
        
        <!-- Post-Match Rating Modal -->
        <div id="rating-modal" class="modal-content bg-gray-800 text-white rounded-lg p-6 w-full max-w-3xl hidden">
            <h3 class="text-2xl font-bold mb-4">Avaliação de Desempenho Pós-Jogo</h3>
            <div id="rating-player-list" class="space-y-6 max-h-[60vh] overflow-y-auto p-2"></div>
            <button class="w-full bg-blue-600 p-2 rounded mt-4" onclick="saveRatings()">Salvar Avaliações e Finalizar Partida</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
          apiKey: "AIzaSyCSxaH-QFQbhrCttS-J8KmVN1MXmjXqY1s",
          authDomain: "meu-scout-pro.firebaseapp.com",
          projectId: "meu-scout-pro",
          storageBucket: "meu-scout-pro.appspot.com",
          messagingSenderId: "303977649743",
          appId: "1:303977649743:web:4e81e55c7180390ec97c3a"
        };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        // --- GLOBAL STATE ---
        let appState = { players: [], matches: [], activeMatchId: null, currentView: 'dashboard' };
        let liveState = { timerInterval: null, possessionInterval: null, seconds: 0, currentPeriod: 0, possession: { myTeam: 0, opponent: 0, stopped: 0 }, current: null };
        let charts = {};
        const { jsPDF } = window.jspdf;
        let userId;
        
        // --- FIREBASE SETUP ---
        const appId = 'scout-pro-futebol'; // Unique ID for this application
        
        async function firebaseAuth() {
            onAuthStateChanged(auth, (user) => {
                if (user) {
                    userId = user.uid;
                    document.getElementById('user-id-display').textContent = userId;
                    setupListeners();
                    navigateTo('dashboard');
                } else {
                    signInAnonymously(auth).catch(error => {
                        showErrorMessage("Falha na autenticação anônima.", error);
                    });
                }
            });
        }
        
        function setupListeners() {
            const playersRef = collection(db, "artifacts", appId, "users", userId, "players");
            onSnapshot(playersRef, (snapshot) => {
                appState.players = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                if(appState.currentView === 'management') {
                    renderPlayersTable();
                }
            }, (error) => {
                showErrorMessage("Erro ao carregar jogadores.", error);
            });

            const matchesRef = collection(db, "artifacts", appId, "users", userId, "matches");
            onSnapshot(query(matchesRef), (snapshot) => {
                appState.matches = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                
                if (appState.currentView === 'live-match' && appState.activeMatchId) {
                    renderLiveScore();
                    renderLiveLog();
                } else if (appState.currentView === 'matches' || appState.currentView === 'dashboard' || appState.currentView === 'reports') {
                    renderMatchList();
                    renderDashboard();
                    renderReportMatchSelect();
                }
            }, (error) => {
                showErrorMessage("Erro ao carregar partidas.", error);
            });
        }
        
        // --- GLOBAL FUNCTIONS ---
        window.navigateTo = navigateTo;
        window.openModal = openModal;
        window.closeModal = closeModal;
        window.closeAllModals = closeAllModals;
        window.editPlayer = editPlayer;
        window.deletePlayer = deletePlayer;
        window.startLiveMatch = startLiveMatch;
        window.timerControl = timerControl;
        window.togglePossession = togglePossession;
        window.logEvent = logEvent;
        window.prepareGoalModal = prepareGoalModal;
        window.saveRatings = saveRatings;
        window.generateReports = generateReports;
        window.exportReportToPDF = exportReportToPDF;
        window.exportActionsToCSV = exportActionsToCSV;
        window.exportPerformancesToCSV = exportPerformancesToCSV;
        window.exportPerformancesToPDF = exportPerformancesToPDF;
        window.deleteMatch = deleteMatch;

        // --- UI ELEMENTS ---
        const ui = {
            views: document.querySelectorAll('.view'), navLinks: document.querySelectorAll('.nav-link'),
            modalContainer: document.getElementById('modal-container'), 
            playerForm: document.getElementById('player-form'), playersTable: document.getElementById('players-table'),
            newMatchForm: document.getElementById('new-match-form'),
            matchSquadList: document.getElementById('match-squad-list'), matchList: document.getElementById('match-list'),
            live: {
                myTeam: document.getElementById('live-my-team'), opponent: document.getElementById('live-opponent'),
                score: document.getElementById('live-score'), timer: document.getElementById('live-timer'),
                logBody: document.getElementById('live-log-body'), possessionDisplay: document.getElementById('possession-display')
            },
            eventModal: {
                form: document.getElementById('event-detail-form'), title: document.getElementById('event-modal-title'),
                zone: document.getElementById('event-zone'), action: document.getElementById('event-action'),
                subActionGroup: document.getElementById('event-sub-action-group'), playerGroup: document.getElementById('event-player-group')
            },
            ratingModal: { list: document.getElementById('rating-player-list') }
        };

        // --- NAVIGATION ---
        function navigateTo(viewId) {
            appState.currentView = viewId;
            ui.views.forEach(v => v.classList.remove('active'));
            document.getElementById(viewId).classList.add('active');
            ui.navLinks.forEach(l => l.classList.remove('active'));
            const link = document.querySelector(`.nav-link[onclick="navigateTo('${viewId}')"]`);
            if (link) {
              link.classList.add('active');
            }
            if (viewId === 'dashboard') renderDashboard();
            if (viewId === 'management') renderPlayersTable();
            if (viewId === 'matches') renderMatchList();
            if (viewId === 'reports') { renderReportMatchSelect(); }
        }

        // --- MODAL HANDLING ---
        let confirmCallback = null;

        function showConfirmationModal(message, onConfirm) {
            document.getElementById('confirmation-message').textContent = message;
            confirmCallback = onConfirm;
            openModal('confirmation-modal');
        }

        document.getElementById('confirm-ok-btn').addEventListener('click', () => {
            if (confirmCallback) {
                confirmCallback();
            }
            closeModal('confirmation-modal');
        });

        document.getElementById('confirm-cancel-btn').addEventListener('click', () => {
            confirmCallback = null;
            closeModal('confirmation-modal');
        });

        function openModal(modalId) {
            if (modalId === 'new-match-modal') prepareNewMatchModal();
            ui.modalContainer.classList.remove('hidden');
            document.getElementById(modalId).classList.remove('hidden');
        }
        function closeModal(modalId) { 
            ui.modalContainer.classList.add('hidden');
            if(modalId) { document.getElementById(modalId).classList.add('hidden');
            } else { ui.modalContainer.querySelectorAll('.modal-content').forEach(m => m.classList.add('hidden')); }
        }
        function closeAllModals(event) { if (event.target === ui.modalContainer) { closeModal(); }}
        
        function showErrorMessage(message, error) {
            console.error(message, error);
            const errorBar = document.createElement('div');
            errorBar.style.position = 'fixed';
            errorBar.style.top = '0';
            errorBar.style.left = '0';
            errorBar.style.width = '100%';
            errorBar.style.backgroundColor = '#ef4444'; // red-500
            errorBar.style.color = 'white';
            errorBar.style.padding = '1rem';
            errorBar.style.textAlign = 'center';
            errorBar.style.zIndex = '1000';
            errorBar.textContent = `Erro: ${message}. Verifique o console (F12) para detalhes.`;
            document.body.appendChild(errorBar);
            setTimeout(() => {
                document.body.removeChild(errorBar);
            }, 5000);
        }

        // --- PLAYER MANAGEMENT ---
        ui.playerForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!userId) { return showErrorMessage("Usuário não autenticado. Tente recarregar a página.", {}); }

            const id = document.getElementById('player-id').value;
            const playerData = {
                name: document.getElementById('player-name').value,
                dob: document.getElementById('player-dob').value,
                position: document.getElementById('player-position').value
            };

            try {
                if (id) {
                    await setDoc(doc(db, "artifacts", appId, "users", userId, "players", id), playerData);
                } else {
                    await addDoc(collection(db, "artifacts", appId, "users", userId, "players"), playerData);
                }
                ui.playerForm.reset(); 
                document.getElementById('player-id').value = '';
            } catch (error) {
                showErrorMessage("Não foi possível salvar o jogador", error);
            }
        });
        function renderPlayersTable() {
            ui.playersTable.innerHTML = appState.players.length === 0 ? '<tr><td colspan="3" class="text-center p-4 text-gray-400">Nenhum jogador cadastrado.</td></tr>' : '';
            appState.players.forEach(player => {
                const row = document.createElement('tr');
                row.innerHTML = `<td class="p-2">${player.name}</td><td class="p-2">${player.position}</td><td class="p-2"><button class="text-blue-400 hover:text-blue-300 mr-2" onclick="editPlayer('${player.id}')">Editar</button><button class="text-red-400 hover:text-red-300" onclick="deletePlayer('${player.id}')">Excluir</button></td>`;
                ui.playersTable.appendChild(row);
            });
        }
        function editPlayer(id) {
            const player = appState.players.find(p => p.id === id);
            document.getElementById('player-id').value = player.id;
            document.getElementById('player-name').value = player.name;
            document.getElementById('player-dob').value = player.dob;
            document.getElementById('player-position').value = player.position;
        }
        async function deletePlayer(id) {
            const player = appState.players.find(p => p.id === id);
            if (!player) return;

            showConfirmationModal(`Tem certeza que deseja excluir o jogador "${player.name}"?`, async () => {
                try {
                    if (!userId) { return showErrorMessage("Usuário não autenticado. Tente recarregar a página.", {}); }
                    await deleteDoc(doc(db, "artifacts", appId, "users", userId, "players", id));
                } catch (error) {
                    showErrorMessage("Não foi possível excluir o jogador", error);
                }
            });
        }
        
        // --- MATCH MANAGEMENT ---
        function prepareNewMatchModal() {
            ui.matchSquadList.innerHTML = appState.players.length === 0 ? '<p class="text-gray-400">Cadastre jogadores primeiro.</p>' : '';
            appState.players.forEach(player => { ui.matchSquadList.innerHTML += `<div class="flex items-center"><input type="checkbox" id="squad-${player.id}" value="${player.id}" class="mr-2"><label for="squad-${player.id}">${player.name} (${player.position})</label></div>`; });
        }
        ui.newMatchForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!userId) { return showErrorMessage("Usuário não autenticado. Tente recarregar a página.", {}); }

            const squadPlayerIds = Array.from(document.querySelectorAll('#match-squad-list input:checked')).map(i => i.value);
            if (squadPlayerIds.length === 0) return alert('Selecione pelo menos um jogador.');
            
            const matchData = {
                myTeamName: document.getElementById('match-my-team-name').value, 
                opponentName: document.getElementById('match-opponent-name').value,
                date: document.getElementById('match-date').value, 
                location: document.getElementById('match-location').value,
                squadPlayerIds, 
                myTeamScore: 0, 
                opponentScore: 0, 
                status: 'scheduled', 
                events: [], 
                possession: { myTeam: 0, opponent: 0, stopped: 0 }, 
                ratings: {}
            };

            try {
                await addDoc(collection(db, "artifacts", appId, "users", userId, "matches"), matchData);
                ui.newMatchForm.reset(); 
                closeModal('new-match-modal'); 
            } catch (error) {
                showErrorMessage("Não foi possível criar a partida", error);
            }
        });
        function renderMatchList() {
            ui.matchList.innerHTML = '';
            appState.matches.forEach(match => {
                const card = document.createElement('div');
                card.className = 'bg-gray-800 p-4 rounded-lg flex justify-between items-center';
                let actionButton;
                if (match.status === 'finished') {
                    actionButton = `<span class="font-bold text-xl">${match.myTeamScore} - ${match.opponentScore}</span>`;
                } else {
                    actionButton = `<button class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded" onclick="startLiveMatch('${match.id}')">Iniciar Scout</button>`;
                }

                card.innerHTML = `
                    <div>
                        <p class="text-xl font-bold">${match.myTeamName} vs ${match.opponentName}</p>
                        <p class="text-sm text-gray-400">${new Date(match.date).toLocaleDateString('pt-BR', {timeZone: 'UTC'})} - ${match.location}</p>
                    </div>
                    <div class="flex items-center gap-4">
                        ${actionButton}
                        <button onclick="deleteMatch('${match.id}')" class="text-red-500 hover:text-red-400 p-2 rounded-full">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                            </svg>
                        </button>
                    </div>`;
                ui.matchList.appendChild(card);
            });
        }
        
        async function deleteMatch(matchId) {
            const match = appState.matches.find(m => m.id === matchId);
            if (!match) return; 

            showConfirmationModal(`Tem certeza que deseja excluir a partida "${match.myTeamName} vs ${match.opponentName}"? Essa ação não pode ser desfeita.`, async () => {
                try {
                    if (!userId) { return showErrorMessage("Usuário não autenticado. Tente recarregar a página.", {}); }
                    await deleteDoc(doc(db, "artifacts", appId, "users", userId, "matches", matchId));
                } catch (error) {
                    showErrorMessage("Não foi possível excluir a partida.", error);
                }
            });
        }
        
        // --- LIVE MATCH ---
        function formatTime(s) { const min = Math.floor(s / 60).toString().padStart(2, '0'); const sec = (s % 60).toString().padStart(2, '0'); return `${min}:${sec}`; }
        
        async function updateMatchData(matchId, data) {
            try {
                if (!userId) { return showErrorMessage("Usuário não autenticado. Tente recarregar a página.", {}); }
                const matchRef = doc(db, "artifacts", appId, "users", userId, "matches", matchId);
                await updateDoc(matchRef, data);
            } catch (error) {
                showErrorMessage("Não foi possível atualizar os dados da partida.", error);
            }
        }

        function startLiveMatch(matchId) {
            appState.activeMatchId = matchId;
            const match = appState.matches.find(m => m.id === matchId);
            if(!match) return;
            
            updateMatchData(matchId, { status: 'live' });
            
            liveState = { 
                timerInterval: null, 
                possessionInterval: null, 
                seconds: (match.events && match.events.length > 0) ? match.events[0].time : 0, 
                currentPeriod: (match.events && match.events.length > 0) ? match.events[0].period : 0, 
                possession: match.possession || { myTeam: 0, opponent: 0, stopped: 0 }, 
                current: null 
            };
            ui.live.myTeam.textContent = match.myTeamName; ui.live.opponent.textContent = match.opponentName;
            renderLiveScore(); renderLiveLog(); updatePossessionDisplay(); navigateTo('live-match');
        }
        function timerControl(action) {
            clearInterval(liveState.timerInterval);
            if (action === 'start1' || action === 'start2') {
                liveState.currentPeriod = (action === 'start1' ? 1 : 2);
                if(action === 'start1' && liveState.seconds === 0) liveState.seconds = 0;
                if(action === 'start2' && liveState.currentPeriod === 1) liveState.seconds = 2700;
                liveState.timerInterval = setInterval(() => { liveState.seconds++; ui.live.timer.textContent = formatTime(liveState.seconds); }, 1000);
            } else if (action === 'end') {
                togglePossession(null);
                prepareRatingModal(); openModal('rating-modal');
            }
        }
        function togglePossession(team) {
            clearInterval(liveState.possessionInterval);
            document.querySelectorAll('.possession-btn').forEach(b => b.classList.remove('active'));
            if (team && liveState.current !== team) {
                liveState.current = team;
                document.getElementById(`possession-${team}`).classList.add('active');
                liveState.possessionInterval = setInterval(() => { 
                    const match = appState.matches.find(m => m.id === appState.activeMatchId);
                    if(match) { 
                        match.possession[team]++;
                        updateMatchData(appState.activeMatchId, { possession: match.possession });
                        updatePossessionDisplay(); 
                    }
                }, 1000);
            } else { liveState.current = null; }
        }
        function updatePossessionDisplay() {
            const match = appState.matches.find(m => m.id === appState.activeMatchId);
            if(!match) return;
            const total = match.possession.myTeam + match.possession.opponent || 1;
            const myTeamPerc = ((match.possession.myTeam / total) * 100).toFixed(0);
            const opponentPerc = ((match.possession.opponent / total) * 100).toFixed(0);
            ui.live.possessionDisplay.textContent = `Posse: ${match.myTeamName} ${myTeamPerc}% | ${match.opponentName} ${opponentPerc}%`;
        }
        
        // --- EVENT LOGGING ---
        const eventOptions = {
            finalizacao: { title: "Finalização", player: true, sub: [{label: "Dentro da Área", value: "dentro"}, {label:"Fora da Área", value:"fora"}, {label:"Cabeça", value:"cabeca"}] },
            duelo: { title: "Duelo", player: true, sub: [{label: "Ganho", value: "ganho"}, {label:"Perdido", value:"perdido"}] },
            finalizacao_adv: { title: "Finalização Adversária", player: false, sub: [{label: "Fora da Área", value: "fora"}, {label:"Dentro da Área", value:"dentro"}, {label:"Cabeça", value:"cabeca"}]}
        };
        async function logEvent(event, zone, action) {
            const match = appState.matches.find(m => m.id === appState.activeMatchId);
            if (!match || liveState.currentPeriod === 0) return alert("Inicie a partida para registrar eventos.");
            
            const newEvent = { time: liveState.seconds, period: liveState.currentPeriod, zone, action, detail: 'N/A', playerId: null, playerName: 'N/A' };
            
            if (eventOptions[action]) {
                prepareEventModal(zone, action);
            } else {
                const updatedEvents = [newEvent, ...match.events];
                await updateMatchData(appState.activeMatchId, { events: updatedEvents });
                
                const btn = event.target;
                btn.classList.add('clicked');
                setTimeout(() => btn.classList.remove('clicked'), 200);
            }
        }
        function prepareEventModal(zone, action) {
            const options = eventOptions[action];
            if (!options) return;
            const match = appState.matches.find(m => m.id === appState.activeMatchId);
            if(!match) return;
            ui.eventModal.title.textContent = options.title;
            ui.eventModal.zone.value = zone; ui.eventModal.action.value = action;
            ui.eventModal.subActionGroup.innerHTML = options.sub.map(opt => `<div><input type="radio" id="sub-${opt.value}" name="sub_action" value="${opt.value}" required class="mr-2"><label for="sub-${opt.value}">${opt.label}</label></div>`).join('');
            if(options.player) {
                const players = match.squadPlayerIds.map(pid => appState.players.find(p => p.id === pid));
                ui.eventModal.playerGroup.innerHTML = `<label>Jogador:</label><select id="event-player" class="w-full p-2 rounded mt-1">${players.map(p => `<option value="${p.id}">${p.name}</option>`).join('')}</select>`;
            } else { ui.eventModal.playerGroup.innerHTML = ''; }
            openModal('event-detail-modal');
        }
        ui.eventModal.form.addEventListener('submit', async (e) => {
            e.preventDefault();
            const match = appState.matches.find(m => m.id === appState.activeMatchId);
            const playerId = document.getElementById('event-player')?.value || null;
            const player = playerId ? appState.players.find(p => p.id === playerId) : null;
            
            const newEvent = {
                time: liveState.seconds, 
                period: liveState.currentPeriod, 
                zone: ui.eventModal.zone.value, 
                action: ui.eventModal.action.value,
                detail: new FormData(e.target).get('sub_action'), 
                playerId, 
                playerName: player?.name || 'N/A'
            };
            const updatedEvents = [newEvent, ...match.events];
            await updateMatchData(appState.activeMatchId, { events: updatedEvents });
            
            closeModal('event-detail-modal');
        });
        function renderLiveLog() {
            const match = appState.matches.find(m => m.id === appState.activeMatchId);
            if(!match || !match.events) return;
            ui.live.logBody.innerHTML = '';
            match.events.forEach(ev => {
                const row = document.createElement('tr');
                row.innerHTML = `<td class="p-1 text-xs">${formatTime(ev.time)}</td><td class="p-1 text-xs">${ev.period}ºT</td><td class="p-1 text-xs">${ev.zone}</td><td class="p-1 text-xs">${ev.action.replace(/_/g, ' ')}</td><td class="p-1 text-xs">${ev.detail}</td><td class="p-1 text-xs">${ev.playerName}</td>`;
                ui.live.logBody.appendChild(row);
            });
        }
        
        // --- GOAL LOGGING ---
        async function prepareGoalModal(teamType) {
            const match = appState.matches.find(m => m.id === appState.activeMatchId);
            if(!match || liveState.currentPeriod === 0) { return alert("Inicie a partida para registrar um gol."); }
            
            const currentScore = teamType === 'myTeam' ? (match.myTeamScore || 0) : (match.opponentScore || 0);
            const update = {};
            
            if (teamType === 'myTeam') {
                update.myTeamScore = currentScore + 1;
            } else { // opponent
                update.opponentScore = currentScore + 1;
                const newEvent = {
                    time: liveState.seconds, period: liveState.currentPeriod, zone: 'ataque', action: 'gol', detail: 'N/A',
                    playerId: null, playerName: 'Adversário', scoringTeam: 'opponent'
                };
                update.events = [newEvent, ...(match.events || [])];
            }
            await updateMatchData(appState.activeMatchId, update);
        }
        
        // --- POST-MATCH RATING ---
        function prepareRatingModal() {
            const match = appState.matches.find(m => m.id === appState.activeMatchId);
            const players = match.squadPlayerIds.map(pid => appState.players.find(p => p.id === pid));
            ui.ratingModal.list.innerHTML = '';
            players.forEach(p => { ui.ratingModal.list.innerHTML += `<div class="bg-gray-700 p-3 rounded-lg"><h4 class="text-lg font-bold">${p.name}</h4><div class="grid grid-cols-2 md:grid-cols-4 gap-4 mt-2">${['Técnico', 'Tático', 'Físico', 'Comportamental'].map(cat => `<div><label for="rating-${p.id}-${cat.toLowerCase()}">${cat}</label><input type="range" id="rating-${p.id}-${cat.toLowerCase()}" min="1" max="10" value="5" class="w-full mt-1"></div>`).join('')}</div></div>`; });
        }
        async function saveRatings() {
            const match = appState.matches.find(m => m.id === appState.activeMatchId);
            if(!match) return;
            const ratings = {};
            match.squadPlayerIds.forEach(pid => {
                ratings[pid] = {
                    tecnico: document.getElementById(`rating-${pid}-técnico`)?.value || 5, tatico: document.getElementById(`rating-${pid}-tático`)?.value || 5,
                    fisico: document.getElementById(`rating-${pid}-físico`)?.value || 5, comportamental: document.getElementById(`rating-${pid}-comportamental`)?.value || 5,
                };
            });

            await updateMatchData(appState.activeMatchId, { status: 'finished', ratings: ratings });
            
            closeModal('rating-modal'); 
            navigateTo('matches');
        }

        // --- DASHBOARD & REPORTS ---
        function renderDashboard() {
            const grid = document.getElementById('dashboard-grid');
            grid.innerHTML = '';

            const finishedMatches = appState.matches.filter(m => m.status === 'finished');
            
            // Card 1: Team Stats
            const totalMatches = finishedMatches.length;
            let wins = 0, draws = 0;
            finishedMatches.forEach(m => {
                if (m.myTeamScore > m.opponentScore) wins++;
                else if (m.myTeamScore === m.opponentScore) draws++;
            });
            const points = (wins * 3) + draws;
            const maxPoints = totalMatches * 3;
            const aproveitamento = maxPoints > 0 ? ((points / maxPoints) * 100).toFixed(0) + '%' : '0%';

            const totalGoalsScored = appState.matches.reduce((acc, m) => acc + (m.myTeamScore || 0), 0);
            const totalGoalsConceded = appState.matches.reduce((acc, m) => acc + (m.opponentScore || 0), 0);

            let statsCardHTML = `
                <div class="dashboard-card p-4 rounded-lg col-span-1 md:col-span-1 xl:col-span-1">
                    <h3 class="font-bold text-lg mb-4">Estatísticas da Equipe</h3>
                    <div class="space-y-3 text-gray-300">
                        <div class="flex justify-between items-center"><span>Partidas</span><span class="font-bold text-xl text-white">${totalMatches}</span></div>
                        <div class="flex justify-between items-center"><span>Gols Marcados</span><span class="font-bold text-xl text-white">${totalGoalsScored}</span></div>
                        <div class="flex justify-between items-center"><span>Gols Sofridos</span><span class="font-bold text-xl text-white">${totalGoalsConceded}</span></div>
                        <div class="flex justify-between items-center"><span>Aproveitamento</span><span class="font-bold text-xl text-white">${aproveitamento}</span></div>
                    </div>
                </div>
            `;
            
            // Card 2: Top Performers
            const allPerformances = [];
            finishedMatches.filter(m => m.ratings && Object.keys(m.ratings).length > 0).forEach(m => {
                Object.entries(m.ratings).forEach(([pid, rates]) => {
                    const avg = (parseFloat(rates.tecnico) + parseFloat(rates.tatico) + parseFloat(rates.fisico) + parseFloat(rates.comportamental)) / 4;
                    const player = appState.players.find(p => p.id === pid);
                    if(player) allPerformances.push({ name: player.name, score: avg, date: m.date });
                });
            });
            allPerformances.sort((a,b) => b.score - a.score);
            let performersCardHTML = `
                <div class="dashboard-card p-4 rounded-lg col-span-1 md:col-span-1 xl:col-span-2">
                    <h3 class="font-bold text-lg mb-4">Melhores Desempenhos</h3>
                    <ul class="space-y-3">`;
            if(allPerformances.length > 0){
                allPerformances.slice(0, 5).forEach(p => {
                    performersCardHTML += `<li class="flex justify-between items-center text-gray-300"><div>${p.name}<p class="text-xs text-gray-500">${new Date(p.date).toLocaleDateString('pt-BR', {timeZone: 'UTC'})}</p></div><strong class="text-white">Nota ${p.score.toFixed(1)}</strong></li>`;
                });
            } else { performersCardHTML += '<li class="text-gray-400">Nenhuma avaliação registrada.</li>'; }
            performersCardHTML += '</ul></div>';

            // Card 3: Last Matches History
            let historyCardHTML = `
                <div class="dashboard-card p-4 rounded-lg col-span-1 md:col-span-2 xl:col-span-3">
                    <h3 class="font-bold text-lg mb-4">Histórico Recente</h3>
                    <div class="space-y-2">`;
            if (finishedMatches.length > 0) {
                finishedMatches.slice(0, 5).forEach(m => {
                    let result = 'E'; let color = 'bg-yellow-500';
                    if (m.myTeamScore > m.opponentScore) { result = 'V'; color = 'bg-green-500'; }
                    if (m.myTeamScore < m.opponentScore) { result = 'D'; color = 'bg-red-500'; }
                    historyCardHTML += `<div class="p-2 bg-gray-700 rounded flex justify-between items-center text-sm"><span>${m.myTeamName} <strong>${m.myTeamScore}x${m.opponentScore}</strong> ${m.opponentName}</span><span class="w-6 h-6 flex items-center justify-center text-white font-bold rounded-full ${color}">${result}</span></div>`;
                });
            } else { historyCardHTML += '<p class="text-gray-400 text-center">Nenhuma partida finalizada.</p>'; }
            historyCardHTML += '</div></div>';

            grid.innerHTML = statsCardHTML + performersCardHTML + historyCardHTML;
        }

        function renderReportMatchSelect() {
            const select = document.getElementById('report-match-select');
            const finishedMatches = appState.matches.filter(m => m.status === 'finished');
            select.innerHTML = '<option value="">Selecione uma partida</option>';
            finishedMatches.forEach(m => { select.innerHTML += `<option value="${m.id}">${m.myTeamName} vs ${m.opponentName} - ${new Date(m.date).toLocaleDateString('pt-BR', {timeZone: 'UTC'})}</option>`; });
            document.getElementById('csv-export-button').style.display = 'none';
        }
        
        function destroyCharts() { Object.values(charts).forEach(chart => chart?.destroy()); }
        
        Chart.register(ChartDataLabels);
        
        const fieldLinesPlugin = {
            id: 'fieldLines',
            beforeDraw: (chart) => {
                if (chart.canvas.id !== 'actionMapChart') return;
                const { ctx, chartArea: { top, bottom, left, right }, scales: { x } } = chart;
                ctx.save();
                
                // Field Background
                ctx.fillStyle = '#166534'; // Green field color
                ctx.fillRect(left, top, right - left, bottom - top);

                // Vertical Lines
                const defenseZoneEnd = x.getPixelForValue(1.5);
                const midfieldZoneEnd = x.getPixelForValue(2.5);

                ctx.beginPath();
                ctx.strokeStyle = 'rgba(255, 255, 255, 0.3)';
                ctx.lineWidth = 1;

                ctx.moveTo(defenseZoneEnd, top);
                ctx.lineTo(defenseZoneEnd, bottom);
                ctx.moveTo(midfieldZoneEnd, top);
                ctx.lineTo(midfieldZoneEnd, bottom);
                ctx.stroke();
                
                ctx.restore();
            }
        };
        Chart.register(fieldLinesPlugin);

        function generateReports(matchId) {
            destroyCharts();
            const reportContent = document.getElementById('report-content');
            if (!matchId) { 
                reportContent.classList.add('hidden'); 
                document.getElementById('csv-export-button').style.display = 'none';
                return; 
            }
            document.getElementById('csv-export-button').style.display = 'inline-flex';
            
            const match = appState.matches.find(m => m.id === matchId);
            if (!match) return;
            reportContent.classList.remove('hidden');
            
            document.getElementById('report-title').textContent = `${match.myTeamName} ${match.myTeamScore} x ${match.opponentScore} ${match.opponentName}`;
            document.getElementById('report-subtitle').textContent = `${new Date(match.date).toLocaleDateString('pt-BR', {timeZone: 'UTC'})} - ${match.location}`;

            const posCtx = document.getElementById('possessionChart').getContext('2d');
            charts.possession = new Chart(posCtx, {
                type: 'bar',
                data: { labels: ['Posse de Bola'], datasets: [ { label: match.myTeamName, data: [match.possession.myTeam], backgroundColor: '#3b82f6' }, { label: match.opponentName, data: [match.possession.opponent], backgroundColor: '#ef4444' } ]},
                options: { indexAxis: 'y', responsive: true, maintainAspectRatio: false, scales: { x: { stacked: true, display: false }, y: { stacked: true, display: false } }, plugins: { legend: { display: true, position: 'top', labels: {color: '#374151'} }, datalabels: { color: 'white', font: { weight: 'bold' }, formatter: (value, context) => {
                    const total = context.chart.data.datasets.reduce((sum, dataset) => sum + (dataset.data[0] || 0), 0);
                    return total > 0 ? (value / total * 100).toFixed(0) + '%' : '0%';
                }}}}
            });

            const sectorCounts = { defesa: 0, meio: 0, ataque: 0 };
            match.events.forEach(e => {
                if (sectorCounts.hasOwnProperty(e.zone)) {
                    sectorCounts[e.zone]++;
                }
            });

            const maxActions = Math.max(...Object.values(sectorCounts));

            const getColor = (count) => {
                const intensity = maxActions > 0 ? Math.min(0.2 + (count / maxActions) * 0.8, 1) : 0.2;
                return `rgba(220, 38, 38, ${intensity})`;
            };
            
            const mapCtx = document.getElementById('actionMapChart').getContext('2d');
            charts.actionMap = new Chart(mapCtx, {
                type: 'bubble',
                plugins: [fieldLinesPlugin],
                data: {
                    datasets: [{
                        label: 'Volume de Ações',
                        data: [
                            { x: 1, y: 5, r: 15 + sectorCounts.defesa * 2 },
                            { x: 2, y: 5, r: 15 + sectorCounts.meio * 2 },
                            { x: 3, y: 5, r: 15 + sectorCounts.ataque * 2 },
                        ],
                        backgroundColor: [
                            getColor(sectorCounts.defesa),
                            getColor(sectorCounts.meio),
                            getColor(sectorCounts.ataque),
                        ],
                        borderColor: 'rgba(153, 27, 27, 1)',
                        borderWidth: 1
                    }]
                },
                options: { 
                    responsive: true, 
                    maintainAspectRatio: false, 
                    layout: { padding: 10 },
                    scales: { 
                        x: { 
                            min: 0.5, max: 3.5, 
                            ticks: { 
                                stepSize: 1, color: '#1f2937', font: { weight: 'bold' },
                                callback: (value) => {
                                    if (value === 1) return 'DEFESA';
                                    if (value === 2) return 'MEIO';
                                    if (value === 3) return 'ATAQUE';
                                    return '';
                                } 
                            }, 
                            grid: { display: false } 
                        }, 
                        y: { display: false, min: 0, max: 10 } 
                    }, 
                    plugins: { 
                        legend: { display: false },
                        datalabels: {
                            color: 'white',
                            font: { weight: 'bold', size: 14 },
                            formatter: (value, context) => {
                                const sector = ['defesa', 'meio', 'ataque'][context.dataIndex];
                                return sectorCounts[sector];
                            }
                        }
                    } 
                }
            });
            
            renderManOfTheMatch(match);
            renderPlayerHighlights(match);
            renderReportSummaryTable(match);
        }
        
        function renderReportSummaryTable(match) {
            const container = document.getElementById('report-summary-table');
            const createRow = (label, myTeamVal, oppVal, cssClass = '') => `<tr class="${cssClass}"><td class="stat-value">${myTeamVal}</td><td class="stat-label">${label}</td><td class="stat-value">${oppVal}</td></tr>`;
            const createSubRow = (label, myTeamVal, oppVal) => `<tr class="bg-gray-50"><td class="sub-stat-value text-right pr-4">${myTeamVal}</td><td class="sub-stat-label">${label}</td><td class="sub-stat-value text-left pl-4">${oppVal}</td></tr>`;

            let tableHTML = `<table class="report-table text-center"><thead class="text-gray-700"><tr><th>${match.myTeamName}</th><th class="stat-label">Estatística</th><th>${match.opponentName}</th></tr></thead><tbody>`;
            
            const myTeamFin = match.events.filter(e => e.action === 'finalizacao');
            const oppFin = match.events.filter(e => e.action === 'finalizacao_adv');
            tableHTML += createRow('Finalizações', myTeamFin.length, oppFin.length, 'highlight-green');
            tableHTML += createSubRow('Dentro da área', myTeamFin.filter(e=>e.detail==='dentro').length, oppFin.filter(e=>e.detail==='dentro').length);
            tableHTML += createSubRow('Fora da área', myTeamFin.filter(e=>e.detail==='fora').length, oppFin.filter(e=>e.detail==='fora').length);
            tableHTML += createSubRow('Cabeça', myTeamFin.filter(e=>e.detail==='cabeca').length, oppFin.filter(e=>e.detail==='cabeca').length);
            
            tableHTML += createRow('Chances Claras', match.events.filter(e => e.action === 'chance_clara').length, match.events.filter(e => e.action === 'chance_clara_adv').length, 'highlight-green');
            
            const myTeamPassesCerto = match.events.filter(e => e.action === 'passe_certo').length;
            const myTeamPassesErrado = match.events.filter(e => e.action === 'passe_errado').length;
            const myTeamPassesTotal = myTeamPassesCerto + myTeamPassesErrado;
            const myTeamPassesPerc = myTeamPassesTotal > 0 ? `${(myTeamPassesCerto / myTeamPassesTotal * 100).toFixed(0)}%` : '0%';
            tableHTML += createRow('Passes (Total)', myTeamPassesTotal, '—', 'highlight-blue');
            tableHTML += createSubRow('Certos', `${myTeamPassesCerto} <span class="text-xs text-gray-500">(${myTeamPassesPerc})</span>`, '—');
            tableHTML += createSubRow('Errados', myTeamPassesErrado, '—');
            
            const myTeamDuelosGanhos = match.events.filter(e => e.action === 'duelo' && e.detail === 'ganho').length;
            const myTeamDuelosPerdidos = match.events.filter(e => e.action === 'duelo' && e.detail === 'perdido').length;
            const myTeamDuelosTotal = myTeamDuelosGanhos + myTeamDuelosPerdidos;
            const myTeamDuelosPerc = myTeamDuelosTotal > 0 ? `${(myTeamDuelosGanhos / myTeamDuelosTotal * 100).toFixed(0)}%` : '0%';
            const oppDuelosTotal = myTeamDuelosTotal; // Assume same number of duels for both
            const oppDuelosPerc = oppDuelosTotal > 0 ? `${(myTeamDuelosPerdidos / oppDuelosTotal * 100).toFixed(0)}%` : '0%';
            tableHTML += createRow('Duelos (Total)', myTeamDuelosTotal, oppDuelosTotal, 'highlight-blue');
            tableHTML += createSubRow('Ganhos', `${myTeamDuelosGanhos} <span class="text-xs text-gray-500">(${myTeamDuelosPerc})</span>`, `${myTeamDuelosPerdidos} <span class="text-xs text-gray-500">(${oppDuelosPerc})</span>`);

            tableHTML += createRow('Faltas Cometidas', match.events.filter(e => e.action === 'falta_cometida').length, match.events.filter(e => e.action === 'falta_sofrida').length, 'highlight-red');
            tableHTML += createRow('Cruzamentos', match.events.filter(e => e.action.startsWith('cruzamento_')).length, '—', 'highlight-green');
            tableHTML += createSubRow('Direita', match.events.filter(e => e.action === 'cruzamento_dir').length, '—');
            tableHTML += createSubRow('Esquerda', match.events.filter(e => e.action === 'cruzamento_esq').length, '—');

            tableHTML += '</tbody></table>';
            container.innerHTML = tableHTML;
        }
        
        function renderManOfTheMatch(match) {
            const container = document.getElementById('report-motm');
            const performers = {};
            if(!match.ratings || Object.keys(match.ratings).length === 0) {
                 container.innerHTML = '<p class="text-gray-500 text-center">Nenhuma avaliação registrada.</p>'; return;
            }
             Object.entries(match.ratings).forEach(([pid, rates]) => {
                const avg = (parseFloat(rates.tecnico) + parseFloat(rates.tatico) + parseFloat(rates.fisico) + parseFloat(rates.comportamental)) / 4;
                performers[pid] = avg;
            });
            const topPlayerId = Object.keys(performers).reduce((a, b) => performers[a] > performers[b] ? a : b);
            const player = appState.players.find(p => p.id === topPlayerId);
            const topScore = performers[topPlayerId];
            
            if(player) {
                container.innerHTML = `
                    <div class="flex flex-col items-center">
                        <div class="w-16 h-16 rounded-full bg-blue-600 text-white flex items-center justify-center text-3xl font-bold mb-2">
                           <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10" viewBox="0 0 20 20" fill="currentColor"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z" /></svg>
                        </div>
                        <p class="text-2xl font-bold">${player.name}</p>
                        <p class="text-lg text-gray-600">Nota Média: <span class="font-bold text-blue-600">${topScore.toFixed(1)}</span></p>
                    </div>
                `;
            }
        }
        
        function renderPlayerHighlights(match) {
            const container = document.getElementById('report-player-highlights');
            
            const countEventsByPlayer = (action, detail = null) => {
                const counts = {};
                match.events.filter(e => e.action === action && (detail ? e.detail === detail : true) && e.playerId).forEach(e => {
                    counts[e.playerId] = (counts[e.playerId] || 0) + 1;
                });
                const sorted = Object.entries(counts).sort(([,a],[,b]) => b-a);
                return sorted.length > 0 ? sorted[0] : [null, 0];
            };
            
            const [topFinisherId, topFinishes] = countEventsByPlayer('finalizacao');
            const [topDuelerId, topDuelsWon] = countEventsByPlayer('duelo', 'ganho');
            const totalPasses = match.events.filter(e => e.action.startsWith('passe_')).length;

            const topFinisher = appState.players.find(p => p.id === topFinisherId);
            const topDueler = appState.players.find(p => p.id === topDuelerId);
            
            container.innerHTML = `
                <ul class="space-y-4 flex flex-col justify-around h-full">
                    <li class="bg-gray-100 p-3 rounded-lg border flex items-center gap-4">
                        <span class="text-2xl">🎯</span>
                        <div><p class="font-bold">${topFinisher?.name || 'N/A'}</p><p class="text-sm text-gray-600">Mais Finalizações (${topFinishes})</p></div>
                    </li>
                     <li class="bg-gray-100 p-3 rounded-lg border flex items-center gap-4">
                        <span class="text-2xl">⚔️</span>
                        <div><p class="font-bold">${topDueler?.name || 'N/A'}</p><p class="text-sm text-gray-600">Mais Duelos Ganhos (${topDuelsWon})</p></div>
                    </li>
                    <li class="bg-gray-100 p-3 rounded-lg border flex items-center gap-4">
                        <span class="text-2xl">🔄</span>
                        <div><p class="font-bold">${totalPasses}</p><p class="text-sm text-gray-600">Total de Passes da Equipe</p></div>
                    </li>
                </ul>
            `;
        }

        function exportReportToPDF() {
            const reportContent = document.getElementById('report-content-wrapper');
            const button = document.getElementById('pdf-export-button');
            const text = document.getElementById('pdf-export-text');
            const loader = document.getElementById('pdf-export-loader');

            text.classList.add('hidden'); loader.classList.remove('hidden'); button.disabled = true;
            html2canvas(reportContent, { backgroundColor: '#ffffff', scale: 1 }).then(canvas => { // Reduced scale
                const imgData = canvas.toDataURL('image/jpeg', 0.7); // Use JPEG with quality
                const pdf = new jsPDF({ orientation: 'p', unit: 'px', format: [canvas.width, canvas.height] });
                pdf.addImage(imgData, 'JPEG', 0, 0, canvas.width, canvas.height); // Use JPEG
                const matchSelect = document.getElementById('report-match-select');
                let fileName = 'Relatorio_Scout';
                if (matchSelect.value) {
                    const match = appState.matches.find(m => m.id === matchSelect.value);
                    fileName = `Relatorio_${match.myTeamName}_vs_${match.opponentName}`;
                }
                pdf.save(`${fileName}.pdf`);
                text.classList.remove('hidden'); loader.classList.add('hidden'); button.disabled = false;
            });
        }
        
        function exportActionsToCSV() {
            const matchId = document.getElementById('report-match-select').value;
            if (!matchId) {
                alert("Por favor, selecione uma partida primeiro.");
                return;
            }
            const match = appState.matches.find(m => m.id === matchId);
            if (!match) return;

            let csvContent = "data:text/csv;charset=utf-8,";
            const headers = ["Tempo de Jogo", "Equipe", "Ação", "Detalhe", "Jogador"];
            csvContent += headers.join(",") + "\r\n";

            const eventsToExport = [...match.events].reverse(); // Export in chronological order

            eventsToExport.forEach(event => {
                const time = formatTime(event.time);
                let teamName = "N/A";
                if (event.playerName === 'Adversário' || event.action.endsWith('_adv')) {
                    teamName = match.opponentName;
                } else if (event.playerId) {
                    teamName = match.myTeamName;
                }
                const action = event.action.replace(/_/g, ' ');
                const detail = event.detail || '';
                const playerName = event.playerName || '';

                const row = [time, teamName, action, detail, playerName].map(str => `"${str}"`).join(",");
                csvContent += row + "\r\n";
            });

            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", `acoes_${match.myTeamName}_vs_${match.opponentName}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
        
        function exportPerformancesToCSV() {
            let csvContent = "data:text/csv;charset=utf-8,";
            const headers = ["Jogador", "Data", "Nota Média", "Técnico", "Tático", "Físico", "Comportamental"];
            csvContent += headers.join(",") + "\r\n";

            appState.matches.forEach(match => {
                if (match.status === 'finished' && match.ratings) {
                    const matchDate = new Date(match.date).toLocaleDateString('pt-BR', {timeZone: 'UTC'});
                    Object.entries(match.ratings).forEach(([playerId, rates]) => {
                         const player = appState.players.find(p => p.id === playerId);
                         if (player) {
                             const avg = ((+rates.tecnico + +rates.tatico + +rates.fisico + +rates.comportamental) / 4).toFixed(1);
                             const row = [player.name, matchDate, avg, rates.tecnico, rates.tatico, rates.fisico, rates.comportamental].join(",");
                             csvContent += row + "\r\n";
                         }
                    });
                }
            });
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "historico_desempenho.csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function exportPerformancesToPDF() {
            let tableHTML = `
                <style>
                    body { font-family: Helvetica, sans-serif; }
                    table { border-collapse: collapse; width: 100%; font-size: 10px; }
                    th, td { border: 1px solid #dddddd; text-align: left; padding: 4px; }
                    th { background-color: #f2f2f2; }
                    h1 { font-size: 18px; }
                </style>
                <h1>Histórico de Desempenho</h1>
                <table>
                    <thead>
                        <tr>
                            <th>Jogador</th>
                            <th>Data</th>
                            <th>Nota Média</th>
                            <th>Técnico</th>
                            <th>Tático</th>
                            <th>Físico</th>
                            <th>Comp.</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            appState.matches.forEach(match => {
                if (match.status === 'finished' && match.ratings) {
                    const matchDate = new Date(match.date).toLocaleDateString('pt-BR', {timeZone: 'UTC'});
                    Object.entries(match.ratings).forEach(([playerId, rates]) => {
                         const player = appState.players.find(p => p.id === playerId);
                         if (player) {
                             const avg = ((+rates.tecnico + +rates.tatico + +rates.fisico + +rates.comportamental) / 4).toFixed(1);
                             tableHTML += `
                                <tr>
                                    <td>${player.name}</td>
                                    <td>${matchDate}</td>
                                    <td>${avg}</td>
                                    <td>${rates.tecnico}</td>
                                    <td>${rates.tatico}</td>
                                    <td>${rates.fisico}</td>
                                    <td>${rates.comportamental}</td>
                                </tr>
                             `;
                         }
                    });
                }
            });

            tableHTML += '</tbody></table>';

            const tempContainer = document.createElement('div');
            tempContainer.style.position = 'absolute';
            tempContainer.style.left = '-9999px';
            tempContainer.innerHTML = tableHTML;
            document.body.appendChild(tempContainer);

            html2canvas(tempContainer, { scale: 1 }).then(canvas => { // Reduced scale
                const imgData = canvas.toDataURL('image/jpeg', 0.7); // Use JPEG with quality
                const pdf = new jsPDF('p', 'mm', 'a4');
                const pdfWidth = pdf.internal.pageSize.getWidth();
                const pdfHeight = pdf.internal.pageSize.getHeight();
                const imgWidth = canvas.width;
                const imgHeight = canvas.height;
                const ratio = imgWidth / imgHeight;
                let finalWidth = pdfWidth - 20;
                let finalHeight = finalWidth / ratio;
                
                if (finalHeight > pdfHeight - 20) {
                    finalHeight = pdfHeight - 20;
                    finalWidth = finalHeight * ratio;
                }

                const x = (pdfWidth - finalWidth) / 2;
                const y = 10;
                
                pdf.addImage(imgData, 'JPEG', x, y, finalWidth, finalHeight); // Use JPEG
                pdf.save("historico_desempenho.pdf");
                document.body.removeChild(tempContainer);
            });
        }


        // --- INITIALIZATION ---
        window.addEventListener('DOMContentLoaded', () => { 
            firebaseAuth();
        });
    </script>
</body>
</html>
